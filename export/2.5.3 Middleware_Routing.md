---
id: 2.5.3
title: Middleware y Routing
parent: '2.5'
breadcrumb: 0 → 2.0 → 2.5 → 2.5.3
type: especificacion
domain:
- nuxt
- routing
- security
- middleware
status: activo
last_updated: 2026-01-29 15:32
file_create: 2026-01-04 20:33
summary: 'Gestión de rutas y protección mediante middleware.

  File-system routing y navegación programática.'
content_hash: 541838292e7b427e
---

# 2.5.3 Middleware y Routing

> Control de navegación y protección de rutas.

---

## Rutas (File System Routing)

Nuxt genera rutas automáticamente basado en `pages/`.

| Archivo | Ruta Generada | Descripción |
|---------|---------------|-------------|
| `pages/index.vue` | `/` | Home / Landing |
| `pages/login.vue` | `/login` | Login público |
| `pages/app/index.vue` | `/app` | Dashboard Cliente B2C |
| `pages/files/[id].vue` | `/files/:id` | Ruta dinámica |

---

## Middleware de Protección

Ubicación: `middleware/`

### 1. Auth Guard Global (`auth.global.ts`)

Middleware que se ejecuta en cada cambio de ruta.

```ts
// middleware/auth.global.ts
export default defineNuxtRouteMiddleware((to, from) => {
  const user = useSupabaseUser()
  
  // Rutas públicas exentas
  if (to.path === '/login' || to.path === '/') return

  // Si no hay usuario, redirigir a login
  if (!user.value) {
    return navigateTo('/login')
  }
})
```

### 2. Role Guard (`role.ts`)

Para proteger rutas específicas (ej. solo Admin).

```ts
// middleware/admin.ts
export default defineNuxtRouteMiddleware(async (to) => {
  const { role } = useUserRole() // Composable personalizado
  
  if (role.value !== 'admin') {
    return abortNavigation('Acceso denegado: Requiere rol Admin')
  }
})
```

**Uso en Página:**

```vue
<script setup>
definePageMeta({
  middleware: ['admin']
})
</script>
```

---

## Estructura de Hijos

| ID | Nombre | Descripción | Estado |
|----|--------|-------------|--------|
| [[Proyecto OnlyCarNLD/Datos/2.5.3.1 Auth_Guards\|2.5.3.1]] | Auth Guards | Middleware de Autenticación | ✅ |
| [[Proyecto OnlyCarNLD/Datos/2.5.3.2 Role_Guards\|2.5.3.2]] | Role Guards | Middleware RBAC por Rol | ✅ |

---

## Layouts

El sistema utiliza layouts persistentes para evitar re-renderizados innecesarios de headers/sidebars.

- `layouts/default.vue`: Header público + Footer.
- `layouts/app.vue`: Sidebar navegación + Topbar usuario (B2C).
- `layouts/admin.vue`: Panel de control completo.
- `layouts/blank.vue`: Login / Pantalla completa.

---

## Navegación Programática

Usar siempre `navigateTo` (SSR friendly) en lugar de `router.push`.

```ts
await navigateTo({
  path: '/search',
  query: {
    q: 'lavado premium'
  }
})
```

---

## Navegación

| ⬆️ Padre             | [[Proyecto OnlyCarNLD/Datos/2.5. Arquitectura_Frontend]]   |
| -------------------- | -------------------------------- |
| ⬅️ Hermano anterior  | [[Proyecto OnlyCarNLD/Datos/2.5.2 Gestion_Estado]]         |

---
