---
id: 5.8.6.5.2
title: PolÃ­tica RetenciÃ³n
parent: 5.8.6.5
breadcrumb: 0 â†’ 5.0 â†’ 5.8 â†’ 5.8.6 â†’ 5.8.6.5 â†’ 5.8.6.5.2
type: politica
status: activo
last_updated: 2026-01-29 15:31
file_create: 2026-01-01 18:10
domain:
- retencion
- gdpr
- privacidad
summary: PolÃ­tica de retenciÃ³n de datos.
content_hash: d8dfca0c8463ed4c
---

# 5.8.6.5.2 PolÃ­tica de RetenciÃ³n

Reglas de almacenamiento y eliminaciÃ³n de datos de ubicaciÃ³n.

---

## Matriz de RetenciÃ³n

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  POLÃTICA DE RETENCIÃ“N DE DATOS GPS                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  TIPO DE DATO              RETENCIÃ“N        RAZÃ“N               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚  Ubicaciones intermedias   30 dÃ­as          Balance storage     â”‚
â”‚  UbicaciÃ³n de inicio       1 aÃ±o            AuditorÃ­a SLA       â”‚
â”‚  UbicaciÃ³n de llegada      1 aÃ±o            Prueba de servicio  â”‚
â”‚  Servicios con disputa     Indefinido       Evidencia legal     â”‚
â”‚  Datos archivados          3 aÃ±os           RegulaciÃ³n fiscal   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## JustificaciÃ³n por Tipo

### Ubicaciones Intermedias (30 dÃ­as)

| Aspecto | Detalle |
|---------|---------|
| **QuÃ© son** | Todas las ubicaciones entre inicio y llegada |
| **Cantidad** | ~90-95% del volumen total |
| **Uso** | ReconstrucciÃ³n de ruta, mÃ©tricas |
| **Por quÃ© 30 dÃ­as** | Suficiente para disputas inmediatas |
| **DespuÃ©s de 30 dÃ­as** | Valor marginal, costo de storage injustificado |

### Ubicaciones de Inicio/Llegada (1 aÃ±o)

| Aspecto | Detalle |
|---------|---------|
| **QuÃ© son** | Primera y Ãºltima ubicaciÃ³n de cada servicio |
| **Cantidad** | ~2 registros por servicio |
| **Uso** | Prueba de cumplimiento, auditorÃ­a |
| **Por quÃ© 1 aÃ±o** | Ciclo fiscal/contable, reclamos tardÃ­os |
| **Volumen anual** | ~2KB Ã— 1000 servicios/mes Ã— 12 = 24 MB |

### Servicios con Disputa (Indefinido)

| Aspecto | Detalle |
|---------|---------|
| **QuÃ© son** | Servicios marcados con `tiene_disputa = true` |
| **Cantidad** | <1% de servicios tÃ­picamente |
| **Uso** | Evidencia legal, arbitraje |
| **Por quÃ© indefinido** | Procesos legales pueden durar aÃ±os |
| **Gatillo** | Admin marca servicio como disputado |

### Datos Archivados (3 aÃ±os)

| Aspecto | Detalle |
|---------|---------|
| **QuÃ© son** | Snapshots comprimidos de servicios antiguos |
| **Formato** | JSON comprimido en tabla de archivo |
| **Uso** | RegulaciÃ³n fiscal, auditorÃ­as externas |
| **Por quÃ© 3 aÃ±os** | Requerimiento SAT MÃ©xico |

---

## Flujo de Ciclo de Vida

```mermaid
flowchart TD
    A[ğŸ“ Nueva UbicaciÃ³n] --> B{Â¿Es llegada/inicio?}
    B -->|SÃ­| C[RetenciÃ³n: 1 aÃ±o]
    B -->|No| D[RetenciÃ³n: 30 dÃ­as]
    
    C --> E[DÃ­a 365]
    D --> F[DÃ­a 30]
    
    E --> G{Â¿Servicio disputado?}
    F --> G
    
    G -->|SÃ­| H[Retener indefinido]
    G -->|No| I[Eliminar/Archivar]
    
    I --> J{Â¿Es llegada?}
    J -->|SÃ­| K[Archivar JSON]
    J -->|No| L[Borrar permanente]
    
    K --> M[RetenciÃ³n: 3 aÃ±os]
    M --> N[Borrar definitivo]
```

---

## ImplementaciÃ³n SQL

### Tabla de Metadatos de RetenciÃ³n

```sql
CREATE TABLE retencion_rules (
  id SERIAL PRIMARY KEY,
  tipo VARCHAR(50) NOT NULL,
  dias_retencion INT,  -- NULL = indefinido
  accion VARCHAR(20) NOT NULL,  -- 'delete' | 'archive' | 'retain'
  descripcion TEXT,
  activo BOOLEAN DEFAULT true
);

INSERT INTO retencion_rules (tipo, dias_retencion, accion, descripcion) VALUES
  ('ubicacion_intermedia', 30, 'delete', 'Ubicaciones entre inicio y llegada'),
  ('ubicacion_inicio', 365, 'archive', 'Primera ubicaciÃ³n del servicio'),
  ('ubicacion_llegada', 365, 'archive', 'UbicaciÃ³n de confirmaciÃ³n de llegada'),
  ('servicio_disputa', NULL, 'retain', 'Servicios con disputa activa'),
  ('archivo_historico', 1095, 'delete', 'Archivos comprimidos (3 aÃ±os)');
```

### Vista de Ubicaciones por Expirar

```sql
CREATE VIEW v_ubicaciones_por_expirar AS
SELECT 
  u.id,
  u.servicio_id,
  u.created_at,
  u.es_llegada,
  u.es_inicio,
  s.tiene_disputa,
  CASE 
    WHEN s.tiene_disputa THEN 'PROTECTED'
    WHEN u.es_llegada OR u.es_inicio THEN 
      CASE WHEN u.created_at < NOW() - INTERVAL '365 days' 
           THEN 'ARCHIVE' ELSE 'RETAIN' END
    ELSE 
      CASE WHEN u.created_at < NOW() - INTERVAL '30 days' 
           THEN 'DELETE' ELSE 'RETAIN' END
  END as accion_recomendada,
  CASE 
    WHEN s.tiene_disputa THEN NULL
    WHEN u.es_llegada OR u.es_inicio THEN 
      u.created_at + INTERVAL '365 days'
    ELSE 
      u.created_at + INTERVAL '30 days'
  END as fecha_expiracion
FROM ubicaciones_servicio u
JOIN servicios s ON u.servicio_id = s.id;
```

---

## Dashboard de RetenciÃ³n

```sql
-- Vista para monitorear volumen por categorÃ­a
CREATE VIEW v_retencion_stats AS
SELECT
  CASE 
    WHEN es_llegada THEN 'Llegadas'
    WHEN es_inicio THEN 'Inicios'
    ELSE 'Intermedias'
  END as categoria,
  COUNT(*) as total_registros,
  pg_size_pretty(COUNT(*) * 150) as tamano_estimado,
  COUNT(*) FILTER (WHERE created_at < NOW() - INTERVAL '30 days') as por_expirar_30d,
  COUNT(*) FILTER (WHERE created_at < NOW() - INTERVAL '365 days') as por_expirar_1y
FROM ubicaciones_servicio
GROUP BY 
  CASE 
    WHEN es_llegada THEN 'Llegadas'
    WHEN es_inicio THEN 'Inicios'
    ELSE 'Intermedias'
  END;
```

---

## Notificaciones de RetenciÃ³n

```typescript
// Alerta cuando un servicio en disputa tiene datos prÃ³ximos a expirar
// (Esto no deberÃ­a pasar, pero es una salvaguarda)
const checkDisputeRetention = async () => {
  const { data } = await supabase
    .from('v_ubicaciones_por_expirar')
    .select('servicio_id')
    .eq('accion_recomendada', 'DELETE')
    .eq('tiene_disputa', true);
  
  if (data?.length) {
    notifyAdmin({
      type: 'warning',
      message: `${data.length} ubicaciones de servicios disputados marcadas para eliminar`,
      action: 'Revisar polÃ­tica de retenciÃ³n'
    });
  }
};
```

---

â†’ Ver limpieza automÃ¡tica: [[Proyecto OnlyCarNLD/Datos/5.8.6.5.3 limpieza_automatica]]

---

## NavegaciÃ³n

| â¬†ï¸ Padre             | [[Proyecto OnlyCarNLD/Datos/5.8.6.5 historial_ubicaciones]] |
| -------------------- | --------------------------------- |
| â¬…ï¸ Hermano anterior  | [[Proyecto OnlyCarNLD/Datos/5.8.6.5.1 modelo_datos]]        |
| â¡ï¸ Hermano siguiente | [[Proyecto OnlyCarNLD/Datos/5.8.6.5.3 limpieza_automatica]] |
