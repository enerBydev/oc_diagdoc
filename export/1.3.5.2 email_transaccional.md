---
id: 1.3.5.2
title: Email Transaccional
parent: 1.3.5
breadcrumb: 0 ‚Üí 1.0 ‚Üí 1.3 ‚Üí 1.3.5 ‚Üí 1.3.5.2
type: feature
status: activo
last_updated: 2026-01-29 16:01
file_create: 2026-01-09 21:15
domain:
- comunicacion
- email
- transaccional
- notificaciones
summary: 'Sistema de env√≠o de emails transaccionales para confirmaciones,

  facturas y contratos. Usa Resend como proveedor con templates React.

  '
content_hash: 0563590853692a27
---

# 1.3.5.2 Email Transaccional

> **Prop√≥sito:** Enviar emails cr√≠ticos del negocio (no marketing) con alta deliverability y tracking.

---

## 1. Proveedor: Resend

### Justificaci√≥n de Elecci√≥n

| Criterio | Resend | SendGrid | Ventaja |
|----------|--------|----------|---------|
| **Developer Experience** | Excelente | Buena | Resend |
| **Pricing** | $20/3k emails/mes | $15/40k emails | SendGrid (volumen) |
| **Templates** | React Email | Handlebars | Resend (moderno) |
| **API simplicity** | 5 l√≠neas | 15+ l√≠neas | Resend |
| **Deliverability** | 98%+ | 95%+ | Resend |

**Decisi√≥n:** Resend para MVP por simplicidad. Migrar a SendGrid si volumen > 50k/mes.

---

## 2. Arquitectura

```mermaid
flowchart LR
    subgraph App[App OnlyCar]
        Event[Evento Trigger]
        API[API Route]
    end
    
    subgraph Resend[Resend Service]
        Send[Send API]
        Track[Tracking]
    end
    
    subgraph User[Usuario]
        Inbox[üìß Email]
    end
    
    Event -->|"service_completed"| API
    API -->|"POST /emails"| Send
    Send -->|"Entrega"| Inbox
    Inbox -->|"Open/Click"| Track
    Track -->|"Webhook"| API
```

---

## 3. Tipos de Email Transaccional

| Evento | Asunto | Prioridad | Attachments |
|--------|--------|-----------|-------------|
| **Servicio Completado** | ‚úÖ Tu servicio est√° listo | Alta | Factura PDF |
| **Pago Recibido** | üí∞ Confirmaci√≥n de pago | Alta | Recibo |
| **Contrato Pendiente** | üìù Contrato listo para firma | Alta | Contrato PDF |
| **Contrato Firmado** | ‚úÖ Contrato firmado | Media | Copia firmada |
| **Cuenta Creada** | üëã Bienvenido a OnlyCar | Media | - |
| **Reset Password** | üîê Restablecer contrase√±a | Alta | - |

---

## 4. Implementaci√≥n con Resend

### 4.1 Configuraci√≥n

```typescript
// server/utils/resend.ts
import { Resend } from 'resend';

const resend = new Resend(process.env.RESEND_API_KEY);

export { resend };
```

### 4.2 Env√≠o de Email

```typescript
// server/api/emails/service-completed.post.ts
import { resend } from '~/server/utils/resend';
import { ServiceCompletedEmail } from '~/emails/ServiceCompleted';
import { render } from '@react-email/render';

export default defineEventHandler(async (event) => {
  const { to, customerName, serviceName, operatorName, photoUrl, paymentLink } = 
    await readBody(event);
  
  const html = render(ServiceCompletedEmail({
    customerName,
    serviceName,
    operatorName,
    photoUrl,
    paymentLink
  }));
  
  const { data, error } = await resend.emails.send({
    from: 'OnlyCar <servicios@onlycar.mx>',
    to: [to],
    subject: '‚úÖ Tu servicio de limpieza est√° listo',
    html,
    tags: [
      { name: 'type', value: 'service_completed' },
      { name: 'service_id', value: serviceName }
    ]
  });
  
  if (error) {
    throw createError({ statusCode: 500, message: error.message });
  }
  
  return { id: data.id };
});
```

---

## 5. Templates con React Email

```tsx
// emails/ServiceCompleted.tsx
import {
  Body,
  Button,
  Container,
  Head,
  Html,
  Img,
  Preview,
  Section,
  Text
} from '@react-email/components';

interface Props {
  customerName: string;
  serviceName: string;
  operatorName: string;
  photoUrl?: string;
  paymentLink: string;
}

export const ServiceCompletedEmail = ({
  customerName,
  serviceName,
  operatorName,
  photoUrl,
  paymentLink
}: Props) => (
  <Html>
    <Head />
    <Preview>Tu servicio de {serviceName} est√° listo</Preview>
    <Body style={main}>
      <Container style={container}>
        <Img
          src="https://onlycar.mx/logo.png"
          width="120"
          alt="OnlyCar"
        />
        
        <Text style={heading}>¬°Hola {customerName}!</Text>
        
        <Text style={paragraph}>
          Tu servicio de <strong>{serviceName}</strong> ha sido completado
          por {operatorName}.
        </Text>
        
        {photoUrl && (
          <Img
            src={photoUrl}
            width="400"
            style={photo}
            alt="Tu veh√≠culo"
          />
        )}
        
        <Section style={buttonSection}>
          <Button style={button} href={paymentLink}>
            üí≥ Pagar Ahora
          </Button>
        </Section>
        
        <Text style={footer}>
          Gracias por preferirnos,<br />
          Equipo OnlyCar
        </Text>
      </Container>
    </Body>
  </Html>
);
```

---

## 6. Dominio Verificado

Para m√°xima deliverability, configurar DNS:

```
# Registros DNS para onlycar.mx
mail._domainkey.onlycar.mx  TXT  v=DKIM1; k=rsa; p=MIGf...
_dmarc.onlycar.mx           TXT  v=DMARC1; p=quarantine; rua=...
onlycar.mx                  TXT  v=spf1 include:resend.com ~all
```

---

## 7. Tracking y Webhooks

Resend env√≠a webhooks para:
- `email.sent` - Email enviado al servidor SMTP
- `email.delivered` - Email entregado al inbox
- `email.opened` - Email abierto (tracking pixel)
- `email.clicked` - Link clickeado
- `email.bounced` - Rebotado (email inv√°lido)
- `email.complained` - Marcado como spam

---

## Navegaci√≥n

| Elemento | Enlace |
|----------|--------|
| ‚¨ÜÔ∏è Padre | [[Proyecto OnlyCarNLD/Datos/1.3.5 notificaciones]] |
| ‚¨ÖÔ∏è Anterior | [[Proyecto OnlyCarNLD/Datos/1.3.5.1 push_notifications]] |
| ‚û°Ô∏è Siguiente | [[Proyecto OnlyCarNLD/Datos/1.3.5.3 sms_verificacion]] |
