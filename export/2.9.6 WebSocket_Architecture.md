---
id: 2.9.6
title: Arquitectura WebSockets
parent: '2.9'
breadcrumb: 0 → 2.0 → 2.9 → 2.9.6
type: arquitectura
status: activo
domain:
- realtime
- websockets
- chat
- tracking
file_create: 2026-01-14 12:55
last_updated: 2026-01-29 15:32
summary: Arquitectura de comunicación en tiempo real sobre Supabase Realtime (Postgres
  Changes + Broadcast).
content_hash: 8cc219f69179b3c8
---

# 2.9.6 Arquitectura WebSockets

> Motor de comunicación bidireccional para Chat y Tracking de Operadores.

---

## Tecnología Base: Supabase Realtime

Utilizamos el motor de Realtime de Supabase sobre WebSockets. No mantenemos un servidor de sockets propio (Socket.io), delegamos la infraestructura.

### Tipos de Canales

1.  **Postgres Changes:**
    *   *Uso:* Chat, Notificaciones de Estado.
    *   *Mecanismo:* Escucha `INSERT/UPDATE` en tablas `mensajes`, `solicitudes`.
    *   *Fiabilidad:* Alta (Persistido en DB).

2.  **Broadcast (Efímero):**
    *   *Uso:* Tracking GPS Operador ([[Proyecto OnlyCarNLD/Datos/5.8. geolocalizacion]]), "Escribiendo...".
    *   *Mecanismo:* Pasa por memoria, bajo latencia, no se guarda en DB.
    *   *Fiabilidad:* Best-effort (Prioriza velocidad).

3.  **Presence:**
    *   *Uso:* Estado "En línea" / "Desconectado".
    *   *Mecanismo:* Sync de estado entre clientes conectados.

---

## Topología de Canales

| Canal | Scope | Eventos | Payload |
|-------|-------|---------|---------|
| `room:{uuid}` | Privado (RLS) | `new_message` | SMS Text + Attachments |
| `tracking:{order_id}` | Privado (RLS) | `coords_update` | `{lat, lng, heading}` |
| `global:system` | Público Auth | `maintenance_alert` | `{msg, type}` |
| `ops:broadcast` | Operadores | `new_request` | `{id, zona, precio}` |

---

## Manejo de Desconexión

El cliente (Front/Mobile) implementa una **Queue Replay Strategy**:
1.  Si cae la red, los mensajes se guardan en IndexedDB ([[Proyecto OnlyCarNLD/Datos/2.10. Estrategia_Offline]]).
2.  Al reconectar, se procesa la cola en orden FIFO.
3.  El tracking GPS se descarta si es viejo (>1 min).

---

## Navegación

| ⬆️ Padre             | [[Proyecto OnlyCarNLD/Datos/2.9. Arquitectura_Backend]] |
| -------------------- | ----------------------------- |
| ⬅️ Hermano anterior  | [[Proyecto OnlyCarNLD/Datos/2.9.5 Database_Interface]] |
| ➡️ Hermano siguiente | [[Proyecto OnlyCarNLD/Datos/2.9.7 API_Versioning]] |

---
