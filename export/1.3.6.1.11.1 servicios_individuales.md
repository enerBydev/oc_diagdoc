---
id: 1.3.6.1.11.1
title: Servicios Individuales
parent: 1.3.6.1.11
breadcrumb: 0 â†’ 1.0 â†’ 1.3 â†’ 1.3.6 â†’ 1.3.6.1 â†’ 1.3.6.1.11 â†’ 1.3.6.1.11.1
type: hoja
status: activo
domain: comunicacion
summary: Modelo de datos y composable para habilitar/deshabilitar servicios individuales
  que ofrece el operador.
version: 1.0
last_updated: 2026-01-29 15:32
file_create: 2025-12-26 15:18
actors:
- operador
- admin
dependencies:
- supabase
affects:
- 1.3.6.1.11 preferencias_servicios
content_hash: 8103fb0d1d94ccbf
---

# 1.3.6.1.11.1 Servicios Individuales

Servicios que el operador puede habilitar/deshabilitar.

---

## Modelo de Datos

### Tabla: servicios_operador

```sql
CREATE TABLE servicios_operador (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  operador_id UUID NOT NULL REFERENCES operadores(id),
  servicio_id UUID NOT NULL REFERENCES servicios(id),
  habilitado BOOLEAN DEFAULT true,
  habilitado_por VARCHAR(20) DEFAULT 'operador',  -- 'operador' | 'admin'
  requiere_capacitacion BOOLEAN DEFAULT false,
  capacitacion_verificada BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),
  
  UNIQUE (operador_id, servicio_id)
);

CREATE INDEX idx_servicios_operador_op ON servicios_operador(operador_id);
CREATE INDEX idx_servicios_operador_serv ON servicios_operador(servicio_id);
CREATE INDEX idx_servicios_operador_hab ON servicios_operador(habilitado) WHERE habilitado = true;
```

### Tabla: servicios (referencia)

```sql
-- Tabla de servicios del catÃ¡logo
CREATE TABLE servicios (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  nombre VARCHAR(100) NOT NULL,
  descripcion TEXT,
  precio DECIMAL(10, 2) NOT NULL,
  duracion_minutos INT NOT NULL,
  requiere_capacitacion BOOLEAN DEFAULT false,
  activo BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT now()
);

-- Seed de servicios
INSERT INTO servicios (nombre, precio, duracion_minutos, requiere_capacitacion) VALUES
  ('Lavado Express', 249, 30, false),
  ('Lavado Completo', 399, 45, false),
  ('Aspirado Interior', 199, 25, false),
  ('Encerado', 299, 40, true),
  ('DesinfecciÃ³n', 149, 15, false),
  ('Pulido de Faros', 349, 35, true);
```

---

## InicializaciÃ³n para Operador Nuevo

```sql
-- Al registrar operador, crear registros para todos los servicios
CREATE OR REPLACE FUNCTION inicializar_servicios_operador()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO servicios_operador (operador_id, servicio_id, habilitado, requiere_capacitacion)
  SELECT 
    NEW.id, 
    s.id, 
    NOT s.requiere_capacitacion,  -- Habilitado si NO requiere capacitaciÃ³n
    s.requiere_capacitacion
  FROM servicios s
  WHERE s.activo = true;
  
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_init_servicios_operador
AFTER INSERT ON operadores
FOR EACH ROW EXECUTE FUNCTION inicializar_servicios_operador();
```

---

## Composable: useOperatorServices

```typescript
// composables/useOperatorServices.ts
interface ServicioOperador {
  id: string;
  servicio_id: string;
  nombre: string;
  precio: number;
  duracion_minutos: number;
  habilitado: boolean;
  requiere_capacitacion: boolean;
  capacitacion_verificada: boolean;
}

export const useOperatorServices = () => {
  const supabase = useSupabaseClient();
  const user = useSupabaseUser();
  
  const servicios = ref<ServicioOperador[]>([]);
  const isLoading = ref(true);
  
  const fetchServicios = async () => {
    isLoading.value = true;
    
    const { data } = await supabase
      .from('servicios_operador')
      .select(`
        id,
        servicio_id,
        habilitado,
        requiere_capacitacion,
        capacitacion_verificada,
        servicios (nombre, precio, duracion_minutos)
      `)
      .eq('operador_id', user.value?.id);
    
    servicios.value = data?.map(s => ({
      ...s,
      nombre: s.servicios.nombre,
      precio: s.servicios.precio,
      duracion_minutos: s.servicios.duracion_minutos
    })) || [];
    
    isLoading.value = false;
  };
  
  const toggleServicio = async (servicioId: string, habilitado: boolean) => {
    const servicio = servicios.value.find(s => s.servicio_id === servicioId);
    
    // Validar: si requiere capacitaciÃ³n y no estÃ¡ verificada, no puede habilitar
    if (habilitado && servicio?.requiere_capacitacion && !servicio?.capacitacion_verificada) {
      toast.error('Este servicio requiere capacitaciÃ³n verificada por Admin');
      return false;
    }
    
    // Validar: mÃ­nimo 1 servicio habilitado
    const habilitados = servicios.value.filter(s => s.habilitado && s.servicio_id !== servicioId);
    if (!habilitado && habilitados.length === 0) {
      toast.error('Debes tener al menos 1 servicio habilitado');
      return false;
    }
    
    const { error } = await supabase
      .from('servicios_operador')
      .update({ 
        habilitado, 
        updated_at: new Date(),
        habilitado_por: 'operador'
      })
      .eq('operador_id', user.value?.id)
      .eq('servicio_id', servicioId);
    
    if (!error) {
      // Actualizar local
      const idx = servicios.value.findIndex(s => s.servicio_id === servicioId);
      if (idx !== -1) servicios.value[idx].habilitado = habilitado;
      
      toast.success(habilitado ? 'Servicio habilitado' : 'Servicio deshabilitado');
    }
    
    return !error;
  };
  
  // Admin habilita capacitaciÃ³n
  const verificarCapacitacion = async (operadorId: string, servicioId: string) => {
    await supabase
      .from('servicios_operador')
      .update({ 
        capacitacion_verificada: true,
        habilitado: true,
        habilitado_por: 'admin'
      })
      .eq('operador_id', operadorId)
      .eq('servicio_id', servicioId);
  };
  
  onMounted(fetchServicios);
  
  return {
    servicios,
    isLoading,
    toggleServicio,
    verificarCapacitacion,
    refetch: fetchServicios
  };
};
```

---

## Vista para Matching

```sql
-- Vista: Servicios habilitados por operador (para matching rÃ¡pido)
CREATE VIEW v_servicios_habilitados AS
SELECT
  so.operador_id,
  so.servicio_id,
  s.nombre as servicio_nombre,
  s.precio,
  s.duracion_minutos
FROM servicios_operador so
JOIN servicios s ON so.servicio_id = s.id
WHERE so.habilitado = true
  AND s.activo = true;

-- Uso en matching:
-- WHERE s.servicio_id IN (
--   SELECT servicio_id FROM v_servicios_habilitados WHERE operador_id = o.id
-- )
```

---

## Admin: Gestionar Capacitaciones

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“‹ ADMIN: CAPACITACIONES PENDIENTES                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Operadores esperando verificaciÃ³n de capacitaciÃ³n:             â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Carlos M.     â”‚ Encerado      â”‚ Solicitud: 12 Ene       â”‚    â”‚
â”‚  â”‚ [ Verificar ] â”‚ [ Rechazar ]  â”‚                         â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Pedro R.      â”‚ Pulido Faros  â”‚ Solicitud: 14 Ene       â”‚    â”‚
â”‚  â”‚ [ Verificar ] â”‚ [ Rechazar ]  â”‚                         â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## NavegaciÃ³n

| â¬†ï¸ Padre             | [[Proyecto OnlyCarNLD/Datos/1.3.6.1.11 preferencias_servicios]]     |
| -------------------- | ----------------------------------------- |
| â¡ï¸ Hermano siguiente | [[Proyecto OnlyCarNLD/Datos/1.3.6.1.11.2 paquetes_aceptados]]       |

---
