---
id: 5.6.4
title: Detección de Tipo de Usuario
parent: '5.6'
breadcrumb: 0 → 5.0 → 5.6 → 5.6.4
type: logica
status: activo
last_updated: 2026-01-29 15:32
file_create: 2025-12-23 14:27
domain:
- auth
- b2c
- b2b
- corporate
summary: 'Lógica post-login para identificar si el usuario es B2C Puro o Corporate+.

  Basado en dominio email, verificación en BD empresas_b2b.'
content_hash: b91413dbc9e39b5c
---

# 5.6.4 Detección de Tipo de Usuario

Lógica post-login para identificar si el usuario es B2C Puro o Corporate+.

---

## Principio

> [!NOTE]
> La detección ocurre **DESPUÉS** del login exitoso, sin importar el método usado.
> Se basa únicamente en el **dominio del email** autenticado.

---

## Flujo de Detección

```
┌─────────────────────────────────────────────────────────────────┐
│                    LOGIN EXITOSO                                │
│            (OAuth Azure/Google o Email/Password)                │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│  EXTRAER DOMINIO                                                │
│                                                                 │
│  email: "juan.perez@empresaxyz.com"                             │
│  dominio: "empresaxyz.com"                                      │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│  ¿ES DOMINIO PÚBLICO?                                           │
│                                                                 │
│  gmail.com, outlook.com, hotmail.com, yahoo.com,                │
│  prodigy.net.mx, live.com, icloud.com, aol.com...               │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                    ┌──────┴──────┐
                    │             │
                    ▼             ▼
                 [ SÍ ]        [ NO ]
                    │             │
                    ▼             │
            B2C PURO              │
          (Sin beneficios         │
           corporativos)          │
                                  ▼
               ┌─────────────────────────────────────┐
               │  BUSCAR EN BD: empresas_b2b         │
               │                                     │
               │  SELECT * FROM empresas_b2b         │
               │  WHERE dominio_email = 'empresaxyz' │
               │  AND contrato_activo = true         │
               └─────────────────┬───────────────────┘
                                 │
                          ┌──────┴──────┐
                          │             │
                          ▼             ▼
                      ENCONTRADO    NO ENCONTRADO
                          │             │
                          ▼             ▼
                    CORPORATE+      B2C PURO
                   (CORP15, etc)   (Sin beneficios)
```

---

## Dominios Públicos (Never Corporate)

Lista de dominios que **nunca** pueden ser Corporate+:

```typescript
const DOMINIOS_PUBLICOS = [
  // Google
  'gmail.com',
  'googlemail.com',
  
  // Microsoft
  'outlook.com',
  'hotmail.com',
  'live.com',
  'msn.com',
  
  // Yahoo
  'yahoo.com',
  'yahoo.com.mx',
  
  // Apple
  'icloud.com',
  'me.com',
  'mac.com',
  
  // ISPs México
  'prodigy.net.mx',
  'infinitum.com.mx',
  'telmexmail.com',
  'izzi.mx',
  'totalplay.com.mx',
  'axtel.net',
  
  // Otros
  'aol.com',
  'zoho.com',
  'mail.com',
  'yandex.com',
  'tutanota.com',
  'protonmail.com',
  'proton.me'
];

const esDominioPublico = (dominio: string): boolean => {
  return DOMINIOS_PUBLICOS.includes(dominio.toLowerCase());
};
```

---

## Implementación

```typescript
// server/utils/detectarTipoUsuario.ts

interface TipoUsuarioResult {
  tipo: 'b2c_puro' | 'corporate_plus';
  empresa_id?: string;
  descuentosDisponibles: string[];
  creditosDisponibles: string[];
  beneficiosAdicionales?: string[];
}

export const detectarTipoUsuario = async (
  email: string
): Promise<TipoUsuarioResult> => {
  const dominio = email.split('@')[1].toLowerCase();
  
  // Paso 1: Verificar si es dominio público
  if (esDominioPublico(dominio)) {
    return {
      tipo: 'b2c_puro',
      descuentosDisponibles: ['BIENVENIDA30', 'BIENVENIDA_REFERIDA', 'FLOTILLA20'],
      creditosDisponibles: ['PADRINO']
    };
  }
  
  // Paso 2: Buscar empresa con contrato activo
  const empresa = await db
    .select()
    .from(empresas_b2b)
    .where(and(
      eq(empresas_b2b.dominio_email, dominio),
      eq(empresas_b2b.contrato_activo, true)
    ))
    .first();
  
  if (empresa) {
    return {
      tipo: 'corporate_plus',
      empresa_id: empresa.id,
      descuentosDisponibles: ['CORP15', 'FLOTILLA20'],
      creditosDisponibles: ['PADRINO'],
      beneficiosAdicionales: ['prioridadAgenda48hrs', 'tarjetasReferido10']
    };
  }
  
  // Paso 3: Dominio corporativo pero sin contrato
  return {
    tipo: 'b2c_puro',
    descuentosDisponibles: ['BIENVENIDA30', 'BIENVENIDA_REFERIDA', 'FLOTILLA20'],
    creditosDisponibles: ['PADRINO']
  };
};
```

---

## Tabla de Detección

| Dominio Email | En BD | Contrato Activo | Resultado |
|---------------|-------|-----------------|-----------|
| `@gmail.com` | — | — | B2C Puro |
| `@prodigy.net.mx` | — | — | B2C Puro |
| `@empresaxyz.com` | ✅ | ✅ | Corporate+ |
| `@empresaxyz.com` | ✅ | ❌ (expirado) | B2C Puro |
| `@nuevaempresa.com` | ❌ | — | B2C Puro |

---

## Descuentos y Beneficios por Tipo

> [!NOTE]
> **Fuente de verdad:** Los valores están en [[Proyecto OnlyCarNLD/Datos/3.1.1 config_precios_v3.2]]

### B2C Puro — Descuentos Disponibles

| Código | Nombre | % | Tipo | Descripción |
|--------|--------|---|------|-------------|
| BIENVENIDA30 | Bienvenida Orgánica | 30% | primeraVez | Sin referido |
| BIENVENIDA_REFERIDA | Bienvenida Referida | 40% | primeraVez | Con código referido |
| FLOTILLA20 | Flotilla Personal | 20% | volumen | 3+ vehículos misma cita |
| PADRINO | Crédito Padrino | 20% | crédito | Ganado por referidos |

**Prioridad de agenda:** 72 horas

---

### Corporate+ — Descuentos Disponibles

| Código | Nombre | % | Tipo | Descripción |
|--------|--------|---|------|-------------|
| CORP15 | Empleado Corporativo | 15% | permanente | Siempre activo |
| FLOTILLA20 | Flotilla Personal | 20% | volumen | Combinable con CORP15 |
| PADRINO | Crédito Padrino | 20% | crédito | Ganado por referidos |

**Beneficios adicionales:**
- Prioridad de agenda: **48 horas** (vs 72 público)
- Tarjetas de referido físicas: **10 unidades**
- Facturación personal (separada de empresa)

---

## Actualización de Tipo

El tipo de usuario puede cambiar si:

| Evento | De → A |
|--------|--------|
| Empresa firma contrato | B2C Puro → Corporate+ |
| Contrato expira | Corporate+ → B2C Puro |
| Contrato se renueva | Corporate+ → Corporate+ |

```typescript
// Webhook cuando cambia estado de empresa
export const actualizarTipoUsuariosEmpresa = async (
  empresaId: string,
  contratoActivo: boolean
) => {
  const empresa = await getEmpresa(empresaId);
  const nuevoTipo = contratoActivo ? 'corporate_plus' : 'b2c_puro';
  
  await db
    .update(users)
    .set({ tipo_usuario: nuevoTipo })
    .where(eq(users.dominio_email, empresa.dominio_email));
  
  // Notificar a usuarios afectados
  if (!contratoActivo) {
    await notificarPerdidaBeneficios(empresa.dominio_email);
  }
};
```

---

## Navegación

| ⬆️ Padre             | [[Proyecto OnlyCarNLD/Datos/5.6. autenticacion]]            |
| -------------------- | --------------------------------- |
| ⬅️ Hermano anterior  | [[Proyecto OnlyCarNLD/Datos/5.6.3 email_password_blindado]] |
| ➡️ Hermano siguiente | [[Proyecto OnlyCarNLD/Datos/5.6.5 seguridad_auth]]          |

---
