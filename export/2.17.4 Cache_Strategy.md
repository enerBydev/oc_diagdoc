---
id: 2.17.4
title: Cache Strategy
parent: '2.17'
breadcrumb: 0 ‚Üí 2.0 ‚Üí 2.17 ‚Üí 2.17.4
type: optimizacion
children_count: 0
descendants_count: 0
status: activo
domain:
- performance
- cache
- swr
- cloudflare
actors:
- arquitecto
- devops
summary: 'Estrategia de Caching multi-nivel: Browser, Service Worker, CDN (Edge) y
  Database.'
last_updated: 2026-01-29 15:32
file_create: 2026-01-23 02:45
content_hash: 23378d21243f6c3f
---

# 2.17.4 Cache Strategy

> "La request m√°s r√°pida es la que no se hace".

---

## Capas de Cach√©

```mermaid
flowchart TD
    App[üì± App] --> |1. Memory| MEM{Pinia}
    MEM --> |Hit| UI[Render]
    MEM --> |Miss| SW{Service Worker}
    
    SW --> |2. Disk/Offline| IDB[(IndexedDB)]
    SW --> |Miss - Network| CDN{3. Cloudflare Edge}
    
    CDN --> |Hit| SW
    CDN --> |Miss| API[Server Nitro]
    
    API --> |4. Redis/Internal| KV[(Redis)]
    API --> |5. Query| DB[(Supabase Postgres)]
```

---

## Estrategias por Tipo de Dato

| Tipo de Dato | Estrategia | TTL (Time To Live) | Herramienta |
|--------------|------------|--------------------|-------------|
| **Cat√°logo Servicios** | Stale-While-Revalidate | 24 horas | Workbox / Pinia |
| **Perfil Usuario** | Network First | 0 (Realtime) | Supabase Auth |
| **Feed Veh√≠culos** | Cache First (con exp) | 1 hora | IndexedDB |
| **Im√°genes Est√°ticas** | Cache Forever | 1 a√±o (inmutable) | CDN |

---

## Configuraci√≥n Nuxt (Nitro)

Para cachear respuestas de API en el Edge (Cloudflare):

```typescript
// server/api/servicios.ts
export default defineEventHandler(async (event) => {
  setResponseHeader(event, 'Cache-Control', 'public, max-age=3600, s-maxage=3600');
  
  // O usar storage layer de Nitro
  return await useStorage('cache').getItem('servicios') || fetchFromDB();
});
```

---

## Service Worker (Offline)

Usamos **Vite PWA Plugin** con estrategia Workbox.

```typescript
// nuxt.config.ts
pwa: {
  workbox: {
    runtimeCaching: [
      {
        urlPattern: /^https:\/\/api\.onlycar\.mx\/catalogo/,
        handler: 'StaleWhileRevalidate',
        options: {
          cacheName: 'api-catalogo',
          expiration: {
            maxEntries: 50,
            maxAgeSeconds: 86400 // 24h
          }
        }
      },
      {
        urlPattern: /^https:\/\/.*\.supabase\.co\/storage/,
        handler: 'CacheFirst',
        options: {
          cacheName: 'images',
          expiration: {
            maxEntries: 100,
            maxAgeSeconds: 7 * 86400 // 1 semana
          }
        }
      }
    ]
  }
}
```

---

## Invalidaci√≥n de Cach√©

La parte m√°s dif√≠cil. Usamos invalidaci√≥n basada en tags o eventos.

1. **Admin actualiza precio:** Webhook ‚Üí Cloudflare Purge Cache.
2. **Usuario edita perfil:** Optimistic UI update local + Request de fondo.

---

## Navegaci√≥n

| ‚¨ÜÔ∏è Padre             | [[Proyecto OnlyCarNLD/Datos/2.17. Performance_Strategy]] |
| -------------------- | ------------------------------ |
| ‚¨ÖÔ∏è Hermano anterior  | [[Proyecto OnlyCarNLD/Datos/2.17.3 Image_Optimization]]  |
| ‚û°Ô∏è Hermano siguiente | *(√öltimo hijo de 2.17)*        |

---
