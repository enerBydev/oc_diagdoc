---
id: 1.3.3.3
title: Flujo de Servicio en Chat
parent: 1.3.3
breadcrumb: 0 ‚Üí 1.0 ‚Üí 1.3 ‚Üí 1.3.3 ‚Üí 1.3.3.3
type: hoja
status: activo
domain: comunicacion
summary: FSM del canal Operador-Cliente durante servicio activo con estados, mensajes
  autom√°ticos, CARDs y acciones por estado.
version: 1.0
last_updated: 2026-01-29 15:32
file_create: 2025-12-23 23:55
actors:
- operador
- cliente
- sistema
dependencies:
- 1.3.3.2 documentacion_fotografica
affects:
- 1.3.3 chat_operador_cliente
content_hash: f9a447076c34abf1
---

# 1.3.3.3 Flujo de Servicio en Chat

FSM del canal Operador-Cliente durante servicio.

---

## FSM: Servicio Activo

```mermaid
stateDiagram-v2
    [*] --> cita_confirmada
    cita_confirmada --> operador_asignado: Admin asigna
    operador_asignado --> en_camino: Operador sale
    en_camino --> llegado: GPS confirma
    llegado --> fotos_antes: Inicia documentaci√≥n
    fotos_antes --> en_servicio: Fotos subidas
    en_servicio --> fotos_despues: Termina trabajo
    fotos_despues --> esperando_pago: Todo documentado
    esperando_pago --> pagado: Pago recibido
    esperando_pago --> pendiente_pago: Cliente no paga
    pagado --> completado: Cierre
    pendiente_pago --> pagado: Pago posterior
    completado --> [*]
```

---

## Estados y Mensajes Autom√°ticos

| Estado | Mensaje al Cliente | CARD |
|--------|-------------------|------|
| `operador_asignado` | "Carlos atender√° tu servicio" | ‚Äî |
| `en_camino` | "Carlos est√° en camino üöó" | Ubicaci√≥n |
| `llegado` | "Carlos ha llegado" | ‚Äî |
| `fotos_antes` | ‚Äî | ‚Äî |
| `en_servicio` | "Servicio en progreso" | ‚Äî |
| `fotos_despues` | "¬°Servicio completado!" | Documentaci√≥n |
| `esperando_pago` | "Revisa el resultado" | Pago |
| `pagado` | "¬°Gracias por tu pago!" | Confirmaci√≥n |
| `completado` | "¬øC√≥mo fue tu experiencia?" | Calificaci√≥n |

---

## Acciones por Estado

### en_camino

| Actor    | Acciones Disponibles                          |
| -------- | --------------------------------------------- |
| Operador | Ver ruta, Compartir ubicaci√≥n, Mensaje r√°pido |
| Cliente  | Ver ubicaci√≥n, Enviar instrucciones           |

### llegado

| Actor | Acciones Disponibles |
|-------|---------------------|
| Operador | Confirmar llegada, Tomar fotos ANTES |
| Cliente | Confirmar recepci√≥n |

### en_servicio

| Actor | Acciones Disponibles |
|-------|---------------------|
| Operador | Preguntar al cliente, Notas internas |
| Cliente | Enviar instrucciones adicionales |

### fotos_despues

| Actor | Acciones Disponibles |
|-------|---------------------|
| Operador | Subir fotos, Agregar comentario, Finalizar |

---

## Implementaci√≥n

```typescript
// Hook: cambio de estado
const onEstadoServicioCambia = async (
  servicioId: string, 
  nuevoEstado: string
) => {
  const conversacionId = await getConversacionServicio(servicioId);
  
  const mensajesAuto: Record<string, string> = {
    en_camino: 'Carlos est√° en camino üöó',
    llegado: 'Carlos ha llegado a tu ubicaci√≥n',
    fotos_despues: '¬°Servicio completado! Revisa el resultado',
    pagado: '¬°Gracias por tu pago! üí∞',
    completado: '¬øC√≥mo fue tu experiencia?'
  };
  
  if (mensajesAuto[nuevoEstado]) {
    await enviarMensajeSistema(conversacionId, mensajesAuto[nuevoEstado]);
  }
  
  // CARDs espec√≠ficos
  if (nuevoEstado === 'en_camino') {
    await enviarCardUbicacion(conversacionId, servicioId);
  } else if (nuevoEstado === 'fotos_despues') {
    await enviarCardDocumentacion(conversacionId, servicioId);
  } else if (nuevoEstado === 'esperando_pago') {
    await enviarCardPago(conversacionId, servicioId);
  } else if (nuevoEstado === 'completado') {
    await enviarCardCalificacion(conversacionId, servicioId);
  }
};
```

---

## Archivado

| Condici√≥n | Acci√≥n |
|-----------|--------|
| 24h despu√©s de `completado` | Chat se archiva |
| Cliente accede despu√©s | Puede ver historial (solo lectura) |
| Disputa abierta | Chat reactivo temporalmente |

---

## Navegaci√≥n

| ‚¨ÜÔ∏è Padre             | [[Proyecto OnlyCarNLD/Datos/1.3.3 chat_operador_cliente]]       |
| -------------------- | ------------------------------------- |
| ‚¨ÖÔ∏è Hermano anterior  | [[Proyecto OnlyCarNLD/Datos/1.3.3.2 documentacion_fotografica]] |

---
