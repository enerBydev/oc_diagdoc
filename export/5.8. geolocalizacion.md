---
id: 5.8
title: GeolocalizaciÃ³n y UbicaciÃ³n en Tiempo Real
parent: '5.0'
breadcrumb: 0 â†’ 5.0 â†’ 5.8
type: modulo_padre
children_count: 12
descendants_count: 54
actors:
- operador
- cliente
- admin
domain:
- gps
- mapas
- tracking
- ubicacion
status: activo
last_updated: 2026-01-29 15:31
file_create: 2025-12-31 02:28
summary: 'Sistema integral de tracking GPS para servicios mÃ³viles. Capacitor GPS,

  Supabase Realtime, Leaflet + OpenStreetMap. Costo: $0/mes.'
content_hash: 5eb29304ab8aa7a9
---

# 5.8 GeolocalizaciÃ³n y UbicaciÃ³n en Tiempo Real

> Sistema integral de tracking GPS para servicios mÃ³viles.

---

## Arquitectura HÃ­brida (Costo: $0/mes)

```mermaid
flowchart TD
    subgraph DISPOSITIVO["ðŸ“± Dispositivo Operador"]
        A[Capacitor Geolocation]
        B[watchPosition]
    end
    
    subgraph BACKEND["â˜ï¸ Supabase"]
        C[Realtime Channels]
        C[Realtime Channels]
        D[Broadcast]
        W[Watchtower Logic]
    end
    
    subgraph CLIENTE["ðŸ“± Dispositivo Cliente"]
        E[Subscribe Channel]
        F[Leaflet Map]
        G[OpenStreetMap Tiles]
    end
    
    A --> B
    B --> C
    C --> D
    C --> W
    W -->|Alert| D
    D --> E
    E --> F
    F --> G
    
    B --> H{Distancia < 100m?}
    H -->|SÃ­| I[Auto-confirma llegada]
    H -->|No| B
```

---

## Stack TecnolÃ³gico

| Componente  | TecnologÃ­a                   | Costo    |
| ----------- | ---------------------------- | -------- |
| GPS nativo  | `@capacitor/geolocation`     | Gratis   |
| Realtime    | Supabase Realtime (Channels) | Incluido |
| Mapas       | Leaflet.js + OpenStreetMap   | Gratis   |
| NavegaciÃ³n  | Links Waze/GMaps             | Gratis   |
| **Total**   | â€”                            | **$0/mes** |

---

## Principios

> [!IMPORTANT]
> - GPS **solo activo durante estado `en_camino`** (ahorro de baterÃ­a)
> - Broadcast configurable desde panel admin (default: 5s, **recomendado: 10s** â­)
> - ConfirmaciÃ³n de llegada **automÃ¡tica** pero con **fallback manual**
> - **Sin geocoding** (cliente ingresa ubicaciÃ³n o usa GPS propio)

---

## Flujo Principal

```mermaid
graph LR
    A[Servicio en camino] --> B[Operador activa tracking]
    B --> C[GPS envia coordenadas]
    C --> D[Cliente ve mapa]
    D --> E{Distancia menor a 100m?}
    E -->|Si| F[Auto llegado]
    E -->|No| C
    F --> G[Tracking se detiene]
```


```
1. Servicio pasa a estado "en_camino"
   â†’ Operador activa tracking
   â†’ Cliente recibe CARD de ubicaciÃ³n

2. Durante tracking:
   â†’ GPS cada Xs (configurable) â†’ Broadcast Supabase â†’ Cliente actualiza mapa
   â†’ Sistema calcula distancia a destino

3. Llegada detectada (< 100m):
   â†’ Auto-cambio a estado "llegado"
   â†’ Tracking se detiene
   â†’ NotificaciÃ³n a cliente

4. Fallback manual:
   â†’ Operador puede confirmar llegada manualmente
   â†’ BotÃ³n "Ya lleguÃ©" siempre disponible
```


---

## IntegraciÃ³n con Flujo de Servicio

| Estado Servicio       | Tracking   | Mapa Cliente |
| --------------------- | ---------- | ------------ |
| `cita_confirmada`     | âŒ          | âŒ            |
| `operador_asignado`   | âŒ          | âŒ            |
| **`en_camino`**       | âœ… Activo   | âœ… Visible    |
| **`llegado`**         | âŒ Se detiene | âŒ Se oculta  |
| `en_servicio`         | âŒ          | âŒ            |
| `completado`          | âŒ          | âŒ            |

---

## Estructura de Hijos

| ID                                     | Nombre                | DescripciÃ³n            | Nietos | Estado |
| -------------------------------------- | --------------------- | ---------------------- | ------ | ------ |
| [[Proyecto OnlyCarNLD/Datos/5.8.1 capacitor_geolocation\|5.8.1]] | Capacitor Geolocation | Plugin GPS nativo      | 0 | âœ…      |
| [[Proyecto OnlyCarNLD/Datos/5.8.2 realtime_broadcast\|5.8.2]]    | Realtime Broadcast    | Supabase channels      | 0 | âœ…      |
| [[Proyecto OnlyCarNLD/Datos/5.8.3 mapas_visualizacion\|5.8.3]]   | Mapas VisualizaciÃ³n   | Leaflet + OSM          | 0 | âœ…      |
| [[Proyecto OnlyCarNLD/Datos/5.8.4 navegacion_externa\|5.8.4]]    | NavegaciÃ³n Externa    | Links Waze/GMaps       | 0      | âœ…      |
| [[Proyecto OnlyCarNLD/Datos/5.8.5 deteccion_llegada\|5.8.5]]     | DetecciÃ³n Llegada     | Auto-confirmar llegada | 0 | âœ…      |
| [[Proyecto OnlyCarNLD/Datos/5.8.6 backend_ubicaciones\|5.8.6]]   | Backend Ubicaciones   | API + historial        | 0 | âœ…      |
| [[Proyecto OnlyCarNLD/Datos/5.8.7 edge_cases\|5.8.7]]            | Edge Cases            | Errores y fallbacks    | 0 | âœ…      |
| [[Proyecto OnlyCarNLD/Datos/5.8.8 testing\|5.8.8]]               | Testing               | Pruebas de ubicaciÃ³n   | 0 | âœ…      |
| [[Proyecto OnlyCarNLD/Datos/5.8.9 configuracion_remota\|5.8.9]]  | Config Remota         | Panel de configuraciÃ³n | 0      | âœ…      |
| [[Proyecto OnlyCarNLD/Datos/5.8.10 watchtower_algorithm\|5.8.10]] | Watchtower Algorithm  | Seguridad y AnomalÃ­as  | 0      | âœ…      |
| [[Proyecto OnlyCarNLD/Datos/5.8.11 client_timeline_ui\|5.8.11]]  | Client Timeline UI    | UX Mapa + Timeline     | 0      | âœ…      |
| [[Proyecto OnlyCarNLD/Datos/5.8.12 admin_god_view\|5.8.12]]      | Admin God View        | Dashboard SupervisiÃ³n  | 0      | âœ…      |

---

## Variables de ConfiguraciÃ³n

```typescript
export const GEO_CONFIG = {
  // Tracking (valores default, sobrescritos por config remota)
  WATCH_INTERVAL_MS: 5000,          // Default: 5s, Recomendado: 10s â­
  HIGH_ACCURACY: true,               // GPS de alta precisiÃ³n
  TIMEOUT_MS: 10000,                 // Timeout por lectura
  MAXIMUM_AGE_MS: 0,                 // No usar cache
  
  // Llegada
  ARRIVAL_THRESHOLD_METERS: 100,     // Distancia para auto-confirmar
  ARRIVAL_CONFIRM_COUNT: 2,          // Lecturas consecutivas
  
  // Supabase Channel
  CHANNEL_PREFIX: 'servicio:',       // Prefijo de canales
  
  // Mapa
  DEFAULT_ZOOM: 15,                  // Zoom inicial
  TILE_URL: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
  
  // Battery saving
  BACKGROUND_UPDATES: false,         // No tracking en background
  PAUSE_ON_MINIMIZE: true            // Pausar si app minimizada
};
```

---

## NavegaciÃ³n

| â¬†ï¸ Padre             | [[Proyecto OnlyCarNLD/Datos/5.0. integraciones]]           |
| -------------------- | -------------------------------- |
| â¬…ï¸ Hermano anterior  | [[Proyecto OnlyCarNLD/Datos/5.7. pdfme_generacion]]        |
| âž¡ï¸ Hermano siguiente | [[Proyecto OnlyCarNLD/Datos/5.9 soporte_externo]]          |
| ðŸ”— Ver tambiÃ©n       | [[Proyecto OnlyCarNLD/Datos/1.3.3.3 flujo_servicio_chat]]  |

---

**Fecha:** Diciembre 2025  
**VersiÃ³n:** 1.0
