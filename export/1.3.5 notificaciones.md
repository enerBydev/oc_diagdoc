---
id: 1.3.5
title: Sistema de Notificaciones
parent: '1.3'
breadcrumb: 0 â†’ 1.0 â†’ 1.3 â†’ 1.3.5
type: hoja
status: activo
domain: comunicacion
summary: Notificaciones multicanal (push, email, in-app) con configuraciÃ³n de preferencias
  por usuario, horarios silenciosos y templates.
version: 1.0
last_updated: 2026-01-29 15:31
file_create: 2025-12-23 10:59
actors:
- sistema
- cliente
- operador
dependencies:
- web_push_api
- firebase
affects:
- 1.3.X chat
content_hash: 1b1154fbb9c3321b
---

# 1.3.5 Sistema de Notificaciones

Notificaciones multicanal para el sistema de comunicaciÃ³n.

---

## Canales de NotificaciÃ³n

| Canal | TecnologÃ­a | Uso Principal |
|-------|------------|---------------|
| **Push** | Web Push API | Mensajes nuevos, alertas urgentes |
| **Email** | Transaccional | Contratos, resÃºmenes, confirmaciones |
| **In-App** | Badge + Toast | Contadores, alertas en UI |
| **SMS** | (Futuro) | Alertas crÃ­ticas, verificaciÃ³n |

> [!NOTE]
> **Recordatorios Amistosos:** Los canales Push y Email tambiÃ©n se utilizan para el sistema de
> recordatorios de re-engagement de clientes inactivos. Ver [[Proyecto OnlyCarNLD/Datos/1.3.13 recordatorios_amistosos]].

---

## Eventos y Sus Canales

### Chat Operador-Cliente

| Evento | Push | Email | In-App |
|--------|------|-------|--------|
| Mensaje nuevo | âœ… | âŒ | âœ… |
| Operador en camino | âœ… | âŒ | âœ… |
| Operador llegÃ³ | âœ… | âŒ | âœ… |
| Servicio completado | âœ… | âœ… | âœ… |
| Fotos disponibles | âœ… | âŒ | âœ… |
| Link de pago | âœ… | âœ… | âœ… |
| Pago recibido | âœ… | âœ… | âœ… |

### Chat Admin-Cliente

| Evento | Push | Email | In-App |
|--------|------|-------|--------|
| Mensaje nuevo | âœ… | âŒ | âœ… |
| Propuesta enviada | âŒ | âœ… | âœ… |
| Contrato enviado | âœ… | âœ… | âœ… |
| Contrato firmado | âœ… | âœ… | âœ… |
| Alerta de vencimiento | âœ… | âœ… | âœ… |

---

## ConfiguraciÃ³n de Usuario

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âš™ï¸ CONFIGURACIÃ“N DE NOTIFICACIONES                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  MENSAJES                                                       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                          â”‚
â”‚  Mensajes nuevos          [Push âœ“] [Email âœ—]                    â”‚
â”‚  Fotos del servicio       [Push âœ“] [Email âœ—]                    â”‚
â”‚                                                                 â”‚
â”‚  SERVICIOS                                                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                          â”‚
â”‚  ConfirmaciÃ³n de cita     [Push âœ“] [Email âœ“]                    â”‚
â”‚  Operador en camino       [Push âœ“] [Email âœ—]                    â”‚
â”‚  Servicio completado      [Push âœ“] [Email âœ“]                    â”‚
â”‚                                                                 â”‚
â”‚  PAGOS                                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                          â”‚
â”‚  Link de pago             [Push âœ“] [Email âœ“]                    â”‚
â”‚  ConfirmaciÃ³n de pago     [Push âœ“] [Email âœ“]                    â”‚
â”‚  Factura disponible       [Push âœ—] [Email âœ“]                    â”‚
â”‚                                                                 â”‚
â”‚  CONTRATOS (B2B)                                                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                          â”‚
â”‚  Contrato pendiente       [Push âœ“] [Email âœ“]                    â”‚
â”‚  Alerta de vencimiento    [Push âœ“] [Email âœ“]                    â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Push Notifications

### ImplementaciÃ³n Web Push

```typescript
// composables/usePushNotifications.ts
export const usePushNotifications = () => {
  const isSupported = 'PushManager' in window;
  const permission = ref<NotificationPermission>('default');
  
  const requestPermission = async () => {
    if (!isSupported) return false;
    
    const result = await Notification.requestPermission();
    permission.value = result;
    
    if (result === 'granted') {
      await subscribeToServer();
    }
    
    return result === 'granted';
  };
  
  const subscribeToServer = async () => {
    const registration = await navigator.serviceWorker.ready;
    const subscription = await registration.pushManager.subscribe({
      userVisibleOnly: true,
      applicationServerKey: useRuntimeConfig().public.vapidPublicKey
    });
    
    // Enviar subscription al servidor
    await $fetch('/api/notifications/subscribe', {
      method: 'POST',
      body: { subscription }
    });
  };
  
  return {
    isSupported,
    permission,
    requestPermission
  };
};
```

### Plantillas de Push

| Tipo | TÃ­tulo | Cuerpo |
|------|--------|--------|
| Mensaje nuevo | "Nuevo mensaje" | "[Nombre]: [preview mensaje]" |
| Operador en camino | "ğŸš— Tu operador viene" | "[Nombre] llegarÃ¡ en ~[X] min" |
| Servicio completado | "âœ… Servicio listo" | "Tu vehÃ­culo estÃ¡ listo" |
| Link de pago | "ğŸ’³ Pago pendiente" | "Tap para completar pago de $[X]" |
| Contrato | "ğŸ“ Contrato pendiente" | "Tienes un contrato por firmar" |

---

## In-App Notifications

### Badge Counter

```vue
<!-- ChatIcon.vue -->
<template>
  <div class="chat-icon">
    <Icon name="chat" />
    <span v-if="unreadCount > 0" class="badge">
      {{ unreadCount > 99 ? '99+' : unreadCount }}
    </span>
  </div>
</template>
```

### Toast Notifications

```vue
<!-- Cuando llega mensaje -->
<Toast>
  <template #icon>
    <Avatar :src="sender.avatar" />
  </template>
  <template #title>{{ sender.name }}</template>
  <template #message>{{ messagePreview }}</template>
  <template #action>
    <Button @click="openChat">Ver</Button>
  </template>
</Toast>
```

---

## Email Templates

### Servicio Completado

```html
<!-- emails/service-completed.html -->
Asunto: âœ… Tu servicio de limpieza estÃ¡ listo

Hola [NOMBRE],

Tu servicio de [PAQUETE] ha sido completado.

ğŸ“ UbicaciÃ³n: [DIRECCIÃ“N]
ğŸ• DuraciÃ³n: [X] minutos
ğŸ‘¨ğŸ”§ Operador: [NOMBRE_OPERADOR]

[Ver fotos del servicio]

[Pagar ahora - $XXX MXN]

Â¿Necesitas factura? [Autofacturar]

Gracias por preferirnos,
OnlyCar
```

### Contrato Pendiente

```html
<!-- emails/contract-pending.html -->
Asunto: ğŸ“ Contrato listo para firma - OnlyCar

Hola [NOMBRE],

El contrato con OnlyCar estÃ¡ listo para su firma.

ğŸ“„ Contrato: [NÃšMERO]
ğŸ“¦ Paquete: [PAQUETE]
ğŸ’° Valor mensual: $[X,XXX] MXN

[Revisar y firmar contrato]

Este enlace expira en 7 dÃ­as.

Saludos,
RenÃ© Mendoza
OnlyCar
```

---

## Reglas de NotificaciÃ³n

| Regla | DescripciÃ³n |
|-------|-------------|
| **NOT-001** | No enviar push entre 22:00 y 08:00 |
| **NOT-002** | MÃ¡ximo 3 push por hora por usuario |
| **NOT-003** | Email solo para eventos importantes |
| **NOT-004** | Respetar preferencias del usuario |
| **NOT-005** | Agrupar notificaciones similares |
| **NOT-006** | In-app siempre activo (no desactivable) |

---

## Modelo de Datos

```sql
CREATE TABLE notification_preferences (
  user_id UUID REFERENCES users(id) PRIMARY KEY,
  
  -- Push
  push_messages BOOLEAN DEFAULT true,
  push_services BOOLEAN DEFAULT true,
  push_payments BOOLEAN DEFAULT true,
  push_contracts BOOLEAN DEFAULT true,
  
  -- Email
  email_service_completed BOOLEAN DEFAULT true,
  email_payment_received BOOLEAN DEFAULT true,
  email_contract_pending BOOLEAN DEFAULT true,
  email_contract_expiring BOOLEAN DEFAULT true,
  
  -- Horario
  quiet_hours_start TIME DEFAULT '22:00',
  quiet_hours_end TIME DEFAULT '08:00',
  
  updated_at TIMESTAMPTZ DEFAULT now()
);
```

---

## NavegaciÃ³n

| â¬†ï¸ Padre             | [[Proyecto OnlyCarNLD/Datos/1.3. comunicacion]]            |
| -------------------- | -------------------------------- |
| â¬…ï¸ Hermano anterior  | [[Proyecto OnlyCarNLD/Datos/1.3.4 tipos_mensajes]]         |
| â¡ï¸ Hermano siguiente | [[Proyecto OnlyCarNLD/Datos/1.3.6 chat_admin_operador]]    |

---
