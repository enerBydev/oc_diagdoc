---
id: 3.1.4.10
title: Tablas Disputas e Incidencias
parent: 3.1.4
breadcrumb: 0 → 3.0 → 3.1 → 3.1.4 → 3.1.4.10
type: hoja
status: activo
domain:
- sql
- disputas
- incidencias
- soporte
actors:
- sistema
- admin
summary: Esquema SQL para persistir el ciclo de vida de disputas e incidencias. Implementa
  los estados definidos en [[1.6.3.2 flujos_resolucion_disputas]].
file_create: 2026-01-16 11:10
last_updated: 2026-01-29 15:32
content_hash: d1b9d47b82b7e14b
---

# 3.1.4.10 Tablas Disputas e Incidencias

> Implementación de la persistencia para el sistema de resolución de conflictos documentado en [[Proyecto OnlyCarNLD/Datos/1.6.3 gestion_incidencias]].

---

## 1. Tabla Principal: `disputas`

Registra cada incidencia reportada en el sistema, desde su apertura hasta su cierre.

```sql
CREATE TABLE IF NOT EXISTS disputas (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  cita_id UUID NOT NULL REFERENCES citas(id),
  
  -- Clasificación (Ver tipificación en [[1.6.3.1 matriz_tipificacion_incidencias]])
  tipo VARCHAR(30) NOT NULL, -- 'OP_NO_SHOW', 'CL_INSATISFACCION', 'DANIO_MENOR', etc.
  severidad INTEGER NOT NULL DEFAULT 2 CHECK (severidad BETWEEN 1 AND 5),
  
  -- Estado (Flujo definido en [[1.6.3.2 flujos_resolucion_disputas]])
  estado VARCHAR(20) DEFAULT 'ABIERTO' CHECK (estado IN (
    'ABIERTO',          -- Recién creada
    'AUTO_RESOLUCION',  -- Algoritmo procesando (GPS, reglas automáticas)
    'INVESTIGACION',    -- Requiere revisión humana
    'EVIDENCIA_REQ',    -- Esperando fotos/chat adicionales
    'DICTAMEN',         -- Admin dictando resolución
    'EJECUCION_PAGO',   -- Procesando reembolso/cobro
    'CERRADO',          -- Finalizada
    'APELACION'         -- Usuario reclama decisión (1 vez permitida)
  )),
  
  -- Actores involucrados
  reportado_por UUID REFERENCES auth.users(id),      -- Quién abrió la disputa
  operador_id UUID REFERENCES operadores(id),        -- Operador involucrado
  asignado_a UUID REFERENCES auth.users(id),         -- Admin investigador (NULL si auto)
  
  -- Evidencia y notas
  evidencia JSONB DEFAULT '[]'::jsonb,              -- Array de URLs de fotos/archivos
  notas_internas TEXT,                              -- Solo visible para Admin
  
  -- Resolución (Ver políticas en [[1.6.3.3 politicas_compensacion]])
  resolucion JSONB,
  -- Ejemplo: {"tipo": "REEMBOLSO", "monto": 250, "cupon": "SORRY-XXX-50"}
  
  compensacion_aplicada BOOLEAN DEFAULT FALSE,
  
  -- Timestamps
  created_at TIMESTAMPTZ DEFAULT NOW(),
  resolved_at TIMESTAMPTZ,
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Índices para consultas frecuentes
CREATE INDEX idx_disputas_cita ON disputas(cita_id);
CREATE INDEX idx_disputas_estado ON disputas(estado);
CREATE INDEX idx_disputas_tipo ON disputas(tipo);
CREATE INDEX idx_disputas_operador ON disputas(operador_id);
```

---

## 2. Tabla de Comunicación: `disputa_mensajes`

Historial de la investigación humana. Cada mensaje es parte del expediente.

```sql
CREATE TABLE IF NOT EXISTS disputa_mensajes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  disputa_id UUID NOT NULL REFERENCES disputas(id) ON DELETE CASCADE,
  
  autor_id UUID REFERENCES auth.users(id),
  rol_autor VARCHAR(20), -- 'cliente', 'operador', 'admin', 'sistema'
  
  mensaje TEXT NOT NULL,
  adjuntos JSONB DEFAULT '[]'::jsonb, -- URLs de archivos adicionales
  
  es_interno BOOLEAN DEFAULT FALSE, -- TRUE = solo visible para Admins
  
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_disputa_mensajes_disputa ON disputa_mensajes(disputa_id);
```

---

## 3. RLS Policies

```sql
ALTER TABLE disputas ENABLE ROW LEVEL SECURITY;
ALTER TABLE disputa_mensajes ENABLE ROW LEVEL SECURITY;

-- Admins: Full access
CREATE POLICY "Admin full access disputes"
ON disputas FOR ALL
USING (auth.jwt() ->> 'role' = 'super_admin');

-- Clientes: Solo ver sus propias disputas
CREATE POLICY "Clientes ver sus disputas"
ON disputas FOR SELECT
USING (reportado_por = auth.uid());

-- Operadores: Ver disputas donde están involucrados
CREATE POLICY "Operadores ver sus disputas"
ON disputas FOR SELECT
USING (operador_id IN (
  SELECT id FROM operadores WHERE user_id = auth.uid()
));

-- Mensajes: Similar lógica
CREATE POLICY "Admin full access messages"
ON disputa_mensajes FOR ALL
USING (auth.jwt() ->> 'role' = 'super_admin');

CREATE POLICY "Participantes ver mensajes no internos"
ON disputa_mensajes FOR SELECT
USING (
  es_interno = FALSE AND
  disputa_id IN (
    SELECT id FROM disputas 
    WHERE reportado_por = auth.uid() 
       OR operador_id IN (SELECT id FROM operadores WHERE user_id = auth.uid())
  )
);
```

---

## 4. Trigger de Auditoría

Cada cambio de estado se registra en `decision_logs` ([[Proyecto OnlyCarNLD/Datos/3.1.4.8 Tablas_Quantum]]).

```sql
CREATE OR REPLACE FUNCTION log_disputa_cambio_estado()
RETURNS TRIGGER AS $$
BEGIN
  IF OLD.estado IS DISTINCT FROM NEW.estado THEN
    INSERT INTO decision_logs (event_id, actor, action, context, decision, signature)
    VALUES (
      NEW.id,
      COALESCE(NEW.asignado_a::TEXT, 'system:auto_resolution'),
      'DISPUTA_ESTADO_CAMBIO',
      jsonb_build_object('old_estado', OLD.estado, 'cita_id', NEW.cita_id),
      jsonb_build_object('new_estado', NEW.estado),
      encode(sha256((NEW.id || NEW.estado || NOW()::TEXT)::BYTEA), 'hex')
    );
  END IF;
  
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_disputa_estado
BEFORE UPDATE ON disputas
FOR EACH ROW EXECUTE FUNCTION log_disputa_cambio_estado();
```

---

## Navegación

| ⬆️ Padre | [[Proyecto OnlyCarNLD/Datos/3.1.4 esquema_sql_logica_negocio]] |
|----------|--------------------------------------|
| ⬅️ Hermano anterior | [[Proyecto OnlyCarNLD/Datos/3.1.4.9 Tablas_Marketplace]] |

---
