---
id: 1.3.6.1.14.2
title: Lista de Espera
parent: 1.3.6.1.14
breadcrumb: 0 ‚Üí 1.0 ‚Üí 1.3 ‚Üí 1.3.6 ‚Üí 1.3.6.1 ‚Üí 1.3.6.1.14 ‚Üí 1.3.6.1.14.2
type: hoja
status: activo
domain: comunicacion
summary: Sistema de cola para clientes cuando no hay disponibilidad con monitoreo
  cada 5 min, flexibilidad configurable y notificaci√≥n al encontrar match.
version: 1.0
last_updated: 2026-01-29 15:32
file_create: 2025-12-26 17:52
actors:
- cliente
- operador
- sistema
dependencies:
- supabase
- firebase_messaging
affects:
- 1.3.6.1.14 matching_alternativo
content_hash: 98e14397355a73b5
---

# 1.3.6.1.14.2 Lista de Espera

Sistema de cola para clientes sin disponibilidad.

---

## Concepto

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  LISTA DE ESPERA                                                ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                 ‚îÇ
‚îÇ  1. Cliente solicita servicio                                   ‚îÇ
‚îÇ  2. No hay operadores disponibles                               ‚îÇ
‚îÇ  3. Cliente entra en lista de espera (max 24h default)          ‚îÇ
‚îÇ  4. Sistema monitorea disponibilidad                            ‚îÇ
‚îÇ  5. Cuando hay match ‚Üí NOTIFICAR CLIENTE                        ‚îÇ
‚îÇ  6. Cliente tiene 15 min para confirmar                         ‚îÇ
‚îÇ  7. Si no confirma ‚Üí siguiente en cola o expirar                ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## Modelo de Datos

```sql
CREATE TABLE lista_espera (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  solicitud_id UUID NOT NULL REFERENCES solicitudes(id),
  cliente_id UUID NOT NULL REFERENCES clientes(id),
  
  -- Par√°metros de b√∫squeda
  ciudad_id UUID NOT NULL REFERENCES ciudades(id),
  servicio_id UUID REFERENCES servicios(id),
  paquete_id UUID REFERENCES paquetes(id),
  fecha_deseada DATE NOT NULL,
  hora_deseada TIME NOT NULL,
  flexibilidad_horas INT DEFAULT 2,  -- ¬±2 horas aceptables
  flexibilidad_dias INT DEFAULT 1,   -- +1 d√≠a aceptable
  
  -- Estado
  estado VARCHAR(20) DEFAULT 'esperando',  -- esperando, match_encontrado, confirmado, expirado
  
  -- Configuraci√≥n
  tiempo_espera_horas INT DEFAULT 24,  -- Configurable
  
  -- Match encontrado
  operador_encontrado_id UUID REFERENCES operadores(id),
  hora_match TIME,
  fecha_match DATE,
  notificado_at TIMESTAMPTZ,
  
  -- Timestamps
  created_at TIMESTAMPTZ DEFAULT now(),
  expires_at TIMESTAMPTZ,
  updated_at TIMESTAMPTZ DEFAULT now()
);

-- √çndices
CREATE INDEX idx_lista_espera_estado ON lista_espera(estado) WHERE estado = 'esperando';
CREATE INDEX idx_lista_espera_ciudad ON lista_espera(ciudad_id);
CREATE INDEX idx_lista_espera_expira ON lista_espera(expires_at);

-- Trigger para auto-calcular expires_at
CREATE OR REPLACE FUNCTION set_lista_espera_expira()
RETURNS TRIGGER AS $$
BEGIN
  NEW.expires_at := NEW.created_at + (NEW.tiempo_espera_horas || ' hours')::INTERVAL;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_lista_espera_expira
BEFORE INSERT ON lista_espera
FOR EACH ROW EXECUTE FUNCTION set_lista_espera_expira();
```

---

## Verificaci√≥n Peri√≥dica (Cron)

```typescript
// server/cron/verificar-lista-espera.ts
// Ejecutar cada 5 minutos
export default defineScheduledHandler(async () => {
  const supabase = createServerSupabaseClient();
  
  // 1. Expirar entradas vencidas
  await supabase
    .from('lista_espera')
    .update({ estado: 'expirado', updated_at: new Date() })
    .eq('estado', 'esperando')
    .lt('expires_at', new Date().toISOString());
  
  // 2. Buscar matches para entradas activas
  const { data: enEspera } = await supabase
    .from('lista_espera')
    .select('*')
    .eq('estado', 'esperando')
    .gte('expires_at', new Date().toISOString());
  
  for (const entrada of enEspera || []) {
    // Buscar operadores considerando flexibilidad
    const { data: operadores } = await supabase.rpc('buscar_operadores_flexible', {
      p_ciudad_id: entrada.ciudad_id,
      p_servicio_id: entrada.servicio_id,
      p_paquete_id: entrada.paquete_id,
      p_fecha: entrada.fecha_deseada,
      p_hora: entrada.hora_deseada,
      p_flex_horas: entrada.flexibilidad_horas,
      p_flex_dias: entrada.flexibilidad_dias
    });
    
    if (operadores?.length > 0) {
      const match = operadores[0];
      
      // Actualizar entrada
      await supabase
        .from('lista_espera')
        .update({
          estado: 'match_encontrado',
          operador_encontrado_id: match.operador_id,
          hora_match: match.hora,
          fecha_match: match.fecha,
          notificado_at: new Date()
        })
        .eq('id', entrada.id);
      
      // Notificar al cliente
      await notifyClient(entrada.cliente_id, {
        type: 'DISPONIBILIDAD_ENCONTRADA',
        title: 'üéâ ¬°Encontramos disponibilidad!',
        body: `${match.operador_nombre} est√° disponible para tu servicio.`,
        data: {
          lista_espera_id: entrada.id,
          operador: match.operador_nombre,
          fecha: match.fecha,
          hora: match.hora
        }
      });
    }
  }
});
```

---

## UI: Entrar en Lista

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  üìã ENTRAR EN LISTA DE ESPERA                                   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                 ‚îÇ
‚îÇ  Tu solicitud: Lavado Express                                   ‚îÇ
‚îÇ  Fecha deseada: Ma√±ana 10:00 AM                                 ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  FLEXIBILIDAD (opcional):                                       ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  Acepto ¬±[ 2 ‚ñº ] horas del horario solicitado                   ‚îÇ
‚îÇ  Acepto hasta [ 1 ‚ñº ] d√≠a(s) despu√©s                            ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  TIEMPO DE ESPERA:                                              ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  M√°ximo esperar: [ 24 horas ‚ñº ]                                 ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  ‚ÑπÔ∏è Te notificaremos inmediatamente cuando haya                 ‚îÇ
‚îÇ     disponibilidad. Tendr√°s 15 minutos para confirmar.          ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  [ Cancelar ]                  [ Entrar en lista de espera ]    ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## UI: Notificaci√≥n de Match (Cliente)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  üéâ ¬°ENCONTRAMOS DISPONIBILIDAD!                                ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                 ‚îÇ
‚îÇ  Buenas noticias, Juan!                                         ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  Carlos M. est√° disponible para tu servicio:                    ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  üìÖ Ma√±ana 11:30 AM                                             ‚îÇ
‚îÇ  üöó Lavado Express - $290                                       ‚îÇ
‚îÇ  üë∑ Carlos M. ‚≠ê 4.8                                            ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  ‚è±Ô∏è Confirma en los pr√≥ximos 15 minutos                         ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  [ Cancelar ]                         [ ‚úÖ CONFIRMAR CITA ]     ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## Flujo del Operador en Lista de Espera

> [!IMPORTANT]
> **El operador NO sabe que hay clientes esperando.**
> 
> El sistema detecta autom√°ticamente cuando un operador queda libre
> y lo "matchea" con un cliente en espera. El operador recibe una
> solicitud como cualquier otra, pero marcada como "LISTA DE ESPERA".

```mermaid
sequenceDiagram
    participant C as üë§ Cliente
    participant S as üóÑÔ∏è Sistema
    participant O as üë∑ Operador
    
    C->>S: Entra en lista de espera
    Note over S: Monitoreo cada 5 min
    
    O->>S: Termina un servicio
    S->>S: Detecta disponibilidad
    S->>S: Busca clientes en espera
    S->>O: üì≤ NUEVA SOLICITUD (Lista Espera)
    
    alt Operador acepta
        O->>S: Acepta
        S->>C: Match confirmado
        Note over O,C: Cita creada
    else Operador rechaza
        O->>S: Pasa/Rechaza
        S->>S: Buscar otro operador
    end
```

---

## UI: Notificaci√≥n al Operador (Push)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  PUSH NOTIFICATION                                              ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                 ‚îÇ
‚îÇ  üéØ CLIENTE EN ESPERA                                           ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  Un cliente ha estado esperando por este servicio.              ‚îÇ
‚îÇ  Lavado Express ‚Ä¢ $290 ‚Üí Tu comisi√≥n: $168                      ‚îÇ
‚îÇ  Ma√±ana 11:30 AM                                                ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  [ VER DETALLES ]                                               ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## UI: Pantalla Completa Operador (Lista de Espera)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                                                                 ‚îÇ
‚îÇ                    [FONDO DEGRADADO NARANJA]                    ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ                         üéØ                                      ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ                  CLIENTE EN ESPERA                              ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ  ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ              ‚è≥ Ha esperado 4 horas por este servicio           ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ              LAVADO EXPRESS                                     ‚îÇ
‚îÇ              $290 ‚Üí Tu comisi√≥n: $168                           ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ              üìÖ Ma√±ana 11:30 AM                                 ‚îÇ
‚îÇ              üìç Col. Centro ‚Ä¢ 2.1 km                            ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ              üë§ Juan Garc√≠a                                     ‚îÇ
‚îÇ              ‚≠ê 4.9 (Cliente frecuente)                         ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ  ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ              ‚è±Ô∏è Responde en 4:32                                ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ   ‚îÇ                                                         ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê           ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îÇ                 ‚îÇ     ‚îÇ                 ‚îÇ           ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îÇ   ‚úÖ ACEPTAR    ‚îÇ     ‚îÇ   ‚è≠Ô∏è PASAR      ‚îÇ           ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îÇ                 ‚îÇ     ‚îÇ                 ‚îÇ           ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò           ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ                                                         ‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## Diferencias: Solicitud Normal vs Lista de Espera

| Aspecto | Solicitud Normal | Lista de Espera |
|---------|------------------|-----------------|
| Color UI | Amarillo | **Naranja** (m√°s urgente) |
| Mensaje | "Nueva Solicitud" | "Cliente en Espera" |
| Info extra | - | Tiempo esperando |
| Prioridad | Normal | **Alta** (cliente ya esper√≥) |
| Timeout | 5 min | **3 min** (m√°s r√°pido) |

---

## L√≥gica: Notificar Operador de Lista de Espera

```typescript
// server/services/waitlistOperatorNotification.ts
const notifyOperatorForWaitlist = async (
  operadorId: string,
  listaEsperaId: string
) => {
  const supabase = createServerSupabaseClient();
  
  // 1. Obtener datos de la lista de espera
  const { data: entrada } = await supabase
    .from('lista_espera')
    .select(`
      *,
      clientes (id, nombre, rating_promedio),
      servicios (nombre, precio),
      paquetes (nombre, precio)
    `)
    .eq('id', listaEsperaId)
    .single();
  
  // 2. Calcular tiempo esperando
  const horasEsperando = Math.floor(
    (Date.now() - new Date(entrada.created_at).getTime()) / (1000 * 60 * 60)
  );
  
  // 3. Obtener FCM token del operador
  const { data: operador } = await supabase
    .from('operadores')
    .select('fcm_token, nombre')
    .eq('id', operadorId)
    .single();
  
  // 4. Calcular comisi√≥n
  const servicio = entrada.servicios || entrada.paquetes;
  const precio = servicio?.precio || 0;
  const comision = await getComisionPorNivel(operadorId, precio);
  // Modelo h√≠brido: 43-76% seg√∫n nivel operador
  // Ver: 3.1.8 sistema_remuneracion
  
  // 5. Enviar push notification
  await sendPushNotification({
    token: operador.fcm_token,
    notification: {
      title: 'üéØ CLIENTE EN ESPERA',
      body: `Ha esperado ${horasEsperando}h por ${servicio.nombre}. $${comision} para ti.`
    },
    data: {
      type: 'WAITLIST_REQUEST',
      lista_espera_id: listaEsperaId,
      cliente_nombre: entrada.clientes.nombre,
      cliente_rating: entrada.clientes.rating_promedio,
      servicio_nombre: servicio.nombre,
      precio: precio.toString(),
      comision: comision.toString(),
      fecha: entrada.fecha_match,
      hora: entrada.hora_match,
      horas_esperando: horasEsperando.toString()
    },
    android: {
      priority: 'high',
      notification: {
        channelId: 'service_requests',
        color: '#FF6B00' // Naranja para diferenciar
      }
    }
  });
  
  // 6. Crear broadcast_operador para tracking
  await supabase.from('broadcast_operadores').insert({
    broadcast_id: listaEsperaId, // Usar ID de lista espera
    operador_id: operadorId,
    estado: 'enviado',
    tipo: 'lista_espera'
  });
};
```

---

## Composable Operador: useWaitlistRequest

```typescript
// composables/useWaitlistRequest.ts (Operador)
export const useWaitlistRequest = () => {
  const supabase = useSupabaseClient();
  const user = useSupabaseUser();
  
  const acceptWaitlistRequest = async (listaEsperaId: string) => {
    // 1. Verificar que sigue disponible
    const { data: entrada } = await supabase
      .from('lista_espera')
      .select('*')
      .eq('id', listaEsperaId)
      .eq('estado', 'match_encontrado')
      .single();
    
    if (!entrada) {
      toast.error('Este cliente ya fue atendido por otro operador');
      return false;
    }
    
    // 2. Actualizar estado
    const { error } = await supabase
      .from('lista_espera')
      .update({
        operador_encontrado_id: user.value?.id,
        estado: 'operador_aceptado'
      })
      .eq('id', listaEsperaId)
      .eq('estado', 'match_encontrado'); // Race condition check
    
    if (error) {
      toast.error('No se pudo aceptar. Intenta de nuevo.');
      return false;
    }
    
    // 3. Notificar al cliente que el operador acept√≥
    await notifyClientWaitlistAccepted(listaEsperaId);
    
    // 4. Actualizar broadcast
    await supabase
      .from('broadcast_operadores')
      .update({ estado: 'aceptado' })
      .eq('broadcast_id', listaEsperaId)
      .eq('operador_id', user.value?.id);
    
    toast.success('¬°Esperando confirmaci√≥n del cliente!');
    return true;
  };
  
  const skipWaitlistRequest = async (listaEsperaId: string, motivo?: string) => {
    // Marcar como pasado y buscar otro operador
    await supabase
      .from('broadcast_operadores')
      .update({ estado: 'pasado', motivo })
      .eq('broadcast_id', listaEsperaId)
      .eq('operador_id', user.value?.id);
    
    // Sistema buscar√° otro operador autom√°ticamente
    toast.info('Solicitud pasada');
  };
  
  return { acceptWaitlistRequest, skipWaitlistRequest };
};
```

---

## Flujo Completo: Match de Lista de Espera

```mermaid
sequenceDiagram
    participant S as üóÑÔ∏è Sistema (Cron)
    participant O as üë∑ Operador
    participant C as üë§ Cliente
    
    Note over S: Cada 5 minutos
    S->>S: Detectar clientes en espera
    S->>S: Buscar operadores disponibles
    
    alt Encuentra operador
        S->>O: üì≤ Push: "Cliente en espera"
        S->>O: üñ•Ô∏è Pantalla completa (naranja)
        
        alt Operador acepta (‚â§3 min)
            O->>S: "Acepto"
            S->>C: üì≤ Push: "Operador encontrado"
            S->>C: üñ•Ô∏è Pantalla confirmaci√≥n
            
            alt Cliente confirma (‚â§15 min)
                C->>S: "Confirmo"
                S->>O: üì≤ Push: "Cita confirmada"
                S->>S: Crear cita
            else Cliente no confirma
                S->>S: Expirar match
                S->>O: üì≤ Push: "Cliente no confirm√≥"
            end
            
        else Operador pasa
            O->>S: "Pasar"
            S->>S: Buscar otro operador
        end
        
    else No hay operadores
        Note over S: Reintentar en 5 min
    end
```

---

## Estados del Match (Vista Operador)

| Estado | Descripci√≥n | Acci√≥n Operador |
|--------|-------------|-----------------|
| `enviado` | Push enviado | Esperando respuesta |
| `aceptado` | Operador acept√≥ | Esperando cliente |
| `pasado` | Operador pas√≥ | Fin |
| `expirado` | No respondi√≥ en 3 min | Fin |
| `confirmado` | Cliente confirm√≥ | Cita creada ‚úÖ |
| `cliente_no_confirmo` | Cliente no confirm√≥ | Liberado |

---

## UI: Cita Confirmada (Operador)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ‚úÖ ¬°CITA CONFIRMADA!                                           ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                 ‚îÇ
‚îÇ  El cliente Juan ha confirmado la cita.                         ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  üìÖ Ma√±ana, 17 Ene ‚Ä¢ 11:30 AM                                   ‚îÇ
‚îÇ  üöó Lavado Express                                              ‚îÇ
‚îÇ  üí∞ Tu comisi√≥n: $168                                           ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  üìç Col. Centro, Calle Principal #123                           ‚îÇ
‚îÇ     [ üó∫Ô∏è Ver en mapa ]                                          ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  üë§ Juan Garc√≠a ‚Ä¢ ‚≠ê 4.9                                        ‚îÇ
‚îÇ     üì± +52 867 123 4567                                         ‚îÇ
‚îÇ     [ üí¨ Enviar mensaje ]                                       ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  ‚ÑπÔ∏è Este cliente esper√≥ 4 horas para encontrar disponibilidad.  ‚îÇ
‚îÇ     ¬°Brinda un excelente servicio!                              ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  [ Ver mi agenda ]                                              ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## Composable: useWaitlist (Cliente)

```typescript
// composables/useWaitlist.ts
export const useWaitlist = () => {
  const supabase = useSupabaseClient();
  const user = useSupabaseUser();
  
  const joinWaitlist = async (params: {
    solicitudId: string;
    ciudadId: string;
    servicioId?: string;
    paqueteId?: string;
    fecha: string;
    hora: string;
    flexHoras?: number;
    flexDias?: number;
    tiempoEspera?: number;
  }) => {
    const { data, error } = await supabase
      .from('lista_espera')
      .insert({
        solicitud_id: params.solicitudId,
        cliente_id: user.value?.id,
        ciudad_id: params.ciudadId,
        servicio_id: params.servicioId,
        paquete_id: params.paqueteId,
        fecha_deseada: params.fecha,
        hora_deseada: params.hora,
        flexibilidad_horas: params.flexHoras || 2,
        flexibilidad_dias: params.flexDias || 1,
        tiempo_espera_horas: params.tiempoEspera || 24
      })
      .select()
      .single();
    
    if (!error) {
      toast.success('Est√°s en la lista de espera. Te notificaremos pronto.');
    }
    
    return { data, error };
  };
  
  const confirmMatch = async (listaEsperaId: string) => {
    // Obtener info del match
    const { data: entrada } = await supabase
      .from('lista_espera')
      .select('*, solicitudes(*)')
      .eq('id', listaEsperaId)
      .single();
    
    if (entrada?.estado !== 'match_encontrado') {
      toast.error('Esta oferta ya no est√° disponible');
      return false;
    }
    
    // Crear cita con el operador encontrado
    await supabase.from('citas').insert({
      solicitud_id: entrada.solicitud_id,
      operador_id: entrada.operador_encontrado_id,
      cliente_id: entrada.cliente_id,
      fecha: entrada.fecha_match,
      hora_inicio: entrada.hora_match,
      estado: 'confirmada'
    });
    
    // Actualizar lista de espera
    await supabase
      .from('lista_espera')
      .update({ estado: 'confirmado' })
      .eq('id', listaEsperaId);
    
    toast.success('¬°Cita confirmada!');
    return true;
  };
  
  const cancelWaitlist = async (listaEsperaId: string) => {
    await supabase
      .from('lista_espera')
      .update({ estado: 'cancelado' })
      .eq('id', listaEsperaId);
  };
  
  return { joinWaitlist, confirmMatch, cancelWaitlist };
};
```

---

## Navegaci√≥n

| ‚¨ÜÔ∏è Padre             | [[Proyecto OnlyCarNLD/Datos/1.3.6.1.14 matching_alternativo]]     |
| -------------------- | --------------------------------------- |
| ‚¨ÖÔ∏è Hermano anterior  | [[Proyecto OnlyCarNLD/Datos/1.3.6.1.14.1 estrategias_busqueda]]   |
| ‚û°Ô∏è Hermano siguiente | [[Proyecto OnlyCarNLD/Datos/1.3.6.1.14.3 notificacion_cliente]]   |

---
