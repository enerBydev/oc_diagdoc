---
id: 1.3.13.5
title: Esquema de Datos
parent: 1.3.13
breadcrumb: 0 ‚Üí 1.0 ‚Üí 1.3 ‚Üí 1.3.13 ‚Üí 1.3.13.5
type: hoja
status: activo
last_updated: 2026-01-29 15:32
file_create: 2026-01-03 03:21
domain:
- sql
- supabase
- schema
actors:
- desarrollador
summary: 'Tablas SQL para recordatorios: reminder_preferences,

  reminder_history, reminder_templates.'
content_hash: ad2e913752dcaf9c
---

# 1.3.13.5 Esquema de Datos

> DDL completo para el sistema de recordatorios.

---

## Tabla: reminder_preferences

```sql
CREATE TABLE reminder_preferences (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  cliente_id UUID REFERENCES clientes(id) ON DELETE CASCADE UNIQUE,
  
  -- Configuraci√≥n
  activo BOOLEAN DEFAULT true,
  frecuencia_dias INTEGER DEFAULT 14,
  
  -- Canales
  push_enabled BOOLEAN DEFAULT true,
  email_enabled BOOLEAN DEFAULT true,
  whatsapp_enabled BOOLEAN DEFAULT false,
  
  -- Horarios
  hora_preferida TIME DEFAULT '10:00',
  dias_semana INTEGER[] DEFAULT '{1,2,3,4,5}',
  
  -- Tracking
  ultimo_recordatorio TIMESTAMPTZ,
  recordatorios_ignorados INTEGER DEFAULT 0,
  templates_usados TEXT[] DEFAULT '{}',
  
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_reminder_prefs_activo 
  ON reminder_preferences(activo) WHERE activo = true;
```

---

## Tabla: reminder_history

```sql
CREATE TABLE reminder_history (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  cliente_id UUID REFERENCES clientes(id) ON DELETE CASCADE,
  template_id VARCHAR(50) NOT NULL,
  canal VARCHAR(20) NOT NULL,
  enviado_at TIMESTAMPTZ DEFAULT NOW(),
  entregado BOOLEAN DEFAULT false,
  abierto BOOLEAN DEFAULT false,
  click_cta BOOLEAN DEFAULT false,
  convirtio BOOLEAN DEFAULT false,
  dias_desde_servicio INTEGER,
  contabilizado BOOLEAN DEFAULT false
);

CREATE INDEX idx_reminder_history_cliente 
  ON reminder_history(cliente_id);
```

---

## Tabla: reminder_templates

```sql
CREATE TABLE reminder_templates (
  id VARCHAR(50) PRIMARY KEY,
  canal VARCHAR(20) NOT NULL,
  titulo VARCHAR(100),
  asunto VARCHAR(150),
  cuerpo TEXT NOT NULL,
  activo BOOLEAN DEFAULT true
);

-- Seed
INSERT INTO reminder_templates VALUES
('push_01', 'push', '¬øTu auto te extra√±a? üöó', NULL, 
 'Hace {d√≠as} d√≠as que no brillamos juntos.'),
('push_02', 'push', '¬°Hola! Solo pasamos a saludar üëã', NULL,
 '¬øQuer√≠as darle amor a tu auto esta semana?');
```

---

## Vista: reminder_candidates

```sql
CREATE VIEW reminder_candidates AS
SELECT 
  c.id, c.nombre, c.email,
  EXTRACT(DAY FROM NOW() - c.ultimo_servicio)::INT AS dias_sin_servicio,
  rp.*,
  CASE 
    WHEN rp.activo = false THEN false
    WHEN rp.recordatorios_ignorados >= 2 THEN false
    ELSE true
  END AS debe_recordar
FROM clientes c
LEFT JOIN reminder_preferences rp ON rp.cliente_id = c.id;
```

---

## RLS Policies

```sql
ALTER TABLE reminder_preferences ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Cliente ve sus preferencias"
ON reminder_preferences FOR SELECT
USING (cliente_id = auth.uid());

CREATE POLICY "Cliente edita sus preferencias"
ON reminder_preferences FOR UPDATE
USING (cliente_id = auth.uid());
```

---

## Navegaci√≥n

| ‚¨ÜÔ∏è Padre             | [[Proyecto OnlyCarNLD/Datos/1.3.13 recordatorios_amistosos]]  |
| -------------------- | ----------------------------------- |
| ‚¨ÖÔ∏è Hermano anterior  | [[Proyecto OnlyCarNLD/Datos/1.3.13.4 logica_disparo]]         |
| ‚û°Ô∏è Hermano siguiente | [[Proyecto OnlyCarNLD/Datos/1.3.13.6 metricas_conversion]]    |

---
