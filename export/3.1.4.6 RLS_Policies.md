---
id: 3.1.4.6
title: RLS Policies
parent: 3.1.4
breadcrumb: 0 → 3.0 → 3.1 → 3.1.4 → 3.1.4.6
type: hoja
status: activo
last_updated: 2026-01-29 15:32
file_create: 2026-01-05 12:30
domain:
- sql
- rls
- seguridad
actors:
- admin
- desarrollador
summary: Políticas Row Level Security para todas las tablas de lógica de negocio.
content_hash: 5923b15b8f64ef50
---

# 3.1.4.6 RLS Policies

> Políticas de seguridad a nivel de fila para control de acceso.

---

## Habilitación Global

```sql
ALTER TABLE config_sistema ENABLE ROW LEVEL SECURITY;
ALTER TABLE servicios ENABLE ROW LEVEL SECURITY;
ALTER TABLE paquetes ENABLE ROW LEVEL SECURITY;
ALTER TABLE descuentos ENABLE ROW LEVEL SECURITY;
ALTER TABLE empresas ENABLE ROW LEVEL SECURITY;
```

---

## Helper Function

```sql
CREATE OR REPLACE FUNCTION auth.user_role()
RETURNS TEXT AS $$
  SELECT COALESCE(
    auth.jwt() -> 'user_metadata' ->> 'role',
    'anonymous'
  );
$$ LANGUAGE sql STABLE;
```

---

## Políticas de Lectura Pública

```sql
CREATE POLICY "Servicios: lectura pública"
  ON servicios FOR SELECT
  USING (activo = true);

CREATE POLICY "Paquetes: lectura pública"
  ON paquetes FOR SELECT
  USING (activo = true);
```

---

## Políticas Restringidas

```sql
CREATE POLICY "Descuentos B2C: lectura autenticada"
  ON descuentos FOR SELECT
  USING (segmento = 'b2c' AND activo = true AND auth.uid() IS NOT NULL);

CREATE POLICY "Empresas: solo admin y propia"
  ON empresas FOR SELECT
  USING (
    auth.user_role() = 'admin' OR 
    codigo = (auth.jwt() -> 'user_metadata' ->> 'empresa_codigo')
  );
```

---

## Políticas Admin

```sql
CREATE POLICY "Admin: gestión completa"
  ON servicios FOR ALL
  USING (auth.user_role() = 'admin');
```

---

## Navegación

| ⬆️ Padre | [[Proyecto OnlyCarNLD/Datos/3.1.4 esquema_sql_logica_negocio]] |
|----------|--------------------------------------|
| ⬅️ Anterior | [[Proyecto OnlyCarNLD/Datos/3.1.4.5 Vistas_Materializadas]] |
| ➡️ Siguiente | [[Proyecto OnlyCarNLD/Datos/3.1.4.7 Triggers_Functions]] |

---
