---
id: 5.8.8.2
title: Integration Tests
parent: 5.8.8
breadcrumb: 0 → 5.0 → 5.8 → 5.8.8 → 5.8.8.2
type: testing
status: activo
last_updated: 2026-01-29 15:32
file_create: 2026-01-01 18:10
domain:
- integration
- e2e
- supabase
summary: Pruebas de integración.
content_hash: 064b9e73d9b063ff
---

# 5.8.8.2 Integration Tests

Tests de integración para flujos completos de geolocalización.

---

## Estructura

```
tests/
└── integration/
    ├── tracking-flow.test.ts
    ├── realtime-sync.test.ts
    ├── arrival-detection.test.ts
    └── offline-recovery.test.ts
```

---

## Test: Flujo Completo de Tracking

```typescript
// tests/integration/tracking-flow.test.ts
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { createTestingPinia } from '@pinia/testing';
import { mount } from '@vue/test-utils';

// Componente a testear
import OperadorServicioView from '~/pages/operador/servicio/[id].vue';

describe('Flujo de Tracking Integration', () => {
  const mockServicio = {
    id: 'servicio-123',
    estado: 'en_camino',
    operador_id: 'operador-123',
    cliente_id: 'cliente-456',
    destino_lat: 27.4797,
    destino_lng: -99.5067
  };
  
  let wrapper: any;
  
  beforeEach(() => {
    vi.clearAllMocks();
    
    wrapper = mount(OperadorServicioView, {
      global: {
        plugins: [createTestingPinia()],
        stubs: ['NuxtLink', 'MapaUbicacion']
      },
      props: {
        servicioId: 'servicio-123'
      }
    });
  });
  
  it('should start tracking when estado is en_camino', async () => {
    // Simular que el servicio está en_camino
    await wrapper.setProps({ estadoServicio: 'en_camino' });
    
    // Verificar que tracking se inició
    expect(wrapper.vm.isTracking).toBe(true);
  });
  
  it('should broadcast location updates', async () => {
    const broadcastSpy = vi.fn();
    wrapper.vm.broadcastLocation = broadcastSpy;
    
    // Simular update de GPS
    wrapper.vm.onGpsUpdate({
      lat: 27.48,
      lng: -99.51,
      accuracy: 10
    });
    
    expect(broadcastSpy).toHaveBeenCalledWith(27.48, -99.51, 10);
  });
  
  it('should stop tracking when estado changes to llegado', async () => {
    await wrapper.setProps({ estadoServicio: 'en_camino' });
    expect(wrapper.vm.isTracking).toBe(true);
    
    await wrapper.setProps({ estadoServicio: 'llegado' });
    expect(wrapper.vm.isTracking).toBe(false);
  });
});
```

---

## Test: Sincronización Realtime

```typescript
// tests/integration/realtime-sync.test.ts
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { createClient } from '@supabase/supabase-js';

// Mock del cliente Supabase
const mockChannel = {
  on: vi.fn().mockReturnThis(),
  subscribe: vi.fn().mockReturnThis(),
  send: vi.fn().mockResolvedValue('ok'),
  unsubscribe: vi.fn()
};

const mockSupabase = {
  channel: vi.fn(() => mockChannel),
  removeChannel: vi.fn()
};

vi.mock('#supabase/client', () => ({
  useSupabaseClient: () => mockSupabase
}));

describe('Realtime Sync Integration', () => {
  beforeEach(() => {
    vi.clearAllMocks();
  });
  
  it('should create channel for servicio', () => {
    const { connect } = useLocationBroadcast('servicio-123');
    
    connect();
    
    expect(mockSupabase.channel).toHaveBeenCalledWith(
      'servicio:servicio-123',
      expect.any(Object)
    );
  });
  
  it('should broadcast location to channel', async () => {
    const { connect, broadcastLocation } = useLocationBroadcast('servicio-123');
    
    connect();
    await broadcastLocation(27.5, -99.5, 10);
    
    expect(mockChannel.send).toHaveBeenCalledWith({
      type: 'broadcast',
      event: 'location_update',
      payload: expect.objectContaining({
        lat: 27.5,
        lng: -99.5,
        accuracy: 10
      })
    });
  });
  
  it('should receive location updates', async () => {
    const callback = vi.fn();
    let eventHandler: Function;
    
    mockChannel.on.mockImplementation((type, filter, handler) => {
      if (filter.event === 'location_update') {
        eventHandler = handler;
      }
      return mockChannel;
    });
    
    const { connect, onLocationUpdate } = useLocationBroadcast('servicio-123');
    
    connect();
    onLocationUpdate(callback);
    
    // Simular recepción de ubicación
    eventHandler({ payload: { lat: 27.5, lng: -99.5, accuracy: 10 } });
    
    expect(callback).toHaveBeenCalledWith({
      lat: 27.5,
      lng: -99.5,
      accuracy: 10
    });
  });
});
```

---

## Test: Detección de Llegada End-to-End

```typescript
// tests/integration/arrival-detection.test.ts
import { describe, it, expect, vi, beforeEach } from 'vitest';

describe('Arrival Detection Integration', () => {
  const destino = { lat: 27.4797, lng: -99.5067 };
  
  it('should complete full arrival flow', async () => {
    const servicioId = 'servicio-123';
    
    // Setup mocks
    const updateServicioMock = vi.fn().mockResolvedValue({ success: true });
    const broadcastArrivalMock = vi.fn().mockResolvedValue(undefined);
    
    // Simular tracking
    const arrivals: boolean[] = [];
    
    const positions = [
      { lat: 27.50, lng: -99.50 },  // 2.5km lejos
      { lat: 27.49, lng: -99.51 },  // 1.2km
      { lat: 27.485, lng: -99.508 }, // 600m
      { lat: 27.480, lng: -99.507 }, // 80m - CERCA
      { lat: 27.480, lng: -99.507 }, // 80m - CONFIRMACIÓN
    ];
    
    const { checkArrival, hasArrived } = useArrivalDetection(ref(destino));
    
    for (const pos of positions) {
      const arrived = checkArrival(pos.lat, pos.lng);
      arrivals.push(arrived);
    }
    
    // Las primeras 3 no deberían detectar llegada
    expect(arrivals.slice(0, 3)).toEqual([false, false, false]);
    
    // La última debería confirmar llegada
    expect(arrivals[4]).toBe(true);
    expect(hasArrived.value).toBe(true);
  });
  
  it('should handle GPS noise without false arrival', () => {
    const { checkArrival, hasArrived, reset } = useArrivalDetection(ref(destino));
    
    // Simular GPS ruidoso que salta
    const noisyPositions = [
      { lat: 27.48, lng: -99.507 },  // Cerca
      { lat: 27.50, lng: -99.520 },  // Lejos (ruido)
      { lat: 27.48, lng: -99.507 },  // Cerca otra vez
      { lat: 27.49, lng: -99.515 },  // Lejos otra vez
    ];
    
    for (const pos of noisyPositions) {
      checkArrival(pos.lat, pos.lng);
    }
    
    // No debería haber llegado (nunca 2 consecutivos cerca)
    expect(hasArrived.value).toBe(false);
  });
});
```

---

## Test: Recuperación Offline

```typescript
// tests/integration/offline-recovery.test.ts
import { describe, it, expect, vi, beforeEach } from 'vitest';

describe('Offline Recovery Integration', () => {
  beforeEach(() => {
    localStorage.clear();
    vi.clearAllMocks();
  });
  
  it('should queue locations when offline and sync when online', async () => {
    const { enqueue, processQueue, queueSize, clearQueue } = useOfflineQueue();
    const broadcastMock = vi.fn().mockResolvedValue(undefined);
    
    // Simular 5 ubicaciones offline
    for (let i = 0; i < 5; i++) {
      enqueue({
        lat: 27.5 + i * 0.001,
        lng: -99.5,
        accuracy: 10,
        timestamp: Date.now() + i * 5000,
        servicioId: 'servicio-123'
      });
    }
    
    expect(queueSize.value).toBe(5);
    
    // Mock broadcast para processQueue
    vi.mock('~/composables/useLocationBroadcast', () => ({
      useLocationBroadcast: () => ({
        broadcastLocation: broadcastMock
      })
    }));
    
    // Procesar cola
    await processQueue();
    
    expect(queueSize.value).toBe(0);
  });
  
  it('should persist queue across page reloads', () => {
    const { enqueue } = useOfflineQueue();
    
    enqueue({
      lat: 27.5,
      lng: -99.5,
      accuracy: 10,
      timestamp: Date.now(),
      servicioId: 'servicio-123'
    });
    
    // Simular "recarga" creando nueva instancia
    const saved = localStorage.getItem('offline_location_queue');
    expect(saved).not.toBeNull();
    
    const parsed = JSON.parse(saved!);
    expect(parsed).toHaveLength(1);
  });
});
```

---

→ Ver mock location: [[Proyecto OnlyCarNLD/Datos/5.8.8.3 mock_location]]

---

## Navegación

| ⬆️ Padre             | [[Proyecto OnlyCarNLD/Datos/5.8.8 testing]]            |
| -------------------- | ---------------------- |
| ⬅️ Hermano anterior  | [[Proyecto OnlyCarNLD/Datos/5.8.8.1 unit_tests]]              |
| ➡️ Hermano siguiente | [[Proyecto OnlyCarNLD/Datos/5.8.8.3 mock_location]]              |
