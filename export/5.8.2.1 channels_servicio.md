---
id: 5.8.2.1
title: Channels Servicio
parent: 5.8.2
breadcrumb: 0 ‚Üí 5.0 ‚Üí 5.8 ‚Üí 5.8.2 ‚Üí 5.8.2.1
type: arquitectura
status: activo
last_updated: 2026-01-29 15:32
file_create: 2026-01-01 18:10
domain:
- supabase
- channels
- realtime
summary: Configuraci√≥n de canales de servicio.
content_hash: fd622d2d284bb1cd
---

# 5.8.2.1 Channels por Servicio

Configuraci√≥n de canales Supabase por servicio activo.

---

## Nomenclatura de Canales

```typescript
// Formato: servicio:{servicioId}
const channelName = `servicio:${servicioId}`;

// Ejemplos:
// servicio:a1b2c3d4-e5f6-7890-abcd-ef1234567890
// servicio:srv_20251225_001
```

---

## Diagrama de Canales

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  SUPABASE REALTIME                                              ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                 ‚îÇ
‚îÇ  Canal: servicio:abc123                                         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ  ‚îÇ                                                         ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  SUSCRIPTORES:                                          ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ üì± Operador (Carlos M.) ‚Äî BROADCASTER                ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ üì± Cliente (Juan G.) ‚Äî LISTENER                      ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ üíª Admin Dashboard ‚Äî LISTENER (opcional)             ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ                                                         ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  EVENTOS:                                               ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ location_update                                      ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ operador_llegado                                     ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ operador_retrasado (opcional)                        ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ                                                         ‚îÇ    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  Canal: servicio:xyz789                                         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ  ‚îÇ  (Otro servicio activo simult√°neo)                      ‚îÇ    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## Ciclo de Vida del Canal

```mermaid
stateDiagram-v2
    [*] --> sin_canal: Servicio creado
    sin_canal --> canal_activo: Estado ‚Üí en_camino
    canal_activo --> broadcasting: Operador conectado
    broadcasting --> broadcasting: location_update (configurable)
    broadcasting --> llegada: Operador llega
    llegada --> canal_cerrado: Estado ‚Üí llegado
    canal_cerrado --> [*]: Cleanup
```

---

## Implementaci√≥n del Canal

```typescript
// services/channelManager.ts
class ChannelManager {
  private channels = new Map<string, RealtimeChannel>();
  private supabase: SupabaseClient;
  
  constructor(supabase: SupabaseClient) {
    this.supabase = supabase;
  }
  
  /**
   * Obtener o crear canal por servicio
   */
  getChannel(servicioId: string): RealtimeChannel {
    const channelName = `servicio:${servicioId}`;
    
    if (!this.channels.has(servicioId)) {
      const channel = this.supabase.channel(channelName, {
        config: {
          broadcast: { 
            self: false,        // No recibir propios mensajes
            ack: false          // Sin confirmaci√≥n (menor latencia)
          }
        }
      });
      
      this.channels.set(servicioId, channel);
    }
    
    return this.channels.get(servicioId)!;
  }
  
  /**
   * Cerrar canal cuando servicio termina
   */
  async closeChannel(servicioId: string): Promise<void> {
    const channel = this.channels.get(servicioId);
    
    if (channel) {
      await this.supabase.removeChannel(channel);
      this.channels.delete(servicioId);
    }
  }
  
  /**
   * Cerrar todos los canales (cleanup)
   */
  async closeAll(): Promise<void> {
    for (const [id] of this.channels) {
      await this.closeChannel(id);
    }
  }
}

// Singleton
export const channelManager = new ChannelManager(useSupabaseClient());
```

---

## Seguridad del Canal

```typescript
// Los canales de Supabase Realtime son p√∫blicos por defecto
// Pero solo quienes conocen el servicioId pueden conectarse

// Medidas adicionales:
// 1. IDs de servicio son UUIDs aleatorios
// 2. No exponer servicioId en URLs p√∫blicas
// 3. Validar que usuario tenga relaci√≥n con servicio

// middleware/canal.ts
export default defineNuxtRouteMiddleware(async (to) => {
  const servicioId = to.params.id as string;
  const user = useSupabaseUser();
  
  // Verificar que usuario es cliente u operador del servicio
  const { data } = await supabase
    .from('servicios')
    .select('cliente_id, operador_id')
    .eq('id', servicioId)
    .single();
  
  if (!data) {
    throw createError({ statusCode: 404 });
  }
  
  const isAuthorized = 
    data.cliente_id === user.value?.id ||
    data.operador_id === user.value?.id ||
    user.value?.rol === 'admin';
  
  if (!isAuthorized) {
    throw createError({ statusCode: 403 });
  }
});
```

---

## L√≠mites y Consideraciones

| Aspecto | L√≠mite Supabase Free |
|---------|---------------------|
| Conexiones simult√°neas | 200 |
| Mensajes/seg | 100 |
| Canales activos | Sin l√≠mite |

**Para OnlyCar:**
- ~10-20 servicios simult√°neos m√°ximo = ~40-60 conexiones
- ‚úÖ Muy por debajo del l√≠mite

---

‚Üí Ver payload: [[Proyecto OnlyCarNLD/Datos/5.8.2.2 payload_ubicacion]]

---

## Navegaci√≥n

| ‚¨ÜÔ∏è Padre             | [[Proyecto OnlyCarNLD/Datos/5.8.2 realtime_broadcast]]            |
| -------------------- | ---------------------- |
| ‚û°Ô∏è Hermano siguiente | [[Proyecto OnlyCarNLD/Datos/5.8.2.2 payload_ubicacion]]              |
