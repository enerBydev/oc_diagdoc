---
id: 5.11.3
title: Webhooks MercadoPago
parent: '5.11'
breadcrumb: 0 → 5.0 → 5.11 → 5.11.3
type: configuracion
status: activo
last_updated: 2026-01-29 16:01
file_create: 2026-01-01 23:25
domain:
- mercadopago
- webhooks
- notificaciones
summary: 'Sistema de notificaciones automáticas para confirmar pagos.

  Recibe eventos de pago y actualiza estado de caja.'
content_hash: bf7be68385115b75
---

# 5.11.3 Webhooks MercadoPago

Sistema de notificaciones automáticas para confirmar pagos.

---

## Configuración

### URL del Webhook

```
https://onlycar.mx/api/webhooks/mercadopago
```

### Eventos a Escuchar

| Evento | Descripción |
|--------|-------------|
| `payment` | Pago creado, aprobado, rechazado |
| `merchant_order` | Orden completada |

---

## Implementación

```typescript
// server/api/webhooks/mercadopago.post.ts
import { MercadoPagoConfig, Payment } from 'mercadopago';

const client = new MercadoPagoConfig({ 
  accessToken: process.env.MERCADOPAGO_ACCESS_TOKEN! 
});

export default defineEventHandler(async (event) => {
  const query = getQuery(event);
  const body = await readBody(event);
  
  // Verificar firma (opcional pero recomendado)
  const xSignature = getHeader(event, 'x-signature');
  const xRequestId = getHeader(event, 'x-request-id');
  
  // Tipo de notificación
  const topic = query.topic || body.type;
  const resourceId = query.id || body.data?.id;
  
  if (topic === 'payment') {
    await procesarNotificacionPago(resourceId);
  }
  
  return { received: true };
});

const procesarNotificacionPago = async (paymentId: string) => {
  const payment = new Payment(client);
  const paymentData = await payment.get({ id: paymentId });
  
  // Obtener referencia externa
  const externalRef = JSON.parse(paymentData.external_reference || '{}');
  
  if (externalRef.type !== 'caja_liquidacion') {
    return; // No es liquidación de caja
  }
  
  switch (paymentData.status) {
    case 'approved':
      await liquidarCaja(externalRef);
      break;
    
    case 'pending':
      await marcarCajaPendiente(externalRef);
      break;
    
    case 'rejected':
      await notificarRechazo(externalRef);
      break;
  }
};

const liquidarCaja = async (ref: {
  operador_id: string;
  caja_id: string;
  monto: number;
}) => {
  // 1. Actualizar caja
  await supabase.from('cajas_diarias').update({
    efectivo_liquidado: ref.monto,
    estado: 'liquidada',
    liquidada_at: new Date()
  }).eq('id', ref.caja_id);
  
  // 2. Registrar transacción
  await supabase.from('liquidaciones').insert({
    operador_id: ref.operador_id,
    caja_id: ref.caja_id,
    monto: ref.monto,
    metodo: 'mercadopago',
    estado: 'completada'
  });
  
  // 3. Notificar operador
  await notifyOperador(ref.operador_id, {
    title: '✅ Caja liquidada',
    body: `$${ref.monto} recibido. Gracias por tu responsabilidad.`
  });
};
```

---

## Estados de Pago

| Estado | Significado | Acción |
|--------|-------------|--------|
| `approved` | Pago exitoso | Liquidar caja ✅ |
| `pending` | Esperando (SPEI) | Mantener pendiente ⏳ |
| `in_process` | Procesando | Esperar ⏳ |
| `rejected` | Rechazado | Notificar, reintentar ❌ |
| `cancelled` | Cancelado | Notificar ❌ |
| `refunded` | Reembolsado | Revertir liquidación ⚠️ |

---

## Seguridad

### Validación de Webhook

```typescript
import { createHmac } from 'crypto';

const validarFirmaMP = (
  xSignature: string,
  xRequestId: string,
  dataId: string
): boolean => {
  const secret = process.env.MERCADOPAGO_WEBHOOK_SECRET!;
  
  // Construir string a firmar
  const manifest = `id:${dataId};request-id:${xRequestId};ts:${timestamp};`;
  
  // Generar HMAC
  const hmac = createHmac('sha256', secret)
    .update(manifest)
    .digest('hex');
  
  // Extraer hash de x-signature
  const signatureParts = xSignature.split(',');
  const receivedHash = signatureParts
    .find(p => p.startsWith('v1='))
    ?.replace('v1=', '');
  
  return hmac === receivedHash;
};
```

---

## Reintentos

MercadoPago reintenta webhooks si no recibe respuesta 200:

| Intento | Delay |
|---------|-------|
| 1 | Inmediato |
| 2 | 5 minutos |
| 3 | 30 minutos |
| 4 | 3 horas |
| 5 | 24 horas |

---

→ Ver flujo completo: [[Proyecto OnlyCarNLD/Datos/5.11.4 flujo_operador]]

---

## Navegación

| ⬆️ Padre             | [[Proyecto OnlyCarNLD/Datos/5.11 mercadopago_integracion]] |
| -------------------- | -------------------------------- |
| ⬅️ Hermano anterior  | [[Proyecto OnlyCarNLD/Datos/5.11.2 checkout_liquidacion]]  |
| ➡️ Hermano siguiente | [[Proyecto OnlyCarNLD/Datos/5.11.4 flujo_operador]]        |

---
