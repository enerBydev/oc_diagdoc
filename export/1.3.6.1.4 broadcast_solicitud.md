---
id: 1.3.6.1.4
title: Broadcast de Solicitud
parent: 1.3.6.1
breadcrumb: 0 ‚Üí 1.0 ‚Üí 1.3 ‚Üí 1.3.6 ‚Üí 1.3.6.1 ‚Üí 1.3.6.1.4
type: padre
status: activo
domain: comunicacion
summary: Sistema de notificaci√≥n push a operadores elegibles con modelo first-come-first-served,
  Supabase Realtime y manejo de race conditions.
version: 1.0
last_updated: 2026-01-29 15:32
file_create: 2025-12-26 13:05
children_count: 4
actors:
- sistema
- operador
dependencies:
- firebase_messaging
- supabase_realtime
affects:
- 1.3.6.1 asignacion_citas
content_hash: 95f80179ee42187e
---

# 1.3.6.1.4 Broadcast de Solicitud

Sistema de notificaci√≥n a operadores elegibles.

---

## Filosof√≠a: First-Come-First-Served

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  MODELO DE BROADCAST                                            ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                 ‚îÇ
‚îÇ   1. Solicitud entra al sistema                                 ‚îÇ
‚îÇ   2. Motor de matching encuentra N operadores elegibles         ‚îÇ
‚îÇ   3. Broadcast SIMULT√ÅNEO a todos los N                         ‚îÇ
‚îÇ   4. El PRIMERO en aceptar gana la asignaci√≥n                   ‚îÇ
‚îÇ   5. Los dem√°s reciben "Ya fue tomada"                          ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ                         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                             ‚îÇ
‚îÇ                         ‚îÇSolicitud‚îÇ                             ‚îÇ
‚îÇ                         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò                             ‚îÇ
‚îÇ                              ‚îÇ                                  ‚îÇ
‚îÇ              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                  ‚îÇ
‚îÇ              ‚ñº               ‚ñº               ‚ñº                  ‚îÇ
‚îÇ         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îÇ
‚îÇ         ‚îÇCarlos M‚îÇ      ‚îÇPedro R ‚îÇ      ‚îÇMar√≠a G ‚îÇ              ‚îÇ
‚îÇ         ‚îî‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îÇ
‚îÇ             ‚îÇ               ‚îÇ               ‚îÇ                   ‚îÇ
‚îÇ         ACEPTA üèÜ        DECIDE            DECIDE               ‚îÇ
‚îÇ        (1.2 seg)        (3.5 seg)        (a√∫n no)               ‚îÇ
‚îÇ                              ‚îÇ               ‚îÇ                  ‚îÇ
‚îÇ                          "Ya tomada"     "Ya tomada"            ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## Tipos de Broadcast

| Tipo | Descripci√≥n | Expiraci√≥n |
|------|-------------|------------|
| **Est√°ndar** | Todos los elegibles | Ver [[Proyecto OnlyCarNLD/Datos/1.6.1 niveles_servicio_sla]] (Def: 5m) |
| **Preferencia** | Solo operador favorito | Ver [[Proyecto OnlyCarNLD/Datos/1.6.1 niveles_servicio_sla]] (Def: 10m) |
| **Urgente** | Prioridad alta, m√°s visible | Ver [[Proyecto OnlyCarNLD/Datos/1.6.1 niveles_servicio_sla]] (Def: 3m) |
| **Reasignaci√≥n** | Excluye operadores previos | Ver [[Proyecto OnlyCarNLD/Datos/1.6.1 niveles_servicio_sla]] (Def: 5m) |

---

## Payload de Broadcast

```typescript
interface BroadcastSolicitud {
  id: string;                    // UUID del broadcast
  tipo: 'standard' | 'preference' | 'urgent' | 'reassign';
  solicitud: {
    id: string;
    servicio: {
      id: string;
      nombre: string;
      duracion_estimada: number;  // minutos
      precio: number;
      comision_operador: number;  // Lo que gana el operador
    };
    cliente: {
      nombre: string;
      tipo: 'b2c' | 'corporate' | 'b2b';
      rating?: number;
    };
    ubicacion: {
      direccion: string;
      lat: number;
      lng: number;
      distancia_km: number;       // Desde operador
    };
    horario: {
      fecha: string;
      hora_preferida: string;
      flexible: boolean;
      rango_flex?: string;        // "¬±2h"
    };
  };
  expira_at: string;              // ISO timestamp
  acciones: ['aceptar', 'pasar', 'bloquear'];
}
```

---

## Push Notification

```typescript
// server/api/broadcast/send.post.ts
import { Messaging } from 'firebase-admin/messaging';

export default defineEventHandler(async (event) => {
  const body = await readBody(event);
  const { solicitudId, operadores } = body;
  
  // Obtener data de la solicitud
  const solicitud = await getSolicitud(solicitudId);
  
  // Crear broadcast record
  const broadcast = await supabase
    .from('broadcasts')
    .insert({
      solicitud_id: solicitudId,
      operadores_notificados: operadores.map(o => o.id),
      estado: 'activo',
      expira_at: new Date(Date.now() + 5 * 60 * 1000)
    })
    .select()
    .single();
  
  // Enviar push a cada operador
  const fcmTokens = await getFCMTokens(operadores.map(o => o.id));
  
  const message = {
    notification: {
      title: 'üöó Nueva solicitud de servicio',
      body: `${solicitud.servicio_nombre} - ${solicitud.ubicacion.direccion.slice(0, 50)}`,
    },
    data: {
      type: 'service_request',
      broadcast_id: broadcast.id,
      solicitud_id: solicitudId,
      expira_at: broadcast.expira_at
    },
    tokens: fcmTokens
  };
  
  await Messaging.sendEachForMulticast(message);
  
  return { success: true, broadcast_id: broadcast.id };
});
```

---

## Vista In-App (Operador)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  üöó NUEVA SOLICITUD                           ‚è±Ô∏è 4:32 restante  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                 ‚îÇ
‚îÇ  LAVADO EXPRESS                                                 ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  üìÖ 17 Enero 2025                                               ‚îÇ
‚îÇ  ‚è∞ ~10:00 AM (flexible ¬±2h)                                    ‚îÇ
‚îÇ  üìç Col. Centro, Blvd. Colosio #456                             ‚îÇ
‚îÇ     ‚îî‚îÄ 2.1 km de tu ubicaci√≥n                                   ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  üí∞ $299 ‚Üí Tu comisi√≥n: seg√∫n nivel (43-76%)                    ‚îÇ
‚îÇ     ‚Üí Ver detalle: ![[3.1.8 sistema_remuneracion]]              ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  üë§ Juan Garc√≠a                                                 ‚îÇ
‚îÇ     B2C Individual ‚Ä¢ ‚≠ê 4.7 (12 servicios)                      ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ ‚úÖ Aceptar ‚îÇ  ‚îÇ ‚è≠Ô∏è Pasar   ‚îÇ  ‚îÇ üö´ Bloquear cliente‚îÇ ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## Supabase Realtime para Estado

```typescript
// composables/useBroadcastListener.ts
export const useBroadcastListener = () => {
  const supabase = useSupabaseClient();
  const activeBroadcast = ref<BroadcastSolicitud | null>(null);
  const isExpired = ref(false);
  
  // Suscribirse a broadcasts dirigidos a este operador
  const subscribe = () => {
    const userId = useSupabaseUser().value?.id;
    
    const channel = supabase
      .channel('broadcast_operador')
      .on(
        'postgres_changes',
        {
          event: 'INSERT',
          schema: 'public',
          table: 'broadcasts',
          filter: `operadores_notificados.cs.{${userId}}`
        },
        (payload) => {
          activeBroadcast.value = payload.new;
          startExpiryTimer(payload.new.expira_at);
        }
      )
      .on(
        'postgres_changes',
        {
          event: 'UPDATE',
          schema: 'public',
          table: 'broadcasts',
          filter: `id=eq.${activeBroadcast.value?.id}`
        },
        (payload) => {
          if (payload.new.estado === 'tomada') {
            showToast('Esta solicitud ya fue tomada por otro operador');
            activeBroadcast.value = null;
          }
        }
      )
      .subscribe();
    
    return channel;
  };
  
  const startExpiryTimer = (expiraAt: string) => {
    const remaining = new Date(expiraAt).getTime() - Date.now();
    
    setTimeout(() => {
      if (activeBroadcast.value) {
        isExpired.value = true;
        activeBroadcast.value = null;
      }
    }, remaining);
  };
  
  return {
    activeBroadcast,
    isExpired,
    subscribe
  };
};
```

---

## Tabla de Broadcasts

```sql
CREATE TABLE broadcasts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  solicitud_id UUID NOT NULL REFERENCES solicitudes(id),
  tipo VARCHAR(20) DEFAULT 'standard',
  operadores_notificados UUID[] NOT NULL,
  operador_aceptado UUID REFERENCES operadores(id),
  estado VARCHAR(20) DEFAULT 'activo',  -- activo, tomada, expirada, cancelada
  expira_at TIMESTAMPTZ NOT NULL,
  tomada_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT now()
);

-- √çndice para b√∫squeda r√°pida
CREATE INDEX idx_broadcasts_solicitud ON broadcasts(solicitud_id);
CREATE INDEX idx_broadcasts_estado ON broadcasts(estado) WHERE estado = 'activo';
```

---

## Manejo de Race Condition

```sql
-- Funci√≥n at√≥mica para aceptar broadcast
-- Evita que dos operadores acepten simult√°neamente
CREATE OR REPLACE FUNCTION aceptar_broadcast(
  p_broadcast_id UUID,
  p_operador_id UUID
) RETURNS JSONB AS $$
DECLARE
  v_broadcast broadcasts;
BEGIN
  -- Lock optimista con UPDATE condicional
  UPDATE broadcasts
  SET 
    estado = 'tomada',
    operador_aceptado = p_operador_id,
    tomada_at = NOW()
  WHERE id = p_broadcast_id
    AND estado = 'activo'
    AND expira_at > NOW()
  RETURNING * INTO v_broadcast;
  
  IF NOT FOUND THEN
    -- Ya fue tomada o expir√≥
    RETURN jsonb_build_object(
      'success', false,
      'reason', 'Solicitud no disponible'
    );
  END IF;
  
  RETURN jsonb_build_object(
    'success', true,
    'solicitud_id', v_broadcast.solicitud_id
  );
END;
$$ LANGUAGE plpgsql;
```

---

## M√©tricas de Broadcast

| M√©trica | Descripci√≥n |
|---------|-------------|
| **Tiempo de aceptaci√≥n** | Segundos hasta primer aceptaci√≥n |
| **Tasa de expiraci√≥n** | % broadcasts sin respuesta |
| **Operadores promedio** | Candidatos por broadcast |
| **Rechazos acumulados** | Operadores que pasan frecuentemente |

---

## Estructura de Hijos

| ID | Nombre | Descripci√≥n | Estado |
|----|--------|-------------|--------|
| [[Proyecto OnlyCarNLD/Datos/1.3.6.1.4.1 notificaciones_premium\|1.3.6.1.4.1]] | Notif. Premium | Push destacadas | ‚úÖ |
| [[Proyecto OnlyCarNLD/Datos/1.3.6.1.4.2 soundscape_alertas\|1.3.6.1.4.2]] | Soundscape | Sonidos alertas | ‚úÖ |
| [[Proyecto OnlyCarNLD/Datos/1.3.6.1.4.3 vibracion_patron\|1.3.6.1.4.3]] | Vibraci√≥n | Patrones hapticos | ‚úÖ |
| [[Proyecto OnlyCarNLD/Datos/1.3.6.1.4.4 persistencia_notificacion\|1.3.6.1.4.4]] | Persistencia | Notif. persistentes | ‚úÖ |

---

## Navegaci√≥n

| ‚¨ÜÔ∏è Padre             | [[Proyecto OnlyCarNLD/Datos/1.3.6.1 asignacion_citas]]        |
| -------------------- | ----------------------------------- |
| ‚¨ÖÔ∏è Hermano anterior  | [[Proyecto OnlyCarNLD/Datos/1.3.6.1.3 zona_cobertura]]        |
| ‚û°Ô∏è Hermano siguiente | [[Proyecto OnlyCarNLD/Datos/1.3.6.1.5 aceptacion_rechazo]]    |

---
