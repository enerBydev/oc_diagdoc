---
id: 1.3.1
title: Arquitectura del Chat
parent: '1.3'
breadcrumb: 0 â†’ 1.0 â†’ 1.3 â†’ 1.3.1
type: hoja
status: activo
domain: comunicacion
summary: Estructura tÃ©cnica del sistema de mensajerÃ­a con modelo de datos, Supabase
  Realtime, composable useChat y polÃ­ticas RLS.
version: 1.0
last_updated: 2026-01-29 15:32
file_create: 2025-12-23 10:57
actors:
- sistema
dependencies:
- supabase
- postgresql
affects:
- 1.3.X chat
content_hash: e06cc8c0f6c0d0e8
---

# 1.3.1 Arquitectura del Chat

Estructura tÃ©cnica del sistema de mensajerÃ­a.

---

## Modelo de Datos

### Tablas Principales

```sql
-- Conversaciones
CREATE TABLE conversations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  type TEXT NOT NULL CHECK (type IN ('admin_client', 'operator_client')),
  
  -- Participantes
  participant_1_id UUID REFERENCES users(id) NOT NULL,
  participant_1_role TEXT NOT NULL,
  participant_2_id UUID REFERENCES users(id) NOT NULL,
  participant_2_role TEXT NOT NULL,
  
  -- Contexto (opcional)
  service_id UUID REFERENCES services(id),
  contract_id UUID REFERENCES contracts(id),
  
  -- Estado
  status TEXT DEFAULT 'active' CHECK (status IN ('active', 'archived')),
  last_message_at TIMESTAMPTZ,
  last_message_preview TEXT,
  
  -- Timestamps
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

-- Mensajes
CREATE TABLE messages (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  conversation_id UUID REFERENCES conversations(id) NOT NULL,
  
  -- Autor
  sender_id UUID REFERENCES users(id) NOT NULL,
  sender_role TEXT NOT NULL,
  
  -- Contenido
  type TEXT NOT NULL CHECK (type IN (
    'text', 'image', 'card_service', 'card_payment', 
    'card_contract', 'file', 'system'
  )),
  content JSONB NOT NULL,
  
  -- Estado de lectura
  read_at TIMESTAMPTZ,
  delivered_at TIMESTAMPTZ,
  
  -- Timestamps
  created_at TIMESTAMPTZ DEFAULT now()
);

-- Ãndices para performance
CREATE INDEX idx_messages_conversation ON messages(conversation_id, created_at DESC);
CREATE INDEX idx_conversations_participant ON conversations(participant_1_id);
CREATE INDEX idx_conversations_participant2 ON conversations(participant_2_id);
```

---

## Arquitectura en Tiempo Real

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CLIENTE A (Navegador)                       â”‚
â”‚                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  useChat() Composable                                   â”‚   â”‚
â”‚  â”‚  â€¢ subscribeToConversation(id)                          â”‚   â”‚
â”‚  â”‚  â€¢ sendMessage(content)                                 â”‚   â”‚
â”‚  â”‚  â€¢ markAsRead(messageId)                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â”‚                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚ WebSocket
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SUPABASE REALTIME                            â”‚
â”‚                                                                 â”‚
â”‚  Channel: conversation:{id}                                     â”‚
â”‚  Events: INSERT, UPDATE on messages                             â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚ Broadcast
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CLIENTE B (Navegador)                        â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Recibe mensaje â†’ Actualiza UI â†’ NotificaciÃ³n           â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Composable: `useChat`

```typescript
// composables/useChat.ts
export const useChat = () => {
  const supabase = useSupabaseClient();
  const user = useSupabaseUser();
  
  const conversations = ref<Conversation[]>([]);
  const activeConversation = ref<Conversation | null>(null);
  const messages = ref<Message[]>([]);
  const isTyping = ref(false);
  
  // Cargar conversaciones del usuario
  const loadConversations = async () => {
    const { data } = await supabase
      .from('conversations')
      .select('*')
      .or(`participant_1_id.eq.${user.value.id},participant_2_id.eq.${user.value.id}`)
      .order('last_message_at', { ascending: false });
    
    conversations.value = data;
  };
  
  // Suscribirse a una conversaciÃ³n
  const subscribeToConversation = (conversationId: string) => {
    return supabase
      .channel(`conversation:${conversationId}`)
      .on('postgres_changes', {
        event: 'INSERT',
        schema: 'public',
        table: 'messages',
        filter: `conversation_id=eq.${conversationId}`
      }, (payload) => {
        messages.value.push(payload.new as Message);
      })
      .subscribe();
  };
  
  // Enviar mensaje
  const sendMessage = async (content: MessageContent) => {
    const message = {
      conversation_id: activeConversation.value.id,
      sender_id: user.value.id,
      sender_role: user.value.role,
      type: content.type,
      content: content.data
    };
    
    await supabase.from('messages').insert(message);
  };
  
  // Marcar como leÃ­do
  const markAsRead = async (messageId: string) => {
    await supabase
      .from('messages')
      .update({ read_at: new Date().toISOString() })
      .eq('id', messageId);
  };
  
  // Typing indicator
  const sendTyping = (conversationId: string) => {
    supabase.channel(`typing:${conversationId}`)
      .send({
        type: 'broadcast',
        event: 'typing',
        payload: { userId: user.value.id }
      });
  };
  
  return {
    conversations,
    activeConversation,
    messages,
    isTyping,
    loadConversations,
    subscribeToConversation,
    sendMessage,
    markAsRead,
    sendTyping
  };
};
```

---

## Estados de Mensaje

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ENVIANDO  â”‚â”€â”€â”€â”€â†’â”‚  ENVIADO    â”‚â”€â”€â”€â”€â†’â”‚  ENTREGADO  â”‚
â”‚   (local)   â”‚     â”‚  (servidor) â”‚     â”‚  (destino)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â”‚
                                              â–¼
                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                        â”‚   LEÃDO     â”‚
                                        â”‚   (visto)   â”‚
                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

| Estado | Indicador | DescripciÃ³n |
|--------|-----------|-------------|
| Enviando | â—‹ | Mensaje local, enviando al servidor |
| Enviado | âœ“ | Guardado en base de datos |
| Entregado | âœ“âœ“ | Recibido por destinatario (WebSocket) |
| LeÃ­do | âœ“âœ“ (azul) | `read_at` actualizado |

---

## PolÃ­ticas RLS

```sql
-- Los usuarios solo ven sus conversaciones
CREATE POLICY "Users can view own conversations" ON conversations
  FOR SELECT USING (
    auth.uid() = participant_1_id OR 
    auth.uid() = participant_2_id
  );

-- Los usuarios solo ven mensajes de sus conversaciones
CREATE POLICY "Users can view messages in own conversations" ON messages
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM conversations 
      WHERE id = messages.conversation_id
      AND (participant_1_id = auth.uid() OR participant_2_id = auth.uid())
    )
  );

-- Solo participantes pueden enviar mensajes
CREATE POLICY "Users can insert messages in own conversations" ON messages
  FOR INSERT WITH CHECK (
    sender_id = auth.uid() AND
    EXISTS (
      SELECT 1 FROM conversations 
      WHERE id = conversation_id
      AND (participant_1_id = auth.uid() OR participant_2_id = auth.uid())
    )
  );
```

---

## Performance

| OptimizaciÃ³n | ImplementaciÃ³n |
|--------------|----------------|
| **PaginaciÃ³n** | Cargar 50 mensajes, scroll infinito |
| **Ãndices** | conversation_id + created_at DESC |
| **Cache** | Conversaciones recientes en memoria |
| **ImÃ¡genes** | Thumbnails para preview rÃ¡pido |
| **Batch** | Agrupar actualizaciones de estado |

---

## NavegaciÃ³n

| â¬†ï¸ Padre             | [[Proyecto OnlyCarNLD/Datos/1.3. comunicacion]]              |
| -------------------- | ---------------------------------- |
| â¡ï¸ Hermano siguiente | [[Proyecto OnlyCarNLD/Datos/1.3.2 chat_admin_cliente]]       |
| ğŸ”— Ver tambiÃ©n       | [[Proyecto OnlyCarNLD/Datos/1.3.4 tipos_mensajes]]           |

---
