---
id: 1.3.6.1.12.2
title: Asignaci√≥n Operador-Ciudad
parent: 1.3.6.1.12
breadcrumb: 0 ‚Üí 1.0 ‚Üí 1.3 ‚Üí 1.3.6 ‚Üí 1.3.6.1 ‚Üí 1.3.6.1.12 ‚Üí 1.3.6.1.12.2
type: hoja
status: activo
domain: comunicacion
summary: Reglas y UI para asignar operador a una ciudad durante onboarding con solo
  Admin pudiendo cambiar despu√©s.
version: 1.0
last_updated: 2026-01-29 15:32
file_create: 2025-12-26 15:16
actors:
- operador
- admin
dependencies:
- supabase
affects:
- 1.3.6.1.12 sistema_ciudades
content_hash: 086a3f0634e0389f
---

# 1.3.6.1.12.2 Asignaci√≥n Operador-Ciudad

Reglas para asignar operador a una ciudad.

---

## Regla Principal

> [!IMPORTANT]
> **Un operador pertenece a exactamente UNA ciudad.**
> - Se asigna durante onboarding
> - Solo Admin puede cambiar
> - Operador NO puede auto-cambiarse

---

## Flujo de Asignaci√≥n

### Durante Onboarding

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  üë∑ REGISTRO DE OPERADOR - PASO 3/5                             ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                 ‚îÇ
‚îÇ  ¬øEn qu√© ciudad trabajar√°s?                                     ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  Estado: [ Tamaulipas ‚ñº ]                                       ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  Ciudad: [ Nuevo Laredo ‚ñº ]                                     ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  ‚ö†Ô∏è Solo recibir√°s solicitudes de clientes de esta ciudad.      ‚îÇ
‚îÇ     Si deseas cambiar despu√©s, contacta a soporte.              ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  [ ‚Üê Anterior ]                      [ Siguiente ‚Üí ]            ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Cambio por Admin

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  üîß ADMIN: EDITAR OPERADOR                                      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                 ‚îÇ
‚îÇ  Operador: Carlos Mart√≠nez                                      ‚îÇ
‚îÇ  ID: op-12345                                                   ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  CIUDAD ACTUAL: Nuevo Laredo, Tamaulipas                        ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  CAMBIAR A:                                                     ‚îÇ
‚îÇ  Estado: [ Tamaulipas ‚ñº ]                                       ‚îÇ
‚îÇ  Ciudad: [ Reynosa ‚ñº ]                                          ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  Motivo del cambio:                                             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ  ‚îÇ Operador se mud√≥ a Reynosa                              ‚îÇ    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  ‚ö†Ô∏è Esto afectar√° inmediatamente qu√© solicitudes recibe.        ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  [ Cancelar ]                    [ Guardar cambio ]             ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## Vista de Operador (Solo Lectura)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  üìç MI CIUDAD                                                   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                 ‚îÇ
‚îÇ  Ciudad actual: Nuevo Laredo, Tamaulipas                        ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  ‚ÑπÔ∏è Solo recibes solicitudes de clientes de esta ciudad.        ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  ¬øNecesitas cambiar de ciudad?                                  ‚îÇ
‚îÇ  [ Contactar soporte ]                                          ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## Implementaci√≥n

### Validaci√≥n en Onboarding

```typescript
// composables/useOperatorOnboarding.ts
const assignCity = async (operadorId: string, ciudadId: string) => {
  // 1. Verificar que ciudad existe y est√° activa
  const { data: ciudad } = await supabase
    .from('ciudades')
    .select('id, activa')
    .eq('id', ciudadId)
    .single();
  
  if (!ciudad?.activa) {
    throw new Error('Ciudad no disponible');
  }
  
  // 2. Asignar
  const { error } = await supabase
    .from('operadores')
    .update({ ciudad_id: ciudadId })
    .eq('id', operadorId);
  
  if (error) throw error;
  
  // 3. Log
  await supabase.from('audit_log').insert({
    accion: 'CIUDAD_ASIGNADA',
    tabla: 'operadores',
    registro_id: operadorId,
    datos: { ciudad_id: ciudadId, tipo: 'onboarding' }
  });
};
```

### Cambio por Admin

```typescript
// server/api/admin/operador/cambiar-ciudad.post.ts
export default defineEventHandler(async (event) => {
  const { operadorId, nuevaCiudadId, motivo } = await readBody(event);
  const adminId = event.context.user?.id;
  
  // Verificar rol admin
  if (event.context.user?.role !== 'admin') {
    throw createError({ statusCode: 403, message: 'Solo admin' });
  }
  
  // Obtener ciudad anterior
  const { data: operador } = await supabase
    .from('operadores')
    .select('ciudad_id, nombre')
    .eq('id', operadorId)
    .single();
  
  // Actualizar
  await supabase
    .from('operadores')
    .update({ ciudad_id: nuevaCiudadId })
    .eq('id', operadorId);
  
  // Log de auditor√≠a
  await supabase.from('audit_log').insert({
    accion: 'CIUDAD_CAMBIADA',
    tabla: 'operadores',
    registro_id: operadorId,
    usuario_id: adminId,
    datos: {
      ciudad_anterior: operador?.ciudad_id,
      ciudad_nueva: nuevaCiudadId,
      motivo
    }
  });
  
  // Notificar al operador
  await sendPushNotification(operadorId, {
    title: 'üìç Tu ciudad ha cambiado',
    body: 'Un administrador ha actualizado tu ciudad de operaci√≥n.'
  });
  
  return { success: true };
});
```

---

## Selector de Ciudad (Componente)

```vue
<!-- components/CiudadSelector.vue -->
<script setup lang="ts">
const props = defineProps<{
  modelValue: string;
  disabled?: boolean;
}>();

const emit = defineEmits(['update:modelValue']);

const { getEstadosConCiudades } = useCities();
const estados = await getEstadosConCiudades();

const estadoSeleccionado = ref<string>('');
const ciudadesDelEstado = computed(() => {
  const estado = estados?.find(e => e.id === estadoSeleccionado.value);
  return estado?.ciudades?.filter(c => c.activa) || [];
});

watch(() => props.modelValue, (newVal) => {
  // Encontrar el estado de la ciudad seleccionada
  for (const estado of estados || []) {
    const ciudad = estado.ciudades?.find(c => c.id === newVal);
    if (ciudad) {
      estadoSeleccionado.value = estado.id;
      break;
    }
  }
}, { immediate: true });
</script>

<template>
  <div class="ciudad-selector">
    <div class="field">
      <label>Estado</label>
      <select v-model="estadoSeleccionado" :disabled="disabled">
        <option value="">Selecciona estado</option>
        <option v-for="estado in estados" :key="estado.id" :value="estado.id">
          {{ estado.nombre }}
        </option>
      </select>
    </div>
    
    <div class="field" v-if="estadoSeleccionado">
      <label>Ciudad</label>
      <select 
        :value="modelValue" 
        @change="emit('update:modelValue', $event.target.value)"
        :disabled="disabled"
      >
        <option value="">Selecciona ciudad</option>
        <option v-for="ciudad in ciudadesDelEstado" :key="ciudad.id" :value="ciudad.id">
          {{ ciudad.nombre }}
        </option>
      </select>
    </div>
  </div>
</template>
```

---

## Historial de Cambios de Ciudad

```sql
-- Vista para ver historial de cambios de ciudad
CREATE VIEW v_historial_cambios_ciudad AS
SELECT
  a.registro_id as operador_id,
  o.nombre as operador_nombre,
  c_ant.nombre as ciudad_anterior,
  c_new.nombre as ciudad_nueva,
  a.datos->>'motivo' as motivo,
  u.nombre as cambiado_por,
  a.created_at as fecha_cambio
FROM audit_log a
JOIN operadores o ON a.registro_id = o.id
LEFT JOIN ciudades c_ant ON (a.datos->>'ciudad_anterior')::UUID = c_ant.id
LEFT JOIN ciudades c_new ON (a.datos->>'ciudad_nueva')::UUID = c_new.id
LEFT JOIN users u ON a.usuario_id = u.id
WHERE a.accion = 'CIUDAD_CAMBIADA'
ORDER BY a.created_at DESC;
```

---

## Navegaci√≥n

| ‚¨ÜÔ∏è Padre             | [[Proyecto OnlyCarNLD/Datos/1.3.6.1.12 sistema_ciudades]]           |
| -------------------- | ----------------------------------------- |
| ‚¨ÖÔ∏è Hermano anterior  | [[Proyecto OnlyCarNLD/Datos/1.3.6.1.12.1 modelo_ciudades]]          |
| ‚û°Ô∏è Hermano siguiente | [[Proyecto OnlyCarNLD/Datos/1.3.6.1.12.3 filtro_solicitud_ciudad]]  |

---
