---
id: 3.1.5
title: API Lógica de Negocio
parent: '3.1'
breadcrumb: 0 → 3.0 → 3.1 → 3.1.5
type: modulo_padre
children_count: 7
descendants_count: 7
status: activo
last_updated: 2026-01-29 15:31
file_create: 2025-12-17 11:38
domain:
- api
- nitro
- endpoints
actors:
- admin
- desarrollador
- cliente
summary: 'Definición de endpoints API para la lógica de negocio.

  Públicos, autenticados, admin. Incluye middleware de auth y roles.'
content_hash: c28515ce06284154
---

# 3.1.5 API Endpoints - Lógica de Negocio

**Stack:** Nitro v3 (server/api/) + Supabase Client  
**Autenticación:** Dual Auth — OAuth (Azure/Google) + Email/Password (JWT)  
**Middleware:** Cloudflare Workers

→ Ver detalle de autenticación: [[Proyecto OnlyCarNLD/Datos/5.6. autenticacion]]

---

### Arquitectura de Seguridad

```
┌──────────────────────────────────────────────────────────────┐
│                    CLOUDFLARE                                │
│  ┌────────────────────────────────────────────────────────┐  │
│  │ WAF + Zero Trust + Rate Limiting                       │  │
│  └────────────────────────────────────────────────────────┘  │
└──────────────────────────────────┬───────────────────────────┘
                                   │
                                   ▼
┌──────────────────────────────────────────────────────────────┐
│                 NITRO API (Edge Functions)                   │
│  ┌──────────────────┐  ┌──────────────────┐                 │
│  │ Middleware Auth  │→ │ Verificar JWT    │                 │
│  └──────────────────┘  └──────────────────┘                 │
└──────────────────────────────────┬───────────────────────────┘
                                   │
                                   ▼
┌──────────────────────────────────────────────────────────────┐
│                   SUPABASE + RLS                             │
│  Las políticas RLS son la última línea de defensa           │
└──────────────────────────────────────────────────────────────┘

> [!NOTE]
> **Integridad Cognitiva:** Toda transacción crítica es validada previamente por el sistema de [[3.6. Auditoria_Logica]] para garantizar invariantes inmutables.
```

---

### Endpoints y Contratos

> [!IMPORTANT]
> **FUENTE ÚNICA DE VERDAD:** El catálogo exhaustivo de endpoints, schemas y códigos de estado se encuentra en:
> [[Proyecto OnlyCarNLD/Datos/4.6 API_Specification]]
>
> Este documento (3.1.5) se centra exclusivamente en la **LÓGICA INTERNA**, algoritmos y flujo de datos detrás de la API.

---

### Arquitectura de Seguridad (Implementación)

---

### Middleware de Autenticación

```typescript
// server/middleware/auth.ts
export default defineEventHandler(async (event) => {
  // Rutas públicas (no requieren auth)
  const publicRoutes = ['/api/catalogo'];
  const path = getRequestURL(event).pathname;
  
  if (publicRoutes.some(r => path.startsWith(r))) {
    return; // Continuar sin verificar
  }
  
  // Verificar JWT
  const client = await serverSupabaseClient(event);
  const { data: { user }, error } = await client.auth.getUser();
  
  if (error || !user) {
    throw createError({
      statusCode: 401,
      message: 'No autorizado'
    });
  }
  
  // Guardar usuario en contexto
  event.context.user = user;
  event.context.role = user.user_metadata?.role || 'cliente';
});
```

---

### Middleware de Roles

```typescript
// server/utils/requireRole.ts
export function requireRole(event: H3Event, allowedRoles: string[]) {
  const role = event.context.role;
  
  if (!allowedRoles.includes(role)) {
    throw createError({
      statusCode: 403,
      message: `Rol '${role}' no tiene permiso. Requerido: ${allowedRoles.join(', ')}`
    });
  }
}
```

---

### Ejemplo: GET /api/catalogo/servicios

```typescript
// server/api/catalogo/servicios.get.ts
export default defineEventHandler(async (event) => {
  const client = await serverSupabaseClient(event);
  
  const { data, error } = await client
    .from('v_servicios_precios')
    .select('codigo, nombre, total_bloqueado, precio_b2c, descripcion')
    .order('orden');
  
  if (error) {
    throw createError({ statusCode: 500, message: error.message });
  }
  
  return {
    success: true,
    data,
    meta: {
      total: data.length,
      currency: 'MXN',
      preciosIncluyenIVA: true
    }
  };
});
```

---

### Ejemplo: GET /api/admin/servicios

```typescript
// server/api/admin/servicios.get.ts
export default defineEventHandler(async (event) => {
  requireRole(event, ['admin']);
  
  const client = await serverSupabaseClient(event);
  
  const { data, error } = await client
    .from('servicios')
    .select('*')
    .order('orden');
  
  if (error) {
    throw createError({ statusCode: 500, message: error.message });
  }
  
  return { success: true, data };
});
```

---

### Ejemplo: POST /api/admin/servicios

```typescript
// server/api/admin/servicios.post.ts
import { z } from 'zod';

const servicioSchema = z.object({
  codigo: z.string().min(3).max(100),
  nombre: z.string().min(3).max(200),
  servicio_minutos: z.number().min(10),
  buffer_minutos: z.number().min(0).default(15),
  precio_base: z.number().min(50),
  descripcion: z.string().optional(),
  orden: z.number().default(0)
});

export default defineEventHandler(async (event) => {
  requireRole(event, ['admin']);
  
  const body = await readBody(event);
  const validated = servicioSchema.parse(body);
  
  const client = await serverSupabaseClient(event);
  
  const { data, error } = await client
    .from('servicios')
    .insert(validated)
    .select()
    .single();
  
  if (error) {
    if (error.code === '23505') { // Unique violation
      throw createError({ statusCode: 409, message: 'El código ya existe' });
    }
    throw createError({ statusCode: 500, message: error.message });
  }
  
  return { success: true, data };
});
```

---

### Ejemplo: GET /api/descuentos/validar/:codigo

```typescript
// server/api/descuentos/validar/[codigo].get.ts
export default defineEventHandler(async (event) => {
  const codigo = getRouterParam(event, 'codigo');
  const user = event.context.user;
  
  const client = await serverSupabaseClient(event);
  
  // Buscar descuento
  const { data: descuento, error } = await client
    .from('descuentos')
    .select(`
      codigo,
      nombre,
      porcentaje,
      tipo,
      requisitos:descuento_requisitos(requisito)
    `)
    .eq('codigo', codigo)
    .eq('activo', true)
    .single();
  
  if (error || !descuento) {
    return { valid: false, message: 'Código no válido o expirado' };
  }
  
  // Verificar requisitos (lógica simplificada)
  const requisitos = descuento.requisitos.map(r => r.requisito);
  const cumpleRequisitos = await verificarRequisitos(client, user, requisitos);
  
  if (!cumpleRequisitos.valido) {
    return { 
      valid: false, 
      message: cumpleRequisitos.razon 
    };
  }
  
  return {
    valid: true,
    descuento: {
      codigo: descuento.codigo,
      nombre: descuento.nombre,
      porcentaje: descuento.porcentaje
    }
  };
});
```

---

### Tipos TypeScript

```typescript
// types/logica-negocio.ts
export interface Servicio {
  id: string;
  codigo: string;
  nombre: string;
  servicio_minutos: number;
  buffer_minutos: number;
  total_bloqueado: number;
  precio_base: number;
  descripcion?: string;
  activo: boolean;
}

export interface ServicioConPrecios extends Servicio {
  precio_b2c: number;
  precio_b2b: number;
}

export interface Paquete {
  id: string;
  codigo: string;
  tipo: 'b2c' | 'b2b';
  nombre: string;
  precio_base: number;
  hereda_de_id?: string;
  escala_volumen_id?: string;
  descripcion?: string;
}

export interface Descuento {
  id: string;
  codigo: string;
  segmento: 'b2c' | 'b2b';
  nombre: string;
  porcentaje: number;
  tipo: string;
  uso_maximo?: number;
  activo: boolean;
}

export interface Empresa {
  id: string;
  codigo: string;
  nombre: string;
  activo: boolean;
  tipo_contrato: 'mensual' | 'anual' | 'proyecto';
  descuento_negociado?: number;
  corporate_plus_activo: boolean;
}
```

---

## Estructura de Hijos (Deep Dive)

| ID | Nombre | Descripción | Estado |
|----|--------|-------------|--------|
| [[Proyecto OnlyCarNLD/Datos/3.1.5.1 Catalogo_Publico\|3.1.5.1]] | Catálogo Público | GET /api/catalogo/* endpoints | ✅ |
| [[Proyecto OnlyCarNLD/Datos/3.1.5.2 Descuentos_API\|3.1.5.2]] | Descuentos API | Validar, disponibles | ✅ |
| [[Proyecto OnlyCarNLD/Datos/3.1.5.3 Empresa_API\|3.1.5.3]] | Empresa API | Datos empresa, paquetes B2B | ✅ |
| [[Proyecto OnlyCarNLD/Datos/3.1.5.4 Admin_CRUD\|3.1.5.4]] | Admin CRUD | /api/admin/* completo | ✅ |
| [[Proyecto OnlyCarNLD/Datos/3.1.5.5 Middleware_Auth\|3.1.5.5]] | Middleware Auth | Autenticación y roles | ✅ |
| [[Proyecto OnlyCarNLD/Datos/3.1.5.6 Types_TS\|3.1.5.6]] | Types TypeScript | Interfaces Servicio, Paquete, etc | ✅ |
| [[Proyecto OnlyCarNLD/Datos/3.1.5.7 Disputas_API\|3.1.5.7]] | Disputas API | Endpoints resolución de conflictos | ✅ |

---

## Navegación

| ⬆️ Padre             | [[Proyecto OnlyCarNLD/Datos/3.1. Logica_Negocio_Core]]                       |
| -------------------- | ---------------------------------------- |
| ⬅️ Hermano anterior  | [[Proyecto OnlyCarNLD/Datos/3.1.4 esquema_sql_logica_negocio]]     |
| ➡️ Hermano siguiente | [[Proyecto OnlyCarNLD/Datos/3.1.6 datos_iniciales_seed]]           |

---
