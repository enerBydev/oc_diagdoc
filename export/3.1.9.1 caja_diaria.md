---
id: 3.1.9.1
title: Caja Diaria
parent: 3.1.9
breadcrumb: 0 ‚Üí 3.0 ‚Üí 3.1 ‚Üí 3.1.9 ‚Üí 3.1.9.1
type: modulo_padre
children_count: 3
descendants_count: 3
status: activo
last_updated: 2026-01-29 15:31
file_create: 2025-12-27 14:11
domain:
- caja
- diaria
- registro
actors:
- operador
summary: 'Sistema de registro y seguimiento de cobros diarios.

  Corte autom√°tico 21:30, estados de caja.'
content_hash: 82051afac92efc74
---

# 3.1.9.1 Caja Diaria

Sistema de registro y seguimiento de cobros diarios del operador.

---

## Prop√≥sito

Controlar el dinero que el operador cobra durante el d√≠a para:
- Saber cu√°nto debe depositar a OnlyCar
- Separar pagos en efectivo vs tarjeta
- Generar cortes diarios autom√°ticos

---

## ‚ö†Ô∏è IMPORTANTE: Diferenciaci√≥n de Horarios

> [!CAUTION]
> **No confundir estos dos conceptos:**
>
> | Concepto | Horario | Frecuencia |
> |----------|---------|------------|
> | **Corte de Caja** | 21:30 (9:30 PM) | DIARIO |
> | **Pago Semanal** | ~23:59 Viernes | SEMANAL |

### Corte de Caja Diario (21:30)
- Cierra la caja del d√≠a
- Operador tiene hasta este momento para liquidar
- Se genera resumen de lo cobrado

### Pago Semanal (~23:59 Viernes)
- OnlyCar paga al operador sus comisiones
- Hora simb√≥lica (puede variar por procesamiento)
- Dep√≥sito puede llegar viernes noche o s√°bado AM

---

## Flujo del D√≠a

```
INICIO DEL D√çA (00:00)
      ‚îÇ
      ‚ñº
Operador realiza servicios
      ‚îÇ
      ‚îú‚îÄ‚îÄ Cliente paga EFECTIVO
      ‚îÇ   ‚îî‚îÄ‚îÄ Operador registra en app ‚Üí Liquidar v√≠a MP Checkout
      ‚îÇ
      ‚îú‚îÄ‚îÄ Cliente paga TARJETA (Terminal MP del operador)
      ‚îÇ   ‚îî‚îÄ‚îÄ Operador registra ‚Üí Liquidar v√≠a MP Checkout
      ‚îÇ
      ‚îî‚îÄ‚îÄ Cliente paga DIGITAL (Stripe link)
          ‚îî‚îÄ‚îÄ Ya liquidado (no aplica caja)
      ‚îÇ
      ‚ñº
üîî CORTE DE CAJA (21:30)
      ‚îÇ
      ‚ñº
Corte autom√°tico ‚Üí Saldo pendiente
      ‚îÇ
      ‚îú‚îÄ‚îÄ $0 pendiente ‚Üí ‚úÖ Caja limpia
      ‚îÇ
      ‚îî‚îÄ‚îÄ >$0 pendiente ‚Üí ‚ö†Ô∏è Debe liquidar
```

```mermaid
flowchart TD
    A["üåÖ INICIO DEL D√çA 00:00"] --> B["üîß Operador realiza servicios"]
    B --> C{"¬øM√©todo de pago?"}
    
    C -->|Efectivo| D["üíµ Registrar en app"]
    C -->|Tarjeta MP| E["üí≥ Sistema detecta autom√°tico"]
    C -->|Digital Stripe| F["‚úÖ Ya liquidado"]
    
    D --> G["üîî CORTE DE CAJA 21:30"]
    E --> G
    
    G --> H["Corte autom√°tico"]
    H --> I{"¬øSaldo pendiente?"}
    
    I -->|"$0"| J["‚úÖ Caja limpia"]
    I -->|"&gt;$0"| K["‚ö†Ô∏è Debe liquidar"]
```

---


## Estados de la Caja

| Estado | Descripci√≥n | Acci√≥n requerida |
|--------|-------------|------------------|
| `abierta` | D√≠a en curso (antes 21:30) | Ninguna |
| `cerrada` | Corte realizado (despu√©s 21:30) | Depositar si hay saldo |
| `liquidada` | Saldo $0 | Ninguna |
| `pendiente` | Saldo >$0 sin depositar | ‚ö†Ô∏è Urgente |

---

## Modelo de Datos

```sql
CREATE TABLE cajas_diarias (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  operador_id UUID NOT NULL REFERENCES operadores(id),
  fecha DATE NOT NULL DEFAULT CURRENT_DATE,
  
  -- Totales del d√≠a
  total_efectivo DECIMAL(10,2) DEFAULT 0,
  total_tarjeta_mp DECIMAL(10,2) DEFAULT 0,  -- Terminal MercadoPago
  total_digital DECIMAL(10,2) DEFAULT 0,     -- Stripe (ya liquidado)
  
  -- Liquidaciones v√≠a MercadoPago
  efectivo_liquidado DECIMAL(10,2) DEFAULT 0,
  tarjeta_liquidada DECIMAL(10,2) DEFAULT 0,
  
  -- Calculados
  saldo_efectivo DECIMAL(10,2) GENERATED ALWAYS AS 
    (total_efectivo - efectivo_liquidado) STORED,
  saldo_tarjeta DECIMAL(10,2) GENERATED ALWAYS AS 
    (total_tarjeta_mp - tarjeta_liquidada) STORED,
  saldo_total DECIMAL(10,2) GENERATED ALWAYS AS 
    (total_efectivo - efectivo_liquidado + total_tarjeta_mp - tarjeta_liquidada) STORED,
  
  estado VARCHAR(20) DEFAULT 'abierta',
  corte_at TIMESTAMPTZ,  -- 21:30 del d√≠a
  created_at TIMESTAMPTZ DEFAULT now(),
  
  UNIQUE(operador_id, fecha)
);

-- √çndice para cron de corte diario
CREATE INDEX idx_cajas_fecha_estado ON cajas_diarias(fecha, estado);
```

---

## Cron de Corte Diario

```typescript
// Cron: Todos los d√≠as a las 21:30
const corteCajaDiario = async () => {
  const hoy = format(new Date(), 'yyyy-MM-dd');
  
  await supabase.from('cajas_diarias')
    .update({
      estado: 'cerrada',
      corte_at: new Date()
    })
    .eq('fecha', hoy)
    .eq('estado', 'abierta');
  
  // Notificar operadores con saldo pendiente
  const { data: pendientes } = await supabase
    .from('cajas_diarias')
    .select('operador_id, saldo_total')
    .eq('fecha', hoy)
    .gt('saldo_total', 0);
  
  for (const caja of pendientes) {
    await notifyOperador(caja.operador_id, {
      title: '‚è∞ Corte de caja realizado',
      body: `Tienes $${caja.saldo_total} pendiente. Liquida v√≠a MercadoPago.`
    });
  }
};
```

---

## Estructura de Hijos

| ID                                       | Nombre | Descripci√≥n        | Estado |
| ---------------------------------------- | ------ | ------------------ | ------ |
| [[Proyecto OnlyCarNLD/Datos/3.1.9.1.1 registro_cobros\|3.1.9.1.1]] | Cobros | Registro de pagos  | ‚úÖ      |
| [[Proyecto OnlyCarNLD/Datos/3.1.9.1.2 tipos_pago\|3.1.9.1.2]]      | Tipos  | Efectivo/tarjeta   | ‚úÖ      |
| [[Proyecto OnlyCarNLD/Datos/3.1.9.1.3 corte_diario\|3.1.9.1.3]]    | Corte  | Cierre a las 21:30 | ‚úÖ      |

---

## Conexiones

| M√≥dulo | Relaci√≥n |
|--------|----------|
| [[Proyecto OnlyCarNLD/Datos/1.1.6 sistema_pagos]] | Pagos del CLIENTE |
| [[Proyecto OnlyCarNLD/Datos/3.1.8.2.1 corte_semanal]] | Pago AL OPERADOR (viernes) |
| [[Proyecto OnlyCarNLD/Datos/5.11 mercadopago_integracion]] | Liquidaci√≥n de caja |

---

## Navegaci√≥n

| ‚¨ÜÔ∏è Padre             | [[Proyecto OnlyCarNLD/Datos/3.1.9 control_caja]]            |
| -------------------- | --------------------------------- |
| ‚û°Ô∏è Hermano siguiente | [[Proyecto OnlyCarNLD/Datos/3.1.9.2 depositos_efectivo]]    |

---
