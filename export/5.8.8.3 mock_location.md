---
id: 5.8.8.3
title: Mock Location
parent: 5.8.8
breadcrumb: 0 ‚Üí 5.0 ‚Üí 5.8 ‚Üí 5.8.8 ‚Üí 5.8.8.3
type: testing
status: activo
last_updated: 2026-01-29 15:32
file_create: 2026-01-01 18:10
domain:
- testing
- mock
- gps
- desarrollo
summary: 'Simulaci√≥n de ubicaciones GPS para desarrollo y testing.

  Mocks de Capacitor Geolocation y panel de debug.'
content_hash: 887d428cb34b3bef
---

# 5.8.8.3 Mock Location

Simulaci√≥n de ubicaciones GPS para desarrollo y testing.

---

## Mock de Capacitor Geolocation

```typescript
// tests/__mocks__/capacitor-geolocation.ts
import { vi } from 'vitest';

interface MockPosition {
  lat: number;
  lng: number;
  accuracy?: number;
  heading?: number;
  speed?: number;
}

let mockPositions: MockPosition[] = [];
let currentIndex = 0;
let watchCallback: Function | null = null;
let watchInterval: NodeJS.Timeout | null = null;

export const Geolocation = {
  getCurrentPosition: vi.fn(async () => {
    const pos = mockPositions[currentIndex] || { lat: 27.5, lng: -99.5 };
    return {
      coords: {
        latitude: pos.lat,
        longitude: pos.lng,
        accuracy: pos.accuracy || 10,
        altitude: null,
        altitudeAccuracy: null,
        heading: pos.heading || null,
        speed: pos.speed || null
      },
      timestamp: Date.now()
    };
  }),
  
  watchPosition: vi.fn(async (options, callback) => {
    watchCallback = callback;
    
    // Simular updates cada segundo
    watchInterval = setInterval(() => {
      if (watchCallback && mockPositions[currentIndex]) {
        const pos = mockPositions[currentIndex];
        watchCallback({
          coords: {
            latitude: pos.lat,
            longitude: pos.lng,
            accuracy: pos.accuracy || 10,
            heading: pos.heading,
            speed: pos.speed
          },
          timestamp: Date.now()
        });
        currentIndex = (currentIndex + 1) % mockPositions.length;
      }
    }, 1000);
    
    return 'mock-watch-id';
  }),
  
  clearWatch: vi.fn(async () => {
    if (watchInterval) {
      clearInterval(watchInterval);
      watchInterval = null;
    }
    watchCallback = null;
  }),
  
  checkPermissions: vi.fn(async () => ({
    location: 'granted'
  })),
  
  requestPermissions: vi.fn(async () => ({
    location: 'granted'
  }))
};

// Helpers para tests
export const setMockPositions = (positions: MockPosition[]) => {
  mockPositions = positions;
  currentIndex = 0;
};

export const setMockPermission = (status: 'granted' | 'denied' | 'prompt') => {
  Geolocation.checkPermissions.mockResolvedValue({ location: status });
};

export const triggerWatchUpdate = (position: MockPosition) => {
  if (watchCallback) {
    watchCallback({
      coords: {
        latitude: position.lat,
        longitude: position.lng,
        accuracy: position.accuracy || 10,
        heading: position.heading,
        speed: position.speed
      },
      timestamp: Date.now()
    });
  }
};

export const simulateGpsError = (code: 1 | 2 | 3) => {
  const errors = {
    1: { code: 1, message: 'Permission denied' },
    2: { code: 2, message: 'Position unavailable' },
    3: { code: 3, message: 'Timeout' }
  };
  
  if (watchCallback) {
    watchCallback(null, errors[code]);
  }
};
```

---

## Uso en Tests

```typescript
// tests/unit/geo/with-mock.test.ts
import { describe, it, expect, beforeEach } from 'vitest';
import { 
  setMockPositions, 
  triggerWatchUpdate, 
  simulateGpsError 
} from '../__mocks__/capacitor-geolocation';

describe('Geolocation with Mock', () => {
  beforeEach(() => {
    // Definir ruta simulada
    setMockPositions([
      { lat: 27.50, lng: -99.50, speed: 10 },
      { lat: 27.49, lng: -99.51, speed: 12 },
      { lat: 27.48, lng: -99.507, speed: 8 },
      { lat: 27.4797, lng: -99.5067, speed: 0 }  // Llegada
    ]);
  });
  
  it('should follow mock route', async () => {
    const positions: any[] = [];
    
    const { startTracking, position } = useGeolocation();
    
    await startTracking((pos) => {
      positions.push({ ...pos });
    });
    
    // Esperar 4 segundos para recibir todas las posiciones
    await new Promise(r => setTimeout(r, 4500));
    
    expect(positions.length).toBeGreaterThanOrEqual(4);
    
    // √öltima posici√≥n deber√≠a ser el destino
    const last = positions[positions.length - 1];
    expect(last.lat).toBeCloseTo(27.4797, 2);
  });
  
  it('should handle GPS error', async () => {
    const { startTracking, error } = useGeolocation();
    
    await startTracking();
    
    // Simular error de permiso
    simulateGpsError(1);
    
    expect(error.value).toBe('Permission denied');
  });
});
```

---

## Composable de Desarrollo

```typescript
// composables/useDevLocation.ts
// Solo para desarrollo local

export const useDevLocation = () => {
  const isDev = process.env.NODE_ENV === 'development';
  const useMockLocation = ref(false);
  const mockRoute = ref<Array<{ lat: number; lng: number }>>([]);
  
  if (!isDev) {
    return {
      useMockLocation: readonly(ref(false)),
      mockRoute: readonly(ref([])),
      setMockRoute: () => {},
      startMockMovement: () => {}
    };
  }
  
  const setMockRoute = (points: Array<{ lat: number; lng: number }>) => {
    mockRoute.value = points;
  };
  
  // Rutas predefinidas para testing
  const PREDEFINED_ROUTES = {
    nuevoLaredoCentro: [
      { lat: 27.5050, lng: -99.5200 },
      { lat: 27.4950, lng: -99.5150 },
      { lat: 27.4850, lng: -99.5100 },
      { lat: 27.4797, lng: -99.5067 }
    ],
    rutaLarga: [
      // 10km de ruta simulada
      { lat: 27.55, lng: -99.55 },
      { lat: 27.54, lng: -99.54 },
      // ... m√°s puntos
    ]
  };
  
  const loadPredefinedRoute = (name: keyof typeof PREDEFINED_ROUTES) => {
    mockRoute.value = PREDEFINED_ROUTES[name];
  };
  
  return {
    useMockLocation,
    mockRoute: readonly(mockRoute),
    setMockRoute,
    loadPredefinedRoute,
    PREDEFINED_ROUTES
  };
};
```

---

## Panel de Debug (Solo Dev)

```vue
<!-- components/dev/GeoDebugPanel.vue -->
<script setup lang="ts">
const { useMockLocation, mockRoute, loadPredefinedRoute, PREDEFINED_ROUTES } = useDevLocation();
const { position, isTracking } = useGeolocation();

const isDev = process.env.NODE_ENV === 'development';
const isOpen = ref(false);
</script>

<template>
  <div v-if="isDev" class="geo-debug-panel">
    <button @click="isOpen = !isOpen" class="toggle">
      üõ†Ô∏è Geo Debug
    </button>
    
    <div v-if="isOpen" class="panel-content">
      <h4>Estado GPS</h4>
      <pre>{{ JSON.stringify(position, null, 2) }}</pre>
      
      <h4>Tracking: {{ isTracking ? '‚úÖ' : '‚ùå' }}</h4>
      
      <h4>Mock Location</h4>
      <label>
        <input type="checkbox" v-model="useMockLocation" />
        Usar ubicaci√≥n simulada
      </label>
      
      <div v-if="useMockLocation">
        <select @change="loadPredefinedRoute($event.target.value)">
          <option value="">Seleccionar ruta...</option>
          <option 
            v-for="(route, name) in PREDEFINED_ROUTES" 
            :key="name" 
            :value="name"
          >
            {{ name }}
          </option>
        </select>
        
        <p>Puntos en ruta: {{ mockRoute.length }}</p>
      </div>
    </div>
  </div>
</template>

<style scoped>
.geo-debug-panel {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 9999;
}

.toggle {
  padding: 8px 16px;
  background: #333;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
}

.panel-content {
  position: absolute;
  bottom: 100%;
  right: 0;
  margin-bottom: 8px;
  padding: 16px;
  background: #1a1a1a;
  color: white;
  border-radius: 8px;
  min-width: 300px;
  max-height: 400px;
  overflow-y: auto;
}

pre {
  background: #000;
  padding: 8px;
  border-radius: 4px;
  font-size: 12px;
}
</style>
```

---

‚Üí Ver m√≥dulo principal Testing: [[Proyecto OnlyCarNLD/Datos/5.8.8 testing]]

---

## Navegaci√≥n

| ‚¨ÜÔ∏è Padre             | [[Proyecto OnlyCarNLD/Datos/5.8.8 testing]]            |
| -------------------- | ---------------------- |
| ‚¨ÖÔ∏è Hermano anterior  | [[Proyecto OnlyCarNLD/Datos/5.8.8.2 integration_tests]]              |
