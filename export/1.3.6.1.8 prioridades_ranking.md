---
id: 1.3.6.1.8
title: Prioridades y Ranking
parent: 1.3.6.1
breadcrumb: 0 ‚Üí 1.0 ‚Üí 1.3 ‚Üí 1.3.6 ‚Üí 1.3.6.1 ‚Üí 1.3.6.1.8
type: hoja
status: activo
domain: comunicacion
summary: Sistema de puntuaci√≥n para ordenar operadores con score compuesto, factores,
  bonificaciones y dashboard de ranking.
version: 1.0
last_updated: 2026-01-29 15:31
file_create: 2025-12-26 13:08
actors:
- sistema
- admin
dependencies:
- supabase
affects:
- 1.3.6.1 asignacion_citas
content_hash: 5b03e242f7a992ed
---

# 1.3.6.1.8 Prioridades y Ranking

Sistema de puntuaci√≥n para ordenar operadores en el matching.

---

## Score Compuesto

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  SCORE = W‚ÇÅ√óDistancia + W‚ÇÇ√óDisp + W‚ÇÉ√óRating + W‚ÇÑ√óHist + W‚ÇÖ√óPref ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                 ‚îÇ
‚îÇ  Donde:                                                         ‚îÇ
‚îÇ  ‚Ä¢ Distancia: Cercan√≠a al cliente (0-100)                       ‚îÇ
‚îÇ  ‚Ä¢ Disp: Disponibilidad/holgura agenda (0-100)                  ‚îÇ
‚îÇ  ‚Ä¢ Rating: Calificaci√≥n promedio (0-100)                        ‚îÇ
‚îÇ  ‚Ä¢ Hist: Historial de √©xito (0-100)                             ‚îÇ
‚îÇ  ‚Ä¢ Pref: Preferencia del cliente (0-100)                        ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  Pesos (W) var√≠an seg√∫n contexto:                               ‚îÇ
‚îÇ  ‚Ä¢ B2C Standard:  30% / 25% / 20% / 15% / 10%                   ‚îÇ
‚îÇ  ‚Ä¢ Corporate+:    20% / 20% / 25% / 20% / 15%                   ‚îÇ
‚îÇ  ‚Ä¢ Urgente:       40% / 30% / 15% / 10% / 5%                    ‚îÇ
‚îÇ  ‚Ä¢ Premium:       15% / 20% / 35% / 20% / 10%                   ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## Factores de Score

### 1. Distancia (0-100)

```typescript
const scoreDistancia = (distanciaKm: number): number => {
  // 0 km = 100 puntos, 10+ km = 0 puntos
  // Curva lineal
  return Math.max(0, 100 - (distanciaKm * 10));
  
  // Alternativa: curva logar√≠tmica (m√°s suave)
  // return Math.max(0, 100 - (Math.log10(distanciaKm + 1) * 50));
};
```

### 2. Disponibilidad (0-100)

```typescript
const scoreDisponibilidad = (citasDelDia: number, horasLibres: number): number => {
  // Menos citas = m√°s score
  const scoreCitas = Math.max(0, 100 - (citasDelDia * 12.5)); // 8 citas = 0
  
  // M√°s horas libres = m√°s score
  const scoreHoras = Math.min(100, horasLibres * 12.5); // 8+ horas = 100
  
  return (scoreCitas + scoreHoras) / 2;
};
```

### 3. Rating (0-100)

```typescript
const scoreRating = (rating: number): number => {
  // Rating 1-5 normalizado a 0-100
  // Con bonus por rating alto
  const base = ((rating - 1) / 4) * 80; // 1=0, 5=80
  const bonus = rating >= 4.5 ? 20 : (rating >= 4.0 ? 10 : 0);
  
  return Math.min(100, base + bonus);
};
```

### 4. Historial (0-100)

```typescript
const scoreHistorial = (stats: OperadorStats): number => {
  // Combinaci√≥n de m√©tricas
  const tasaExito = (stats.completados / stats.total) * 40;        // 0-40
  const puntualidad = (stats.puntuales / stats.completados) * 30; // 0-30
  const sinCancelaciones = (1 - stats.cancelaciones / stats.total) * 30; // 0-30
  
  return tasaExito + puntualidad + sinCancelaciones;
};
```

### 5. Preferencia Cliente (0-100)

```typescript
const scorePreferencia = (operadorId: string, clienteId: string): number => {
  // ¬øCliente lo ha usado antes?
  const usoPrevio = await hasUsedOperator(clienteId, operadorId);
  
  if (!usoPrevio) return 0;
  
  // ¬øCu√°ntas veces?
  const veces = await countTimesUsed(clienteId, operadorId);
  
  // ¬øLo calific√≥ bien?
  const avgRating = await getAvgRatingForOperator(clienteId, operadorId);
  
  return Math.min(100, (veces * 20) + (avgRating ? avgRating * 10 : 0));
};
```

---

## Modelo de Datos

```sql
-- Tabla de estad√≠sticas de operador (cache)
CREATE TABLE operador_stats (
  operador_id UUID PRIMARY KEY REFERENCES operadores(id),
  
  -- Contadores
  total_servicios INT DEFAULT 0,
  servicios_completados INT DEFAULT 0,
  servicios_cancelados INT DEFAULT 0,
  servicios_puntuales INT DEFAULT 0,
  
  -- Promedios
  rating_promedio DECIMAL(3, 2),
  tiempo_llegada_promedio INT,  -- minutos
  distancia_promedio INT,       -- metros
  
  -- Respuestas a broadcasts
  broadcasts_recibidos INT DEFAULT 0,
  broadcasts_aceptados INT DEFAULT 0,
  broadcasts_rechazados INT DEFAULT 0,
  broadcasts_ignorados INT DEFAULT 0,
  
  -- Score calculado
  score_global DECIMAL(5, 2),
  
  -- Timestamps
  updated_at TIMESTAMPTZ DEFAULT now()
);

-- Recalcular stats diariamente
CREATE OR REPLACE FUNCTION recalcular_stats_operador(p_operador_id UUID)
RETURNS VOID AS $$
BEGIN
  UPDATE operador_stats os
  SET
    total_servicios = (
      SELECT COUNT(*) FROM citas 
      WHERE operador_id = p_operador_id
    ),
    servicios_completados = (
      SELECT COUNT(*) FROM citas 
      WHERE operador_id = p_operador_id AND estado = 'completada'
    ),
    rating_promedio = (
      SELECT AVG(rating) FROM calificaciones
      WHERE operador_id = p_operador_id
    ),
    score_global = (
      -- F√≥rmula simplificada
      (os.servicios_completados::DECIMAL / NULLIF(os.total_servicios, 0) * 100) * 0.4 +
      os.rating_promedio * 20 * 0.4 +
      ((os.broadcasts_aceptados::DECIMAL / NULLIF(os.broadcasts_recibidos, 0)) * 100) * 0.2
    ),
    updated_at = NOW()
  WHERE operador_id = p_operador_id;
END;
$$ LANGUAGE plpgsql;
```

---

## Dashboard: Ranking de Operadores (Admin)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  üèÜ RANKING DE OPERADORES                                       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                 ‚îÇ
‚îÇ  PER√çODO: √öltimo mes ‚ñº                                          ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  POS  OPERADOR      SCORE   SERVICIOS  RATING  ACEPTACI√ìN       ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ    ‚îÇ
‚îÇ  ü•á  Carlos M.      92.4     45         4.8     95%             ‚îÇ
‚îÇ  ü•à  Ana T.         88.7     38         4.9     88%             ‚îÇ
‚îÇ  ü•â  Pedro R.       85.2     42         4.5     90%             ‚îÇ
‚îÇ   4  Mar√≠a G.       81.0     35         4.6     82%             ‚îÇ
‚îÇ   5  Juan P.        78.5     40         4.4     79%             ‚îÇ
‚îÇ  ...                                                            ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  ‚ö†Ô∏è OPERADORES CON BAJO RENDIMIENTO:                            ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ  ‚îÇ  Luis R.   Score: 45.2   Rating: 3.2   Tasa rechazo: 60%‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  [ Ver detalles ] [ Notificar ] [ Suspender ]           ‚îÇ    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## Bonificaciones y Penalizaciones

| Factor | Efecto | Aplicaci√≥n |
|--------|--------|------------|
| **Nuevo operador** | +10 puntos | Primeras 10 citas |
| **Racha de √©xito** | +5 puntos | 5+ completadas seguidas |
| **Cancelaci√≥n** | -15 puntos | Por cada cancelaci√≥n |
| **Late arrival** | -5 puntos | Lleg√≥ >15 min tarde |
| **5 estrellas** | +3 puntos | Por cada calificaci√≥n 5‚≠ê |
| **Queja cliente** | -20 puntos | Por queja verificada |

---

## Composable: useOperatorRanking

```typescript
// composables/useOperatorRanking.ts
export const useOperatorRanking = () => {
  const supabase = useSupabaseClient();
  
  const getTopOperators = async (limit: number = 10) => {
    const { data } = await supabase
      .from('operador_stats')
      .select(`
        operador_id,
        score_global,
        total_servicios,
        rating_promedio,
        operadores (nombre, foto_url)
      `)
      .order('score_global', { ascending: false })
      .limit(limit);
    
    return data;
  };
  
  const getOperatorScore = async (operadorId: string) => {
    const { data } = await supabase
      .from('operador_stats')
      .select('*')
      .eq('operador_id', operadorId)
      .single();
    
    return data;
  };
  
  const recalculateAll = async () => {
    // Llamar funci√≥n RPC
    await supabase.rpc('recalcular_todos_stats');
  };
  
  return { getTopOperators, getOperatorScore, recalculateAll };
};
```

---

## Navegaci√≥n

| ‚¨ÜÔ∏è Padre             | [[Proyecto OnlyCarNLD/Datos/1.3.6.1 asignacion_citas]]           |
| -------------------- | -------------------------------------- |
| ‚¨ÖÔ∏è Hermano anterior  | [[Proyecto OnlyCarNLD/Datos/1.3.6.1.7 fallback_manual]]          |
| ‚û°Ô∏è Hermano siguiente | [[Proyecto OnlyCarNLD/Datos/1.3.6.1.9 configuracion_operador]]   |

---
