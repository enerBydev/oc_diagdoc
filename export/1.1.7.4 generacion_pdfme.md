---
id: 1.1.7.4
title: Generaci√≥n de Contratos con PDFme
parent: 1.1.7
breadcrumb: 0 ‚Üí 1.0 ‚Üí 1.1 ‚Üí 1.1.7 ‚Üí 1.1.7.4
type: integracion
status: activo
last_updated: 2026-01-29 16:05
file_create: 2025-12-23 10:54
domain:
- pdfme
- generacion
- pdf
- contratos
summary: 'Integraci√≥n con PDFme para generar contratos PDF desde plantillas JSON.

  Composable useContratoPDF, flujo formulario‚ÜíMifiel, API endpoint.

  '
content_hash: 68f862e5ef7195b7
---

# 1.1.7.4 Generaci√≥n de Contratos con PDFme

> Integraci√≥n con PDFme para generar contratos PDF desde plantillas JSON.

---

## ¬øPor qu√© PDFme?

| Caracter√≠stica | Beneficio |
|----------------|-----------|
| **Open Source** | Sin costos de licencia |
| **Client-side** | Generaci√≥n en el navegador, sin servidor |
| **JSON Schema** | Plantillas f√°ciles de modificar |
| **Typescript** | Tipado fuerte, mejor DX |
| **Vue compatible** | Integraci√≥n con Nuxt |

---

## Arquitectura de Generaci√≥n

```mermaid
flowchart LR
    subgraph INPUT
        FORM[Formulario<br/>Contrato]
        JSON[JSON Schema<br/>+ Datos]
    end
    
    subgraph PROCESO
        PDFME[PDFme<br/>Engine]
        BLOB[PDF Blob<br/>Preview]
        B64[Base64<br/>Encoded]
    end
    
    subgraph OUTPUT
        MIFIEL[Mifiel<br/>API]
    end
    
    FORM --> JSON
    JSON --> PDFME
    PDFME --> BLOB
    BLOB --> B64
    B64 --> MIFIEL
```

---

## Componentes del Sistema

### 1. Template JSON (Plantilla Base)

```json
{
  "schemas": [
    {
      "header": { "type": "text", "position": { "x": 10, "y": 10 } },
      "logo": { "type": "image", "position": { "x": 150, "y": 10 } },
      "titulo": { "type": "text", "fontSize": 18, "fontWeight": "bold" },
      "partes": { "type": "multitext" },
      "clausulas": { "type": "table" },
      "firmas": { "type": "signature" }
    }
  ],
  "basePdf": "contrato_base.pdf"
}
```

### 2. Input Data (Datos del Formulario)

```json
{
  "numero_contrato": "CONT-B2B-[a√±o]-[mes]-[dia]-[numero-aleatorio]",
  "fecha_generacion": "2025-01-15",
  "cliente_razon_social": "Empresa XYZ S.A. de C.V.",
  "cliente_rfc": "XYZ123456ABC",
  "cliente_representante": "Juan Carlos P√©rez",
  "paquete": "Express Flotilla",
  "vehiculos": 15,
  "precio_unitario": "$224 MXN",
  "descuento_total": "35%",
  "fecha_inicio": "01/02/2025",
  "fecha_vencimiento": "31/01/2026",
  ...
}
```

### 3. Generated PDF

Documento PDF profesional con:
- Encabezado con logo OnlyCar
- N√∫mero √∫nico de contrato
- Todas las cl√°usulas formateadas
- Espacios para firmas digitales
---

## Integraci√≥n Nuxt + PDFme

### Instalaci√≥n

```bash
npm install @pdfme/generator @pdfme/schemas
```

### Composable: `useContratoPDF`

```typescript
// composables/useContratoPDF.ts
import { generate } from '@pdfme/generator';
import { text, image, table } from '@pdfme/schemas';

export const useContratoPDF = () => {
  const template = ref<Template>(null);
  const isGenerating = ref(false);
  
  // Cargar plantilla base
  const loadTemplate = async () => {
    const response = await fetch('/templates/contrato_b2b.json');
    template.value = await response.json();
  };
  
  // Generar PDF desde formulario
  const generatePDF = async (formData: ContratoFormData): Promise<Blob> => {
    isGenerating.value = true;
    
    const inputs = mapFormDataToInputs(formData);
    
    const pdf = await generate({
      template: template.value,
      inputs: [inputs],
      plugins: { text, image, table }
    });
    
    isGenerating.value = false;
    return new Blob([pdf], { type: 'application/pdf' });
  };
  
  // Preview en el navegador
  const previewPDF = async (formData: ContratoFormData) => {
    const blob = await generatePDF(formData);
    const url = URL.createObjectURL(blob);
    window.open(url, '_blank');
  };
  
  // Convertir a Base64 para Mifiel
  const toBase64 = async (formData: ContratoFormData): Promise<string> => {
    const blob = await generatePDF(formData);
    return blobToBase64(blob);
  };
  
  return {
    loadTemplate,
    generatePDF,
    previewPDF,
    toBase64,
    isGenerating
  };
};
```

---

## Flujo Completo: Formulario ‚Üí Mifiel

```mermaid
flowchart TD
    A[Admin completa formulario] --> B[Click Generar PDF]
    B --> C[useContratoPDF.generatePDF]
    C --> D[Preview en navegador]
    D --> E{¬øOK?}
    E -->|No| A
    E -->|S√≠| F[Click Enviar a Firma]
    F --> G[toBase64]
    G --> H[POST /api/contracts]
    H --> I[Server ‚Üí Mifiel API]
    I --> J[Guarda document_id]
    J --> K[Mifiel env√≠a invitaciones]
```

---

## API Endpoint

### POST `/api/contracts`

```typescript
// server/api/contracts.post.ts
export default defineEventHandler(async (event) => {
  const { pdfBase64, firmantes, metadata } = await readBody(event);
  
  // 1. Subir a Mifiel
  const mifiel = useMifiel();
  const document = await mifiel.createDocument({
    file_base64: pdfBase64,
    signatories: firmantes.map(f => ({
      name: f.name,
      email: f.email,
      tax_id: f.rfc
    })),
    send_invites: true
  });
  
  // 2. Guardar en DB
  const contract = await db.insert(contracts).values({
    mifiel_document_id: document.id,
    status: 'pending_signature',
    client_id: metadata.clientId,
    ...metadata
  });
  
  return { success: true, contractId: contract.id };
});
```

---

## Almacenamiento de Plantillas

```
/public
‚îî‚îÄ‚îÄ /templates
    ‚îú‚îÄ‚îÄ contrato_b2b.json           ‚Üê Plantilla principal
    ‚îú‚îÄ‚îÄ contrato_b2b_basepdf.pdf    ‚Üê PDF base (opcional)
    ‚îî‚îÄ‚îÄ /assets
        ‚îú‚îÄ‚îÄ logo_onlycar.png
        ‚îî‚îÄ‚îÄ firma_placeholder.png
```

---

## Personalizaci√≥n

| Elemento | Personalizable | C√≥mo |
|----------|----------------|------|
| Logo | ‚úÖ | Reemplazar imagen en assets |
| Colores | ‚úÖ | Modificar JSON schema |
| Fuentes | ‚úÖ | Agregar fuentes custom |
| Cl√°usulas | ‚úÖ | Editar template JSON |
| Dise√±o | ‚úÖ | Usar PDFme Designer (GUI) |

---

## Dependencias

```bash
npm install @pdfme/generator @pdfme/schemas @pdfme/ui
```
Acceso: `/admin/contract-template-designer`

- `@pdfme/generator`: ^4.x
- `@pdfme/schemas`: ^4.x
- `@pdfme/ui`: ^4.x (opcional, para designer)

---

## Navegaci√≥n

| ‚¨ÜÔ∏è Padre             | [[Proyecto OnlyCarNLD/Datos/1.1.7 contratos_b2b]]            |
| -------------------- | ---------------------------------- |
| ‚¨ÖÔ∏è Hermano anterior  | [[Proyecto OnlyCarNLD/Datos/1.1.7.3 formulario_contrato]]    |
| ‚û°Ô∏è Hermano siguiente | [[Proyecto OnlyCarNLD/Datos/1.1.7.5 registro_empresa_b2b]]   |
| üîó Ver tambi√©n       | [[Proyecto OnlyCarNLD/Datos/5.7. pdfme_generacion]]          |

---
