---
id: 1.3.7.3
title: Vista Unificada
parent: 1.3.7
breadcrumb: 0 â†’ 1.0 â†’ 1.3 â†’ 1.3.7 â†’ 1.3.7.3
type: hoja
status: activo
domain: comunicacion
summary: Componente y composable useAdminChatHub para la vista de conversaciones unificada
  del Admin con tiempo real.
version: 1.0
last_updated: 2026-01-29 15:31
file_create: 2025-12-24 10:32
actors:
- admin
dependencies:
- nuxt
- supabase
affects:
- 1.3.7 hub_chat_admin
content_hash: 9c64a984d1bc9e84
---

# 1.3.7.3 Vista Unificada

Componente y composable para la vista del Admin.

---

## Arquitectura

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ChatHubView.vue                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                       â”‚                                         â”‚
â”‚   ConversationList    â”‚        ConversationDetail               â”‚
â”‚   (30% width)         â”‚        (70% width)                      â”‚
â”‚                       â”‚                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚ Filtros       â”‚   â”‚   â”‚ Header (nombre, tipo, estado)   â”‚   â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚   â”‚ Items list    â”‚   â”‚   â”‚                                 â”‚   â”‚
â”‚   â”‚ â€¢ Nombre      â”‚   â”‚   â”‚ Messages Area                   â”‚   â”‚
â”‚   â”‚ â€¢ Preview     â”‚   â”‚   â”‚ (scroll infinito)               â”‚   â”‚
â”‚   â”‚ â€¢ Tiempo      â”‚   â”‚   â”‚                                 â”‚   â”‚
â”‚   â”‚ â€¢ Badge       â”‚   â”‚   â”‚                                 â”‚   â”‚
â”‚   â”‚               â”‚   â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚   â”‚               â”‚   â”‚   â”‚ Input + Plantillas              â”‚   â”‚
â”‚   â”‚               â”‚   â”‚   â”‚                                 â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                       â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Composable Principal

```typescript
// composables/useAdminChatHub.ts
export const useAdminChatHub = () => {
  const supabase = useSupabaseClient();
  const user = useSupabaseUser();
  
  // Estado
  const conversaciones = ref<Conversacion[]>([]);
  const conversacionActiva = ref<Conversacion | null>(null);
  const mensajes = ref<Mensaje[]>([]);
  const cargando = ref(false);
  
  // Filtros
  const filtros = ref<Filtros>({
    tipoUsuario: 'todos',
    estado: 'todos',
    urgencia: 'todas',
    busqueda: ''
  });
  
  // Cargar todas las conversaciones (Admin ve todo)
  const cargarConversaciones = async () => {
    cargando.value = true;
    
    const { data } = await supabase
      .from('conversations')
      .select(`
        *,
        participante:users!participant_2_id(
          id, nombre, email, tipo, avatar_url
        ),
        ultimo_mensaje:messages(content, created_at)
      `)
      .order('last_message_at', { ascending: false });
    
    conversaciones.value = data?.map(c => ({
      ...c,
      urgencia: calcularUrgencia(c),
      tipoVisual: getTipoVisual(c.participante.tipo)
    })) || [];
    
    cargando.value = false;
  };
  
  // SuscripciÃ³n tiempo real
  const suscribirseATodas = () => {
    return supabase
      .channel('admin-all-conversations')
      .on('postgres_changes', {
        event: '*',
        schema: 'public',
        table: 'messages'
      }, (payload) => {
        handleNuevoMensaje(payload);
      })
      .subscribe();
  };
  
  // Filtrar conversaciones
  const conversacionesFiltradas = computed(() => {
    return conversaciones.value.filter(c => {
      // Tipo usuario
      if (filtros.value.tipoUsuario !== 'todos') {
        if (c.participante.tipo !== filtros.value.tipoUsuario) return false;
      }
      
      // Estado
      if (filtros.value.estado !== 'todos') {
        if (c.estado !== filtros.value.estado) return false;
      }
      
      // BÃºsqueda
      if (filtros.value.busqueda) {
        const buscar = filtros.value.busqueda.toLowerCase();
        if (!c.participante.nombre.toLowerCase().includes(buscar)) {
          return false;
        }
      }
      
      return true;
    });
  });
  
  // Contadores por tipo
  const contadores = computed(() => ({
    todos: conversaciones.value.length,
    operador: conversaciones.value.filter(c => 
      c.participante.tipo === 'operador').length,
    b2c: conversaciones.value.filter(c => 
      c.participante.tipo === 'cliente_b2c').length,
    corporate: conversaciones.value.filter(c => 
      c.participante.tipo === 'cliente_corporate_plus').length,
    b2b: conversaciones.value.filter(c => 
      c.participante.tipo === 'cliente_b2b').length
  }));
  
  return {
    conversaciones: conversacionesFiltradas,
    conversacionActiva,
    mensajes,
    cargando,
    filtros,
    contadores,
    cargarConversaciones,
    suscribirseATodas
  };
};
```

---

## Helpers

```typescript
const getTipoVisual = (tipo: string) => {
  const tipos = {
    operador: { icono: 'ğŸ› ï¸', color: 'gray', label: 'Operador' },
    cliente_b2c: { icono: 'ğŸ‘¤', color: 'blue', label: 'B2C' },
    cliente_corporate_plus: { icono: 'â­', color: 'purple', label: 'Corp+' },
    cliente_b2b: { icono: 'ğŸ¢', color: 'green', label: 'B2B' }
  };
  return tipos[tipo] || tipos.cliente_b2c;
};

const calcularUrgencia = (conv: Conversacion) => {
  // Incidencia abierta
  if (conv.tiene_incidencia_abierta) return 'urgente';
  
  // Queja sin resolver
  if (conv.tiene_queja_pendiente) return 'urgente';
  
  // Mensaje sin leer >4 horas
  const horasSinLeer = horasDesde(conv.ultimo_mensaje_at);
  if (!conv.leido && horasSinLeer > 4) return 'urgente';
  
  // Mensaje sin leer <4 horas
  if (!conv.leido) return 'pendiente';
  
  return 'resuelto';
};
```

---

## NavegaciÃ³n

| â¬†ï¸ Padre             | [[Proyecto OnlyCarNLD/Datos/1.3.7 hub_chat_admin]]           |
| -------------------- | ---------------------------------- |
| â¬…ï¸ Hermano anterior  | [[Proyecto OnlyCarNLD/Datos/1.3.7.2 acciones_masivas]]       |
| â¡ï¸ Hermano siguiente | [[Proyecto OnlyCarNLD/Datos/1.3.7.4 atajos_productividad]]   |

---
