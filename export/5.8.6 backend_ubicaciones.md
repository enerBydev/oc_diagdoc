---
id: 5.8.6
title: Backend Ubicaciones
parent: '5.8'
breadcrumb: 0 ‚Üí 5.0 ‚Üí 5.8 ‚Üí 5.8.6
type: modulo_padre
children_count: 5
descendants_count: 15
status: activo
last_updated: 2026-01-29 15:31
file_create: 2026-01-01 18:10
domain:
- api
- supabase
- ubicaciones
summary: API y almacenamiento de ubicaciones.
content_hash: 94979ed012e65f1a
---

# 5.8.6 Backend de Ubicaciones

Sistema de persistencia y procesamiento de ubicaciones en el servidor.

---

## Arquitectura

```mermaid
flowchart LR
    subgraph CLIENTE[üì± Cliente]
        A[Capacitor GPS]
    end
    
    subgraph EDGE[‚òÅÔ∏è Cloudflare Edge]
        B[Worker Validaci√≥n]
        C[KV Cache]
    end
    
    subgraph BACKEND[üóÑÔ∏è Supabase]
        D[Realtime Broadcast]
        E[PostgreSQL]
        F[RLS Policies]
    end
    
    A --> B
    B --> C
    B --> D
    D --> E
    E --> F
```

---

## Stack Espec√≠fico

| Componente | Tecnolog√≠a | Funci√≥n |
|------------|------------|---------|
| **API Routes** | Nitro v3 | Endpoints RESTful |
| **Database** | Supabase/PostgreSQL | Persistencia ubicaciones |
| **Security** | RLS Policies | Control acceso por servicio |
| **Cache** | Cloudflare KV | √öltima ubicaci√≥n r√°pida |
| **Edge Processing** | Cloudflare Workers | Validaci√≥n y filtrado |

---

## Flujo de Datos

```
1. Operador env√≠a ubicaci√≥n (Capacitor)
        ‚Üì
2. Cloudflare Worker valida payload
   - Formato correcto
   - Coordenadas v√°lidas
   - Usuario autenticado
        ‚Üì
3. Supabase Realtime broadcast (inmediato)
        ‚Üì
4. Cloudflare KV actualiza √∫ltima ubicaci√≥n (cache)
        ‚Üì
5. PostgreSQL guarda historial (as√≠ncrono, opcional)
```

---

## Decisiones de Dise√±o

> [!IMPORTANT]
> **Decisi√≥n adoptada: Opci√≥n C (Historial Completo con Autolimpieza)**
> 
> - Persistir todas las ubicaciones durante el servicio
> - Limpieza autom√°tica a 30 d√≠as (excepto llegadas y disputas)
> - Retenci√≥n de ubicaciones de llegada: 1 a√±o
> - Storage estimado: ~18 KB/servicio, ~22 MB/a√±o
> - Justificaci√≥n: Evidencia B2B, analytics, diferenciador

---

## Estructura de Hijos

| ID                                         | Nombre                | Descripci√≥n              | Nietos | Estado |
| ------------------------------------------ | --------------------- | ------------------------ | ------ | ------ |
| [[Proyecto OnlyCarNLD/Datos/5.8.6.1 nitro_endpoints\|5.8.6.1]]       | Nitro Endpoints       | API endpoints            | 0      | ‚úÖ      |
| [[Proyecto OnlyCarNLD/Datos/5.8.6.2 supabase_schema\|5.8.6.2]]       | Supabase Schema       | Esquema BD ubicaciones   | 0      | ‚úÖ      |
| [[Proyecto OnlyCarNLD/Datos/5.8.6.3 rls_policies\|5.8.6.3]]          | RLS Policies          | Pol√≠ticas RLS            | 0      | ‚úÖ      |
| [[Proyecto OnlyCarNLD/Datos/5.8.6.4 cloudflare_edge\|5.8.6.4]]       | Cloudflare Edge       | Workers y KV cache       | 0      | ‚úÖ      |
| [[Proyecto OnlyCarNLD/Datos/5.8.6.5 historial_ubicaciones\|5.8.6.5]] | Historial Ubicaciones | Almacenamiento hist√≥rico | 0 | ‚úÖ      |

---

## Variables de Entorno

```env
# Supabase
SUPABASE_URL=https://xxxxx.supabase.co
SUPABASE_ANON_KEY=eyJhbGc...
SUPABASE_SERVICE_ROLE_KEY=eyJhbGc... # Solo server-side

# Cloudflare
CLOUDFLARE_KV_NAMESPACE_ID=xxxxx
CLOUDFLARE_ACCOUNT_ID=xxxxx
```

---

‚Üí Ver Nitro endpoints: [[Proyecto OnlyCarNLD/Datos/5.8.6.1 nitro_endpoints]]

---

## Navegaci√≥n

| ‚¨ÜÔ∏è Padre             | [[Proyecto OnlyCarNLD/Datos/5.8. geolocalizacion]]            |
| -------------------- | ---------------------- |
| ‚¨ÖÔ∏è Hermano anterior  | [[Proyecto OnlyCarNLD/Datos/5.8.5 deteccion_llegada]]              |
| ‚û°Ô∏è Hermano siguiente | [[Proyecto OnlyCarNLD/Datos/5.8.7 edge_cases]]              |
