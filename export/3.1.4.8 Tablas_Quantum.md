---
id: 3.1.4.8
title: Tablas Quantum
parent: 3.1.4
breadcrumb: 0 → 3.0 → 3.1 → 3.1.4 → 3.1.4.8
type: hoja
status: activo
last_updated: 2026-01-29 15:32
file_create: 2026-01-14 18:05
domain:
- sql
- quantum
- auditoria
- simulacion
actors:
- sistema
- auditor
summary: Definición SQL para los módulos de 'Cerebro' (3.7), 'Oráculo' (3.8) y 'Juez'
  (3.9). Persistencia de decisiones autónomas y auditoría.
content_hash: 7e052039888841e3
---

# 3.1.4.8 Tablas Quantum (Lógica Avanzada)

> Persistencia para los módulos de Inteligencia, Simulación y Auditoría.

---

## 1. Auditoría Lógica (3.9)

### decision_logs
> Referencia: Para módulo [[Proyecto OnlyCarNLD/Datos/3.6.3 trazabilidad_decisiones]]

La "Caja Negra". Registra decisiones automáticas tomadas por el sistema.

```sql
CREATE TABLE IF NOT EXISTS decision_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  event_id UUID NOT NULL, -- UUID único del evento
  timestamp TIMESTAMPTZ DEFAULT NOW(),
  
  actor VARCHAR(100) NOT NULL, -- ej: 'system:dynamic_pricing'
  action VARCHAR(50) NOT NULL, -- ej: 'PRICE_JUMP'
  
  -- Contexto y Decisión en formato JSONB para flexibilidad
  context JSONB NOT NULL,
  decision JSONB NOT NULL,
  
  -- Firma criptográfica para inmutabilidad
  signature VARCHAR(64) NOT NULL,
  
  created_at TIMESTAMPTZ DEFAULT NOW()
) PARTITION BY RANGE (created_at);

-- Particionado mensual para manejo de volumen
CREATE TABLE decision_logs_2026_01 PARTITION OF decision_logs
  FOR VALUES FROM ('2026-01-01') TO ('2026-02-01');

CREATE INDEX idx_decision_logs_actor ON decision_logs(actor);
CREATE INDEX idx_decision_logs_timestamp ON decision_logs(timestamp);
```

### anomalias_detectadas
> Referencia: Para módulo [[Proyecto OnlyCarNLD/Datos/3.6.2 deteccion_anomalias]]

Alertas generadas por los Watchdogs del sistema.

```sql
CREATE TABLE IF NOT EXISTS anomalias_detectadas (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tipo VARCHAR(50) NOT NULL, -- 'drift', 'integrity', 'fraud'
  severidad INTEGER NOT NULL CHECK (severidad BETWEEN 1 AND 5),
  
  detalles JSONB NOT NULL,
  
  estado VARCHAR(20) DEFAULT 'open' CHECK (estado IN ('open', 'investigating', 'resolved', 'false_positive')),
  resolucion_nota TEXT,
  resolved_at TIMESTAMPTZ,
  resolved_by UUID REFERENCES auth.users(id),
  
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_anomalias_estado ON anomalias_detectadas(estado);
CREATE INDEX idx_anomalias_tipo ON anomalias_detectadas(tipo);
```

---

## 2. Simulación Financiera (3.8)

### `simulacion_runs` (Para 3.8.1)

Resultados de ejecuciones de Monte Carlo y Stress Tests.

```sql
CREATE TABLE IF NOT EXISTS simulacion_runs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tipo VARCHAR(50) NOT NULL, -- 'monte_carlo', 'stress_test'
  parametros_input JSONB NOT NULL, -- Variables de entrada usadas
  
  resultado_summary JSONB NOT NULL, -- P10, P50, P90, BreakEvenPoint
  
  ejecutado_por UUID REFERENCES auth.users(id),
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

---

## 3. Lógica Autosuficiencia (3.7)

### dynamic_pricing_state
> Referencia: Para módulo [[Proyecto OnlyCarNLD/Datos/3.1.11.6.1 algoritmo_ajuste_precios]]

Estado actual de los multiplicadores de precio por zona. La "memoria" del algoritmo de precios.

```sql
CREATE TABLE IF NOT EXISTS dynamic_pricing_state (
  zona_id VARCHAR(50) PRIMARY KEY, -- ej: 'NLD_CENTRO'
  
  multiplicador_actual DECIMAL(4,2) DEFAULT 1.0,
  ultimo_cambio TIMESTAMPTZ DEFAULT NOW(),
  
  -- Factores individuales para trazabilidad
  factor_demanda DECIMAL(4,2) DEFAULT 1.0,
  factor_clima DECIMAL(4,2) DEFAULT 1.0,
  factor_escasez DECIMAL(4,2) DEFAULT 1.0,
  
  active_alerts JSONB DEFAULT '[]'::jsonb, -- Alertas activas en la zona
  
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Trigger para historial de cambios (Opcional: guardar histórico en decision_logs)
```

---

## RLS Policies

```sql
ALTER TABLE decision_logs ENABLE ROW LEVEL SECURITY;
ALTER TABLE anomalias_detectadas ENABLE ROW LEVEL SECURITY;
ALTER TABLE simulacion_runs ENABLE ROW LEVEL SECURITY;
ALTER TABLE dynamic_pricing_state ENABLE ROW LEVEL SECURITY;

-- Solo el sistema (Service Role) o Admins pueden escribir aquí
-- Lectura permitida a Admin
```

---

## Navegación

| ⬆️ Padre | [[Proyecto OnlyCarNLD/Datos/3.1.4 esquema_sql_logica_negocio]] |
|----------|--------------------------------------|
| ⬅️ Anterior | [[Proyecto OnlyCarNLD/Datos/3.1.4.7 Triggers_Functions]] |
