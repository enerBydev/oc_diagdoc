---
id: 1.3.6.1.14.1
title: Estrategias de BÃºsqueda
parent: 1.3.6.1.14
breadcrumb: 0 â†’ 1.0 â†’ 1.3 â†’ 1.3.6 â†’ 1.3.6.1 â†’ 1.3.6.1.14 â†’ 1.3.6.1.14.1
type: hoja
status: activo
domain: comunicacion
summary: LÃ³gica SQL para encontrar operadores en horarios alternativos (Â±2h) y fechas
  cercanas (+3 dÃ­as) cuando no hay match directo.
version: 1.0
last_updated: 2026-01-29 15:32
file_create: 2025-12-26 17:52
actors:
- sistema
dependencies:
- supabase
affects:
- 1.3.6.1.14 matching_alternativo
content_hash: f33aa8e3fe7c4bd1
---

# 1.3.6.1.14.1 Estrategias de BÃºsqueda

LÃ³gica para encontrar alternativas cuando no hay match.

---

## Estrategia 1: Ampliar Horario (Â±2h)

```sql
-- Buscar operadores en horario cercano
CREATE OR REPLACE FUNCTION buscar_horario_alternativo(
  p_cliente_id UUID,
  p_lat DECIMAL,
  p_lng DECIMAL,
  p_fecha DATE,
  p_hora_original TIME,
  p_servicio_id UUID,
  p_rango_horas INT DEFAULT 2
)
RETURNS TABLE (
  hora_alternativa TIME,
  operador_id UUID,
  operador_nombre TEXT,
  distancia_km DECIMAL
) AS $$
DECLARE
  v_ciudad_cliente UUID;
  v_hora_inicio TIME;
  v_hora_fin TIME;
  v_duracion_servicio INT;
BEGIN
  -- Obtener ciudad y duraciÃ³n
  SELECT ciudad_id INTO v_ciudad_cliente FROM clientes WHERE id = p_cliente_id;
  SELECT duracion_minutos INTO v_duracion_servicio FROM servicios WHERE id = p_servicio_id;
  
  -- Generar horarios alternativos cada 30 minutos
  FOR v_hora_inicio IN 
    SELECT generate_series(
      (p_hora_original - (p_rango_horas || ' hours')::INTERVAL)::TIME,
      (p_hora_original + (p_rango_horas || ' hours')::INTERVAL)::TIME,
      '30 minutes'::INTERVAL
    )::TIME
  LOOP
    -- No incluir el horario original
    IF v_hora_inicio = p_hora_original THEN
      CONTINUE;
    END IF;
    
    v_hora_fin := v_hora_inicio + (v_duracion_servicio || ' minutes')::INTERVAL;
    
    -- Buscar operadores disponibles en este horario
    RETURN QUERY
    SELECT 
      v_hora_inicio,
      o.id,
      o.nombre,
      calcular_distancia(o.lat_base, o.lng_base, p_lat, p_lng) / 1000
    FROM operadores o
    WHERE o.ciudad_id = v_ciudad_cliente
      AND o.estado = 'activo'
      AND EXISTS (
        SELECT 1 FROM servicios_operador so
        WHERE so.operador_id = o.id AND so.servicio_id = p_servicio_id AND so.habilitado = true
      )
      AND NOT EXISTS (
        SELECT 1 FROM citas c
        WHERE c.operador_id = o.id
          AND c.fecha = p_fecha
          AND c.estado NOT IN ('cancelada', 'rechazada')
          AND c.hora_inicio < v_hora_fin
          AND c.hora_fin > v_hora_inicio
      )
    ORDER BY ABS(EXTRACT(EPOCH FROM (v_hora_inicio - p_hora_original)))
    LIMIT 1;
  END LOOP;
END;
$$ LANGUAGE plpgsql;
```

---

## Estrategia 2: Fecha Alternativa

```sql
-- Buscar en fechas cercanas
CREATE OR REPLACE FUNCTION buscar_fecha_alternativa(
  p_cliente_id UUID,
  p_lat DECIMAL,
  p_lng DECIMAL,
  p_fecha_original DATE,
  p_hora TIME,
  p_servicio_id UUID,
  p_rango_dias INT DEFAULT 3
)
RETURNS TABLE (
  fecha_alternativa DATE,
  operador_id UUID,
  operador_nombre TEXT
) AS $$
DECLARE
  v_fecha DATE;
BEGIN
  FOR v_fecha IN 
    SELECT generate_series(
      p_fecha_original + INTERVAL '1 day',
      p_fecha_original + (p_rango_dias || ' days')::INTERVAL,
      '1 day'::INTERVAL
    )::DATE
  LOOP
    RETURN QUERY
    SELECT 
      v_fecha,
      o.id,
      o.nombre
    FROM operadores o
    JOIN clientes c ON c.id = p_cliente_id
    WHERE o.ciudad_id = c.ciudad_id
      AND o.estado = 'activo'
      AND EXISTS (
        SELECT 1 FROM servicios_operador so
        WHERE so.operador_id = o.id AND so.servicio_id = p_servicio_id AND so.habilitado = true
      )
      AND NOT EXISTS (
        SELECT 1 FROM citas ci
        WHERE ci.operador_id = o.id
          AND ci.fecha = v_fecha
          AND ci.hora_inicio = p_hora
          AND ci.estado NOT IN ('cancelada', 'rechazada')
      )
    LIMIT 1;
  END LOOP;
END;
$$ LANGUAGE plpgsql;
```

---

## Composable: useAlternativeMatching

```typescript
// composables/useAlternativeMatching.ts
interface AlternativaHorario {
  hora: string;
  operador_id: string;
  operador_nombre: string;
  distancia_km: number;
}

interface AlternativaFecha {
  fecha: string;
  operador_id: string;
  operador_nombre: string;
}

export const useAlternativeMatching = () => {
  const supabase = useSupabaseClient();
  
  const buscarAlternativas = async (solicitud: {
    clienteId: string;
    lat: number;
    lng: number;
    fecha: string;
    hora: string;
    servicioId: string;
  }) => {
    // 1. Buscar horarios alternativos
    const { data: horarios } = await supabase.rpc('buscar_horario_alternativo', {
      p_cliente_id: solicitud.clienteId,
      p_lat: solicitud.lat,
      p_lng: solicitud.lng,
      p_fecha: solicitud.fecha,
      p_hora_original: solicitud.hora,
      p_servicio_id: solicitud.servicioId,
      p_rango_horas: 2
    });
    
    // 2. Buscar fechas alternativas
    const { data: fechas } = await supabase.rpc('buscar_fecha_alternativa', {
      p_cliente_id: solicitud.clienteId,
      p_lat: solicitud.lat,
      p_lng: solicitud.lng,
      p_fecha_original: solicitud.fecha,
      p_hora: solicitud.hora,
      p_servicio_id: solicitud.servicioId,
      p_rango_dias: 3
    });
    
    return {
      horariosAlternativos: horarios || [],
      fechasAlternativas: fechas || [],
      hayAlternativas: (horarios?.length || 0) + (fechas?.length || 0) > 0
    };
  };
  
  const seleccionarAlternativa = async (tipo: 'horario' | 'fecha', alternativa: any, solicitudId: string) => {
    // Actualizar solicitud con la alternativa elegida
    if (tipo === 'horario') {
      await supabase
        .from('solicitudes')
        .update({
          hora_inicio: alternativa.hora,
          estado: 'pendiente_matching'
        })
        .eq('id', solicitudId);
    } else {
      await supabase
        .from('solicitudes')
        .update({
          fecha: alternativa.fecha,
          estado: 'pendiente_matching'
        })
        .eq('id', solicitudId);
    }
    
    // Re-ejecutar matching con nuevos parÃ¡metros
    // ...
  };
  
  return { buscarAlternativas, seleccionarAlternativa };
};
```

---

## UI: Resultados de BÃºsqueda

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ” ALTERNATIVAS ENCONTRADAS                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Tu solicitud original: MaÃ±ana 10:00 AM                         â”‚
â”‚                                                                 â”‚
â”‚  â° OTROS HORARIOS MAÃ‘ANA:                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ 08:00 AM â”‚ Carlos M. â”‚ 2.1 km â”‚ [ Elegir ]              â”‚    â”‚
â”‚  â”‚ 11:30 AM â”‚ Pedro R.  â”‚ 3.4 km â”‚ [ Elegir ]              â”‚    â”‚
â”‚  â”‚ 12:00 PM â”‚ Carlos M. â”‚ 2.1 km â”‚ [ Elegir ]              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                 â”‚
â”‚  ğŸ“… OTROS DÃAS A LAS 10:00 AM:                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Pasado maÃ±ana â”‚ Pedro R.  â”‚ [ Elegir ]                  â”‚    â”‚
â”‚  â”‚ En 3 dÃ­as     â”‚ Carlos M. â”‚ [ Elegir ]                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                 â”‚
â”‚  Â¿Ninguna opciÃ³n te conviene?                                   â”‚
â”‚  [ ğŸ“‹ Entrar en lista de espera ]                               â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## NavegaciÃ³n

| â¬†ï¸ Padre             | [[Proyecto OnlyCarNLD/Datos/1.3.6.1.14 matching_alternativo]] |
| -------------------- | ----------------------------------- |
| â¡ï¸ Hermano siguiente | [[Proyecto OnlyCarNLD/Datos/1.3.6.1.14.2 lista_espera]]       |

---
