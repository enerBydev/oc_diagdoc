---
id: 5.8.6.5.5
title: Analytics MÃ©tricas
parent: 5.8.6.5
breadcrumb: 0 â†’ 5.0 â†’ 5.8 â†’ 5.8.6 â†’ 5.8.6.5 â†’ 5.8.6.5.5
type: analytics
status: activo
last_updated: 2026-01-29 15:32
file_create: 2026-01-01 18:10
domain:
- metricas
- tiempos
- kpi
summary: Analytics de tiempos y rutas.
content_hash: 45542925b9796b27
---

# 5.8.6.5.5 Analytics y MÃ©tricas

ExtracciÃ³n de insights operacionales del historial GPS.

---

## Dashboard de MÃ©tricas

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“Š ANALYTICS GPS - ONLYCARNLD                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ â±ï¸ 18 min    â”‚  â”‚ ğŸ“ 4.2 km    â”‚  â”‚ ğŸ¯ 92%       â”‚           â”‚
â”‚  â”‚ Tiempo Prom. â”‚  â”‚ Dist. Prom.  â”‚  â”‚ SLA Cumplido â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                 â”‚
â”‚  RENDIMIENTO POR ZONA                                           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚  Centro      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘ 85% (15 min avg)          â”‚
â”‚  PerifÃ©rico  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 60% (28 min avg)          â”‚
â”‚  Industrial  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘ 78% (20 min avg)          â”‚
â”‚                                                                 â”‚
â”‚  TOP OPERADORES                                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚  1. Carlos M.    â­ 98% SLA    ğŸ“ 3.8km avg    â±ï¸ 14min avg     â”‚
â”‚  2. Juan P.      â­ 95% SLA    ğŸ“ 4.1km avg    â±ï¸ 17min avg     â”‚
â”‚  3. MarÃ­a G.     â­ 89% SLA    ğŸ“ 5.2km avg    â±ï¸ 22min avg     â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## MÃ©tricas Disponibles

| MÃ©trica | DescripciÃ³n | Uso |
|---------|-------------|-----|
| **Tiempo de llegada** | Minutos desde inicio hasta llegada | SLA, pricing |
| **Distancia recorrida** | Metros totales del recorrido | Eficiencia |
| **Velocidad promedio** | km/h durante el servicio | Seguridad |
| **SLA cumplido** | % dentro del tiempo acordado | Calidad |
| **Tiempo en zona** | Minutos en radio del destino | Servicio |

---

## Vistas SQL AnalÃ­ticas

### Vista: MÃ©tricas por Servicio

```sql
CREATE VIEW v_metricas_servicio AS
SELECT 
  s.id as servicio_id,
  s.operador_id,
  s.created_at as fecha_servicio,
  
  -- Tiempo de llegada (minutos)
  EXTRACT(EPOCH FROM (
    (SELECT created_at FROM ubicaciones_servicio 
     WHERE servicio_id = s.id AND es_llegada = true LIMIT 1)
    -
    (SELECT created_at FROM ubicaciones_servicio 
     WHERE servicio_id = s.id AND es_inicio = true LIMIT 1)
  )) / 60 as tiempo_llegada_min,
  
  -- Total ubicaciones
  (SELECT COUNT(*) FROM ubicaciones_servicio 
   WHERE servicio_id = s.id) as total_ubicaciones,
  
  -- Primera y Ãºltima ubicaciÃ³n
  (SELECT lat FROM ubicaciones_servicio 
   WHERE servicio_id = s.id AND es_inicio = true) as inicio_lat,
  (SELECT lng FROM ubicaciones_servicio 
   WHERE servicio_id = s.id AND es_inicio = true) as inicio_lng,
  (SELECT lat FROM ubicaciones_servicio 
   WHERE servicio_id = s.id AND es_llegada = true) as llegada_lat,
  (SELECT lng FROM ubicaciones_servicio 
   WHERE servicio_id = s.id AND es_llegada = true) as llegada_lng
   
FROM servicios s
WHERE s.estado IN ('completado', 'llegado');
```

### Vista: MÃ©tricas por Operador

```sql
CREATE VIEW v_metricas_operador AS
SELECT 
  u.id as operador_id,
  u.nombre as operador_nombre,
  
  -- Total servicios
  COUNT(DISTINCT m.servicio_id) as total_servicios,
  
  -- Tiempo promedio de llegada
  AVG(m.tiempo_llegada_min) as tiempo_llegada_promedio,
  
  -- % SLA cumplido (asumiendo 30 min mÃ¡ximo)
  (COUNT(*) FILTER (WHERE m.tiempo_llegada_min <= 30) * 100.0 / 
   NULLIF(COUNT(*), 0)) as porcentaje_sla_cumplido,
  
  -- Mejor y peor tiempo
  MIN(m.tiempo_llegada_min) as mejor_tiempo,
  MAX(m.tiempo_llegada_min) as peor_tiempo
  
FROM users u
LEFT JOIN v_metricas_servicio m ON u.id = m.operador_id
WHERE u.rol = 'operador'
GROUP BY u.id, u.nombre
ORDER BY porcentaje_sla_cumplido DESC;
```

### Vista: MÃ©tricas por Zona

```sql
-- Requiere tener zonas definidas con polÃ­gonos
CREATE VIEW v_metricas_zona AS
SELECT 
  z.nombre as zona,
  
  COUNT(DISTINCT m.servicio_id) as total_servicios,
  AVG(m.tiempo_llegada_min) as tiempo_promedio,
  
  (COUNT(*) FILTER (WHERE m.tiempo_llegada_min <= 30) * 100.0 / 
   NULLIF(COUNT(*), 0)) as porcentaje_sla
   
FROM zonas z
LEFT JOIN v_metricas_servicio m ON 
  ST_Contains(z.poligono, ST_MakePoint(m.llegada_lng, m.llegada_lat))
GROUP BY z.nombre
ORDER BY total_servicios DESC;
```

---

## FunciÃ³n: Calcular Distancia Recorrida

```sql
-- FunciÃ³n para calcular distancia total de un servicio
CREATE OR REPLACE FUNCTION calcular_distancia_servicio(p_servicio_id UUID)
RETURNS NUMERIC AS $$
DECLARE
  v_distancia NUMERIC := 0;
  v_prev_lat NUMERIC;
  v_prev_lng NUMERIC;
  v_curr RECORD;
BEGIN
  FOR v_curr IN 
    SELECT lat, lng 
    FROM ubicaciones_servicio 
    WHERE servicio_id = p_servicio_id
    ORDER BY created_at
  LOOP
    IF v_prev_lat IS NOT NULL THEN
      v_distancia := v_distancia + calcular_distancia(
        v_prev_lat, v_prev_lng, v_curr.lat, v_curr.lng
      );
    END IF;
    v_prev_lat := v_curr.lat;
    v_prev_lng := v_curr.lng;
  END LOOP;
  
  RETURN v_distancia;
END;
$$ LANGUAGE plpgsql;
```

---

## Composable: useGPSAnalytics

```typescript
// composables/useGPSAnalytics.ts
interface OperadorMetrics {
  operador_id: string;
  operador_nombre: string;
  total_servicios: number;
  tiempo_llegada_promedio: number;
  porcentaje_sla_cumplido: number;
}

interface ZonaMetrics {
  zona: string;
  total_servicios: number;
  tiempo_promedio: number;
  porcentaje_sla: number;
}

export const useGPSAnalytics = () => {
  const supabase = useSupabaseClient();
  
  const getOperadorMetrics = async (): Promise<OperadorMetrics[]> => {
    const { data, error } = await supabase
      .from('v_metricas_operador')
      .select('*')
      .order('porcentaje_sla_cumplido', { ascending: false });
    
    if (error) throw error;
    return data || [];
  };
  
  const getZonaMetrics = async (): Promise<ZonaMetrics[]> => {
    const { data, error } = await supabase
      .from('v_metricas_zona')
      .select('*')
      .order('total_servicios', { ascending: false });
    
    if (error) throw error;
    return data || [];
  };
  
  const getResumenGeneral = async () => {
    const { data, error } = await supabase
      .from('v_metricas_servicio')
      .select('tiempo_llegada_min');
    
    if (error) throw error;
    
    const tiempos = data?.map(d => d.tiempo_llegada_min).filter(Boolean) || [];
    
    return {
      total_servicios: tiempos.length,
      tiempo_promedio: tiempos.reduce((a, b) => a + b, 0) / tiempos.length || 0,
      sla_cumplido: (tiempos.filter(t => t <= 30).length / tiempos.length * 100) || 0
    };
  };
  
  return {
    getOperadorMetrics,
    getZonaMetrics,
    getResumenGeneral
  };
};
```

---

## Casos de Uso de Analytics

### 1. Identificar Zonas ProblemÃ¡ticas

```typescript
// Alertar zonas con bajo SLA
const zonasProblematicas = await supabase
  .from('v_metricas_zona')
  .select('zona, porcentaje_sla')
  .lt('porcentaje_sla', 80);

if (zonasProblematicas.data?.length) {
  notifyAdmin({
    type: 'warning',
    message: `${zonasProblematicas.data.length} zonas con SLA < 80%`,
    data: zonasProblematicas.data
  });
}
```

### 2. Ranking de Operadores

```typescript
// Top 3 operadores del mes
const top3 = await supabase
  .from('v_metricas_operador')
  .select('operador_nombre, porcentaje_sla_cumplido')
  .limit(3);
```

### 3. Tendencia de SLA

```sql
-- SLA por semana (Ãºltimos 3 meses)
SELECT 
  DATE_TRUNC('week', fecha_servicio) as semana,
  COUNT(*) as total,
  (COUNT(*) FILTER (WHERE tiempo_llegada_min <= 30) * 100.0 / 
   COUNT(*)) as sla_porcentaje
FROM v_metricas_servicio
WHERE fecha_servicio > NOW() - INTERVAL '3 months'
GROUP BY DATE_TRUNC('week', fecha_servicio)
ORDER BY semana;
```

---

â†’ Ver reconstrucciÃ³n de ruta: [[Proyecto OnlyCarNLD/Datos/5.8.6.5.6 reconstruccion_ruta]]

---

## NavegaciÃ³n

| â¬†ï¸ Padre             | [[Proyecto OnlyCarNLD/Datos/5.8.6.5 historial_ubicaciones]]            |
| -------------------- | ---------------------- |
| â¬…ï¸ Hermano anterior  | [[Proyecto OnlyCarNLD/Datos/5.8.6.5.4 evidencia_disputas]]              |
| â¡ï¸ Hermano siguiente | [[Proyecto OnlyCarNLD/Datos/5.8.6.5.6 reconstruccion_ruta]]              |
