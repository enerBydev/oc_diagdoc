---
id: 1.3.4.1
title: Mensajes de Audio
parent: 1.3.4
breadcrumb: 0 â†’ 1.0 â†’ 1.3 â†’ 1.3.4 â†’ 1.3.4.1
type: feature
status: activo
last_updated: 2026-01-29 16:01
file_create: 2026-01-09 21:15
domain:
- comunicacion
- audio
- mobile
- voz
summary: 'Soporte para notas de voz (voice messages) en el sistema de chat.

  CrÃ­tico para operadores mÃ³viles que no pueden teclear mientras conducen.

  Incluye grabaciÃ³n, transcripciÃ³n opcional y playback variable.

  '
content_hash: 2206bacb93b38080
---

# 1.3.4.1 Mensajes de Audio

> **PropÃ³sito:** Permitir comunicaciÃ³n por voz entre operadores y clientes, especialmente cuando teclear no es prÃ¡ctico (conduciendo, manos ocupadas).

---

## 1. JustificaciÃ³n de Negocio

Los operadores de OnlyCar pasan la mayor parte de su dÃ­a en movimiento. Responder mensajes de texto mientras conducen es:
- **Peligroso:** DistracciÃ³n al volante.
- **Ilegal:** En MÃ©xico, usar el celular manejando es infracciÃ³n.
- **Lento:** Requiere detenerse.

**SoluciÃ³n:** Implementar notas de voz con un patrÃ³n "Hold-to-Record" que permite grabar un mensaje con una sola mano mientras se detiene brevemente.

---

## 2. Diagrama de Flujo

```mermaid
sequenceDiagram
    participant User as Operador
    participant App as App MÃ³vil
    participant R2 as Cloudflare R2
    participant API as Backend
    participant Whisper as Whisper API (Opcional)
    
    User->>App: Mantiene presionado botÃ³n ğŸ™ï¸
    App->>App: Inicia grabaciÃ³n (Opus)
    User->>App: Suelta botÃ³n
    App->>App: Finaliza grabaciÃ³n
    App->>R2: Upload audio (WebM/Opus)
    R2-->>App: URL del archivo
    App->>API: Enviar mensaje tipo "audio"
    
    alt TranscripciÃ³n habilitada
        API->>Whisper: Transcribir audio
        Whisper-->>API: Texto transcrito
        API->>API: Guardar metadata + transcripciÃ³n
    end
    
    API-->>App: Mensaje enviado âœ“
```

---

## 3. Especificaciones TÃ©cnicas

### 3.1 Formato de Audio
| ParÃ¡metro | Valor | JustificaciÃ³n |
|-----------|-------|---------------|
| **CÃ³dec** | Opus | Mejor compresiÃ³n para voz |
| **Contenedor** | WebM | Compatible con todos los navegadores modernos |
| **Bitrate** | 24 kbps | Calidad de voz clara, tamaÃ±o mÃ­nimo |
| **Sample Rate** | 16 kHz | Ã“ptimo para voz humana |
| **DuraciÃ³n MÃ¡xima** | 60 segundos | Evitar abusos, forzar concisiÃ³n |

### 3.2 Almacenamiento
- **UbicaciÃ³n:** Cloudflare R2 (mismo bucket que imÃ¡genes).
- **Ruta:** `/audio/{conversation_id}/{message_id}.webm`
- **RetenciÃ³n:** Igual que mensajes de texto (indefinida para B2B, 1 aÃ±o para B2C).

---

## 4. Estructura JSON

```json
{
  "type": "audio",
  "content": {
    "url": "https://r2.onlycar.mx/audio/conv123/msg456.webm",
    "duration_seconds": 12,
    "waveform": [0.2, 0.5, 0.8, 0.4, 0.3, ...],
    "transcription": "Voy llegando en 5 minutos, estaciona el carro afuera",
    "transcription_status": "completed"
  }
}
```

---

## 5. Componente de UI

### 5.1 BotÃ³n de GrabaciÃ³n

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“  Aa  Escribe un mensaje...              [ğŸ™ï¸]       â¤      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Estado: Grabando (Hold)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ”´ GRABANDO... 0:08            [CANCELAR]      [Soltar âœ“]    â”‚
â”‚  â–â–‚â–…â–†â–ƒâ–â–‚â–…â–‡â–…â–ƒâ–â–‚â–„â–†â–ƒâ–‚â–                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 Mensaje de Audio (Reproductor)

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ”Š  â–“â–“â–“â–“â–“â–“â–“â–“â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  0:12 / 0:24                      â”‚
â”‚                                                             â”‚
â”‚  "Voy llegando en 5 minutos..."  (transcripciÃ³n)            â”‚
â”‚                                                    14:28 âœ“âœ“ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. Playback Configurable

El usuario puede ajustar la velocidad de reproducciÃ³n:
- **1x:** Normal (default).
- **1.5x:** RÃ¡pido.
- **2x:** Muy rÃ¡pido (para usuarios avanzados).

Esto permite consumir audios largos mÃ¡s rÃ¡pidamente.

---

## 7. TranscripciÃ³n (Opcional)

Utiliza Whisper API (OpenAI) para generar texto a partir del audio.

**Beneficios:**
- Accesibilidad para usuarios con dificultades auditivas.
- BÃºsqueda en historial de mensajes.
- Referencia rÃ¡pida sin reproducir.

**Costos:**
- ~$0.006 por minuto de audio.
- Habilitar solo para mensajes > 10 segundos y bajo demanda.

---

## NavegaciÃ³n

| Elemento | Enlace |
|----------|--------|
| â¬†ï¸ Padre | [[Proyecto OnlyCarNLD/Datos/1.3.4 tipos_mensajes]] |
| ğŸ”— Relacionado | [[Proyecto OnlyCarNLD/Datos/1.3.12 upload_multimedia]] |
