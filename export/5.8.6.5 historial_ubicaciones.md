---
id: 5.8.6.5
title: Historial Ubicaciones
parent: 5.8.6
breadcrumb: 0 â†’ 5.0 â†’ 5.8 â†’ 5.8.6 â†’ 5.8.6.5
type: modulo_padre
children_count: 10
status: activo
last_updated: 2026-01-29 15:32
file_create: 2026-01-01 18:10
domain:
- historial
- ubicaciones
- storage
summary: Almacenamiento histÃ³rico de ubicaciones.
content_hash: 254267d6c82c4198
---

# 5.8.6.5 Historial de Ubicaciones

Sistema completo de almacenamiento histÃ³rico de ubicaciones GPS con autolimpieza programada.

---

## DecisiÃ³n Adoptada

> [!IMPORTANT]
> Historial Completo con Autolimpieza**
> 
> Persistir **todas** las ubicaciones durante el servicio, con limpieza automatizada para controlar storage.

---

## JustificaciÃ³n para OnlyCar

| Factor | RazÃ³n |
|--------|-------|
| **Contratos B2B** | Clientes Corporate+ requieren prueba de servicio |
| **Disputas** | "El operador nunca llegÃ³" vs "AquÃ­ estÃ¡ el GPS" |
| **SLAs** | Demostrar tiempo de llegada cumplido |
| **MÃ©tricas** | Tiempo promedio por zona, rutas eficientes |
| **Diferenciador** | "Vea el recorrido de su servicio" |
| **Costo** | ~216 MB/aÃ±o estÃ¡ dentro de Supabase Free |

---

## Arquitectura

```mermaid
flowchart TD
    subgraph INGESTA[ğŸ“¥ Ingesta]
        A[GPS Capacitor] --> B[Cloudflare Edge]
        B --> C[ValidaciÃ³n]
        C --> D[Supabase Insert]
    end
    
    subgraph STORAGE[ğŸ—„ï¸ Storage]
        D --> E[(ubicaciones_servicio)]
        D --> F[(ubicacion_actual)]
        E --> G[Ãndices Optimizados]
    end
    
    subgraph LIMPIEZA[ğŸ§¹ Autolimpieza]
        H[Cron Diario 3AM] --> I{Â¿AntigÃ¼edad?}
        I -->|>30 dÃ­as| J[Borrar no-llegada]
        I -->|>365 dÃ­as| K[Archivar llegadas]
        I -->|Disputa| L[Retener indefinido]
    end
    
    subgraph CONSUMO[ğŸ“Š Consumo]
        E --> M[Analytics Dashboard]
        E --> N[ReconstrucciÃ³n Ruta]
        E --> O[Evidencia Disputas]
        E --> P[API Consultas]
    end
```

---

## Casos de Uso

### Caso 1: Disputa de Cliente B2B

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ESCENARIO: Cliente Corporate+ reclama operador no llegÃ³        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  SIN HISTORIAL:                                                 â”‚
â”‚  â€¢ Cliente: "El operador nunca llegÃ³"                           â”‚
â”‚  â€¢ Admin: "SegÃºn el operador sÃ­ llegÃ³"                          â”‚
â”‚  â€¢ Resultado: Palabra contra palabra â†’ Cliente insatisfecho     â”‚
â”‚                                                                 â”‚
â”‚  CON HISTORIAL:                                                 â”‚
â”‚  â€¢ Cliente: "El operador nunca llegÃ³"                           â”‚
â”‚  â€¢ Admin: "AquÃ­ estÃ¡ el recorrido GPS completo:"                â”‚
â”‚    - 14:00 SaliÃ³ de base (lat, lng)                             â”‚
â”‚    - 14:15 LlegÃ³ a destino (lat, lng)                           â”‚
â”‚    - 14:16 ConfirmÃ³ llegada automÃ¡tica                          â”‚
â”‚  â€¢ Resultado: Evidencia irrefutable â†’ Caso cerrado              â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Caso 2: SLA Incumplido

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ESCENARIO: SLA de 30 min mÃ¡ximo para llegar                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  CON HISTORIAL:                                                 â”‚
â”‚  â€¢ Servicio confirmado: 14:00                                   â”‚
â”‚  â€¢ Primera ubicaciÃ³n: 14:05 (operador saliÃ³ 5 min despuÃ©s)      â”‚
â”‚  â€¢ Llegada detectada: 14:42 (42 min totales)                    â”‚
â”‚  â€¢ SLA: INCUMPLIDO â†’ Aplicar compensaciÃ³n automÃ¡tica            â”‚
â”‚                                                                 â”‚
â”‚  BENEFICIO: Proceso automatizado sin intervenciÃ³n humana        â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Caso 3: OptimizaciÃ³n Operacional

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ESCENARIO: AnÃ¡lisis de eficiencia                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  CON HISTORIAL:                                                 â”‚
â”‚  â€¢ Zona Centro: 15 min promedio de llegada                      â”‚
â”‚  â€¢ Zona PerifÃ©rico: 35 min promedio                             â”‚
â”‚  â€¢ Operador Carlos: 20% mÃ¡s rÃ¡pido que promedio                 â”‚
â”‚  â€¢ Operador Juan: 15% mÃ¡s lento que promedio                   â”‚
â”‚                                                                 â”‚
â”‚  ACCIÃ“N: Reasignar zonas, capacitar operadores lentos           â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Estructura de Hijos

| ID                                             | Nombre               | DescripciÃ³n             | Estado |
| ---------------------------------------------- | -------------------- | ----------------------- | ------ |
| [[Proyecto OnlyCarNLD/Datos/5.8.6.5.1 modelo_datos\|5.8.6.5.1]]          | Modelo Datos         | Esquema SQL historial   | âœ…      |
| [[Proyecto OnlyCarNLD/Datos/5.8.6.5.2 politica_retencion\|5.8.6.5.2]]    | PolÃ­tica RetenciÃ³n   | Reglas de retenciÃ³n     | âœ…      |
| [[Proyecto OnlyCarNLD/Datos/5.8.6.5.3 limpieza_automatica\|5.8.6.5.3]]   | Limpieza AutomÃ¡tica  | Cron job autolimpieza   | âœ…      |
| [[Proyecto OnlyCarNLD/Datos/5.8.6.5.4 evidencia_disputas\|5.8.6.5.4]]    | Evidencia Disputas   | Uso en disputas         | âœ…      |
| [[Proyecto OnlyCarNLD/Datos/5.8.6.5.5 analytics_metricas\|5.8.6.5.5]]    | Analytics MÃ©tricas   | KPIs y analytics        | âœ…      |
| [[Proyecto OnlyCarNLD/Datos/5.8.6.5.6 reconstruccion_ruta\|5.8.6.5.6]]   | ReconstrucciÃ³n Ruta  | Replay de rutas         | âœ…      |
| [[Proyecto OnlyCarNLD/Datos/5.8.6.5.7 privacidad_gdpr\|5.8.6.5.7]]       | Privacidad GDPR      | Cumplimiento privacidad | âœ…      |
| [[Proyecto OnlyCarNLD/Datos/5.8.6.5.8 storage_estimaciones\|5.8.6.5.8]]  | Storage Estimaciones | CÃ¡lculos de storage     | âœ…      |
| [[Proyecto OnlyCarNLD/Datos/5.8.6.5.9 queries_optimizadas\|5.8.6.5.9]]   | Queries Optimizadas  | SQL optimizado          | âœ…      |
| [[Proyecto OnlyCarNLD/Datos/5.8.6.5.10 backup_recuperacion\|5.8.6.5.10]] | Backup RecuperaciÃ³n  | DR y backups            | âœ…      |

---

## Matriz de RetenciÃ³n

| Tipo de Dato | RetenciÃ³n | RazÃ³n |
|--------------|-----------|-------|
| Ubicaciones intermedias | 30 dÃ­as | Balance storage/utilidad |
| UbicaciÃ³n de llegada | 1 aÃ±o | AuditorÃ­a, SLAs |
| Servicios con disputa | Indefinido | Evidencia legal |
| Ubicaciones archivadas | 3 aÃ±os | RegulaciÃ³n fiscal |

---

## Estimaciones de Storage

| MÃ©trica | Valor |
|---------|-------|
| Por ubicaciÃ³n | ~100 bytes |
| Por servicio (30 min) | ~18 KB |
| Por mes (1000 servicios) | ~18 MB |
| Por aÃ±o | ~216 MB |
| Supabase Free | 500 MB |
| **Margen disponible** | **284 MB** âœ… |

---

â†’ Ver modelo de datos: [[Proyecto OnlyCarNLD/Datos/5.8.6.5.1 modelo_datos]]

---

## NavegaciÃ³n

| â¬†ï¸ Padre             | [[Proyecto OnlyCarNLD/Datos/5.8.6 backend_ubicaciones]]            |
| -------------------- | ---------------------- |
| â¬…ï¸ Hermano anterior  | [[Proyecto OnlyCarNLD/Datos/5.8.6.4 cloudflare_edge]]              |
