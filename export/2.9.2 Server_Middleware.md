---
id: 2.9.2
title: Server Middleware
parent: '2.9'
breadcrumb: 0 → 2.0 → 2.9 → 2.9.2
type: especificacion
domain:
- middleware
- auth
- context
- logging
status: activo
last_updated: 2026-01-29 15:31
file_create: 2026-01-04 21:33
summary: 'Middleware global de servidor para inyección de contexto de usuario

  y logging de peticiones.'
content_hash: 100cff76d88c6efe
---

# 2.9.2 Server Middleware

> Interceptores que se ejecutan antes de cada petición a la API.

---

## Auth Context Injection

Para evitar verificar el token JWT en cada endpoint, usamos un middleware que inyecta el usuario en el contexto.

```ts
// server/middleware/auth.ts
import { serverSupabaseUser } from '#supabase/server'

export default defineEventHandler(async (event) => {
  // Solo aplicar a rutas /api
  if (!event.path.startsWith('/api')) return

  // Intentar obtener usuario (no fallar si es ruta pública)
  const user = await serverSupabaseUser(event).catch(() => null)
  
  // Inyectar en contexto para uso posterior
  event.context.user = user
})
```

**Uso en Endpoint:**
```ts
const user = event.context.user
if (!user) throw createError({ statusCode: 401 })
```

---

## Logger Middleware

Registra métricas básicas de cada petición para observabilidad.

```ts
// server/middleware/log.ts
export default defineEventHandler((event) => {
  console.log(`[${event.method}] ${event.path} - ${new Date().toISOString()}`)
})
```

---

## Navegación

| ⬆️ Padre             | [[Proyecto OnlyCarNLD/Datos/2.9. Arquitectura_Backend]]   |
| -------------------- | ------------------------------- |
| ⬅️ Hermano anterior  | [[Proyecto OnlyCarNLD/Datos/2.9.1 API_Routes]]            |
| ➡️ Hermano siguiente | [[Proyecto OnlyCarNLD/Datos/2.9.3 Background_Jobs]]       |

---
