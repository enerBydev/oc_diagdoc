---
id: 5.8.9
title: ConfiguraciÃ³n Remota
parent: '5.8'
breadcrumb: 0 â†’ 5.0 â†’ 5.8 â†’ 5.8.9
type: configuracion
status: activo
last_updated: 2026-01-29 15:32
file_create: 2026-01-01 18:10
domain:
- config
- panel
- admin
summary: Panel de configuraciÃ³n remota de geo.
content_hash: e50534a3b1e6df73
---

# 5.8.9 ConfiguraciÃ³n Remota

Sistema de configuraciÃ³n dinÃ¡mica desde panel de administraciÃ³n.

---

## Arquitectura

```mermaid
flowchart LR
    A[ğŸ”§ Panel Admin] --> B[Supabase Table]
    B --> C[Edge Config]
    C --> D[ğŸ“± App Operador]
    C --> E[ğŸ“± App Cliente]
    
    style A fill:#f9f,stroke:#333
    style C fill:#ff9,stroke:#333
```

---

## ConfiguraciÃ³n: Throttle GPS

| ParÃ¡metro | Valor Default | Recomendado | Rango |
|-----------|---------------|-------------|-------|
| `gps_throttle_ms` | 5000 | **10000** â­ | 5000-30000 |

> [!TIP]
> **10 segundos es el valor recomendado** â€” Balance Ã³ptimo entre UX y baterÃ­a.

---

## Schema Supabase

```sql
-- Tabla de configuraciones globales
CREATE TABLE config_global (
  key TEXT PRIMARY KEY,
  value JSONB NOT NULL,
  description TEXT,
  min_value NUMERIC,
  max_value NUMERIC,
  recommended_value NUMERIC,
  updated_at TIMESTAMPTZ DEFAULT now(),
  updated_by UUID REFERENCES users(id)
);

-- Insertar configuraciÃ³n de throttle
INSERT INTO config_global (key, value, description, min_value, max_value, recommended_value)
VALUES (
  'gps_throttle_ms',
  '5000',
  'Intervalo de actualizaciÃ³n GPS en milisegundos',
  5000,
  30000,
  10000
);

-- RLS: Solo admin puede escribir, todos pueden leer
ALTER TABLE config_global ENABLE ROW LEVEL SECURITY;

CREATE POLICY "anyone_can_read_config"
ON config_global FOR SELECT TO authenticated USING (true);

CREATE POLICY "only_admin_can_update_config"
ON config_global FOR UPDATE TO authenticated
USING (
  EXISTS (SELECT 1 FROM users WHERE id = auth.uid() AND rol = 'admin')
);
```

---

## Composable: useRemoteConfig

```typescript
// composables/useRemoteConfig.ts
interface RemoteConfig {
  gps_throttle_ms: number;
  arrival_threshold_meters: number;
  // Extensible...
}

const DEFAULT_CONFIG: RemoteConfig = {
  gps_throttle_ms: 5000,
  arrival_threshold_meters: 100
};

export const useRemoteConfig = () => {
  const supabase = useSupabaseClient();
  const config = useState<RemoteConfig>('remote-config', () => DEFAULT_CONFIG);
  const isLoaded = ref(false);
  
  /**
   * Cargar configuraciÃ³n desde Supabase
   */
  const loadConfig = async () => {
    const { data, error } = await supabase
      .from('config_global')
      .select('key, value');
    
    if (data) {
      data.forEach(({ key, value }) => {
        if (key in config.value) {
          (config.value as any)[key] = typeof value === 'string' 
            ? JSON.parse(value) 
            : value;
        }
      });
    }
    
    isLoaded.value = true;
  };
  
  /**
   * Suscribirse a cambios en tiempo real
   */
  const subscribeToChanges = () => {
    supabase
      .channel('config_changes')
      .on('postgres_changes', {
        event: 'UPDATE',
        schema: 'public',
        table: 'config_global'
      }, (payload) => {
        const { key, value } = payload.new;
        if (key in config.value) {
          (config.value as any)[key] = typeof value === 'string'
            ? JSON.parse(value)
            : value;
          
          console.log(`Config actualizada: ${key} = ${value}`);
          toast.info(`ConfiguraciÃ³n actualizada: ${key}`);
        }
      })
      .subscribe();
  };
  
  // Auto-cargar y suscribirse
  onMounted(async () => {
    await loadConfig();
    subscribeToChanges();
  });
  
  return {
    config: readonly(config),
    isLoaded: readonly(isLoaded),
    refreshConfig: loadConfig,
    
    // Getter especÃ­fico para throttle
    gpsThrottleMs: computed(() => config.value.gps_throttle_ms)
  };
};
```

---

## IntegraciÃ³n con Tracking

```typescript
// composables/useWatchPosition.ts (actualizado)
export const useWatchPosition = () => {
  const { gpsThrottleMs } = useRemoteConfig();
  
  // Usar config remota en lugar de constante local
  let lastBroadcast = 0;
  
  const shouldBroadcast = (): boolean => {
    const now = Date.now();
    const throttle = gpsThrottleMs.value; // â† DinÃ¡mico
    
    if (now - lastBroadcast < throttle) return false;
    lastBroadcast = now;
    return true;
  };
  
  // ... resto del composable
};
```

---

## Panel Admin: UI de ConfiguraciÃ³n

```vue
<!-- pages/admin/configuracion/gps.vue -->
<script setup lang="ts">
const supabase = useSupabaseClient();

const throttleValue = ref(5000);
const isLoading = ref(true);
const isSaving = ref(false);

// Cargar valor actual
onMounted(async () => {
  const { data } = await supabase
    .from('config_global')
    .select('value, recommended_value')
    .eq('key', 'gps_throttle_ms')
    .single();
  
  if (data) {
    throttleValue.value = parseInt(data.value);
  }
  isLoading.value = false;
});

// Guardar nuevo valor
const saveConfig = async () => {
  isSaving.value = true;
  
  const { error } = await supabase
    .from('config_global')
    .update({ 
      value: throttleValue.value,
      updated_at: new Date().toISOString()
    })
    .eq('key', 'gps_throttle_ms');
  
  if (error) {
    toast.error('Error al guardar');
  } else {
    toast.success('ConfiguraciÃ³n guardada. Se actualizarÃ¡ en todos los dispositivos.');
  }
  
  isSaving.value = false;
};

const presets = [
  { label: '5s (Fluido)', value: 5000 },
  { label: '10s â­ Recomendado', value: 10000 },
  { label: '15s (Ahorro baterÃ­a)', value: 15000 },
  { label: '20s (MÃ¡ximo ahorro)', value: 20000 }
];
</script>

<template>
  <div class="config-page">
    <h1>ConfiguraciÃ³n GPS</h1>
    
    <div class="config-card">
      <h3>Intervalo de ActualizaciÃ³n (Throttle)</h3>
      <p class="description">
        Cada cuÃ¡ntos segundos se envÃ­a la ubicaciÃ³n del operador.
        Un valor mayor ahorra baterÃ­a pero reduce la fluidez del mapa.
      </p>
      
      <div class="input-group">
        <input 
          type="range" 
          v-model.number="throttleValue"
          min="5000" 
          max="30000" 
          step="1000"
        />
        <span class="value">{{ throttleValue / 1000 }}s</span>
      </div>
      
      <div class="presets">
        <button 
          v-for="preset in presets"
          :key="preset.value"
          :class="['preset-btn', { active: throttleValue === preset.value }]"
          @click="throttleValue = preset.value"
        >
          {{ preset.label }}
        </button>
      </div>
      
      <div class="recommendation">
        <span class="badge">â­ Recomendado: 10 segundos</span>
        <p>Balance Ã³ptimo entre experiencia de usuario y consumo de baterÃ­a.</p>
      </div>
      
      <button 
        @click="saveConfig" 
        :disabled="isSaving"
        class="btn-save"
      >
        {{ isSaving ? 'Guardando...' : 'Guardar y aplicar a todos los dispositivos' }}
      </button>
    </div>
  </div>
</template>
```

---

## SincronizaciÃ³n AutomÃ¡tica

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FLUJO DE SINCRONIZACIÃ“N                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  1. Admin cambia valor en panel web                             â”‚
â”‚     â””â”€â†’ UPDATE config_global SET value = 10000                  â”‚
â”‚                                                                 â”‚
â”‚  2. Supabase Realtime detecta cambio                            â”‚
â”‚     â””â”€â†’ postgres_changes event                                  â”‚
â”‚                                                                 â”‚
â”‚  3. Todos los dispositivos suscritos reciben update             â”‚
â”‚     â””â”€â†’ ~50-200ms de latencia                                   â”‚
â”‚                                                                 â”‚
â”‚  4. useRemoteConfig actualiza config local                      â”‚
â”‚     â””â”€â†’ gpsThrottleMs.value = 10000                             â”‚
â”‚                                                                 â”‚
â”‚  5. PrÃ³ximo GPS update usa nuevo intervalo                      â”‚
â”‚     â””â”€â†’ Efecto inmediato sin reiniciar app                      â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Configuraciones Adicionales Sugeridas

```sql
-- Otras configuraciones que podrÃ­an ser dinÃ¡micas
INSERT INTO config_global (key, value, description, min_value, max_value, recommended_value)
VALUES 
  ('arrival_threshold_meters', '100', 'Distancia para auto-confirmar llegada', 50, 200, 100),
  ('arrival_confirm_count', '2', 'Lecturas GPS consecutivas para confirmar', 1, 5, 2),
  ('map_default_zoom', '15', 'Zoom inicial del mapa', 10, 18, 15);
```

---

â†’ Ver mÃ³dulo principal: [[Proyecto OnlyCarNLD/Datos/5.8. geolocalizacion]]

---

## NavegaciÃ³n

| â¬†ï¸ Padre             | [[Proyecto OnlyCarNLD/Datos/5.8. geolocalizacion]]            |
| -------------------- | ---------------------- |
| â¬…ï¸ Hermano anterior  | [[Proyecto OnlyCarNLD/Datos/5.8.8 testing]]              |
