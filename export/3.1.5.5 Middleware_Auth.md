---
id: 3.1.5.5
title: Middleware Auth
parent: 3.1.5
breadcrumb: 0 → 3.0 → 3.1 → 3.1.5 → 3.1.5.5
type: hoja
status: activo
last_updated: 2026-01-29 15:32
file_create: 2026-01-05 12:30
domain:
- api
- middleware
- auth
actors:
- desarrollador
summary: Middleware de autenticación y verificación de roles.
content_hash: 21db4a86e7f651cd
---

# 3.1.5.5 Middleware Auth

> Código de middleware para autenticación y autorización.

---

## Middleware Principal

```typescript
// server/middleware/auth.ts
export default defineEventHandler(async (event) => {
  const publicRoutes = ['/api/catalogo'];
  const path = getRequestURL(event).pathname;
  
  if (publicRoutes.some(r => path.startsWith(r))) return;
  
  const client = await serverSupabaseClient(event);
  const { data: { user }, error } = await client.auth.getUser();
  
  if (error || !user) {
    throw createError({ statusCode: 401, message: 'No autorizado' });
  }
  
  event.context.user = user;
  event.context.role = user.user_metadata?.role || 'cliente';
});
```

---

## Helper: requireRole

```typescript
// server/utils/requireRole.ts
export function requireRole(event: H3Event, allowedRoles: string[]) {
  const role = event.context.role;
  
  if (!allowedRoles.includes(role)) {
    throw createError({
      statusCode: 403,
      message: `Rol '${role}' no tiene permiso`
    });
  }
}
```

---

## Navegación

| ⬆️ Padre | [[Proyecto OnlyCarNLD/Datos/3.1.5 api_logica_negocio]] |
|----------|------------------------------|
| ⬅️ Anterior | [[Proyecto OnlyCarNLD/Datos/3.1.5.4 Admin_CRUD]] |
| ➡️ Siguiente | [[Proyecto OnlyCarNLD/Datos/3.1.5.6 Types_TS]] |

---
