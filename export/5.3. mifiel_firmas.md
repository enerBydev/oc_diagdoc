---
id: 5.3
title: Mifiel - Firma Digital de Contratos
parent: '5.0'
breadcrumb: 0 â†’ 5.0 â†’ 5.3
type: integracion
status: activo
last_updated: 2026-01-29 16:01
file_create: 2026-01-01 23:42
actors:
- admin
- cliente_b2b
domain:
- firmas
- contratos
- legal
- b2b
summary: 'Sistema de firma digital de contratos B2B via Mifiel (PSC acreditado).

  DelegaciÃ³n completa del proceso de e.firma/FIEL.'
content_hash: 0bfcf82ad45e906d
---

# 5.3 MIFIEL - FIRMA DIGITAL DE CONTRATOS

> MÃ³dulo de generaciÃ³n y firma digital de contratos **exclusivamente para clientes B2B**.

> [!IMPORTANT]
> OnlyCar **NUNCA gestiona, procesa ni almacena certificados digitales**.
> Todo el proceso de firma electrÃ³nica avanzada es manejado por Mifiel (PSC acreditado).

---

El sistema implementa un mÃ³dulo de generaciÃ³n y firma digital de contratos **exclusivamente para clientes empresariales B2B**. La arquitectura estÃ¡ diseÃ±ada bajo un modelo de **delegaciÃ³n completa** a Mifiel, un Prestador de Servicios de CertificaciÃ³n (PSC) acreditado ante la SecretarÃ­a de EconomÃ­a.

**Principio fundamental de delegaciÃ³n:**

OnlyCar **NUNCA gestiona, procesa ni almacena certificados digitales** de ningÃºn tipo. Todo el proceso de firma electrÃ³nica avanzada (e.firma/FIEL) es manejado completamente por Mifiel, incluyendo:
- ValidaciÃ³n de identidad de firmantes
- Custodia temporal de certificados digitales
- ValidaciÃ³n de certificados contra el SAT
- AplicaciÃ³n de firmas criptogrÃ¡ficas
- GeneraciÃ³n de evidencias legales
- EmisiÃ³n de constancias NOM-151 (cuando aplique)

OnlyCar actÃºa Ãºnicamente como **orquestador del flujo**, generando el documento contractual y enviÃ¡ndolo a Mifiel para su firma.

---

## Arquitectura del Flujo de Firma

El proceso se divide en **3 etapas operativas claramente definidas**:

```mermaid
flowchart TD
    subgraph ETAPA1["ğŸ“„ ETAPA 1: GeneraciÃ³n"]
        REQ[Cliente solicita servicio]
        TIPO{Tipo?}
        UNICO[OpciÃ³n A:<br/>Servicio Ãšnico]
        SUSCR[OpciÃ³n B:<br/>SuscripciÃ³n Mensual]
        PDF[PDF generado]
    end
    
    subgraph ETAPA2["âœï¸ ETAPA 2: Firma (Mifiel)"]
        API[POST /api/v1/documents]
        DOCID[document_id]
        INVITE[Mifiel envÃ­a invitaciones]
        PORTAL[Firmante accede portal]
        EFIRMA[Valida e.firma + Firma]
    end
    
    subgraph ETAPA3["ğŸ’¾ ETAPA 3: Cierre"]
        WEBHOOK[Webhook document.signed]
        DOWNLOAD[Descarga PDF firmado]
        R2[Cloudflare R2]
        POSTGRES[Metadata PostgreSQL]
        NOTIFY[NotificaciÃ³n cliente]
    end
    
    REQ --> TIPO
    TIPO --> UNICO
    TIPO --> SUSCR
    UNICO --> PDF
    SUSCR --> PDF
    PDF --> API
    API --> DOCID
    DOCID --> INVITE
    INVITE --> PORTAL
    PORTAL --> EFIRMA
    EFIRMA --> WEBHOOK
    WEBHOOK --> DOWNLOAD
    DOWNLOAD --> R2
    DOWNLOAD --> POSTGRES
    POSTGRES --> NOTIFY
```

```
FLUJO COMPLETO DE CONTRATOS Y FIRMAS:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ETAPA 1: GENERACIÃ“N DE CONTRATOS DINÃMICOS (Back-Office)   â”‚
â”‚                                                             â”‚
â”‚ Cliente solicita servicio â†’ Sistema identifica tipo         â”‚
â”‚                     â†“                                       â”‚
â”‚ Plantilla base legal + ClÃ¡usulas dinÃ¡micas                 â”‚
â”‚                     â†“                                       â”‚
â”‚ Variables: OpciÃ³n A (Pago por servicio)                    â”‚
â”‚            OpciÃ³n B (SuscripciÃ³n mensual)                  â”‚
â”‚                     â†“                                       â”‚
â”‚ OUTPUT: PDF generado internamente ANTES de firma           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ETAPA 2: ORQUESTACIÃ“N DE FIRMA CON MIFIEL API              â”‚
â”‚                                                             â”‚
â”‚ Sistema prepara payload:                                   â”‚
â”‚ â€¢ PDF generado (base64)                                    â”‚
â”‚ â€¢ Lista de firmantes (nombres + emails)                    â”‚
â”‚ â€¢ ConfiguraciÃ³n: send_invites: true                        â”‚
â”‚                     â†“                                       â”‚
â”‚ POST /api/v1/documents â†’ Mifiel API                        â”‚
â”‚                     â†“                                       â”‚
â”‚ Mifiel responde con document_id                            â”‚
â”‚                     â†“                                       â”‚
â”‚ Mifiel envÃ­a invitaciones por email a cada firmante        â”‚
â”‚                     â†“                                       â”‚
â”‚ Firmantes acceden a portal web de Mifiel                   â”‚
â”‚                     â†“                                       â”‚
â”‚ Mifiel valida identidad + e.firma/FIEL + Aplica firmas     â”‚
â”‚                     â†“                                       â”‚
â”‚ OnlyCar NO participa en el proceso de firma             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ETAPA 3: CIERRE Y PERSISTENCIA                             â”‚
â”‚                                                             â”‚
â”‚ Mifiel completa todas las firmas                           â”‚
â”‚                     â†“                                       â”‚
â”‚ Webhook a OnlyCar: document.signed                      â”‚
â”‚                     â†“                                       â”‚
â”‚ Sistema descarga PDF firmado desde Mifiel                  â”‚
â”‚                     â†“                                       â”‚
â”‚ Almacenamiento en Cloudflare R2 (conservaciÃ³n legal)       â”‚
â”‚                     â†“                                       â”‚
â”‚ Registro de metadata en PostgreSQL:                        â”‚
â”‚ â€¢ document_id de Mifiel                                    â”‚
â”‚ â€¢ Hashes de verificaciÃ³n SHA-256                           â”‚
â”‚ â€¢ Timestamps de firma                                      â”‚
â”‚ â€¢ URLs de descarga del documento                           â”‚
â”‚                     â†“                                       â”‚
â”‚ NotificaciÃ³n al cliente: Contrato disponible               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---
## ETAPA 1: GeneraciÃ³n de Contratos DinÃ¡micos

El sistema implementa un generador de contratos que combina plantillas legales base con clÃ¡usulas variables segÃºn el tipo de servicio contratado.
## Tipos de Contratos

| Tipo | Contenido |
|------|-----------|
| **OpciÃ³n A - Servicio Ãšnico** | IdentificaciÃ³n partes, descripciÃ³n servicio, monto, tÃ©rminos pago Ãºnico |
| **OpciÃ³n B - SuscripciÃ³n Mensual** | Plan suscripciÃ³n, servicios incluidos, monto mensual, renovaciÃ³n automÃ¡tica |

**OpciÃ³n A - Contrato por Servicio Ãšnico:**
Para servicios especÃ­ficos de pago Ãºnico, el contrato incluye:
- IdentificaciÃ³n completa de las partes (cliente empresarial y OnlyCar)
- DescripciÃ³n detallada del servicio a prestar
- Especificaciones tÃ©cnicas del servicio
- Monto total del servicio
- TÃ©rminos de pago (pago Ãºnico al finalizar)
- Condiciones de cancelaciÃ³n
- GarantÃ­as y responsabilidades
- JurisdicciÃ³n y ley aplicable

**OpciÃ³n B - Contrato de SuscripciÃ³n Mensual:**
Para servicios recurrentes, el contrato incluye:
- IdentificaciÃ³n de las partes
- DescripciÃ³n del plan de suscripciÃ³n
- Cantidad de servicios incluidos por mes
- Monto mensual recurrente
- Fecha de inicio y renovaciÃ³n automÃ¡tica
- TÃ©rminos de cobro automÃ¡tico
- Condiciones de uso de servicios incluidos
- PolÃ­tica de servicios no utilizados
- Condiciones de cancelaciÃ³n de suscripciÃ³n
- GarantÃ­as y responsabilidades
- JurisdicciÃ³n y ley aplicable

### Proceso de generaciÃ³n:

El sistema mantiene plantillas legales previamente revisadas por asesores jurÃ­dicos. Al crear un nuevo contrato, el sistema:

1. Identifica el tipo de servicio solicitado
2. Extrae los datos del cliente desde la base de datos (razÃ³n social, RFC, domicilio fiscal, representante legal)
3. Extrae los datos del servicio (descripciÃ³n, especificaciones, monto, fechas)
4. Selecciona la plantilla contractual correspondiente
5. Reemplaza las variables dinÃ¡micas con los datos extraÃ­dos
6. Genera el documento PDF con formato profesional
7. AÃ±ade pie de pÃ¡gina con fecha de generaciÃ³n y nÃºmero de contrato
8. Almacena temporalmente el PDF generado para su envÃ­o a Mifiel

El PDF generado estÃ¡ listo para firma pero aÃºn no tiene ninguna firma digital aplicada. Este documento serÃ¡ el que se envÃ­e a Mifiel en la siguiente etapa.

---

## ETAPA 2: OrquestaciÃ³n de Firma con Mifiel API

Una vez generado el contrato en formato PDF, el sistema orquesta el proceso de firma delegando completamente a Mifiel.

### PreparaciÃ³n del payload:

El sistema prepara la informaciÃ³n necesaria para invocar la API de Mifiel:

- **Documento**: El PDF generado codificado en base64
- **Firmantes**: Lista con los datos de cada persona que debe firmar
  - Nombre completo del firmante
  - DirecciÃ³n de correo electrÃ³nico
  - Rol en el contrato (cliente o proveedor)
- **ConfiguraciÃ³n**: ParÃ¡metro `send_invites: true` para que Mifiel envÃ­e automÃ¡ticamente las invitaciones por correo
- **Metadatos**: InformaciÃ³n adicional como ID del servicio, tipo de contrato, fecha de solicitud

### InvocaciÃ³n de la API:

El sistema realiza una peticiÃ³n HTTP POST al endpoint `/api/v1/documents` de Mifiel. La respuesta incluye un `document_id` Ãºnico que identifica el documento en la plataforma de Mifiel. Este ID se almacena inmediatamente en la base de datos como referencia.

### Proceso gestionado por Mifiel:

A partir de este momento, Mifiel asume el control completo del proceso:

1. Mifiel recibe el documento y lo almacena de forma segura en su infraestructura
2. EnvÃ­a correos electrÃ³nicos personalizados a cada firmante con un enlace Ãºnico y seguro
3. Cuando el firmante accede al enlace, Mifiel presenta una interfaz web donde puede:
   - Revisar el documento completo
   - Cargar su certificado digital e.firma/FIEL
   - Ingresar su contraseÃ±a de forma segura
   - Firmar digitalmente el documento
4. Mifiel valida la autenticidad del certificado digital contra el SAT
5. Aplica la firma criptogrÃ¡fica al documento PDF
6. Notifica al siguiente firmante si hay mÃ¡s de uno
7. Una vez completadas todas las firmas, notifica a OnlyCar mediante webhook

**Importante:** Durante todo este proceso, OnlyCar **NO tiene acceso** a los certificados digitales ni participa en la aplicaciÃ³n de las firmas. La interfaz de firma, validaciÃ³n y custodia temporal de certificados es responsabilidad exclusiva de Mifiel como PSC acreditado.

---

## ETAPA 3: Cierre y Persistencia

Cuando Mifiel completa el proceso de firma con todas las firmas requeridas, envÃ­a una notificaciÃ³n webhook a OnlyCar.

### Procesamiento del webhook:

El sistema recibe el webhook con el evento `document.signed` que incluye el `document_id`. Este webhook se valida criptogrÃ¡ficamente para garantizar que proviene de Mifiel y no ha sido alterado.

### Descarga del documento firmado:

El sistema invoca el endpoint de la API de Mifiel para descargar el PDF firmado. Este documento ahora contiene todas las firmas digitales integradas con sus respectivos sellos criptogrÃ¡ficos.

### Almacenamiento en Cloudflare R2:

El PDF firmado se almacena en Cloudflare R2 con las siguientes configuraciones:
- EncriptaciÃ³n server-side habilitada
- Ruta: `contratos_firmados/contrato_{id}.pdf`
- Metadata incluida: fecha de firma, tipo de contrato, nÃºmero de firmantes
- PolÃ­tica de conservaciÃ³n: permanente (evidencia legal)

### Registro de metadata en PostgreSQL:

El sistema almacena exclusivamente los metadatos del contrato en la tabla `contratos_firmados`:
- ID del contrato interno
- Referencia al cliente
- `document_id` de Mifiel (para futuras consultas)
- Hash SHA-256 del documento original (sin firmas)
- Hash SHA-256 del documento firmado (con firmas)
- Timestamps de cada firma realizada
- URL del documento firmado en Cloudflare R2
- Estado del contrato (firmado, vigente, cancelado)
- Timestamps de auditorÃ­a

**CRÃTICO:** Nunca se almacenan certificados digitales, claves privadas ni contraseÃ±as. Solo referencias, hashes y URLs.

### NotificaciÃ³n al cliente:

El sistema envÃ­a una notificaciÃ³n por correo electrÃ³nico al cliente informando que el contrato ha sido firmado por todas las partes y estÃ¡ disponible para descarga. El correo incluye:
- ConfirmaciÃ³n de firma exitosa
- Resumen del contrato
- Enlace directo de descarga desde el panel del cliente
- InformaciÃ³n de contacto para soporte

El cliente puede descargar el contrato firmado en cualquier momento desde su panel de usuario. El documento tiene plena validez legal conforme a la Ley de Firma ElectrÃ³nica Avanzada y el CÃ³digo de Comercio.

---

## Constancias NOM-151

Mifiel como PSC acreditado emite constancias de conservaciÃ³n NOM-151 automÃ¡ticamente cuando se requiere mÃ¡xima fuerza probatoria en juicios.

---

## Validez Legal

La integraciÃ³n con Mifiel como PSC acreditado proporciona:

- Validez legal plena conforme a Ley de Firma ElectrÃ³nica Avanzada
- Constancias NOM-151 (cuando aplique)
- Trazabilidad completa de firmantes
- Evidencias legales robustas
- Cero responsabilidad de custodia de certificados para OnlyCar

---

## Costos por Documento

| Tipo | Costo Mifiel | Incluye |
|------|--------------|---------|
| Contrato con firma digital | ~$30-50 MXN | ValidaciÃ³n SAT, firma, constancia |

---

## Credenciales Requeridas

Variables de entorno necesarias:

```env
MIFIEL_APP_ID=...
MIFIEL_APP_SECRET=...
MIFIEL_ENV=sandbox|production
MIFIEL_WEBHOOK_URL=https://onlycar.mx/api/webhooks/mifiel
```

---

## NavegaciÃ³n

| â¬†ï¸ Padre             | [[Proyecto OnlyCarNLD/Datos/5.0. integraciones]]           |
| -------------------- | -------------------------------- |
| â¬…ï¸ Hermano anterior  | [[Proyecto OnlyCarNLD/Datos/5.2. gigstack_facturacion]]    |
| â¡ï¸ Hermano siguiente | [[Proyecto OnlyCarNLD/Datos/5.4. cumplimiento_legal_fiscal]]|
| ğŸ”— Ver tambiÃ©n       | [[Proyecto OnlyCarNLD/Datos/1.1.7 contratos_b2b]]          |

---
