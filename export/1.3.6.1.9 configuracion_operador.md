---
id: 1.3.6.1.9
title: ConfiguraciÃ³n del Operador
parent: 1.3.6.1
breadcrumb: 0 â†’ 1.0 â†’ 1.3 â†’ 1.3.6 â†’ 1.3.6.1 â†’ 1.3.6.1.9
type: hoja
status: activo
domain: comunicacion
summary: Preferencias individuales del operador que afectan matching incluyendo zonas,
  servicios, distancia mÃ¡xima y Do Not Disturb.
version: 1.0
last_updated: 2026-01-29 15:31
file_create: 2025-12-26 13:11
actors:
- operador
dependencies:
- supabase
affects:
- 1.3.6.1 asignacion_citas
content_hash: fcd71970a470b16d
---

# 1.3.6.1.9 ConfiguraciÃ³n del Operador

Preferencias individuales que afectan el matching y broadcasts.

---

## Panel de ConfiguraciÃ³n

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âš™ï¸ MI CONFIGURACIÃ“N                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  DISPONIBILIDAD                                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  Estado actual: ğŸŸ¢ Disponible                                   â”‚
â”‚  [ Ver mi horario semanal â†’ ]                                   â”‚
â”‚                                                                 â”‚
â”‚  ZONAS DE TRABAJO                                               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  [âœ“] Centro (principal)                                         â”‚
â”‚  [âœ“] Norte                                                      â”‚
â”‚  [ ] Sur                                                        â”‚
â”‚  [ Ver mapa de zonas â†’ ]                                        â”‚
â”‚                                                                 â”‚
â”‚  TIPOS DE SERVICIO                                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  [âœ“] Lavado Express                                             â”‚
â”‚  [âœ“] Lavado Completo                                            â”‚
â”‚  [âœ“] Detallado Premium                                          â”‚
â”‚  [ ] Encerado (requiere capacitaciÃ³n)                           â”‚
â”‚                                                                 â”‚
â”‚  PREFERENCIAS DE SOLICITUDES                                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                 â”‚
â”‚  Recibir de clientes:                                           â”‚
â”‚  [âœ“] B2C Individual                                             â”‚
â”‚  [âœ“] Corporate+                                                 â”‚
â”‚  [âœ“] B2B Empresas                                               â”‚
â”‚                                                                 â”‚
â”‚  Distancia mÃ¡xima: [ 8 km â–¼ ]                                   â”‚
â”‚                                                                 â”‚
â”‚  Servicios por dÃ­a mÃ¡ximo: [ 6 â–¼ ]                              â”‚
â”‚                                                                 â”‚
â”‚  Tiempo mÃ­nimo entre citas: [ 30 min â–¼ ]                        â”‚
â”‚                                                                 â”‚
â”‚  NOTIFICACIONES                                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  [âœ“] Push notifications                                         â”‚
â”‚  [âœ“] Sonido para nuevas solicitudes                             â”‚
â”‚  [âœ“] VibraciÃ³n                                                  â”‚
â”‚  [ ] No molestar 22:00 - 07:00                                  â”‚
â”‚                                                                 â”‚
â”‚  [ Guardar cambios ]                                            â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Modelo de Datos

```sql
CREATE TABLE config_operador (
  operador_id UUID PRIMARY KEY REFERENCES operadores(id),
  
  -- Preferencias de solicitudes
  recibir_b2c BOOLEAN DEFAULT true,
  recibir_corporate BOOLEAN DEFAULT true,
  recibir_b2b BOOLEAN DEFAULT true,
  distancia_max_km DECIMAL(5, 2) DEFAULT 10,
  servicios_max_dia INT DEFAULT 8,
  tiempo_entre_citas_min INT DEFAULT 30,  -- minutos
  
  -- Notificaciones
  push_enabled BOOLEAN DEFAULT true,
  sound_enabled BOOLEAN DEFAULT true,
  vibration_enabled BOOLEAN DEFAULT true,
  dnd_enabled BOOLEAN DEFAULT false,
  dnd_inicio TIME DEFAULT '22:00',
  dnd_fin TIME DEFAULT '07:00',
  
  -- Servicios habilitados (array de IDs)
  servicios_habilitados UUID[] DEFAULT '{}',
  
  -- Metadata
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

-- Trigger para updated_at
CREATE TRIGGER update_config_operador_timestamp
BEFORE UPDATE ON config_operador
FOR EACH ROW EXECUTE FUNCTION update_timestamp();
```

---

## AplicaciÃ³n en Matching

```sql
-- Modificar buscar_operadores_elegibles para usar config
CREATE OR REPLACE FUNCTION buscar_operadores_elegibles_v2(
  p_lat DECIMAL,
  p_lng DECIMAL,
  p_fecha DATE,
  p_hora_inicio TIME,
  p_hora_fin TIME,
  p_servicio_id UUID,
  p_cliente_id UUID,
  p_tipo_cliente VARCHAR,  -- 'b2c', 'corporate', 'b2b'
  p_limite INT DEFAULT 5
)
RETURNS TABLE (...) AS $$
BEGIN
  RETURN QUERY
  SELECT ...
  FROM operadores o
  JOIN config_operador co ON o.id = co.operador_id
  WHERE
    -- Filtros base existentes...
    AND (
      -- Filtro por tipo de cliente
      (p_tipo_cliente = 'b2c' AND co.recibir_b2c = true) OR
      (p_tipo_cliente = 'corporate' AND co.recibir_corporate = true) OR
      (p_tipo_cliente = 'b2b' AND co.recibir_b2b = true)
    )
    -- Filtro por distancia mÃ¡xima del operador
    AND calcular_distancia(o.lat_base, o.lng_base, p_lat, p_lng) / 1000 <= co.distancia_max_km
    -- Filtro por servicios habilitados
    AND p_servicio_id = ANY(co.servicios_habilitados)
    -- Filtro por lÃ­mite de servicios del dÃ­a
    AND (
      SELECT COUNT(*) FROM citas c2
      WHERE c2.operador_id = o.id
      AND c2.fecha = p_fecha
      AND c2.estado NOT IN ('cancelada', 'rechazada')
    ) < co.servicios_max_dia
    -- Filtro por tiempo entre citas
    AND NOT EXISTS (
      SELECT 1 FROM citas c3
      WHERE c3.operador_id = o.id
      AND c3.fecha = p_fecha
      AND c3.estado NOT IN ('cancelada', 'rechazada')
      AND (
        c3.hora_fin + (co.tiempo_entre_citas_min || ' minutes')::INTERVAL > p_hora_inicio
        OR
        p_hora_fin + (co.tiempo_entre_citas_min || ' minutes')::INTERVAL > c3.hora_inicio
      )
    )
  ORDER BY score DESC
  LIMIT p_limite;
END;
$$ LANGUAGE plpgsql;
```

---

## Composable: useOperatorConfig

```typescript
// composables/useOperatorConfig.ts
export const useOperatorConfig = () => {
  const supabase = useSupabaseClient();
  const user = useSupabaseUser();
  
  const config = ref<OperatorConfig | null>(null);
  const isLoading = ref(true);
  
  const fetchConfig = async () => {
    isLoading.value = true;
    const { data } = await supabase
      .from('config_operador')
      .select('*')
      .eq('operador_id', user.value?.id)
      .single();
    
    config.value = data;
    isLoading.value = false;
  };
  
  const updateConfig = async (updates: Partial<OperatorConfig>) => {
    const { error } = await supabase
      .from('config_operador')
      .upsert({
        operador_id: user.value?.id,
        ...updates,
        updated_at: new Date()
      });
    
    if (!error) {
      config.value = { ...config.value, ...updates } as OperatorConfig;
      toast.success('ConfiguraciÃ³n guardada');
    }
  };
  
  const toggleServicio = async (servicioId: string, enabled: boolean) => {
    const servicios = config.value?.servicios_habilitados || [];
    
    const newServicios = enabled
      ? [...servicios, servicioId]
      : servicios.filter(s => s !== servicioId);
    
    await updateConfig({ servicios_habilitados: newServicios });
  };
  
  onMounted(fetchConfig);
  
  return {
    config: readonly(config),
    isLoading: readonly(isLoading),
    updateConfig,
    toggleServicio
  };
};
```

---

## Validaciones

| Config | ValidaciÃ³n | Mensaje |
|--------|------------|---------|
| `distancia_max_km` | Min 1, Max 50 | "Distancia debe ser 1-50 km" |
| `servicios_max_dia` | Min 1, Max 20 | "Servicios por dÃ­a: 1-20" |
| `tiempo_entre_citas_min` | Min 0, Max 120 | "Tiempo entre citas: 0-120 min" |
| `servicios_habilitados` | Min 1 | "Debes habilitar al menos 1 servicio" |

---

## Do Not Disturb

```typescript
// Verificar antes de enviar push
const shouldSendPush = async (operadorId: string): Promise<boolean> => {
  const { data } = await supabase
    .from('config_operador')
    .select('push_enabled, dnd_enabled, dnd_inicio, dnd_fin')
    .eq('operador_id', operadorId)
    .single();
  
  if (!data?.push_enabled) return false;
  
  if (data.dnd_enabled) {
    const now = new Date();
    const horaActual = now.getHours() * 100 + now.getMinutes();
    const dndInicio = parseInt(data.dnd_inicio.replace(':', ''));
    const dndFin = parseInt(data.dnd_fin.replace(':', ''));
    
    // Manejar rango que cruza medianoche
    if (dndInicio > dndFin) {
      if (horaActual >= dndInicio || horaActual < dndFin) return false;
    } else {
      if (horaActual >= dndInicio && horaActual < dndFin) return false;
    }
  }
  
  return true;
};
```

---

## NavegaciÃ³n

| â¬†ï¸ Padre             | [[Proyecto OnlyCarNLD/Datos/1.3.6.1 asignacion_citas]]         |
| -------------------- | ------------------------------------ |
| â¬…ï¸ Hermano anterior  | [[Proyecto OnlyCarNLD/Datos/1.3.6.1.8 prioridades_ranking]]    |
| â¡ï¸ Hermano siguiente | [[Proyecto OnlyCarNLD/Datos/1.3.6.1.10 metricas_asignacion]]   |

---
