---
id: 3.1.4.9
title: Tablas Marketplace
parent: 3.1.4
breadcrumb: 0 → 3.0 → 3.1 → 3.1.4 → 3.1.4.9
type: hoja
status: activo
domain:
- sql
- marketplace
- ecommerce
actors:
- sistema
- operador
summary: Esquema SQL para el Marketplace de Operadores. Inventario, Carrito y Órdenes.
last_updated: 2026-01-29 15:31
content_hash: bc50b0bf71385b7c
---

# 3.1.4.9 Tablas Marketplace

> **Backing SQL para [[Proyecto OnlyCarNLD/Datos/3.1.11 marketplace_operadores]]**

---

## 1. Inventario y Productos

### productos_marketplace

Catálogo de items disponibles para compra por operadores.

```sql
CREATE TABLE IF NOT EXISTS productos_marketplace (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  sku VARCHAR(50) NOT NULL UNIQUE,
  nombre VARCHAR(200) NOT NULL,
  descripcion TEXT,
  
  precio DECIMAL(10,2) NOT NULL CHECK (precio >= 0),
  costo DECIMAL(10,2) NOT NULL DEFAULT 0, -- Para cálculo de margen interno
  
  stock_actual INTEGER NOT NULL DEFAULT 0,
  stock_minimo INTEGER DEFAULT 5, -- Punto de reorden
  
  categoria VARCHAR(50) NOT NULL, -- 'quimicos', 'herramientas', 'merch'
  imagen_url TEXT,
  
  activo BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_productos_categoria ON productos_marketplace(categoria);
```

## 2. Proceso de Compra

### carrito_compras

Estado temporal de la compra del operador.

```sql
CREATE TABLE IF NOT EXISTS carrito_compras (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  operador_id UUID NOT NULL REFERENCES auth.users(id),
  producto_id UUID NOT NULL REFERENCES productos_marketplace(id),
  cantidad INTEGER NOT NULL CHECK (cantidad > 0),
  
  created_at TIMESTAMPTZ DEFAULT NOW(),
  
  UNIQUE(operador_id, producto_id)
);
```

### ordenes_compra

Pedidos confirmados.

```sql
CREATE TABLE IF NOT EXISTS ordenes_compra (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  folio VARCHAR(20) NOT NULL UNIQUE, -- Ej: MKT-2026-001
  operador_id UUID NOT NULL REFERENCES auth.users(id),
  
  subtotal DECIMAL(10,2) NOT NULL,
  total DECIMAL(10,2) NOT NULL,
  
  metodo_pago VARCHAR(20) NOT NULL CHECK (metodo_pago IN ('saldo_favor', 'tarjeta', 'deduccion_semanal')),
  estado VARCHAR(20) DEFAULT 'pendiente' CHECK (estado IN ('pendiente', 'pagado', 'entregado', 'cancelado')),
  
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### orden_items

Detalle de la orden.

```sql
CREATE TABLE IF NOT EXISTS orden_items (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  orden_id UUID NOT NULL REFERENCES ordenes_compra(id) ON DELETE CASCADE,
  producto_id UUID NOT NULL REFERENCES productos_marketplace(id),
  
  cantidad INTEGER NOT NULL,
  precio_unitario DECIMAL(10,2) NOT NULL, -- Snapshot del precio al momento de compra
  
  UNIQUE(orden_id, producto_id)
);
```

---

## 3. Kits (Relación M:N)

### kits_items

Definición de qué productos componen un Kit.

```sql
CREATE TABLE IF NOT EXISTS kits_items (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  kit_id UUID NOT NULL REFERENCES productos_marketplace(id), -- El producto padre (tipo 'kit')
  item_id UUID NOT NULL REFERENCES productos_marketplace(id), -- El componente
  
  cantidad_por_kit INTEGER NOT NULL DEFAULT 1,
  
  UNIQUE(kit_id, item_id)
);
```

---

## RLS Policies

```sql
ALTER TABLE productos_marketplace ENABLE ROW LEVEL SECURITY;
ALTER TABLE carrito_compras ENABLE ROW LEVEL SECURITY;
ALTER TABLE ordenes_compra ENABLE ROW LEVEL SECURITY;
ALTER TABLE orden_items ENABLE ROW LEVEL SECURITY;

-- Lectura pública de productos (para operadores)
CREATE POLICY "Productos: ver activos" ON productos_marketplace FOR SELECT USING (activo = true);

-- Gestión de carrito propia
CREATE POLICY "Carrito: propio" ON carrito_compras FOR ALL USING (auth.uid() = operador_id);

-- Órdenes propias
CREATE POLICY "Ordenes: propias" ON ordenes_compra FOR SELECT USING (auth.uid() = operador_id);
```

---

## Navegación

| ⬆️ Padre | [[Proyecto OnlyCarNLD/Datos/3.1.4 esquema_sql_logica_negocio]] |
|----------|--------------------------------------|
| ⬅️ Anterior | [[Proyecto OnlyCarNLD/Datos/3.1.4.8 Tablas_Quantum]] |

---
