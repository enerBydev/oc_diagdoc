---
id: 1.3.6.1.6
title: Negociaci√≥n de Horario
parent: 1.3.6.1
breadcrumb: 0 ‚Üí 1.0 ‚Üí 1.3 ‚Üí 1.3.6 ‚Üí 1.3.6.1 ‚Üí 1.3.6.1.6
type: hoja
status: activo
domain: comunicacion
summary: Chat operador-cliente para acordar hora final con composable, timeout de
  24/48h y reglas de negociaci√≥n.
version: 1.0
last_updated: 2026-01-29 15:32
file_create: 2025-12-26 13:08
actors:
- operador
- cliente
dependencies:
- supabase_realtime
affects:
- 1.3.6.1 asignacion_citas
content_hash: 62a00b3b2610f821
---

# 1.3.6.1.6 Negociaci√≥n de Horario

Chat operador‚Üîcliente para acordar detalles finales.

---

## Flujo Post-Aceptaci√≥n

```mermaid
sequenceDiagram
    participant O as üë∑ Operador
    participant C as üë§ Cliente
    participant S as üóÑÔ∏è Sistema
    
    Note over O,C: Operador acept√≥ broadcast
    
    S->>O: Abre chat con cliente
    S->>C: Notificaci√≥n: "Carlos M. tom√≥ tu solicitud"
    
    O->>C: "Hola! Puedo a las 10:30, ¬øte funciona?"
    C->>O: "S√≠ perfecto, es en el estacionamiento azul"
    O->>C: "Entendido, ah√≠ nos vemos üëç"
    
    O->>S: Confirma hora: 10:30
    C->>S: Acepta confirmaci√≥n
    
    S->>S: Actualizar cita a 'confirmada'
    S->>O: Agregar a agenda
    S->>C: Notificaci√≥n: "Cita confirmada"
```

---

## Datos Negociables

| Dato | Qui√©n Modifica | Restricciones |
|------|----------------|---------------|
| **Hora exacta** | Operador (propone), Cliente (acepta) | Dentro de rango flexible |
| **Instrucciones de ubicaci√≥n** | Cliente | Texto libre |
| **Notas adicionales** | Ambos | Texto libre |
| **Veh√≠culo** | Cliente | Ya definido previamente |
| ~~Servicio~~ | ‚ùå No | Ya definido |
| ~~Precio~~ | ‚ùå No | Ya definido |
| ~~Fecha~~ | ‚ùå No (reagendar = nueva solicitud) | ‚Äî |

---

## UI: Chat de Negociaci√≥n (Operador)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ‚Üê Juan Garc√≠a                                    üìç üìû         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                 ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ  ‚îÇ  üìã SOLICITUD DE SERVICIO                               ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  üöó Lavado Express ‚Ä¢ $299                               ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  üìÖ 17 Enero 2025                                       ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  ‚è∞ ~10:00 AM (flexible ¬±2h)                            ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  üìç Col. Centro, Blvd. Colosio #456                     ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ                                                         ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  Estado: ‚è≥ Negociando                                  ‚îÇ    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  ü§ñ Carlos M. ha sido asignado para tu servicio.                 ‚îÇ
‚îÇ     Coordinen los detalles finales aqu√≠.                        ‚îÇ
‚îÇ                                                        11:30    ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                                ‚îÇ
‚îÇ  ‚îÇ Hola Juan! Tengo disponible ‚îÇ                                ‚îÇ
‚îÇ  ‚îÇ a las 10:30, ¬øte funciona?  ‚îÇ                                ‚îÇ
‚îÇ  ‚îÇ                      11:32  ‚îÇ                                ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ                              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ                              ‚îÇ S√≠ perfecto! Es en el       ‚îÇ    ‚îÇ
‚îÇ                              ‚îÇ estacionamiento del         ‚îÇ    ‚îÇ
‚îÇ                              ‚îÇ edificio azul, junto al     ‚îÇ    ‚îÇ
‚îÇ                              ‚îÇ Oxxo                        ‚îÇ    ‚îÇ
‚îÇ                              ‚îÇ                      11:33  ‚îÇ    ‚îÇ
‚îÇ                              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                 ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ  ‚îÇ  ‚è∞ CONFIRMAR HORA FINAL                                ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ                                                         ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  Hora acordada: [ 10:30 ‚ñº ]                             ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ                                                         ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  [ Confirmar cita ]                                     ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ                                                         ‚îÇ    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  üìé  Aa  Escribe un mensaje...                        ‚û§         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## Composable: useNegotiation

```typescript
// composables/useNegotiation.ts
export const useNegotiation = (solicitudId: string) => {
  const supabase = useSupabaseClient();
  
  const solicitud = ref<Solicitud | null>(null);
  const cita = ref<Cita | null>(null);
  const horaAcordada = ref<string>('');
  
  // Cargar datos
  const fetchData = async () => {
    const { data } = await supabase
      .from('solicitudes')
      .select(`
        *,
        citas (*),
        clientes (nombre, telefono)
      `)
      .eq('id', solicitudId)
      .single();
    
    solicitud.value = data;
    cita.value = data?.citas?.[0];
    horaAcordada.value = solicitud.value?.hora_preferida || '';
  };
  
  // Proponer hora (solo actualiza UI, no persiste)
  const proponerHora = (hora: string) => {
    horaAcordada.value = hora;
  };
  
  // Confirmar cita
  const confirmarCita = async () => {
    if (!cita.value) return false;
    
    // 1. Actualizar cita
    const { error } = await supabase
      .from('citas')
      .update({
        hora_inicio: horaAcordada.value,
        hora_fin: calcularHoraFin(horaAcordada.value, solicitud.value!.servicio_duracion),
        estado: 'confirmada',
        confirmada_at: new Date()
      })
      .eq('id', cita.value.id);
    
    if (error) {
      toast.error('Error al confirmar');
      return false;
    }
    
    // 2. Enviar mensaje de confirmaci√≥n
    await enviarMensajeSistema(solicitudId, {
      texto: `‚úÖ Cita confirmada para el ${formatDate(solicitud.value!.fecha)} a las ${horaAcordada.value}`,
      tipo: 'cita_confirmada'
    });
    
    // 3. Notificar a cliente
    await notificarCliente(solicitud.value!.cliente_id, {
      title: '‚úÖ Cita confirmada',
      body: `Tu servicio con ${useSupabaseUser().value?.nombre} es el ${formatDate(solicitud.value!.fecha)} a las ${horaAcordada.value}`
    });
    
    toast.success('¬°Cita confirmada!');
    return true;
  };
  
  // Cancelar negociaci√≥n (devuelve al pool)
  const cancelarNegociacion = async (motivo: string) => {
    await supabase
      .from('citas')
      .update({ estado: 'cancelada', motivo_cancelacion: motivo })
      .eq('id', cita.value!.id);
    
    // Re-broadcast excluyendo este operador
    await rebroadcastSolicitud(solicitudId, [useSupabaseUser().value!.id]);
  };
  
  onMounted(fetchData);
  
  return {
    solicitud,
    cita,
    horaAcordada,
    proponerHora,
    confirmarCita,
    cancelarNegociacion
  };
};
```

---

## Timeout de Negociaci√≥n

```typescript
// Si pasan 24h sin confirmar, notificar
const checkNegociacionesPendientes = async () => {
  const hace24h = new Date(Date.now() - 24 * 60 * 60 * 1000);
  
  const { data } = await supabase
    .from('citas')
    .select('id, operador_id, solicitud_id')
    .eq('estado', 'negociando')
    .lt('created_at', hace24h.toISOString());
  
  for (const cita of data || []) {
    // Notificar a ambas partes
    await notificarOperador(cita.operador_id, {
      title: '‚ö†Ô∏è Cita sin confirmar',
      body: 'Tienes una cita pendiente de confirmaci√≥n hace m√°s de 24h'
    });
    
    // Si pasan 48h, cancelar y re-broadcast
  }
};
```

---

## Reglas de Negociaci√≥n

| Regla | Descripci√≥n |
|-------|-------------|
| **NEG-001** | Hora debe estar en rango flexible del cliente |
| **NEG-002** | M√°ximo 24h para confirmar (alerta) |
| **NEG-003** | M√°ximo 48h para confirmar (auto-cancelar) |
| **NEG-004** | Servicio y precio NO son negociables |
| **NEG-005** | Solo operador puede confirmar hora final |
| **NEG-006** | Cliente puede cancelar antes de confirmar |

---

## Navegaci√≥n

| ‚¨ÜÔ∏è Padre             | [[Proyecto OnlyCarNLD/Datos/1.3.6.1 asignacion_citas]]        |
| -------------------- | ----------------------------------- |
| ‚¨ÖÔ∏è Hermano anterior  | [[Proyecto OnlyCarNLD/Datos/1.3.6.1.5 aceptacion_rechazo]]    |
| ‚û°Ô∏è Hermano siguiente | [[Proyecto OnlyCarNLD/Datos/1.3.6.1.7 fallback_manual]]       |

---
