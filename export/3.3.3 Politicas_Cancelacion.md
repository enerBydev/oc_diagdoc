---
id: 3.3.3
title: PolÃ­ticas de CancelaciÃ³n
parent: '3.3'
breadcrumb: 0 â†’ 3.0 â†’ 3.3 â†’ 3.3.3
type: hoja
status: activo
last_updated: 2026-01-29 15:32
file_create: 2026-01-05 12:40
domain:
- negocio
- cancelacion
- tarifas
actors:
- cliente
- admin
summary: Flujos de cancelaciÃ³n con tarifas dinÃ¡micas por tiempo.
content_hash: d9c33844f6d02913
---

# 3.3.3 PolÃ­ticas de CancelaciÃ³n

> Tarifas dinÃ¡micas segÃºn anticipaciÃ³n de la cancelaciÃ³n.

---

## 1. Tabla de Penalizaciones

| AnticipaciÃ³n | PenalizaciÃ³n | Reembolso Cliente |
|--------------|--------------|-------------------|
| > 24 horas | 0% (gratis) | 100% |
| 12-24 horas | 25% | 75% |
| 6-12 horas | 50% | 50% |
| < 6 horas | 75% | 25% |
| No-show | 100% | 0% |

---

## 2. Diagrama de Estado de CancelaciÃ³n

```mermaid
stateDiagram-v2
    [*] --> Programada: Cita Confirmada
    Programada --> CancelRequest: Cliente solicita
    Programada --> OpCancelRequest: Operador solicita
    
    CancelRequest --> FreeCancel: >24h
    CancelRequest --> PartialCharge: 12-24h (25%)
    CancelRequest --> MajorCharge: 6-12h (50%)
    CancelRequest --> FullCharge: <6h (75%)
    CancelRequest --> NoShow: No apareciÃ³ (100%)
    
    OpCancelRequest --> OpFreeCancel: >24h sin penalizaciÃ³n
    OpCancelRequest --> OpPenalty: <24h Afecta ranking
    
    FreeCancel --> Cancelada
    PartialCharge --> Refund75: Procesar Refund 75%
    MajorCharge --> Refund50: Procesar Refund 50%
    FullCharge --> Refund25: Procesar Refund 25%
    NoShow --> NoRefund: Sin reembolso
    
    OpFreeCancel --> Cancelada
    OpPenalty --> Cancelada: Registrar en [[3.1.8.1.5 Ajuste_Penalizacion]]
    
    Refund75 --> Cancelada
    Refund50 --> Cancelada
    Refund25 --> Cancelada
    NoRefund --> Cancelada
    Cancelada --> [*]
```

---

## 3. LÃ³gica de Excepciones

Casos donde se omite la penalizaciÃ³n estÃ¡ndar:

| ExcepciÃ³n | PenalizaciÃ³n | Aprobador | Evidencia Requerida |
|-----------|--------------|-----------|---------------------|
| Emergencia mÃ©dica documentada | 0% | Admin | Documento mÃ©dico |
| Clima severo (huracÃ¡n/inundaciÃ³n) | 0% automÃ¡tico | Sistema | Alerta meteorolÃ³gica |
| Muerte familiar | 0% + cupÃ³n APOLOGY | Admin | Acta defunciÃ³n |
| Falla del operador | 0% + bonificaciÃ³n cliente | Sistema | Log de incidencia |
| Error de sistema | 0% + bonificaciÃ³n | Sistema | Log de error |

---

## 4. IntegraciÃ³n API

**Endpoint:** `PATCH /api/citas/:id/cancel`

```typescript
// Request
interface CancelCitaRequest {
  motivo: 'CLIENTE' | 'OPERADOR' | 'SISTEMA' | 'EXCEPCION';
  razon?: string;
  solicita_excepcion?: boolean;
  evidencia_url?: string;
}

// Response (200 OK)
interface CancelCitaResponse {
  cita_id: string;
  estado: 'cancelada';
  penalizacion_aplicada: number;
  refund_procesado: boolean;
  refund_monto?: number;
}
```

**Referencia Completa:** [[Proyecto OnlyCarNLD/Datos/3.1.5 api_logica_negocio]]

---

## 5. LÃ³gica de CÃ¡lculo

```typescript
const calcularPenalizacion = (cita: Cita): number => {
  const horasAntes = differenceInHours(cita.fecha_programada, new Date());
  
  if (horasAntes > 24) return 0;
  if (horasAntes >= 12) return cita.precio_final * 0.25;
  if (horasAntes >= 6) return cita.precio_final * 0.50;
  if (horasAntes > 0) return cita.precio_final * 0.75;
  return cita.precio_final; // No-show
};
```

---

## NavegaciÃ³n

| â¬†ï¸ Padre | [[Proyecto OnlyCarNLD/Datos/3.3. reglas_negocio]] |
|----------|-------------------------|
| â¬…ï¸ Anterior | [[Proyecto OnlyCarNLD/Datos/3.3.2 Validaciones_Backend]] |
| â¡ï¸ Siguiente | [[Proyecto OnlyCarNLD/Datos/3.3.4 Politicas_Reagendamiento]] |
| ğŸ”— Relacionado | [[Proyecto OnlyCarNLD/Datos/1.6.3.3 politicas_compensacion]] |
| ğŸ”— Relacionado | [[Proyecto OnlyCarNLD/Datos/5.1. stripe_pagos]] |

---

