---
id: 5.8.6.3
title: RLS Policies
parent: 5.8.6
breadcrumb: 0 → 5.0 → 5.8 → 5.8.6 → 5.8.6.3
type: seguridad
status: activo
last_updated: 2026-01-29 15:32
file_create: 2026-01-01 18:10
domain:
- rls
- supabase
- permisos
summary: Políticas RLS para ubicaciones.
content_hash: de245b82470e0249
---

# 5.8.6.3 RLS Policies

Row Level Security para tablas de ubicación.

---

## Principios de Seguridad

> [!IMPORTANT]
> - **Operador:** Solo puede escribir su propia ubicación
> - **Cliente:** Solo puede leer ubicaciones de sus servicios
> - **Admin:** Acceso completo para monitoreo
> - **Anónimo:** Sin acceso

---

## Habilitar RLS

```sql
-- Habilitar RLS en todas las tablas de ubicación
ALTER TABLE ubicaciones_servicio ENABLE ROW LEVEL SECURITY;
ALTER TABLE ubicacion_actual ENABLE ROW LEVEL SECURITY;

-- Forzar RLS incluso para el owner de la tabla
ALTER TABLE ubicaciones_servicio FORCE ROW LEVEL SECURITY;
ALTER TABLE ubicacion_actual FORCE ROW LEVEL SECURITY;
```

---

## Políticas: ubicaciones_servicio

### SELECT (Lectura)

```sql
-- Operador: puede ver ubicaciones de servicios donde es el operador
CREATE POLICY "operador_ve_sus_ubicaciones"
ON ubicaciones_servicio
FOR SELECT
TO authenticated
USING (
  operador_id = auth.uid()
);

-- Cliente: puede ver ubicaciones de sus servicios
CREATE POLICY "cliente_ve_ubicaciones_sus_servicios"
ON ubicaciones_servicio
FOR SELECT
TO authenticated
USING (
  EXISTS (
    SELECT 1 FROM servicios s
    WHERE s.id = ubicaciones_servicio.servicio_id
    AND s.cliente_id = auth.uid()
  )
);

-- Admin: puede ver todas las ubicaciones
CREATE POLICY "admin_ve_todas_ubicaciones"
ON ubicaciones_servicio
FOR SELECT
TO authenticated
USING (
  EXISTS (
    SELECT 1 FROM users u
    WHERE u.id = auth.uid()
    AND u.rol = 'admin'
  )
);
```

### INSERT (Escritura)

```sql
-- Operador: solo puede insertar ubicaciones donde es el operador asignado
CREATE POLICY "operador_inserta_su_ubicacion"
ON ubicaciones_servicio
FOR INSERT
TO authenticated
WITH CHECK (
  operador_id = auth.uid()
  AND EXISTS (
    SELECT 1 FROM servicios s
    WHERE s.id = ubicaciones_servicio.servicio_id
    AND s.operador_id = auth.uid()
    AND s.estado = 'en_camino'
  )
);
```

### UPDATE / DELETE (Prohibido)

```sql
-- Nadie puede modificar ubicaciones históricas (inmutabilidad)
CREATE POLICY "no_update_ubicaciones"
ON ubicaciones_servicio
FOR UPDATE
TO authenticated
USING (false);

-- Nadie puede borrar ubicaciones (solo cleanup automático)
CREATE POLICY "no_delete_ubicaciones"
ON ubicaciones_servicio
FOR DELETE
TO authenticated
USING (
  EXISTS (
    SELECT 1 FROM users u
    WHERE u.id = auth.uid()
    AND u.rol = 'admin'
  )
);
```

---

## Políticas: ubicacion_actual

```sql
-- Cliente: puede ver ubicación actual de sus servicios
CREATE POLICY "cliente_ve_ubicacion_actual"
ON ubicacion_actual
FOR SELECT
TO authenticated
USING (
  EXISTS (
    SELECT 1 FROM servicios s
    WHERE s.id = ubicacion_actual.servicio_id
    AND s.cliente_id = auth.uid()
    AND s.estado IN ('en_camino', 'llegado')
  )
);

-- Admin: puede ver todas las ubicaciones actuales
CREATE POLICY "admin_ve_ubicacion_actual"
ON ubicacion_actual
FOR SELECT
TO authenticated
USING (
  EXISTS (
    SELECT 1 FROM users u
    WHERE u.id = auth.uid()
    AND u.rol = 'admin'
  )
);

-- Operador: puede ver su propia ubicación actual
CREATE POLICY "operador_ve_su_ubicacion_actual"
ON ubicacion_actual
FOR SELECT
TO authenticated
USING (
  operador_id = auth.uid()
);

-- Insert/Update manejado por trigger (no política directa)
```

---

## Función Helper: Verificar Acceso

```sql
-- Función para verificar si un usuario puede ver un servicio
CREATE OR REPLACE FUNCTION puede_ver_ubicacion(p_servicio_id UUID)
RETURNS BOOLEAN AS $$
BEGIN
  RETURN EXISTS (
    SELECT 1 FROM servicios s
    WHERE s.id = p_servicio_id
    AND (
      s.cliente_id = auth.uid()
      OR s.operador_id = auth.uid()
      OR EXISTS (
        SELECT 1 FROM users u 
        WHERE u.id = auth.uid() 
        AND u.rol = 'admin'
      )
    )
  );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

---

## Diagrama de Acceso

```
┌─────────────────────────────────────────────────────────────────┐
│  MATRIZ DE PERMISOS - UBICACIONES                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  TABLA: ubicaciones_servicio                                    │
│  ┌───────────┬────────┬────────┬────────┬────────┐              │
│  │           │ SELECT │ INSERT │ UPDATE │ DELETE │              │
│  ├───────────┼────────┼────────┼────────┼────────┤              │
│  │ Anónimo   │   ❌   │   ❌   │   ❌   │   ❌   │              │
│  │ Cliente   │   ✅*  │   ❌   │   ❌   │   ❌   │              │
│  │ Operador  │   ✅*  │   ✅*  │   ❌   │   ❌   │              │
│  │ Admin     │   ✅   │   ❌   │   ❌   │   ✅   │              │
│  └───────────┴────────┴────────┴────────┴────────┘              │
│                                                                 │
│  * = Solo para servicios relacionados                           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## Testing de Políticas

```sql
-- Test: Como cliente, intentar ver ubicación de servicio ajeno
SET LOCAL ROLE authenticated;
SET LOCAL request.jwt.claims = '{"sub": "cliente-uuid-123"}';

SELECT * FROM ubicaciones_servicio 
WHERE servicio_id = 'servicio-de-otro-cliente';
-- Resultado esperado: 0 rows

-- Test: Como operador, intentar insertar en servicio ajeno
INSERT INTO ubicaciones_servicio (servicio_id, operador_id, lat, lng)
VALUES ('servicio-ajeno', 'mi-uuid', 27.4797, -99.5067);
-- Resultado esperado: ERROR policy violation
```

---

→ Ver Cloudflare Edge: [[Proyecto OnlyCarNLD/Datos/5.8.6.4 cloudflare_edge]]

---

## Navegación

| ⬆️ Padre             | [[Proyecto OnlyCarNLD/Datos/5.8.6 backend_ubicaciones]]            |
| -------------------- | ---------------------- |
| ⬅️ Hermano anterior  | [[Proyecto OnlyCarNLD/Datos/5.8.6.2 supabase_schema]]              |
| ➡️ Hermano siguiente | [[Proyecto OnlyCarNLD/Datos/5.8.6.4 cloudflare_edge]]              |
