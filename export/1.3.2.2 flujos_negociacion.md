---
id: 1.3.2.2
title: Flujos de Negociación
parent: 1.3.2
breadcrumb: 0 → 1.0 → 1.3 → 1.3.2 → 1.3.2.2
type: hoja
status: activo
domain: comunicacion
summary: Máquina de estados FSM para negociaciones B2B con transiciones automáticas,
  historial y estados desde prospecto hasta contrato activo.
version: 1.0
last_updated: 2026-01-29 15:31
file_create: 2025-12-23 23:53
actors:
- admin
- cliente_b2b
dependencies:
- mifiel
affects:
- 1.3.2 chat_admin_cliente
content_hash: 33e54b1620ef6f36
---

# 1.3.2.2 Flujos de Negociación

Máquina de estados para negociaciones B2B.

---

## FSM: Negociación B2B

```mermaid
stateDiagram-v2
    [*] --> prospecto
    prospecto --> propuesta_enviada: Admin envía propuesta
    propuesta_enviada --> en_negociacion: Cliente responde
    propuesta_enviada --> expirada: 30 días sin respuesta
    en_negociacion --> propuesta_ajustada: Admin modifica
    en_negociacion --> aceptada: Cliente acepta
    propuesta_ajustada --> en_negociacion: Cliente responde
    aceptada --> contrato_enviado: Admin genera contrato
    contrato_enviado --> firmado: Ambos firman
    contrato_enviado --> rechazado: Cliente rechaza
    firmado --> activo: Contrato vigente
    expirada --> [*]
    rechazado --> [*]
```

---

## Estados

| Estado | Descripción | Acciones |
|--------|-------------|----------|
| `prospecto` | Cliente identificado | Enviar propuesta |
| `propuesta_enviada` | Esperando respuesta | Ver, seguimiento |
| `en_negociacion` | Intercambio activo | Responder, ajustar |
| `propuesta_ajustada` | Nueva versión | Esperar respuesta |
| `aceptada` | Cliente aceptó | Generar contrato |
| `contrato_enviado` | Pendiente firma | Rastrear firma |
| `firmado` | Firma completada | Activar servicios |
| `activo` | Relación comercial | Gestionar cuenta |
| `expirada` | Sin respuesta | Archivar, relanzar |
| `rechazado` | Cliente declinó | Archivar |

---

## Transiciones Automáticas

| Trigger | De | A | Condición |
|---------|----|----|-----------| 
| Timer 30 días | propuesta_enviada | expirada | Sin respuesta |
| Webhook Mifiel | contrato_enviado | firmado | Todas las firmas |
| Timer 7 días | contrato_enviado | recordatorio | Sin firma |

---

## Historial

```sql
CREATE TABLE negociacion_historial (
  id UUID PRIMARY KEY,
  conversacion_id UUID REFERENCES conversations(id),
  estado_anterior VARCHAR(50),
  estado_nuevo VARCHAR(50),
  trigger VARCHAR(100),
  actor_id UUID,
  metadata JSONB,
  created_at TIMESTAMPTZ DEFAULT now()
);
```

---

## Navegación

| ⬆️ Padre             | [[Proyecto OnlyCarNLD/Datos/1.3.2 chat_admin_cliente]]        |
| -------------------- | ----------------------------------- |
| ⬅️ Hermano anterior  | [[Proyecto OnlyCarNLD/Datos/1.3.2.1 cards_admin_cliente]]     |
| ➡️ Hermano siguiente | [[Proyecto OnlyCarNLD/Datos/1.3.2.3 notificaciones_admin]]    |

---
