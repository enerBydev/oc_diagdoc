---
id: 3.1.7.7
title: API Endpoints - Sistema de Costos
parent: 3.1.7
breadcrumb: 0 → 3.0 → 3.1 → 3.1.7 → 3.1.7.7
type: hoja
status: activo
last_updated: 2026-01-29 15:32
file_create: 2025-12-17 11:53
domain:
- api
- endpoints
- nitro
actors:
- admin
summary: 'API endpoints del sistema de costos.

  CRUD de recursos, análisis y aplicación de precios.'
content_hash: eea1d501eb7ba24b
---

# 3.1.7.7 API Endpoints - Sistema de Costos

**Stack:** Nitro v3 + Supabase Client  
**Autenticación:** JWT + verificación rol admin

---

### Tabla de Endpoints

| Método | Endpoint | Descripción |
|--------|----------|-------------|
| GET | `/api/admin/costos/recursos` | Listar recursos |
| POST | `/api/admin/costos/recursos` | Crear recurso |
| PUT | `/api/admin/costos/recursos/:id` | Actualizar recurso |
| DELETE | `/api/admin/costos/recursos/:id` | Eliminar recurso |
| GET | `/api/admin/costos/fijos` | Listar costos fijos |
| POST | `/api/admin/costos/fijos` | Crear costo fijo |
| PUT | `/api/admin/costos/fijos/:id` | Actualizar costo fijo |
| DELETE | `/api/admin/costos/fijos/:id` | Eliminar costo fijo |
| GET | `/api/admin/costos/servicio/:id` | Análisis de un servicio |
| POST | `/api/admin/costos/servicio/:id/asignar` | Asignar recurso a servicio |
| DELETE | `/api/admin/costos/servicio/:id/recurso/:rid` | Quitar recurso de servicio |
| GET | `/api/admin/costos/analisis` | Análisis de todos los servicios |
| POST | `/api/admin/costos/aplicar-precio` | Aplicar precio sugerido |
| GET | `/api/admin/costos/sync-json` | Regenerar JSON en R2 |
| GET | `/api/admin/costos/config` | Obtener config márgenes |
| PUT | `/api/admin/costos/config` | Actualizar config márgenes |

---

### Ejemplo: GET /api/admin/costos/servicio/:id

```typescript
// server/api/admin/costos/servicio/[id].get.ts
import { serverSupabaseClient } from '#supabase/server'

export default defineEventHandler(async (event) => {
  const servicioId = getRouterParam(event, 'id')
  const client = await serverSupabaseClient(event)
  
  // Verificar rol admin
  const { data: { user } } = await client.auth.getUser()
  if (!user || user.user_metadata?.role !== 'admin') {
    throw createError({ statusCode: 403, message: 'No autorizado' })
  }
  
  // Obtener análisis del servicio
  const { data: analisis, error } = await client
    .from('v_analisis_costos')
    .select('*')
    .eq('servicio_id', servicioId)
    .single()
  
  if (error) {
    throw createError({ statusCode: 404, message: 'Servicio sin costos asignados' })
  }
  
  // Obtener detalle de costos asignados
  const { data: costosDetalle } = await client
    .from('costos_servicio')
    .select(`
      id,
      cantidad,
      notas,
      recurso:recursos(id, nombre, unidad, costo_unitario, tipo_costo:tipos_costo(nombre))
    `)
    .eq('servicio_id', servicioId)
  
  // Obtener precio actual de config_precios
  const configPrecios = await useStorage('assets:server').getItem('config_precios_v3.2.json')
  const servicio = configPrecios.servicios.find(s => s.id === servicioId)
  const precioActual = servicio ? Math.round(servicio.precioBase * 0.7 / 10) * 10 : null
  
  return {
    servicioId,
    nombre: servicio?.nombre,
    costosDetalle: costosDetalle?.map(c => ({
      id: c.id,
      recursoId: c.recurso.id,
      nombre: c.recurso.nombre,
      tipo: c.recurso.tipo_costo.nombre,
      cantidad: c.cantidad,
      unidad: c.recurso.unidad,
      costoUnitario: c.recurso.costo_unitario,
      costoTotal: c.cantidad * c.recurso.costo_unitario,
      notas: c.notas
    })),
    resumen: {
      costoVariable: analisis.costo_variable,
      costoFijoProrrateado: analisis.costo_fijo_prorrateado,
      costoTotal: analisis.costo_total,
      precioActual,
      margenActual: precioActual ? 
        Math.round(((precioActual - analisis.costo_total) / precioActual) * 100 * 100) / 100 : null,
      alertaMargen: precioActual ? 
        ((precioActual - analisis.costo_total) / precioActual) * 100 < analisis.margen_minimo : false
    },
    sugerencias: {
      minimo: { margen: analisis.margen_minimo, precio: analisis.precio_sugerido_minimo },
      optimo: { margen: analisis.margen_optimo, precio: analisis.precio_sugerido_optimo },
      maximo: { margen: analisis.margen_maximo, precio: analisis.precio_sugerido_maximo }
    }
  }
})
```

---

### Ejemplo: POST /api/admin/costos/aplicar-precio

```typescript
// server/api/admin/costos/aplicar-precio.post.ts
import { serverSupabaseClient } from '#supabase/server'

export default defineEventHandler(async (event) => {
  const body = await readBody(event)
  const { servicioId, nuevoPrecio, motivo } = body
  
  const client = await serverSupabaseClient(event)
  const { data: { user } } = await client.auth.getUser()
  
  if (!user || user.user_metadata?.role !== 'admin') {
    throw createError({ statusCode: 403, message: 'No autorizado' })
  }
  
  // Leer config actual
  const storage = useStorage('assets:server')
  const config = await storage.getItem('config_precios_v3.2.json')
  
  // Encontrar servicio y precio anterior
  const servicioIndex = config.servicios.findIndex(s => s.id === servicioId)
  if (servicioIndex === -1) {
    throw createError({ statusCode: 404, message: 'Servicio no encontrado' })
  }
  
  const precioAnterior = config.servicios[servicioIndex].precioBase
  
  // Calcular nuevo precioBase (inverso del factor B2C)
  const nuevoPrecioBase = Math.round(nuevoPrecio / 0.7)
  
  // Registrar en historial
  await client.rpc('fn_registrar_cambio_precio', {
    p_servicio_id: servicioId,
    p_precio_anterior: Math.round(precioAnterior * 0.7 / 10) * 10,
    p_precio_nuevo: nuevoPrecio,
    p_motivo: motivo || 'Ajuste desde calculadora de costos',
    p_user_id: user.id
  })
  
  // Actualizar JSON
  config.servicios[servicioIndex].precioBase = nuevoPrecioBase
  config.meta.lastUpdated = new Date().toISOString().slice(0, 19).replace('T', ' ')
  config.meta.version = incrementVersion(config.meta.version)
  
  // Guardar en R2
  await storage.setItem('config_precios_v3.2.json', config)
  
  // Invalidar cache CDN
  await purgeCache(`/api/config/precios`)
  
  return {
    success: true,
    servicioId,
    precioAnterior: Math.round(precioAnterior * 0.7 / 10) * 10,
    precioNuevo: nuevoPrecio,
    precioBase: nuevoPrecioBase,
    version: config.meta.version
  }
})

function incrementVersion(version: string): string {
  const parts = version.split('.').map(Number)
  parts[2]++
  return parts.join('.')
}
```

---

## Navegación

| ⬆️ Padre             | [[Proyecto OnlyCarNLD/Datos/3.1.7 sistema_costos]]         |
| -------------------- | -------------------------------- |
| ⬅️ Hermano anterior  | [[Proyecto OnlyCarNLD/Datos/3.1.7.6 esquema_sql_costos]]   |
| ➡️ Hermano siguiente | [[Proyecto OnlyCarNLD/Datos/3.1.7.8 json_costos_ejemplo]]  |

---
