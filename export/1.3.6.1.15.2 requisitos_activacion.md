---
id: 1.3.6.1.15.2
title: Requisitos de Activación
parent: 1.3.6.1.15
breadcrumb: 0 → 1.0 → 1.3 → 1.3.6 → 1.3.6.1 → 1.3.6.1.15 → 1.3.6.1.15.2
type: hoja
status: activo
domain: comunicacion
summary: Checklist obligatorio para cambiar estado de ciudad con funciones SQL para
  verificar requisitos de piloto y activación.
version: 1.0
last_updated: 2026-01-29 15:31
file_create: 2025-12-26 17:55
actors:
- admin
dependencies:
- supabase
affects:
- 1.3.6.1.15 control_expansion
content_hash: 4bdb0131d3d7366d
---

# 1.3.6.1.15.2 Requisitos de Activación

Checklist para cambiar estado de ciudad.

---

## Requisitos: Borrador → Piloto

```sql
-- Función para verificar requisitos de piloto
CREATE OR REPLACE FUNCTION verificar_requisitos_piloto(p_ciudad_id UUID)
RETURNS TABLE (
  requisito VARCHAR,
  cumplido BOOLEAN,
  detalle TEXT
) AS $$
BEGIN
  -- REQ 1: Mínimo 2 operadores verificados
  RETURN QUERY
  SELECT 
    'Mínimo 2 operadores verificados'::VARCHAR,
    (SELECT COUNT(*) FROM operadores WHERE ciudad_id = p_ciudad_id AND estado = 'activo') >= 2,
    (SELECT COUNT(*) || ' operadores activos' FROM operadores WHERE ciudad_id = p_ciudad_id AND estado = 'activo')::TEXT;
  
  -- REQ 2: Al menos 1 zona definida
  RETURN QUERY
  SELECT 
    'Al menos 1 zona definida'::VARCHAR,
    (SELECT COUNT(*) FROM zonas WHERE ciudad_id = p_ciudad_id AND activa = true) >= 1,
    (SELECT COUNT(*) || ' zonas activas' FROM zonas WHERE ciudad_id = p_ciudad_id AND activa = true)::TEXT;
  
  -- REQ 3: Admin regional asignado
  RETURN QUERY
  SELECT 
    'Admin regional asignado'::VARCHAR,
    (SELECT admin_regional_id IS NOT NULL FROM ciudades WHERE id = p_ciudad_id),
    COALESCE((SELECT u.nombre FROM ciudades c JOIN users u ON c.admin_regional_id = u.id WHERE c.id = p_ciudad_id), 'No asignado')::TEXT;
END;
$$ LANGUAGE plpgsql;
```

---

## Requisitos: Piloto → Activa

| # | Requisito | Valor Mínimo |
|---|-----------|--------------|
| 1 | Operadores activos | 2 |
| 2 | Servicios piloto completados | 5 |
| 3 | Rating promedio | ≥ 4.0 |
| 4 | Quejas no resueltas | 0 |
| 5 | Días en piloto | ≥ 7 |
| 6 | Herramientas verificadas | 100% básicas |

```sql
CREATE OR REPLACE FUNCTION verificar_requisitos_activa(p_ciudad_id UUID)
RETURNS TABLE (
  requisito VARCHAR,
  cumplido BOOLEAN,
  valor_actual TEXT,
  valor_requerido TEXT
) AS $$
DECLARE
  v_servicios_completados INT;
  v_rating_promedio DECIMAL;
  v_quejas_pendientes INT;
  v_dias_piloto INT;
BEGIN
  -- Calcular métricas
  SELECT COUNT(*) INTO v_servicios_completados
  FROM citas c
  JOIN operadores o ON c.operador_id = o.id
  WHERE o.ciudad_id = p_ciudad_id AND c.estado = 'completada';
  
  SELECT COALESCE(AVG(c.rating_cliente), 0) INTO v_rating_promedio
  FROM citas c
  JOIN operadores o ON c.operador_id = o.id
  WHERE o.ciudad_id = p_ciudad_id AND c.estado = 'completada';
  
  SELECT COUNT(*) INTO v_quejas_pendientes
  FROM quejas q
  JOIN citas c ON q.cita_id = c.id
  JOIN operadores o ON c.operador_id = o.id
  WHERE o.ciudad_id = p_ciudad_id AND q.estado = 'pendiente';
  
  SELECT EXTRACT(DAY FROM NOW() - (
    SELECT created_at FROM ciudades_estado_log
    WHERE ciudad_id = p_ciudad_id AND estado_nuevo = 'piloto'
    ORDER BY created_at DESC LIMIT 1
  ))::INT INTO v_dias_piloto;
  
  -- Requisitos
  RETURN QUERY SELECT 
    'Servicios piloto completados'::VARCHAR,
    v_servicios_completados >= 5,
    v_servicios_completados::TEXT,
    '5'::TEXT;
  
  RETURN QUERY SELECT 
    'Rating promedio'::VARCHAR,
    v_rating_promedio >= 4.0,
    ROUND(v_rating_promedio, 1)::TEXT,
    '4.0'::TEXT;
  
  RETURN QUERY SELECT 
    'Quejas no resueltas'::VARCHAR,
    v_quejas_pendientes = 0,
    v_quejas_pendientes::TEXT,
    '0'::TEXT;
  
  RETURN QUERY SELECT 
    'Días en piloto'::VARCHAR,
    COALESCE(v_dias_piloto, 0) >= 7,
    COALESCE(v_dias_piloto, 0)::TEXT,
    '7'::TEXT;
END;
$$ LANGUAGE plpgsql;
```

---

## UI Admin: Verificar Requisitos

```
┌─────────────────────────────────────────────────────────────────┐
│  ✅ VERIFICAR REQUISITOS - Nuevo Laredo                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Estado actual: PILOTO                                          │
│  Transición deseada: PILOTO → ACTIVA                            │
│                                                                 │
│  REQUISITOS:                                                    │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ ✅ Servicios completados   │ 8      │ Req: 5            │    │
│  │ ✅ Rating promedio         │ 4.6    │ Req: 4.0          │    │
│  │ ✅ Quejas pendientes       │ 0      │ Req: 0            │    │
│  │ ✅ Días en piloto          │ 14     │ Req: 7            │    │
│  │ ✅ Operadores activos      │ 3      │ Req: 2            │    │
│  │ ✅ Herramientas básicas    │ 100%   │ Req: 100%         │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                 │
│  ✅ TODOS LOS REQUISITOS CUMPLIDOS                              │
│                                                                 │
│  [ Cancelar ]                    [ ACTIVAR CIUDAD ]             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## Función de Cambio de Estado

```typescript
// server/api/admin/ciudad/cambiar-estado.post.ts
export default defineEventHandler(async (event) => {
  const { ciudadId, nuevoEstado, motivo } = await readBody(event);
  const adminId = event.context.user?.id;
  
  // 1. Verificar permisos
  if (event.context.user?.role !== 'admin') {
    throw createError({ statusCode: 403, message: 'Solo admin' });
  }
  
  // 2. Obtener estado actual
  const { data: ciudad } = await supabase
    .from('ciudades')
    .select('estado')
    .eq('id', ciudadId)
    .single();
  
  // 3. Validar transición
  const { data: valido } = await supabase
    .rpc('validar_transicion_ciudad', {
      p_estado_actual: ciudad.estado,
      p_estado_nuevo: nuevoEstado
    });
  
  if (!valido) {
    throw createError({ 
      statusCode: 400, 
      message: `No se puede cambiar de ${ciudad.estado} a ${nuevoEstado}` 
    });
  }
  
  // 4. Verificar requisitos según transición
  if (nuevoEstado === 'piloto') {
    const { data: requisitos } = await supabase.rpc('verificar_requisitos_piloto', {
      p_ciudad_id: ciudadId
    });
    const todosOk = requisitos.every(r => r.cumplido);
    if (!todosOk) {
      throw createError({ 
        statusCode: 400, 
        message: 'No cumple todos los requisitos para piloto' 
      });
    }
  }
  
  if (nuevoEstado === 'activa') {
    const { data: requisitos } = await supabase.rpc('verificar_requisitos_activa', {
      p_ciudad_id: ciudadId
    });
    const todosOk = requisitos.every(r => r.cumplido);
    if (!todosOk) {
      throw createError({ 
        statusCode: 400, 
        message: 'No cumple todos los requisitos para activación' 
      });
    }
  }
  
  // 5. Aplicar cambio
  await supabase
    .from('ciudades')
    .update({ estado: nuevoEstado })
    .eq('id', ciudadId);
  
  // 6. Log con motivo
  await supabase
    .from('ciudades_estado_log')
    .update({ motivo, cambiado_por: adminId })
    .eq('ciudad_id', ciudadId)
    .order('created_at', { ascending: false })
    .limit(1);
  
  return { success: true, nuevoEstado };
});
```

---

## Navegación

| ⬆️ Padre             | [[Proyecto OnlyCarNLD/Datos/1.3.6.1.15 control_expansion]]      |
| -------------------- | ------------------------------------- |
| ⬅️ Hermano anterior  | [[Proyecto OnlyCarNLD/Datos/1.3.6.1.15.1 estados_ciudad]]       |
| ➡️ Hermano siguiente | [[Proyecto OnlyCarNLD/Datos/1.3.6.1.15.3 dashboard_expansion]]  |

---
