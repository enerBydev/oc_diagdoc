---
id: 1.3.6.1.13.3
title: Validaci√≥n de Servicios
parent: 1.3.6.1.13
breadcrumb: 0 ‚Üí 1.0 ‚Üí 1.3 ‚Üí 1.3.6 ‚Üí 1.3.6.1 ‚Üí 1.3.6.1.13 ‚Üí 1.3.6.1.13.3
type: hoja
status: activo
domain: comunicacion
summary: L√≥gica para calcular qu√© servicios puede ofrecer un operador basado en herramientas
  aprobadas.
version: 1.0
last_updated: 2026-01-29 15:32
file_create: 2025-12-26 17:50
actors:
- sistema
dependencies:
- supabase
affects:
- 1.3.6.1.11 preferencias_servicios
content_hash: 10480b7cf58750b5
---

# 1.3.6.1.13.3 Validaci√≥n de Servicios

L√≥gica para calcular servicios disponibles.

---

## Regla de Validaci√≥n

```
SERVICIO DISPONIBLE = Operador tiene TODAS las herramientas obligatorias

Si servicio "Lavado Express" requiere:
  - Hidrolavadora (obligatorio) ‚úì
  - Shampoo (obligatorio) ‚úì
  - Cubetas (obligatorio) ‚úì
  ‚Üí DISPONIBLE ‚úÖ

Si servicio "Pulido de Faros" requiere:
  - Pulidora orbital (obligatorio) ‚úó FALTA
  - Kit pulido faros (obligatorio) ‚úó FALTA
  ‚Üí BLOQUEADO üîí
```

---

## Funci√≥n SQL: Validar Servicios

```sql
-- Funci√≥n para determinar si operador puede ofrecer un servicio
CREATE OR REPLACE FUNCTION operador_puede_servicio(
  p_operador_id UUID,
  p_servicio_id UUID
) RETURNS BOOLEAN AS $$
DECLARE
  v_requeridas INT;
  v_tiene INT;
BEGIN
  -- Contar herramientas obligatorias del servicio
  SELECT COUNT(*) INTO v_requeridas
  FROM requisitos_servicio
  WHERE servicio_id = p_servicio_id
    AND obligatorio = true;
  
  -- Contar cu√°ntas de esas tiene el operador (aprobadas)
  SELECT COUNT(DISTINCT rs.tipo_herramienta_id) INTO v_tiene
  FROM requisitos_servicio rs
  JOIN herramientas_operador ho ON rs.tipo_herramienta_id = ho.tipo_herramienta_id
  WHERE rs.servicio_id = p_servicio_id
    AND rs.obligatorio = true
    AND ho.operador_id = p_operador_id
    AND ho.estado = 'aprobada';
  
  RETURN v_tiene = v_requeridas;
END;
$$ LANGUAGE plpgsql;
```

---

## Funci√≥n: Recalcular Servicios Operador

```sql
-- Recalcular todos los servicios disponibles para un operador
CREATE OR REPLACE FUNCTION recalcular_servicios_operador(p_operador_id UUID)
RETURNS VOID AS $$
DECLARE
  v_servicio RECORD;
  v_puede BOOLEAN;
BEGIN
  -- Para cada servicio existente
  FOR v_servicio IN SELECT id FROM servicios WHERE activo = true LOOP
    v_puede := operador_puede_servicio(p_operador_id, v_servicio.id);
    
    -- Actualizar o insertar en servicios_operador
    INSERT INTO servicios_operador (operador_id, servicio_id, habilitado, habilitado_por)
    VALUES (p_operador_id, v_servicio.id, false, 'sistema')
    ON CONFLICT (operador_id, servicio_id)
    DO UPDATE SET 
      -- Si no puede, forzar deshabilitado
      habilitado = CASE 
        WHEN NOT v_puede THEN false 
        ELSE servicios_operador.habilitado 
      END,
      updated_at = NOW();
  END LOOP;
END;
$$ LANGUAGE plpgsql;

-- Trigger: recalcular cuando cambian herramientas
CREATE OR REPLACE FUNCTION trigger_recalcular_servicios()
RETURNS TRIGGER AS $$
BEGIN
  PERFORM recalcular_servicios_operador(
    COALESCE(NEW.operador_id, OLD.operador_id)
  );
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_herramientas_change
AFTER INSERT OR UPDATE OR DELETE ON herramientas_operador
FOR EACH ROW EXECUTE FUNCTION trigger_recalcular_servicios();
```

---

## Vista: Servicios con Faltantes

```sql
CREATE VIEW v_servicios_faltantes AS
SELECT
  so.operador_id,
  s.id as servicio_id,
  s.nombre as servicio_nombre,
  operador_puede_servicio(so.operador_id, s.id) as puede_habilitar,
  -- Herramientas que le faltan
  ARRAY(
    SELECT th.nombre
    FROM requisitos_servicio rs
    JOIN tipos_herramientas th ON rs.tipo_herramienta_id = th.id
    WHERE rs.servicio_id = s.id
      AND rs.obligatorio = true
      AND NOT EXISTS (
        SELECT 1 FROM herramientas_operador ho
        WHERE ho.operador_id = so.operador_id
          AND ho.tipo_herramienta_id = rs.tipo_herramienta_id
          AND ho.estado = 'aprobada'
      )
  ) as herramientas_faltantes
FROM servicios_operador so
JOIN servicios s ON so.servicio_id = s.id;
```

---

## UI: Panel de Preferencias Actualizado

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  üõ†Ô∏è MIS SERVICIOS                                               ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                 ‚îÇ
‚îÇ  SERVICIOS DISPONIBLES (tienes el equipo):                      ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ
‚îÇ  [‚úì] Lavado Express                    $290   ‚è±Ô∏è 30 min         ‚îÇ
‚îÇ  [‚úì] Lavado Completo                   $399   ‚è±Ô∏è 45 min         ‚îÇ
‚îÇ  [‚úì] Aspirado Interior                 $168   ‚è±Ô∏è 25 min         ‚îÇ
‚îÇ  [ ] Desinfecci√≥n                      $149   ‚è±Ô∏è 15 min         ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  SERVICIOS BLOQUEADOS (falta equipo):                           ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ
‚îÇ  üîí Encerado                           $299   ‚è±Ô∏è 40 min          ‚îÇ
‚îÇ     ‚îî‚îÄ Falta: Kit de cera/sellador                              ‚îÇ
‚îÇ     ‚îî‚îÄ [ Agregar herramienta ‚Üí ]                                ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  üîí Pulido de Faros                    $430   ‚è±Ô∏è 35 min          ‚îÇ
‚îÇ     ‚îî‚îÄ Falta: Pulidora orbital, Kit pulido de faros             ‚îÇ
‚îÇ     ‚îî‚îÄ [ Agregar herramientas ‚Üí ]                               ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  [ Guardar preferencias ]                                       ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## Composable: useServiceValidation

```typescript
// composables/useServiceValidation.ts
interface ServicioValidado {
  id: string;
  nombre: string;
  precio: number;
  puede_habilitar: boolean;
  habilitado: boolean;
  herramientas_faltantes: string[];
}

export const useServiceValidation = () => {
  const supabase = useSupabaseClient();
  const user = useSupabaseUser();
  
  const servicios = ref<ServicioValidado[]>([]);
  
  const fetchServiciosConValidacion = async () => {
    const { data } = await supabase
      .from('v_servicios_faltantes')
      .select('*')
      .eq('operador_id', user.value?.id);
    
    servicios.value = data || [];
  };
  
  const toggleServicio = async (servicioId: string, habilitado: boolean) => {
    const servicio = servicios.value.find(s => s.servicio_id === servicioId);
    
    // Validar que puede habilitar
    if (habilitado && !servicio?.puede_habilitar) {
      const faltantes = servicio?.herramientas_faltantes.join(', ');
      toast.error(`No puedes habilitar este servicio. Falta: ${faltantes}`);
      return false;
    }
    
    await supabase
      .from('servicios_operador')
      .update({ habilitado })
      .eq('operador_id', user.value?.id)
      .eq('servicio_id', servicioId);
    
    await fetchServiciosConValidacion();
    return true;
  };
  
  onMounted(fetchServiciosConValidacion);
  
  return { servicios, toggleServicio, refetch: fetchServiciosConValidacion };
};
```

---

## Navegaci√≥n

| ‚¨ÜÔ∏è Padre            | [[Proyecto OnlyCarNLD/Datos/1.3.6.1.13 inventario_herramientas]] |
| ------------------- | -------------------------------------- |
| ‚¨ÖÔ∏è Hermano anterior | [[Proyecto OnlyCarNLD/Datos/1.3.6.1.13.2 registro_equipo]]       |

---
