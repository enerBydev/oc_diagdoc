---
id: 5.8.6.5.9
title: Queries Optimizadas
parent: 5.8.6.5
breadcrumb: 0 → 5.0 → 5.8 → 5.8.6 → 5.8.6.5 → 5.8.6.5.9
type: optimizacion
status: activo
last_updated: 2026-01-29 15:32
file_create: 2026-01-01 18:10
domain:
- sql
- indices
- queries
summary: Queries SQL optimizadas.
content_hash: bf3de4c349110dcd
---

# 5.8.6.5.9 Queries Optimizadas

Consultas SQL optimizadas para operaciones comunes sobre historial GPS.

---

## Principios de Optimización

| Principio | Aplicación |
|-----------|------------|
| **Usar índices** | Siempre filtrar por `servicio_id` primero |
| **Limitar resultados** | Usar `LIMIT` en consultas de UI |
| **Evitar SELECT *** | Seleccionar solo columnas necesarias |
| **Índices parciales** | Para flags como `es_llegada` |
| **Materializar vistas** | Para analytics pesados |

---

## Queries Frecuentes

### 1. Obtener Última Ubicación (más usada)

```sql
-- ❌ Lenta: escanea toda la tabla
SELECT * FROM ubicaciones_servicio 
WHERE servicio_id = $1 
ORDER BY created_at DESC 
LIMIT 1;

-- ✅ Optimizada: usa tabla de cache
SELECT lat, lng, accuracy, updated_at 
FROM ubicacion_actual 
WHERE servicio_id = $1;

-- Tiempo: <1ms vs ~50ms
```

### 2. Ruta Completa de Servicio

```sql
-- ✅ Optimizada: usa índice compuesto
-- Índice: idx_ubicaciones_servicio_tiempo (servicio_id, created_at DESC)

SELECT 
  lat, lng, accuracy, created_at, es_inicio, es_llegada
FROM ubicaciones_servicio
WHERE servicio_id = $1
ORDER BY created_at ASC;

-- EXPLAIN ANALYZE: Index Scan using idx_ubicaciones_servicio_tiempo
-- Tiempo: ~5-20ms para 120 registros
```

### 3. Ubicaciones de Llegada (para auditoría)

```sql
-- ✅ Optimizada: índice parcial es_llegada = true

SELECT 
  s.id as servicio_id,
  u.lat, u.lng, u.created_at
FROM servicios s
JOIN ubicaciones_servicio u ON u.servicio_id = s.id
WHERE u.es_llegada = true
  AND s.operador_id = $1
  AND u.created_at > NOW() - INTERVAL '30 days'
ORDER BY u.created_at DESC
LIMIT 50;

-- Usa: idx_ubicaciones_llegada (WHERE es_llegada = true)
```

### 4. Distancia Total Recorrida

```sql
-- Función optimizada con window function
CREATE OR REPLACE FUNCTION distancia_servicio(p_servicio_id UUID)
RETURNS NUMERIC AS $$
SELECT COALESCE(SUM(
  calcular_distancia(prev_lat, prev_lng, lat, lng)
), 0)
FROM (
  SELECT 
    lat, lng,
    LAG(lat) OVER (ORDER BY created_at) as prev_lat,
    LAG(lng) OVER (ORDER BY created_at) as prev_lng
  FROM ubicaciones_servicio
  WHERE servicio_id = p_servicio_id
) sub
WHERE prev_lat IS NOT NULL;
$$ LANGUAGE SQL STABLE;

-- Tiempo: ~10-30ms para 120 registros
```

### 5. Servicios en un Área Geográfica

```sql
-- ✅ Con PostGIS (si disponible)
SELECT DISTINCT s.id, s.cliente_id
FROM servicios s
JOIN ubicaciones_servicio u ON u.servicio_id = s.id
WHERE ST_DWithin(
  ST_SetSRID(ST_MakePoint(u.lng, u.lat), 4326)::geography,
  ST_SetSRID(ST_MakePoint($1, $2), 4326)::geography,
  $3  -- radio en metros
)
AND u.es_llegada = true;

-- ❌ Sin PostGIS (alternativa menos eficiente)
SELECT DISTINCT s.id, s.cliente_id
FROM servicios s
JOIN ubicaciones_servicio u ON u.servicio_id = s.id
WHERE u.es_llegada = true
  AND u.lat BETWEEN ($1 - 0.01) AND ($1 + 0.01)  -- ~1km
  AND u.lng BETWEEN ($2 - 0.01) AND ($2 + 0.01)
  AND calcular_distancia($1, $2, u.lat, u.lng) < $3;
```

---

## Índices Recomendados (Resumen)

```sql
-- Índice principal: búsqueda por servicio + orden temporal
CREATE INDEX CONCURRENTLY idx_ubicaciones_servicio_tiempo 
ON ubicaciones_servicio(servicio_id, created_at DESC);

-- Índice parcial: llegadas (solo ~1% de registros)
CREATE INDEX CONCURRENTLY idx_ubicaciones_llegada 
ON ubicaciones_servicio(servicio_id, created_at) 
WHERE es_llegada = true;

-- Índice parcial: inicios
CREATE INDEX CONCURRENTLY idx_ubicaciones_inicio 
ON ubicaciones_servicio(servicio_id) 
WHERE es_inicio = true;

-- Índice para limpieza: fecha sin es_llegada
CREATE INDEX CONCURRENTLY idx_ubicaciones_cleanup 
ON ubicaciones_servicio(created_at) 
WHERE es_llegada = false;

-- Índice por operador (para métricas)
CREATE INDEX CONCURRENTLY idx_ubicaciones_operador 
ON ubicaciones_servicio(operador_id, created_at DESC);
```

---

## Vistas Materializadas para Analytics

```sql
-- Materializar métricas de operador (refrescar diariamente)
CREATE MATERIALIZED VIEW mv_metricas_operador AS
SELECT 
  operador_id,
  COUNT(DISTINCT servicio_id) as total_servicios,
  AVG(tiempo_llegada) as tiempo_promedio,
  PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY tiempo_llegada) as mediana
FROM (
  SELECT 
    operador_id,
    servicio_id,
    EXTRACT(EPOCH FROM (
      MAX(CASE WHEN es_llegada THEN created_at END) -
      MIN(CASE WHEN es_inicio THEN created_at END)
    )) / 60 as tiempo_llegada
  FROM ubicaciones_servicio
  GROUP BY operador_id, servicio_id
) sub
WHERE tiempo_llegada IS NOT NULL
GROUP BY operador_id;

-- Índice en vista materializada
CREATE UNIQUE INDEX idx_mv_metricas_operador 
ON mv_metricas_operador(operador_id);

-- Refrescar diariamente
SELECT cron.schedule(
  'refresh-metricas-operador',
  '0 4 * * *',  -- 4 AM
  $$REFRESH MATERIALIZED VIEW CONCURRENTLY mv_metricas_operador$$
);
```

---

## Paginación Eficiente

```sql
-- ❌ Ineficiente para páginas grandes
SELECT * FROM ubicaciones_servicio 
OFFSET 10000 LIMIT 50;  -- Escanea 10,050 filas

-- ✅ Paginación por cursor (keyset)
SELECT lat, lng, created_at
FROM ubicaciones_servicio
WHERE servicio_id = $1
  AND created_at < $2  -- cursor del último registro
ORDER BY created_at DESC
LIMIT 50;
```

---

## Evitar N+1 Queries

```typescript
// ❌ N+1: una query por servicio
for (const servicio of servicios) {
  const ubicacion = await getUltimaUbicacion(servicio.id);
}

// ✅ Batch: una query para todos
const ubicaciones = await supabase
  .from('ubicacion_actual')
  .select('servicio_id, lat, lng')
  .in('servicio_id', servicios.map(s => s.id));
```

---

## Benchmark de Queries

| Query | Sin Optimizar | Optimizada | Mejora |
|-------|---------------|------------|--------|
| Última ubicación | 50ms | <1ms | 50x |
| Ruta completa (120 pts) | 100ms | 15ms | 6.6x |
| Distancia total | 200ms | 25ms | 8x |
| Métricas operador | 500ms | 5ms* | 100x |

*Vista materializada

---

→ Ver backup y recuperación: [[Proyecto OnlyCarNLD/Datos/5.8.6.5.10 backup_recuperacion]]

---

## Navegación

| ⬆️ Padre             | [[Proyecto OnlyCarNLD/Datos/5.8.6.5 historial_ubicaciones]]            |
| -------------------- | ---------------------- |
| ⬅️ Hermano anterior  | [[Proyecto OnlyCarNLD/Datos/5.8.6.5.8 storage_estimaciones]]              |
| ➡️ Hermano siguiente | [[Proyecto OnlyCarNLD/Datos/5.8.6.5.10 backup_recuperacion]]              |
