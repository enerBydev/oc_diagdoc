---
id: 4.7.9
title: ADR-009 Caching
parent: '4.7'
breadcrumb: 0 ‚Üí 4.0 ‚Üí 4.7 ‚Üí 4.7.9
type: hoja
status: aceptado
adr_date: 2025-12-20
participants:
- enerBydev
- Backend Team
last_updated: 2026-01-29 15:31
file_create: 2026-01-05 19:57
domain:
- adr
- caching
- d1
- kv
actors:
- desarrollador
- devops
summary: ADR-009 Decisi√≥n de estrategia de caching con D1 + KV.
content_hash: 2e9e0d258aa9efd5
---

# 4.7.9 ADR-009 Caching

> Architecture Decision Record: Estrategia de Caching

---

## Estado

**üü¢ ACEPTADO** ‚Äî 20 Diciembre 2025

---

## Contexto

Se requiere:
- Cache de cat√°logo servicios/precios (cambia poco, acceso alto)
- Cache de sesiones/tokens (acceso muy alto, expira)
- Cache de configuraci√≥n sistema (casi nunca cambia)
- Cache de ubicaciones operadores (alta frecuencia, corta vida)

---

## Opciones Consideradas

| Opci√≥n | Latencia | Costo | Uso ideal |
|--------|----------|-------|-----------|
| **Cloudflare KV** | ~50ms | Gratis tier | Key-value simple, sesiones |
| **Cloudflare D1** | ~30ms | Gratis tier | SQL queries, relaciones |
| **Redis (Upstash)** | ~100ms | $0.20/100K | Estructuras complejas |
| **In-memory Workers** | ~1ms | Limitado 128MB | Ultra-hot data |

---

## Decisi√≥n

**Caching en 3 capas:**

| Capa | Tecnolog√≠a | Datos | TTL |
|------|------------|-------|-----|
| L1 (Hot) | Workers Memory | Config sistema | Duraci√≥n worker |
| L2 (Warm) | Cloudflare KV | Sesiones, tokens | 1-24 horas |
| L3 (Cool) | Cloudflare D1 | Cat√°logos, precios | 1-7 d√≠as |

---

## Consecuencias

### Positivas

- ‚úÖ Sin costo adicional (incluido en CF)
- ‚úÖ Edge-native, baja latencia
- ‚úÖ Fallback autom√°tico L1 ‚Üí L2 ‚Üí L3 ‚Üí Supabase

### Negativas

- ‚ö†Ô∏è Complejidad de invalidaci√≥n
- ‚ö†Ô∏è Consistencia eventual
- ‚ö†Ô∏è L√≠mites de tama√±o KV (25MB/value)

---

## Implementaci√≥n

```typescript
// composables/useCache.ts
export async function getCached<T>(
  key: string,
  fetcher: () => Promise<T>,
  ttl: number = 3600
): Promise<T> {
  // L2: KV
  const cached = await hubKV().get<T>(key);
  if (cached) return cached;
  
  // Miss: fetch from source
  const fresh = await fetcher();
  
  // Store in KV
  await hubKV().set(key, fresh, { ttl });
  
  return fresh;
}
```

---

## Referencias

- [[Proyecto OnlyCarNLD/Datos/2.1.3 Cloudflare_Architecture|Cloudflare]]
- [[Proyecto OnlyCarNLD/Datos/4.3.1 RNF_Rendimiento|Rendimiento]]

---

## Navegaci√≥n

| ‚¨ÜÔ∏è Padre | [[Proyecto OnlyCarNLD/Datos/4.7 Decisiones_Arquitectura]] |
|----------|---------------------------------|
| ‚¨ÖÔ∏è Anterior | [[Proyecto OnlyCarNLD/Datos/4.7.8 ADR_008_Storage]] |

---
