---
id: 1.3.6.1.11.2
title: Paquetes Aceptados
parent: 1.3.6.1.11
breadcrumb: 0 â†’ 1.0 â†’ 1.3 â†’ 1.3.6 â†’ 1.3.6.1 â†’ 1.3.6.1.11 â†’ 1.3.6.1.11.2
type: hoja
status: activo
domain: comunicacion
summary: Paquetes como conjuntos de servicios que solo se habilitan si todos sus componentes
  estÃ¡n habilitados.
version: 1.0
last_updated: 2026-01-29 15:32
file_create: 2025-12-26 15:19
actors:
- operador
dependencies:
- supabase
affects:
- 1.3.6.1.11 preferencias_servicios
content_hash: b258e9316899bffc
---

# 1.3.6.1.11.2 Paquetes Aceptados

Paquetes que el operador puede aceptar.

---

## Concepto

> [!IMPORTANT]
> **Paquete = Conjunto de servicios**
> 
> - Paquete solo se puede habilitar si TODOS sus servicios estÃ¡n habilitados
> - Deshabilitar un servicio â†’ deshabilita paquetes que lo contienen
> - Precio de paquete â‰¤ suma de servicios (descuento)

---

## Modelo de Datos

### Tabla: paquetes

```sql
CREATE TABLE paquetes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  nombre VARCHAR(100) NOT NULL,
  descripcion TEXT,
  precio DECIMAL(10, 2) NOT NULL,  -- Precio con descuento
  duracion_minutos INT NOT NULL,   -- Suma de duraciones
  activo BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT now()
);

-- Seed de paquetes
INSERT INTO paquetes (nombre, descripcion, precio, duracion_minutos) VALUES
  ('Paquete BÃ¡sico', 'Lavado Completo + Aspirado Interior', 549, 70),
  ('Paquete Premium', 'Lavado Completo + Aspirado + DesinfecciÃ³n', 699, 85),
  ('Paquete VIP', 'Todo incluido: Lavado + Aspirado + DesinfecciÃ³n + Encerado + Pulido', 1349, 165);
```

### Tabla: paquetes_servicios (ComposiciÃ³n)

```sql
CREATE TABLE paquetes_servicios (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  paquete_id UUID NOT NULL REFERENCES paquetes(id),
  servicio_id UUID NOT NULL REFERENCES servicios(id),
  
  UNIQUE (paquete_id, servicio_id)
);

-- ComposiciÃ³n de paquetes
INSERT INTO paquetes_servicios (paquete_id, servicio_id) VALUES
  -- Paquete BÃ¡sico
  ((SELECT id FROM paquetes WHERE nombre = 'Paquete BÃ¡sico'), 
   (SELECT id FROM servicios WHERE nombre = 'Lavado Completo')),
  ((SELECT id FROM paquetes WHERE nombre = 'Paquete BÃ¡sico'), 
   (SELECT id FROM servicios WHERE nombre = 'Aspirado Interior')),
  
  -- Paquete Premium
  ((SELECT id FROM paquetes WHERE nombre = 'Paquete Premium'), 
   (SELECT id FROM servicios WHERE nombre = 'Lavado Completo')),
  ((SELECT id FROM paquetes WHERE nombre = 'Paquete Premium'), 
   (SELECT id FROM servicios WHERE nombre = 'Aspirado Interior')),
  ((SELECT id FROM paquetes WHERE nombre = 'Paquete Premium'), 
   (SELECT id FROM servicios WHERE nombre = 'DesinfecciÃ³n'));
  
  -- Paquete VIP... (todos los servicios)
```

### Tabla: paquetes_operador

```sql
CREATE TABLE paquetes_operador (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  operador_id UUID NOT NULL REFERENCES operadores(id),
  paquete_id UUID NOT NULL REFERENCES paquetes(id),
  habilitado BOOLEAN DEFAULT false,
  -- Auto-calculado: true si tiene todos los servicios del paquete
  servicios_completos BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),
  
  UNIQUE (operador_id, paquete_id)
);
```

---

## LÃ³gica: Verificar Servicios Completos

```sql
-- FunciÃ³n para verificar si operador tiene todos los servicios de un paquete
CREATE OR REPLACE FUNCTION verificar_servicios_paquete(
  p_operador_id UUID,
  p_paquete_id UUID
) RETURNS BOOLEAN AS $$
DECLARE
  v_servicios_requeridos INT;
  v_servicios_habilitados INT;
BEGIN
  -- Contar servicios requeridos por el paquete
  SELECT COUNT(*) INTO v_servicios_requeridos
  FROM paquetes_servicios
  WHERE paquete_id = p_paquete_id;
  
  -- Contar cuÃ¡ntos tiene habilitados el operador
  SELECT COUNT(*) INTO v_servicios_habilitados
  FROM paquetes_servicios ps
  JOIN servicios_operador so ON ps.servicio_id = so.servicio_id
  WHERE ps.paquete_id = p_paquete_id
    AND so.operador_id = p_operador_id
    AND so.habilitado = true;
  
  RETURN v_servicios_habilitados = v_servicios_requeridos;
END;
$$ LANGUAGE plpgsql;

-- Trigger: actualizar servicios_completos cuando cambian servicios
CREATE OR REPLACE FUNCTION actualizar_paquetes_operador()
RETURNS TRIGGER AS $$
BEGIN
  -- Actualizar todos los paquetes del operador
  UPDATE paquetes_operador po
  SET servicios_completos = verificar_servicios_paquete(
    COALESCE(NEW.operador_id, OLD.operador_id),
    po.paquete_id
  )
  WHERE po.operador_id = COALESCE(NEW.operador_id, OLD.operador_id);
  
  -- Deshabilitar paquetes sin servicios completos
  UPDATE paquetes_operador
  SET habilitado = false
  WHERE operador_id = COALESCE(NEW.operador_id, OLD.operador_id)
    AND servicios_completos = false
    AND habilitado = true;
  
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_actualizar_paquetes
AFTER INSERT OR UPDATE OR DELETE ON servicios_operador
FOR EACH ROW EXECUTE FUNCTION actualizar_paquetes_operador();
```

---

## Composable: useOperatorPackages

```typescript
// composables/useOperatorPackages.ts
interface PaqueteOperador {
  id: string;
  paquete_id: string;
  nombre: string;
  precio: number;
  duracion_minutos: number;
  habilitado: boolean;
  servicios_completos: boolean;
  servicios: Array<{ id: string; nombre: string; habilitado: boolean }>;
}

export const useOperatorPackages = () => {
  const supabase = useSupabaseClient();
  const user = useSupabaseUser();
  
  const paquetes = ref<PaqueteOperador[]>([]);
  
  const fetchPaquetes = async () => {
    // 1. Obtener paquetes con su estado para este operador
    const { data: paquetesData } = await supabase
      .from('paquetes_operador')
      .select(`
        id,
        paquete_id,
        habilitado,
        servicios_completos,
        paquetes (nombre, precio, duracion_minutos)
      `)
      .eq('operador_id', user.value?.id);
    
    // 2. Para cada paquete, obtener sus servicios
    const paquetesConServicios = await Promise.all(
      (paquetesData || []).map(async (p) => {
        const { data: servicios } = await supabase
          .from('paquetes_servicios')
          .select(`
            servicio_id,
            servicios (nombre),
            servicios_operador!inner (habilitado)
          `)
          .eq('paquete_id', p.paquete_id)
          .eq('servicios_operador.operador_id', user.value?.id);
        
        return {
          ...p,
          nombre: p.paquetes.nombre,
          precio: p.paquetes.precio,
          duracion_minutos: p.paquetes.duracion_minutos,
          servicios: servicios?.map(s => ({
            id: s.servicio_id,
            nombre: s.servicios.nombre,
            habilitado: s.servicios_operador[0]?.habilitado || false
          })) || []
        };
      })
    );
    
    paquetes.value = paquetesConServicios;
  };
  
  const togglePaquete = async (paqueteId: string, habilitado: boolean) => {
    const paquete = paquetes.value.find(p => p.paquete_id === paqueteId);
    
    // No puede habilitar si no tiene servicios completos
    if (habilitado && !paquete?.servicios_completos) {
      const faltantes = paquete?.servicios.filter(s => !s.habilitado).map(s => s.nombre);
      toast.error(`Primero habilita: ${faltantes?.join(', ')}`);
      return false;
    }
    
    await supabase
      .from('paquetes_operador')
      .update({ habilitado, updated_at: new Date() })
      .eq('operador_id', user.value?.id)
      .eq('paquete_id', paqueteId);
    
    await fetchPaquetes();
    return true;
  };
  
  onMounted(fetchPaquetes);
  
  return { paquetes, togglePaquete, refetch: fetchPaquetes };
};
```

---

## UI: Lista de Paquetes

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“¦ PAQUETES                                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ [âœ“] Paquete BÃ¡sico                            $710      â”‚    â”‚
â”‚  â”‚     â””â”€ âœ“ Lavado Completo                                â”‚    â”‚
â”‚  â”‚     â””â”€ âœ“ Aspirado Interior                              â”‚    â”‚
â”‚  â”‚     Disponible âœ…                                       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ [ ] Paquete VIP                               $1,349    â”‚    â”‚
â”‚  â”‚     â””â”€ âœ“ Lavado Completo                                â”‚    â”‚
â”‚  â”‚     â””â”€ âœ“ Aspirado Interior                              â”‚    â”‚
â”‚  â”‚     â””â”€ âœ“ DesinfecciÃ³n                                   â”‚    â”‚
â”‚  â”‚     â””â”€ âœ— Encerado â† Falta habilitar                     â”‚    â”‚
â”‚  â”‚     â””â”€ âœ— Pulido de Faros â† Falta habilitar              â”‚    â”‚
â”‚  â”‚     No disponible âš ï¸ (faltan 2 servicios)               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## NavegaciÃ³n

| â¬†ï¸ Padre             | [[Proyecto OnlyCarNLD/Datos/1.3.6.1.11 preferencias_servicios]]   |
| -------------------- | --------------------------------------- |
| â¬…ï¸ Hermano anterior  | [[Proyecto OnlyCarNLD/Datos/1.3.6.1.11.1 servicios_individuales]] |
| â¡ï¸ Hermano siguiente | [[Proyecto OnlyCarNLD/Datos/1.3.6.1.11.3 integracion_matching]]   |

---
