---
id: 5.8.1
title: Capacitor Geolocation
parent: '5.8'
breadcrumb: 0 ‚Üí 5.0 ‚Üí 5.8 ‚Üí 5.8.1
type: plugin
children_count: 7
status: activo
last_updated: 2026-01-29 15:31
file_create: 2025-12-25 00:16
domain:
- gps
- capacitor
- ubicacion
summary: 'Obtenci√≥n de coordenadas GPS del dispositivo nativo.

  Composable Vue con watchPosition y manejo de errores.'
content_hash: e0c6bb014ef803c6
---

# 5.8.1 Capacitor Geolocation

Obtenci√≥n de coordenadas GPS del dispositivo nativo.

---

## Instalaci√≥n

```bash
npm install @capacitor/geolocation
npx cap sync
```

---

## Composable Principal

```typescript
// composables/useGeolocation.ts
import { Geolocation, type Position, type WatchPositionCallback } from '@capacitor/geolocation';
import { GEO_CONFIG } from '~/config/geolocation';

export const useGeolocation = () => {
  // Estado reactivo
  const position = ref<{ lat: number; lng: number; accuracy: number } | null>(null);
  const error = ref<string | null>(null);
  const isTracking = ref(false);
  const watchId = ref<string | null>(null);
  
  // Opciones del GPS
  const options = {
    enableHighAccuracy: GEO_CONFIG.HIGH_ACCURACY,
    timeout: GEO_CONFIG.TIMEOUT_MS,
    maximumAge: GEO_CONFIG.MAXIMUM_AGE_MS
  };
  
  /**
   * Obtener posici√≥n √∫nica
   */
  const getCurrentPosition = async () => {
    try {
      error.value = null;
      const pos = await Geolocation.getCurrentPosition(options);
      position.value = {
        lat: pos.coords.latitude,
        lng: pos.coords.longitude,
        accuracy: pos.coords.accuracy
      };
      return position.value;
    } catch (e: any) {
      error.value = e.message;
      throw e;
    }
  };
  
  /**
   * Iniciar tracking continuo
   */
  const startTracking = async (callback?: (pos: typeof position.value) => void) => {
    if (isTracking.value) return;
    
    try {
      error.value = null;
      isTracking.value = true;
      
      watchId.value = await Geolocation.watchPosition(
        options,
        (pos: Position | null, err?: any) => {
          if (err) {
            error.value = err.message;
            return;
          }
          
          if (pos) {
            position.value = {
              lat: pos.coords.latitude,
              lng: pos.coords.longitude,
              accuracy: pos.coords.accuracy
            };
            
            // Callback opcional
            callback?.(position.value);
          }
        }
      );
    } catch (e: any) {
      error.value = e.message;
      isTracking.value = false;
      throw e;
    }
  };
  
  /**
   * Detener tracking
   */
  const stopTracking = async () => {
    if (watchId.value) {
      await Geolocation.clearWatch({ id: watchId.value });
      watchId.value = null;
    }
    isTracking.value = false;
  };
  
  // Cleanup al desmontar componente
  onUnmounted(() => {
    stopTracking();
  });
  
  return {
    position: readonly(position),
    error: readonly(error),
    isTracking: readonly(isTracking),
    getCurrentPosition,
    startTracking,
    stopTracking
  };
};
```

---

## Estructura de Hijos

| ID                                        | Nombre               | Descripci√≥n        |
| ----------------------------------------- | -------------------- | ------------------ |
| [[Proyecto OnlyCarNLD/Datos/5.8.1.1 permisos_gps\|5.8.1.1]]         | Permisos GPS         | Solicitud permisos |
| [[Proyecto OnlyCarNLD/Datos/5.8.1.2 watch_position\|5.8.1.2]]       | Watch Position       | Tracking continuo  |
| [[Proyecto OnlyCarNLD/Datos/5.8.1.3 background_tracking\|5.8.1.3]]  | Background Tracking  | Segundo plano      |
| [[Proyecto OnlyCarNLD/Datos/5.8.1.4 accuracy_modes\|5.8.1.4]]       | Accuracy Modes       | Modos precisi√≥n    |
| [[Proyecto OnlyCarNLD/Datos/5.8.1.5 battery_optimization\|5.8.1.5]] | Battery Optimization | Ahorro bater√≠a     |
| [[Proyecto OnlyCarNLD/Datos/5.8.1.6 platform_differences\|5.8.1.6]] | Platform Differences | iOS vs Android     |
| [[Proyecto OnlyCarNLD/Datos/5.8.1.7 fallback_web\|5.8.1.7]]         | Fallback Web         | Fallback navegador |

---

## Uso en Componente

```vue
<script setup lang="ts">
const { position, isTracking, error, startTracking, stopTracking } = useGeolocation();
const { broadcastLocation } = useLocationBroadcast(props.servicioId);

// Iniciar tracking cuando estado = en_camino
watch(() => props.estadoServicio, (estado) => {
  if (estado === 'en_camino') {
    startTracking((pos) => {
      if (pos) {
        broadcastLocation(pos.lat, pos.lng, pos.accuracy);
      }
    });
  } else if (estado === 'llegado') {
    stopTracking();
  }
});
</script>

<template>
  <div v-if="error" class="error">
    ‚ö†Ô∏è Error GPS: {{ error }}
    <button @click="startTracking">Reintentar</button>
  </div>
  
  <div v-if="isTracking" class="tracking-badge">
    üìç Compartiendo ubicaci√≥n...
  </div>
</template>
```

---

## Manejo de Errores

| C√≥digo | Causa | Soluci√≥n |
|--------|-------|----------|
| `PERMISSION_DENIED` | Usuario neg√≥ permiso | Mostrar explicaci√≥n, pedir de nuevo |
| `POSITION_UNAVAILABLE` | GPS no disponible | Pedir que active GPS |
| `TIMEOUT` | Tard√≥ demasiado | Reintentar con menor precisi√≥n |

```typescript
const handleGeoError = (error: GeolocationPositionError) => {
  switch (error.code) {
    case 1: // PERMISSION_DENIED
      toast.error('Necesitamos acceso a tu ubicaci√≥n');
      break;
    case 2: // POSITION_UNAVAILABLE
      toast.warning('Activa el GPS de tu dispositivo');
      break;
    case 3: // TIMEOUT
      // Reintentar con menor precisi√≥n
      retryWithLowAccuracy();
      break;
  }
};
```

---

## Optimizaci√≥n de Bater√≠a

```typescript
// Si la app se minimiza, pausar tracking
const handleAppStateChange = (state: { isActive: boolean }) => {
  if (!state.isActive && GEO_CONFIG.PAUSE_ON_MINIMIZE) {
    stopTracking();
  } else if (state.isActive && servicioEnCamino.value) {
    startTracking();
  }
};

// Registrar listener
App.addListener('appStateChange', handleAppStateChange);
```

---

‚Üí Ver permisos: [[Proyecto OnlyCarNLD/Datos/5.8.1.1 permisos_gps]]
‚Üí Ver watch: [[Proyecto OnlyCarNLD/Datos/5.8.1.2 watch_position]]

---

## Navegaci√≥n

| ‚¨ÜÔ∏è Padre             | [[Proyecto OnlyCarNLD/Datos/5.8. geolocalizacion]]       |
| -------------------- | ------------------------------ |
| ‚û°Ô∏è Hermano siguiente | [[Proyecto OnlyCarNLD/Datos/5.8.2 realtime_broadcast]]   |

---
