---
id: 1.3.6.1.5
title: Aceptaci√≥n y Rechazo
parent: 1.3.6.1
breadcrumb: 0 ‚Üí 1.0 ‚Üí 1.3 ‚Üí 1.3.6 ‚Üí 1.3.6.1 ‚Üí 1.3.6.1.5
type: hoja
status: activo
domain: comunicacion
summary: Flujo de respuesta del operador a broadcasts con aceptar, pasar, bloquear
  cliente y notificaci√≥n al cliente.
version: 1.0
last_updated: 2026-01-29 15:31
file_create: 2025-12-26 13:07
actors:
- operador
- sistema
dependencies:
- supabase
affects:
- 1.3.6.1 asignacion_citas
content_hash: 98e2b5f48cd084bd
---

# 1.3.6.1.5 Aceptaci√≥n y Rechazo

Flujo de respuesta del operador a un broadcast.

---

## Acciones Disponibles

| Acci√≥n | Efecto | Consecuencia |
|--------|--------|--------------|
| **‚úÖ Aceptar** | Gana la asignaci√≥n | Abre chat con cliente |
| **‚è≠Ô∏è Pasar** | Ignora esta vez | Sin penalizaci√≥n |
| **üö´ Bloquear** | Ignora + nunca m√°s este cliente | Afecta matching futuro |

---
## Flujo de Aceptaci√≥n

```mermaid
sequenceDiagram
    participant O as üë∑ Operador
    participant S as üóÑÔ∏è Sistema
    participant C as üë§ Cliente
    
    O->>S: Tap "Aceptar"
    S->>S: aceptar_broadcast() atomico
    
    alt Ya fue tomada
        S->>O: "Solicitud no disponible"
    else √âxito
        S->>S: Actualizar broadcast estado='tomada'
        S->>S: Crear entrada en citas (estado='negociando')
        S->>S: Crear canal de chat operador‚Üîcliente
        S->>O: "¬°Asignaci√≥n exitosa!"
        S->>C: Push "Carlos M. atender√° tu servicio"
        O->>C: Chat abierto para coordinar
    end
```

---

## Implementaci√≥n: Aceptar

```typescript
// composables/useBroadcastActions.ts
export const useBroadcastActions = () => {
  const supabase = useSupabaseClient();
  const user = useSupabaseUser();
  
  const aceptar = async (broadcastId: string) => {
    // 1. Intentar aceptar (at√≥mico)
    const { data, error } = await supabase
      .rpc('aceptar_broadcast', {
        p_broadcast_id: broadcastId,
        p_operador_id: user.value?.id
      });
    
    if (error || !data?.success) {
      toast.error(data?.reason || 'Error al aceptar');
      return false;
    }
    
    // 2. Crear cita preliminar
    await supabase.from('citas').insert({
      solicitud_id: data.solicitud_id,
      operador_id: user.value?.id,
      estado: 'negociando',
      // Otros campos se llenan en negociaci√≥n
    });
    
    // 3. Navegar a chat
    navigateTo(`/operador/chat/${data.solicitud_id}`);
    
    return true;
  };
  
  const pasar = async (broadcastId: string) => {
    // Solo registrar que pas√≥, sin penalizaci√≥n
    await supabase.from('respuestas_broadcast').insert({
      broadcast_id: broadcastId,
      operador_id: user.value?.id,
      accion: 'pasar'
    });
    
    // Cerrar UI del broadcast
    return true;
  };
  
  const bloquear = async (broadcastId: string, clienteId: string, motivo: string) => {
    // 1. Registrar bloqueo
    await supabase.from('bloqueos_operador').insert({
      operador_id: user.value?.id,
      cliente_id: clienteId,
      motivo
    });
    
    // 2. Registrar respuesta
    await supabase.from('respuestas_broadcast').insert({
      broadcast_id: broadcastId,
      operador_id: user.value?.id,
      accion: 'bloquear',
      motivo
    });
    
    return true;
  };
  
  return { aceptar, pasar, bloquear };
};
```

---

## Modal: Motivo de Bloqueo

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  üö´ BLOQUEAR CLIENTE                                            ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                 ‚îÇ
‚îÇ  No recibir√°s m√°s solicitudes de este cliente.                  ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  Motivo (requerido):                                            ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ  ‚îÇ ( ) Mala experiencia previa                             ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ ( ) Ubicaci√≥n muy lejana                                ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ ( ) Cancelaciones frecuentes                            ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ ( ) Otro: ___________________________                   ‚îÇ    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  ‚ö†Ô∏è Esta acci√≥n es permanente. Solo Admin puede revertirla.     ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  [ Cancelar ]              [ Bloquear cliente ]                 ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## Tabla: Respuestas a Broadcasts

```sql
CREATE TABLE respuestas_broadcast (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  broadcast_id UUID NOT NULL REFERENCES broadcasts(id),
  operador_id UUID NOT NULL REFERENCES operadores(id),
  accion VARCHAR(20) NOT NULL,  -- 'aceptar', 'pasar', 'bloquear'
  motivo TEXT,
  tiempo_respuesta_ms INT,  -- Tiempo desde broadcast hasta respuesta
  created_at TIMESTAMPTZ DEFAULT now(),
  
  UNIQUE (broadcast_id, operador_id)
);

-- Para analytics
CREATE INDEX idx_respuestas_operador ON respuestas_broadcast(operador_id);
CREATE INDEX idx_respuestas_accion ON respuestas_broadcast(accion);
```

---

## Tabla: Bloqueos

```sql
CREATE TABLE bloqueos_operador (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  operador_id UUID NOT NULL REFERENCES operadores(id),
  cliente_id UUID NOT NULL REFERENCES clientes(id),
  motivo TEXT,
  created_at TIMESTAMPTZ DEFAULT now(),
  
  UNIQUE (operador_id, cliente_id)
);

-- Consultar si cliente est√° bloqueado
CREATE INDEX idx_bloqueos_cliente ON bloqueos_operador(cliente_id);
```

---

## Notificaci√≥n al Cliente

```typescript
// Cuando operador acepta
const notificarClienteAsignacion = async (solicitudId: string, operador: Operador) => {
  const solicitud = await getSolicitud(solicitudId);
  
  await sendPushNotification(solicitud.cliente_id, {
    title: 'üéâ ¬°Operador asignado!',
    body: `${operador.nombre} atender√° tu servicio. Coordina los detalles en el chat.`,
    data: {
      type: 'operador_asignado',
      solicitud_id: solicitudId,
      operador_id: operador.id
    }
  });
  
  // Tambi√©n mensaje sistema en chat
  await enviarMensajeSistema(solicitudId, {
    texto: `${operador.nombre} ha sido asignado para tu servicio. 
            Pueden coordinar los detalles finales aqu√≠.`,
    tipo: 'asignacion_confirmada'
  });
};
```

---

## Timeout y Expiraci√≥n

```typescript
// Cron job cada minuto
const procesarBroadcastsExpirados = async () => {
  const { data: expirados } = await supabase
    .from('broadcasts')
    .select('id, solicitud_id')
    .eq('estado', 'activo')
    .lt('expira_at', new Date().toISOString());
  
  for (const broadcast of expirados || []) {
    await supabase
      .from('broadcasts')
      .update({ estado: 'expirada' })
      .eq('id', broadcast.id);
    
    // Escalar a admin o re-broadcast
    await escalarSolicitud(broadcast.solicitud_id);
  }
};
```

---

## Navegaci√≥n

| ‚¨ÜÔ∏è Padre             | [[Proyecto OnlyCarNLD/Datos/1.3.6.1 asignacion_citas]]         |
| -------------------- | ------------------------------------ |
| ‚¨ÖÔ∏è Hermano anterior  | [[Proyecto OnlyCarNLD/Datos/1.3.6.1.4 broadcast_solicitud]]    |
| ‚û°Ô∏è Hermano siguiente | [[Proyecto OnlyCarNLD/Datos/1.3.6.1.6 negociacion_horario]]    |

---
