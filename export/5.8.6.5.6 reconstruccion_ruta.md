---
id: 5.8.6.5.6
title: Reconstrucci√≥n Ruta
parent: 5.8.6.5
breadcrumb: 0 ‚Üí 5.0 ‚Üí 5.8 ‚Üí 5.8.6 ‚Üí 5.8.6.5 ‚Üí 5.8.6.5.6
type: feature
status: activo
last_updated: 2026-01-29 15:31
file_create: 2026-01-01 18:10
domain:
- ruta
- reconstruccion
- historial
summary: Reconstrucci√≥n de rutas pasadas.
content_hash: b83c5419a6f55744
---

# 5.8.6.5.6 Reconstrucci√≥n de Ruta

Visualizaci√≥n del recorrido GPS completo de un servicio.

---

## Casos de Uso

| Caso | Descripci√≥n |
|------|-------------|
| **Disputa** | Mostrar al cliente d√≥nde estuvo el operador |
| **Auditor√≠a** | Verificar ruta tomada vs √≥ptima |
| **UX Premium** | "Revive tu servicio" en historial |
| **An√°lisis** | Detectar desv√≠os innecesarios |

---

## Componente: MapaRuta

```vue
<!-- components/MapaRuta.vue -->
<script setup lang="ts">
import L from 'leaflet';
import 'leaflet/dist/leaflet.css';

interface Ubicacion {
  lat: number;
  lng: number;
  timestamp: string;
  es_inicio?: boolean;
  es_llegada?: boolean;
}

const props = defineProps<{
  ruta: Ubicacion[];
  inicio?: { lat: number; lng: number } | null;
  llegada?: { lat: number; lng: number } | null;
  destino?: { lat: number; lng: number } | null;
  height?: string;
  animated?: boolean;
}>();

const mapContainer = ref<HTMLElement>();
let map: L.Map;
let polyline: L.Polyline;
let startMarker: L.Marker;
let endMarker: L.Marker;
let destinoMarker: L.Marker;

const iconos = {
  inicio: L.divIcon({
    className: 'marker-inicio',
    html: '<div class="marker-dot inicio">üöÄ</div>',
    iconSize: [32, 32],
    iconAnchor: [16, 16]
  }),
  llegada: L.divIcon({
    className: 'marker-llegada',
    html: '<div class="marker-dot llegada">‚úÖ</div>',
    iconSize: [32, 32],
    iconAnchor: [16, 16]
  }),
  destino: L.divIcon({
    className: 'marker-destino',
    html: '<div class="marker-dot destino">üìç</div>',
    iconSize: [32, 32],
    iconAnchor: [16, 32]
  })
};

onMounted(() => {
  if (!mapContainer.value || !props.ruta.length) return;
  
  // Centro en primera ubicaci√≥n
  const centro = props.ruta[0];
  
  // Crear mapa
  map = L.map(mapContainer.value).setView([centro.lat, centro.lng], 14);
  
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap'
  }).addTo(map);
  
  // Coordenadas de la ruta
  const coords: L.LatLngExpression[] = props.ruta.map(u => [u.lat, u.lng]);
  
  // Dibujar polyline
  polyline = L.polyline(coords, {
    color: '#3b82f6',
    weight: 4,
    opacity: 0.8,
    lineJoin: 'round'
  }).addTo(map);
  
  // Marker de inicio
  if (props.inicio) {
    startMarker = L.marker([props.inicio.lat, props.inicio.lng], {
      icon: iconos.inicio
    }).addTo(map).bindPopup('Inicio del recorrido');
  }
  
  // Marker de llegada
  if (props.llegada) {
    endMarker = L.marker([props.llegada.lat, props.llegada.lng], {
      icon: iconos.llegada
    }).addTo(map).bindPopup('Llegada confirmada');
  }
  
  // Marker de destino (si diferente de llegada)
  if (props.destino) {
    destinoMarker = L.marker([props.destino.lat, props.destino.lng], {
      icon: iconos.destino
    }).addTo(map).bindPopup('Destino del cliente');
  }
  
  // Ajustar bounds
  map.fitBounds(polyline.getBounds(), { padding: [30, 30] });
  
  // Animaci√≥n opcional
  if (props.animated) {
    animateRoute();
  }
});

// Animaci√≥n de la ruta
const animateRoute = () => {
  polyline.setLatLngs([]);
  
  let index = 0;
  const interval = setInterval(() => {
    if (index >= props.ruta.length) {
      clearInterval(interval);
      return;
    }
    
    const path = polyline.getLatLngs() as L.LatLng[];
    path.push(L.latLng(props.ruta[index].lat, props.ruta[index].lng));
    polyline.setLatLngs(path);
    
    index++;
  }, 100); // 100ms entre puntos
};

onUnmounted(() => {
  map?.remove();
});
</script>

<template>
  <div 
    ref="mapContainer" 
    class="mapa-ruta"
    :style="{ height: height || '300px' }"
  />
</template>

<style scoped>
.mapa-ruta {
  width: 100%;
  border-radius: 12px;
  overflow: hidden;
}

:deep(.marker-dot) {
  font-size: 24px;
  text-align: center;
}

:deep(.marker-dot.inicio) {
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}
</style>
```

---

## Composable: useRouteReconstruction

```typescript
// composables/useRouteReconstruction.ts
interface RoutePoint {
  lat: number;
  lng: number;
  timestamp: string;
  accuracy: number;
  speed?: number;
  es_inicio: boolean;
  es_llegada: boolean;
}

export const useRouteReconstruction = (servicioId: string) => {
  const supabase = useSupabaseClient();
  const route = ref<RoutePoint[]>([]);
  const isLoading = ref(true);
  const error = ref<string | null>(null);
  
  const inicio = computed(() => route.value.find(p => p.es_inicio) || null);
  const llegada = computed(() => route.value.find(p => p.es_llegada) || null);
  
  const totalPoints = computed(() => route.value.length);
  
  const totalDistance = computed(() => {
    let distance = 0;
    for (let i = 1; i < route.value.length; i++) {
      distance += calcularDistancia(
        route.value[i-1].lat,
        route.value[i-1].lng,
        route.value[i].lat,
        route.value[i].lng
      );
    }
    return distance;
  });
  
  const totalDuration = computed(() => {
    if (!inicio.value || !llegada.value) return 0;
    return (new Date(llegada.value.timestamp).getTime() - 
            new Date(inicio.value.timestamp).getTime()) / 60000; // minutos
  });
  
  const averageSpeed = computed(() => {
    if (totalDuration.value === 0) return 0;
    return (totalDistance.value / 1000) / (totalDuration.value / 60); // km/h
  });
  
  const fetchRoute = async () => {
    isLoading.value = true;
    error.value = null;
    
    const { data, error: err } = await supabase
      .from('ubicaciones_servicio')
      .select('lat, lng, accuracy, speed, created_at, es_inicio, es_llegada')
      .eq('servicio_id', servicioId)
      .order('created_at', { ascending: true });
    
    if (err) {
      error.value = err.message;
    } else {
      route.value = data?.map(d => ({
        lat: d.lat,
        lng: d.lng,
        accuracy: d.accuracy,
        speed: d.speed,
        timestamp: d.created_at,
        es_inicio: d.es_inicio,
        es_llegada: d.es_llegada
      })) || [];
    }
    
    isLoading.value = false;
  };
  
  onMounted(fetchRoute);
  
  return {
    route: readonly(route),
    inicio,
    llegada,
    totalPoints,
    totalDistance,
    totalDuration,
    averageSpeed,
    isLoading: readonly(isLoading),
    error: readonly(error),
    refetch: fetchRoute
  };
};
```

---

## Vista: Historial de Servicio (Cliente)

```vue
<!-- pages/cliente/servicio/[id]/historial.vue -->
<script setup lang="ts">
const route = useRoute();
const servicioId = route.params.id as string;

const { 
  route: ruta, 
  inicio, 
  llegada,
  totalDistance,
  totalDuration,
  averageSpeed,
  isLoading 
} = useRouteReconstruction(servicioId);

const formatDistance = (m: number) => m < 1000 ? `${Math.round(m)}m` : `${(m/1000).toFixed(2)}km`;
const formatDuration = (min: number) => min < 60 ? `${Math.round(min)} min` : `${Math.floor(min/60)}h ${Math.round(min%60)}min`;
</script>

<template>
  <div class="historial-servicio">
    <h1>üìç Recorrido del Servicio</h1>
    
    <div v-if="isLoading" class="loading">Cargando...</div>
    
    <template v-else>
      <!-- M√©tricas -->
      <div class="stats-grid">
        <div class="stat">
          <span class="value">{{ formatDistance(totalDistance) }}</span>
          <span class="label">Distancia</span>
        </div>
        <div class="stat">
          <span class="value">{{ formatDuration(totalDuration) }}</span>
          <span class="label">Duraci√≥n</span>
        </div>
        <div class="stat">
          <span class="value">{{ averageSpeed.toFixed(1) }} km/h</span>
          <span class="label">Velocidad Prom.</span>
        </div>
      </div>
      
      <!-- Mapa -->
      <MapaRuta
        :ruta="ruta"
        :inicio="inicio"
        :llegada="llegada"
        height="400px"
        animated
      />
      
      <!-- Timeline -->
      <div class="timeline">
        <div class="point" v-if="inicio">
          <span class="icon">üöÄ</span>
          <span class="time">{{ formatTime(inicio.timestamp) }}</span>
          <span class="label">Operador sali√≥</span>
        </div>
        <div class="point" v-if="llegada">
          <span class="icon">‚úÖ</span>
          <span class="time">{{ formatTime(llegada.timestamp) }}</span>
          <span class="label">Lleg√≥ a destino</span>
        </div>
      </div>
    </template>
  </div>
</template>
```

---

## Casos Especiales

### Servicio sin Llegada Confirmada

```typescript
// Si no hay llegada, mostrar √∫ltimo punto conocido
const ultimaPosicion = computed(() => {
  if (llegada.value) return llegada.value;
  return route.value[route.value.length - 1] || null;
});
```

### Ruta Vac√≠a (datos expirados)

```vue
<div v-if="route.length === 0 && !isLoading" class="no-data">
  <span class="icon">‚è≥</span>
  <p>Los datos del recorrido ya no est√°n disponibles.</p>
  <small>La informaci√≥n GPS se retiene por 30 d√≠as.</small>
</div>
```

---

‚Üí Ver privacidad GDPR: [[Proyecto OnlyCarNLD/Datos/5.8.6.5.7 privacidad_gdpr]]

---

## Navegaci√≥n

| ‚¨ÜÔ∏è Padre             | [[Proyecto OnlyCarNLD/Datos/5.8.6.5 historial_ubicaciones]]            |
| -------------------- | ---------------------- |
| ‚¨ÖÔ∏è Hermano anterior  | [[Proyecto OnlyCarNLD/Datos/5.8.6.5.5 analytics_metricas]]              |
| ‚û°Ô∏è Hermano siguiente | [[Proyecto OnlyCarNLD/Datos/5.8.6.5.7 privacidad_gdpr]]              |
