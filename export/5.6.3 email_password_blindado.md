---
id: 5.6.3
title: Email/Password Blindado
parent: '5.6'
breadcrumb: 0 → 5.0 → 5.6 → 5.6.3
type: arquitectura
status: activo
last_updated: 2026-01-29 15:31
file_create: 2025-12-23 14:25
domain:
- auth
- email
- password
- seguridad
summary: 'Sistema de autenticación tradicional con seguridad reforzada.

  Argon2id hashing, rate limiting, MFA TOTP, verificación email.'
content_hash: 6531e5c667a86eef
---

# 5.6.3 Email/Password Blindado

Sistema de autenticación tradicional con seguridad reforzada para usuarios 
que no pueden o no desean usar OAuth.

---

## Casos de Uso

| Caso | Email Ejemplo |
|------|---------------|
| ISPs mexicanos | `@prodigy.net.mx`, `@infinitum.com.mx` |
| Correos empresariales sin OAuth | `@miempresalocal.com` |
| Yahoo, iCloud | `@yahoo.com`, `@icloud.com` |
| Preferencia personal | Usuario prefiere no usar OAuth |

---

## Flujo de Registro

```
1. FORMULARIO DE REGISTRO
   ├── Email (cualquier dominio)
   ├── Contraseña
   ├── Confirmar contraseña
   └── [Registrarse]

2. VALIDACIONES
   ├── Email formato válido
   ├── Email no registrado
   ├── Contraseña ≥ 8 caracteres
   ├── Al menos 1 mayúscula
   ├── Al menos 1 número
   └── Al menos 1 símbolo

3. PROCESAMIENTO
   ├── Hashear password (Argon2id)
   ├── Generar token verificación
   ├── Crear usuario (email_verified: false)
   └── Enviar email de verificación

4. VERIFICACIÓN EMAIL
   ├── Usuario recibe email
   ├── Clic en link (token único)
   ├── Sistema verifica token
   └── Activa cuenta (email_verified: true)

5. DETECCIÓN TIPO USUARIO
   ├── Extraer dominio email
   ├── Verificar en BD empresas_b2b
   └── Asignar B2C Puro o Corporate+
```

---

## Flujo de Login

```
1. FORMULARIO LOGIN
   ├── Email
   ├── Contraseña
   └── [Iniciar Sesión]

2. VALIDACIONES PREVIAS
   ├── Rate limiting check (IP + email)
   ├── Email existe en BD
   └── Email verificado

3. VERIFICACIÓN PASSWORD
   ├── Obtener hash de BD
   ├── Comparar con Argon2id
   └── Registrar intento (éxito/fallo)

4. MFA (Si habilitado)
   ├── Solicitar código TOTP
   ├── Verificar código
   └── Si fallo → registrar intento

5. CREAR SESIÓN
   ├── Generar JWT (15 min)
   ├── Generar Refresh Token (7 días)
   ├── Guardar sesión en BD
   └── Retornar tokens

6. REDIRECT → Dashboard
```

---

## Seguridad del Password

### Hashing con Argon2id

```typescript
import { hash, verify } from '@node-rs/argon2';

// Al registrar/cambiar password
const hashear = async (password: string): Promise<string> => {
  return await hash(password, {
    memoryCost: 65536,     // 64 MB
    timeCost: 3,           // 3 iteraciones
    parallelism: 4,        // 4 threads
    outputLen: 32,         // 256 bits
    algorithm: 2           // Argon2id
  });
};

// Al verificar login
const verificar = async (password: string, hash: string): Promise<boolean> => {
  return await verify(hash, password);
};
```

### Requisitos de Contraseña

| Requisito | Valor |
|-----------|-------|
| Longitud mínima | 8 caracteres |
| Mayúscula | ≥ 1 |
| Minúscula | ≥ 1 |
| Número | ≥ 1 |
| Símbolo | ≥ 1 de `!@#$%^&*()_+-=[]{}` |
| Longitud máxima | 128 caracteres |
| Blacklist | Top 10,000 passwords comunes |

```typescript
const validarPassword = (password: string): { valid: boolean; errors: string[] } => {
  const errors: string[] = [];
  
  if (password.length < 8) errors.push('Mínimo 8 caracteres');
  if (password.length > 128) errors.push('Máximo 128 caracteres');
  if (!/[A-Z]/.test(password)) errors.push('Requiere mayúscula');
  if (!/[a-z]/.test(password)) errors.push('Requiere minúscula');
  if (!/[0-9]/.test(password)) errors.push('Requiere número');
  if (!/[!@#$%^&*()_+\-=\[\]{}]/.test(password)) errors.push('Requiere símbolo');
  if (isCommonPassword(password)) errors.push('Contraseña muy común');
  
  return { valid: errors.length === 0, errors };
};
```

---

## Rate Limiting

### Configuración

| Evento | Límite | Bloqueo |
|--------|--------|---------|
| Login fallido (email) | 5 en 15 min | 15 min |
| Login fallido (IP) | 10 en 15 min | 15 min |
| Registro (IP) | 3 en 1 hora | 1 hora |
| Reset password | 3 en 1 hora | 1 hora |
| Verificación email | 5 en 1 hora | 1 hora |

### Implementación

```typescript
// server/utils/rateLimiter.ts
export const checkRateLimit = async (
  type: 'login_email' | 'login_ip' | 'register' | 'reset',
  identifier: string
): Promise<{ allowed: boolean; retryAfter?: number }> => {
  const config = {
    login_email: { limit: 5, window: 15 * 60 * 1000 },
    login_ip: { limit: 10, window: 15 * 60 * 1000 },
    register: { limit: 3, window: 60 * 60 * 1000 },
    reset: { limit: 3, window: 60 * 60 * 1000 }
  };
  
  const { limit, window } = config[type];
  const since = new Date(Date.now() - window);
  
  const attempts = await db
    .select({ count: count() })
    .from(auth_attempts)
    .where(and(
      eq(auth_attempts.identifier, identifier),
      eq(auth_attempts.type, type),
      gt(auth_attempts.attempted_at, since),
      eq(auth_attempts.success, false)
    ));
  
  if (attempts[0].count >= limit) {
    const oldestAttempt = await getOldestAttempt(identifier, type, since);
    const retryAfter = window - (Date.now() - oldestAttempt.getTime());
    return { allowed: false, retryAfter: Math.ceil(retryAfter / 1000) };
  }
  
  return { allowed: true };
};
```

---

## Reset de Password

```
1. SOLICITAR RESET
   ├── Usuario ingresa email
   ├── Verificar email existe
   ├── Rate limit check
   ├── Generar token único (32 bytes)
   ├── Guardar hash del token en BD
   ├── Expira en 1 hora
   └── Enviar email con link

2. CONFIRMAR RESET
   ├── Usuario clic link
   ├── Validar token (no expirado)
   ├── Mostrar form nueva contraseña
   ├── Validar nueva contraseña
   ├── Hashear nueva contraseña
   ├── Invalidar token usado
   ├── Revocar todas las sesiones
   └── Enviar email confirmación
```

---

## Email Templates

### Verificación de Email

```
Asunto: Verifica tu cuenta - OnlyCar

Hola [NOMBRE],

Gracias por registrarte en OnlyCar.

Para completar tu registro, verifica tu email:

[Verificar Email]

Este link expira en 24 horas.

Si no solicitaste esta cuenta, ignora este email.

Saludos,
OnlyCar
```

### Reset de Password

```
Asunto: Recupera tu contraseña - OnlyCar

Hola [NOMBRE],

Recibimos una solicitud para restablecer tu contraseña.

[Restablecer Contraseña]

Este link expira en 1 hora.

Si no solicitaste esto, ignora este email.
Tu contraseña no cambiará.

Saludos,
OnlyCar
```

---

## Auditoría

Todos los eventos de auth se registran:

| Campo | Descripción |
|-------|-------------|
| `event_type` | login, logout, register, reset, mfa_setup |
| `user_id` | ID del usuario (si aplica) |
| `email` | Email intentado |
| `ip_address` | IP del cliente |
| `user_agent` | Navegador/dispositivo |
| `success` | true/false |
| `failure_reason` | Si falló, por qué |
| `created_at` | Timestamp |

---

## Navegación

| ⬆️ Padre            | [[Proyecto OnlyCarNLD/Datos/5.6. autenticacion]]              |
| ------------------- | ----------------------------------- |
| ⬅️ Hermano anterior | [[Proyecto OnlyCarNLD/Datos/5.6.2 oauth_proveedores]]         |
| ➡️ Hermano siguiente | [[Proyecto OnlyCarNLD/Datos/5.6.4 deteccion_tipo_usuario]]    |

---
