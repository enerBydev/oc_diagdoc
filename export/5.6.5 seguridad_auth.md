---
id: 5.6.5
title: Seguridad de Autenticación
parent: '5.6'
breadcrumb: 0 → 5.0 → 5.6 → 5.6.5
type: seguridad
status: activo
last_updated: 2026-01-29 16:05
file_create: 2025-12-23 14:27
domain:
- auth
- mfa
- jwt
- seguridad
summary: 'Medidas de seguridad adicionales para proteger el sistema de auth.

  MFA TOTP, headers seguridad, JWT RS256, protección ataques.'
content_hash: da55dd536f82e33e
---

# 5.6.5 Seguridad de Autenticación

Medidas de seguridad adicionales para proteger el sistema de autenticación.

---

## MFA (Autenticación Multifactor)

### Implementación TOTP

| Aspecto | Valor |
|---------|-------|
| **Algoritmo** | TOTP (RFC 6238) |
| **Período** | 30 segundos |
| **Dígitos** | 6 |
| **Hash** | SHA-1 |
| **Apps compatibles** | Google Authenticator, Authy, 1Password |

### Flujo de Activación

```
1. Usuario accede a Configuración → Seguridad
2. Clic "Activar autenticación en 2 pasos"
3. Sistema genera secreto TOTP
4. Muestra QR code + código manual
5. Usuario escanea con app
6. Usuario ingresa código de verificación
7. Sistema valida código
8. Si correcto → MFA activado
9. Sistema genera códigos de respaldo (10)
```

### Códigos de Respaldo

- 10 códigos de un solo uso
- Se generan al activar MFA
- Cada código: 8 caracteres alfanuméricos
- Almacenados como hashes en BD

```typescript
// Generar códigos de respaldo
const generarCodigosRespaldo = (): string[] => {
  const codigos: string[] = [];
  for (let i = 0; i < 10; i++) {
    codigos.push(crypto.randomBytes(4).toString('hex').toUpperCase());
  }
  return codigos;
};
```

---

## Headers de Seguridad

### Configuración Nitro

```typescript
// nuxt.config.ts
export default defineNuxtConfig({
  routeRules: {
    '/**': {
      headers: {
        'Strict-Transport-Security': 'max-age=31536000; includeSubDomains',
        'X-Content-Type-Options': 'nosniff',
        'X-Frame-Options': 'DENY',
        'X-XSS-Protection': '1; mode=block',
        'Referrer-Policy': 'strict-origin-when-cross-origin',
        'Content-Security-Policy': "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';"
      }
    }
  }
});
```

| Header | Propósito |
|--------|-----------|
| **HSTS** | Forzar HTTPS |
| **X-Content-Type-Options** | Prevenir MIME sniffing |
| **X-Frame-Options** | Prevenir clickjacking |
| **X-XSS-Protection** | Filtro XSS del navegador |
| **Referrer-Policy** | Controlar información de referrer |
| **CSP** | Prevenir XSS e inyecciones |

---

## JWT y Tokens

### Configuración JWT

| Parámetro | Valor |
|-----------|-------|
| **Algoritmo** | RS256 |
| **Expiración access** | 15 minutos |
| **Expiración refresh** | 7 días |
| **Issuer** | `https://app.onlycar.mx` |
| **Audience** | `onlycar-api` |

### Estructura del JWT

```json
{
  "header": {
    "alg": "RS256",
    "typ": "JWT"
  },
  "payload": {
    "sub": "uuid-del-usuario",
    "email": "usuario@email.com",
    "tipo": "corporate_plus",
    "empresa_id": "uuid-empresa",
    "iat": 1703347200,
    "exp": 1703348100,
    "iss": "https://app.onlycar.mx",
    "aud": "onlycar-api"
  }
}
```

### Rotación de Refresh Tokens

```typescript
// Al usar refresh token, se genera uno nuevo
const refreshSession = async (refreshToken: string) => {
  const session = await validateRefreshToken(refreshToken);
  
  if (!session) {
    throw createError({ statusCode: 401, message: 'Token inválido' });
  }
  
  // Revocar token actual
  await revokeRefreshToken(session.id);
  
  // Generar nuevos tokens
  const newAccessToken = await generateAccessToken(session.user_id);
  const newRefreshToken = await generateRefreshToken(session.user_id);
  
  return { accessToken: newAccessToken, refreshToken: newRefreshToken };
};
```

---

## Protección contra Ataques

### Fuerza Bruta

| Medida | Implementación |
|--------|----------------|
| Rate limiting | 5 fallos → bloqueo 15 min |
| CAPTCHA | Después de 3 fallos |
| Delay incremental | +1s por cada fallo |
| Alertas | Notificar admin después de 10 fallos |

### Credential Stuffing

| Medida | Implementación |
|--------|----------------|
| Detección | Analizar patrones de IP/UA |
| Bloqueo IP | IPs sospechosas → CAPTCHA obligatorio |
| Monitoreo | Alertas de picos de logins fallidos |

### Session Hijacking

| Medida | Implementación |
|--------|----------------|
| Secure cookies | `Secure; HttpOnly; SameSite=Strict` |
| Fingerprinting | Validar UA + IP en cada request |
| Regeneración | Nueva sesión al cambiar privilegios |

---

## Logs y Auditoría

### Eventos Registrados

| Evento | Datos |
|--------|-------|
| `auth.login.success` | user_id, method, ip, ua |
| `auth.login.failure` | email, reason, ip, ua |
| `auth.logout` | user_id, ip |
| `auth.register` | user_id, ip |
| `auth.password.reset.request` | email, ip |
| `auth.password.reset.confirm` | user_id, ip |
| `auth.mfa.enable` | user_id |
| `auth.mfa.disable` | user_id |
| `auth.session.revoke` | user_id, session_id |

### Retención

| Tipo | Retención |
|------|-----------|
| Logins exitosos | 90 días |
| Logins fallidos | 30 días |
| Cambios de seguridad | 1 año |
| Eventos críticos | 5 años |

---

## Cloudflare Zero Trust

### Integración

| Característica | Uso |
|----------------|-----|
| **Access** | Proteger rutas admin |
| **WAF** | Bloquear ataques conocidos |
| **Bot Management** | Detectar bots maliciosos |
| **Rate Limiting** | Capa adicional en edge |

```
Usuario → Cloudflare → WAF/Rate Limit → App → Auth
```

---

## Checklist de Seguridad

- [x] Passwords hasheados con Argon2id
- [x] Rate limiting en login
- [x] CAPTCHA después de fallos
- [x] MFA opcional con TOTP
- [x] JWTs con RS256 y rotación
- [x] Headers de seguridad (HSTS, CSP, etc.)
- [x] Cookies seguras
- [x] Logs de auditoría
- [x] Verificación de email obligatoria
- [x] Tokens de reset con expiración
- [x] Cloudflare Zero Trust

---

## Navegación

| ⬆️ Padre            | [[Proyecto OnlyCarNLD/Datos/5.6. autenticacion]]              |
| ------------------- | ----------------------------------- |
| ⬅️ Hermano anterior | [[Proyecto OnlyCarNLD/Datos/5.6.4 deteccion_tipo_usuario]]    |
| ➡️ Hermano siguiente | [[Proyecto OnlyCarNLD/Datos/5.6.6 migracion_usuarios]]        |

---
