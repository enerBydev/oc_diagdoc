---
id: 1.3.14.4
title: Purga Programada
parent: 1.3.14
breadcrumb: 0 ‚Üí 1.0 ‚Üí 1.3 ‚Üí 1.3.14 ‚Üí 1.3.14.4
type: feature
status: activo
last_updated: 2026-01-29 15:32
file_create: 2026-01-10 12:16
domain:
- eliminacion
- cumplimiento
actors:
- admin
- sistema
summary: Proceso de eliminaci√≥n permanente de datos tras cumplir per√≠odo de retenci√≥n.
content_hash: 72bca1898679ebec
---

# 1.3.14.4 Purga Programada

> Eliminaci√≥n permanente cuando se cumple la retenci√≥n.

---

## Proceso de Purga

```mermaid
flowchart TD
    A[Cron semanal] --> B[Query datos elegibles]
    B --> C{¬øTipo de dato?}
    
    C -->|Multimedia| D[Eliminar de R2 Archive]
    C -->|Mensajes| E[Eliminar de archived_messages]
    C -->|Conversaciones| F[Eliminar metadatos]
    
    D --> G[Actualizar contadores]
    E --> G
    F --> G
    
    G --> H[Log de auditor√≠a]
    H --> I[Notificar a Admin]
```

---

## Criterios de Elegibilidad

```sql
-- Multimedia para purga (>30 meses desde creaci√≥n)
SELECT file_key, created_at 
FROM archived_media
WHERE created_at < NOW() - INTERVAL '30 months';

-- Mensajes para purga (>72 meses desde creaci√≥n)
SELECT id, conversation_id, created_at
FROM archived_messages
WHERE created_at < NOW() - INTERVAL '72 months';

-- Conversaciones completamente purgadas
SELECT id 
FROM archived_conversations
WHERE scheduled_deletion < NOW()
  AND NOT EXISTS (
    SELECT 1 FROM archived_messages m 
    WHERE m.conversation_id = archived_conversations.original_conversation_id
  );
```

---

## Cron Job de Purga

```typescript
// jobs/purge-archived-data.ts
import { CronJob } from 'cron';

export const purgeArchivedDataJob = new CronJob(
  '0 2 * * 0', // Domingos 2:00 AM
  async () => {
    console.log('[Purge] Iniciando purga programada...');
    
    // 1. Purgar multimedia antigua
    const mediaToDelete = await db
      .select({ key: archivedMedia.fileKey })
      .from(archivedMedia)
      .where(lt(archivedMedia.createdAt, subMonths(new Date(), 30)));
    
    for (const file of mediaToDelete) {
      await r2.delete(`archive/${file.key}`);
      await db.delete(archivedMedia).where(eq(archivedMedia.fileKey, file.key));
    }
    console.log(`[Purge] Multimedia eliminada: ${mediaToDelete.length}`);
    
    // 2. Purgar mensajes antiguos
    const deletedMessages = await db
      .delete(archivedMessages)
      .where(lt(archivedMessages.createdAt, subMonths(new Date(), 72)))
      .returning({ id: archivedMessages.id });
    console.log(`[Purge] Mensajes eliminados: ${deletedMessages.length}`);
    
    // 3. Purgar conversaciones vac√≠as
    const emptyConversations = await db.execute(sql`
      DELETE FROM archived_conversations ac
      WHERE ac.scheduled_deletion < NOW()
        AND NOT EXISTS (
          SELECT 1 FROM archived_messages m 
          WHERE m.conversation_id = ac.original_conversation_id
        )
      RETURNING ac.id
    `);
    console.log(`[Purge] Conversaciones eliminadas: ${emptyConversations.length}`);
    
    // 4. Log y notificaci√≥n
    await logPurgeReport({
      media: mediaToDelete.length,
      messages: deletedMessages.length,
      conversations: emptyConversations.length,
      date: new Date(),
    });
    
    await notifyAdmin('purge_completed', {
      subject: 'Purga semanal completada',
      body: `Media: ${mediaToDelete.length}, Mensajes: ${deletedMessages.length}`,
    });
  }
);
```

---

## Seguridad

| Control | Descripci√≥n |
|---------|-------------|
| **Solo sistema** | Purga autom√°tica no requiere intervenci√≥n |
| **Log inmutable** | Todo se registra en tabla de auditor√≠a |
| **Backup pre-purga** | Snapshot antes de cada ejecuci√≥n |
| **Rollback 24h** | Backup disponible 24 horas |

---

## Reporte de Purga

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  üìä REPORTE DE PURGA ‚Äî 12 Enero 2026                            ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                 ‚îÇ
‚îÇ  RESUMEN                                                        ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ              ‚îÇ
‚îÇ  Archivos multimedia eliminados:    1,234                       ‚îÇ
‚îÇ  Mensajes eliminados:               45,678                      ‚îÇ
‚îÇ  Conversaciones eliminadas:         890                         ‚îÇ
‚îÇ  Espacio liberado:                  2.3 GB                      ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  DETALLE POR TIPO                                               ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ              ‚îÇ
‚îÇ  ‚îÇ Tipo            ‚îÇ Cantidad ‚îÇ Espacio  ‚îÇ Antig√ºedad ‚îÇ         ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ Fotos           ‚îÇ    890   ‚îÇ  1.8 GB  ‚îÇ 30+ meses  ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ Notas de voz    ‚îÇ    234   ‚îÇ  0.3 GB  ‚îÇ 30+ meses  ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ PDFs            ‚îÇ    110   ‚îÇ  0.2 GB  ‚îÇ 72+ meses  ‚îÇ         ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  PR√ìXIMA PURGA: 19 Enero 2026, 2:00 AM                          ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## Navegaci√≥n

| ‚¨ÜÔ∏è Padre | [[Proyecto OnlyCarNLD/Datos/1.3.14 archivado_chats]] |
|----------|---------------------------|
| ‚¨ÖÔ∏è Hermano anterior | [[Proyecto OnlyCarNLD/Datos/1.3.14.3 archivado_manual]] |
| ‚û°Ô∏è Hermano siguiente | [[Proyecto OnlyCarNLD/Datos/1.3.14.5 cumplimiento_legal]] |

---
