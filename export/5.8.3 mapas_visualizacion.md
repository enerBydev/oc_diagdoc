---
id: 5.8.3
title: Mapas Visualizaci√≥n
parent: '5.8'
breadcrumb: 0 ‚Üí 5.0 ‚Üí 5.8 ‚Üí 5.8.3
type: modulo_padre
children_count: 6
status: activo
last_updated: 2026-01-29 15:32
file_create: 2026-01-01 18:10
domain:
- mapas
- leaflet
- osm
summary: Visualizaci√≥n de mapas con Leaflet + OpenStreetMap.
content_hash: b1ce56184b2dcb63
---

# 5.8.3 Mapas y Visualizaci√≥n

Renderizado de mapas con Leaflet y OpenStreetMap.

---

## Instalaci√≥n

```bash
npm install leaflet
npm install -D @types/leaflet
```

---

## Componente Principal

```vue
<!-- components/MapaUbicacion.vue -->
<script setup lang="ts">
import L from 'leaflet';
import 'leaflet/dist/leaflet.css';
import { GEO_CONFIG } from '~/config/geolocation';

interface Props {
  // Posici√≥n del operador
  operadorLat?: number;
  operadorLng?: number;
  
  // Posici√≥n del destino
  destinoLat?: number;
  destinoLng?: number;
  
  // Opciones
  zoom?: number;
  height?: string;
  showRoute?: boolean;
}

const props = withDefaults(defineProps<Props>(), {
  zoom: GEO_CONFIG.DEFAULT_ZOOM,
  height: '200px',
  showRoute: false
});

const mapContainer = ref<HTMLElement | null>(null);
let map: L.Map | null = null;
let operadorMarker: L.Marker | null = null;
let destinoMarker: L.Marker | null = null;
let routeLine: L.Polyline | null = null;

// Iconos personalizados
const operadorIcon = L.divIcon({
  className: 'marker-operador',
  html: '<div class="marker-dot operador">üöó</div>',
  iconSize: [32, 32],
  iconAnchor: [16, 16]
});

const destinoIcon = L.divIcon({
  className: 'marker-destino',
  html: '<div class="marker-dot destino">üìç</div>',
  iconSize: [32, 32],
  iconAnchor: [16, 32]
});

onMounted(() => {
  if (!mapContainer.value) return;
  
  // Centro inicial
  const centro = props.operadorLat && props.operadorLng
    ? [props.operadorLat, props.operadorLng]
    : [27.4797, -99.5067]; // Default: Nuevo Laredo
  
  // Crear mapa
  map = L.map(mapContainer.value).setView(centro as L.LatLngExpression, props.zoom);
  
  // A√±adir tiles de OpenStreetMap
  L.tileLayer(GEO_CONFIG.TILE_URL, {
    attribution: '¬© <a href="https://openstreetmap.org">OpenStreetMap</a>',
    maxZoom: 19
  }).addTo(map);
  
  // Marker del operador
  if (props.operadorLat && props.operadorLng) {
    operadorMarker = L.marker([props.operadorLat, props.operadorLng], {
      icon: operadorIcon
    }).addTo(map);
  }
  
  // Marker del destino
  if (props.destinoLat && props.destinoLng) {
    destinoMarker = L.marker([props.destinoLat, props.destinoLng], {
      icon: destinoIcon
    }).addTo(map);
    
    // Ajustar vista para mostrar ambos puntos
    if (props.operadorLat && props.operadorLng) {
      const bounds = L.latLngBounds(
        [props.operadorLat, props.operadorLng],
        [props.destinoLat, props.destinoLng]
      );
      map.fitBounds(bounds, { padding: [50, 50] });
    }
  }
});

// Actualizar posici√≥n del operador
watch(
  () => [props.operadorLat, props.operadorLng],
  ([lat, lng]) => {
    if (!map || !lat || !lng) return;
    
    if (operadorMarker) {
      operadorMarker.setLatLng([lat, lng]);
    } else {
      operadorMarker = L.marker([lat, lng], { icon: operadorIcon }).addTo(map);
    }
    
    // Centrar suavemente
    map.panTo([lat, lng], { animate: true, duration: 0.5 });
    
    // Actualizar l√≠nea de ruta
    if (props.showRoute && props.destinoLat && props.destinoLng) {
      updateRouteLine(lat, lng);
    }
  }
);

const updateRouteLine = (operadorLat: number, operadorLng: number) => {
  if (!map || !props.destinoLat || !props.destinoLng) return;
  
  const coords: L.LatLngExpression[] = [
    [operadorLat, operadorLng],
    [props.destinoLat, props.destinoLng]
  ];
  
  if (routeLine) {
    routeLine.setLatLngs(coords);
  } else {
    routeLine = L.polyline(coords, {
      color: '#3b82f6',
      weight: 3,
      opacity: 0.7,
      dashArray: '10, 10'
    }).addTo(map);
  }
};

// Cleanup
onUnmounted(() => {
  map?.remove();
});
</script>

<template>
  <div 
    ref="mapContainer" 
    class="mapa-container"
    :style="{ height }"
  />
</template>

<style>
.mapa-container {
  width: 100%;
  border-radius: 12px;
  overflow: hidden;
}

.marker-dot {
  font-size: 24px;
  text-align: center;
}

.marker-dot.operador {
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}
</style>
```

---

## Estructura de Hijos

| ID                                     | Nombre            | Descripci√≥n              | Estado |
| -------------------------------------- | ----------------- | ------------------------ | ------ |
| [[Proyecto OnlyCarNLD/Datos/5.8.3.1 tiles_osm\|5.8.3.1]]         | Tiles OSM         | Configuraci√≥n tiles OSM  | ‚úÖ      |
| [[Proyecto OnlyCarNLD/Datos/5.8.3.2 markers_dinamicos\|5.8.3.2]] | Markers Din√°micos | Marcadores en mapa       | ‚úÖ      |
| [[Proyecto OnlyCarNLD/Datos/5.8.3.3 nuxt_integration\|5.8.3.3]]  | Nuxt Integration  | Integraci√≥n con Nuxt     | ‚úÖ      |
| [[Proyecto OnlyCarNLD/Datos/5.8.3.4 responsive_design\|5.8.3.4]] | Responsive Design | Dise√±o responsivo        | ‚úÖ      |
| [[Proyecto OnlyCarNLD/Datos/5.8.3.5 accessibility\|5.8.3.5]]     | Accessibility     | Accesibilidad            | ‚úÖ      |
| [[Proyecto OnlyCarNLD/Datos/5.8.3.6 performance\|5.8.3.6]]       | Performance       | Optimizaci√≥n rendimiento | ‚úÖ      |

---

## Uso en Chat

```vue
<!-- components/chat/CardUbicacion.vue -->
<script setup lang="ts">
const props = defineProps<{
  servicioId: string;
  destinoLat: number;
  destinoLng: number;
}>();

const { onLocationUpdate, isConnected } = useLocationBroadcast(props.servicioId);

const operador = reactive({
  lat: 0,
  lng: 0,
  lastUpdate: null as Date | null
});

onLocationUpdate((payload) => {
  operador.lat = payload.lat;
  operador.lng = payload.lng;
  operador.lastUpdate = new Date(payload.timestamp);
});

const distanciaEstimada = computed(() => {
  if (!operador.lat || !operador.lng) return null;
  return calcularDistancia(
    operador.lat, operador.lng,
    props.destinoLat, props.destinoLng
  );
});
</script>

<template>
  <div class="card-ubicacion">
    <div class="card-header">
      <span>üöó El operador viene en camino</span>
      <span v-if="isConnected" class="live-badge">EN VIVO</span>
    </div>
    
    <MapaUbicacion
      v-if="operador.lat && operador.lng"
      :operador-lat="operador.lat"
      :operador-lng="operador.lng"
      :destino-lat="destinoLat"
      :destino-lng="destinoLng"
      :show-route="true"
      height="250px"
    />
    
    <div v-else class="loading">
      Obteniendo ubicaci√≥n...
    </div>
    
    <div class="card-footer">
      <span v-if="distanciaEstimada">
        üìè {{ formatDistance(distanciaEstimada) }}
      </span>
      <span v-if="operador.lastUpdate">
        üïê {{ formatRelativeTime(operador.lastUpdate) }}
      </span>
    </div>
  </div>
</template>
```

---

## Temas de Mapa (Opcional)

```typescript
// Diferentes estilos de tiles
const TILE_PROVIDERS = {
  osm: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
  osmHot: 'https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png',
  cartoDB_light: 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png',
  cartoDB_dark: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png'
};

// Usar tema oscuro si el usuario tiene dark mode
const tileUrl = computed(() => {
  const colorMode = useColorMode();
  return colorMode.value === 'dark' 
    ? TILE_PROVIDERS.cartoDB_dark 
    : TILE_PROVIDERS.osm;
});
```

---

‚Üí Ver tiles: [[Proyecto OnlyCarNLD/Datos/5.8.3.1 tiles_osm]]
‚Üí Ver markers: [[Proyecto OnlyCarNLD/Datos/5.8.3.2 markers_dinamicos]]

---

## Navegaci√≥n

| ‚¨ÜÔ∏è Padre             | [[Proyecto OnlyCarNLD/Datos/5.8. geolocalizacion]]            |
| -------------------- | ---------------------- |
| ‚¨ÖÔ∏è Hermano anterior  | [[Proyecto OnlyCarNLD/Datos/5.8.2 realtime_broadcast]]              |
| ‚û°Ô∏è Hermano siguiente | [[Proyecto OnlyCarNLD/Datos/5.8.4 navegacion_externa]]              |
