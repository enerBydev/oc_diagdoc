---
id: 3.1.4.5
title: Vistas Materializadas
parent: 3.1.4
breadcrumb: 0 → 3.0 → 3.1 → 3.1.4 → 3.1.4.5
type: hoja
status: activo
last_updated: 2026-01-29 15:32
file_create: 2026-01-05 12:30
domain:
- sql
- vistas
- performance
actors:
- admin
- desarrollador
summary: 'Vistas para consultas optimizadas: precios calculados, paquetes completos.'
content_hash: 89e6e082390a732f
---

# 3.1.4.5 Vistas Materializadas

> Vistas SQL para consultas frecuentes con cálculos complejos.

---

## v_servicios_precios

Servicios con precios B2C y B2B calculados automáticamente.

```sql
CREATE OR REPLACE VIEW v_servicios_precios AS
WITH config AS (
  SELECT factor_b2c, factor_b2b, redondeo_multiplo
  FROM config_sistema
  LIMIT 1
)
SELECT
  s.id, s.codigo, s.nombre,
  s.servicio_minutos, s.buffer_minutos, s.total_bloqueado,
  s.precio_base,
  ROUND(s.precio_base * c.factor_b2c / c.redondeo_multiplo) * c.redondeo_multiplo as precio_b2c,
  ROUND(s.precio_base * c.factor_b2b / c.redondeo_multiplo) * c.redondeo_multiplo as precio_b2b,
  s.descripcion, s.activo
FROM servicios s
CROSS JOIN config c
WHERE s.activo = true;
```

---

## v_paquetes_completos

Paquetes con servicios heredados resueltos recursivamente.

```sql
CREATE OR REPLACE VIEW v_paquetes_completos AS
WITH RECURSIVE paquete_jerarquia AS (
  SELECT 
    p.id, p.codigo, p.tipo, p.nombre, p.precio_base,
    p.hereda_de_id,
    ARRAY[]::uuid[] as servicios_heredados
  FROM paquetes p
  WHERE p.hereda_de_id IS NULL AND p.activo = true
  
  UNION ALL
  
  SELECT
    p.id, p.codigo, p.tipo, p.nombre, p.precio_base,
    p.hereda_de_id,
    pj.servicios_heredados || ARRAY(
      SELECT ps.servicio_id 
      FROM paquete_servicios ps 
      WHERE ps.paquete_id = pj.id AND NOT ps.es_adicional
    )
  FROM paquetes p
  JOIN paquete_jerarquia pj ON p.hereda_de_id = pj.id
  WHERE p.activo = true
)
SELECT * FROM paquete_jerarquia;
```

---

## Navegación

| ⬆️ Padre | [[Proyecto OnlyCarNLD/Datos/3.1.4 esquema_sql_logica_negocio]] |
|----------|--------------------------------------|
| ⬅️ Anterior | [[Proyecto OnlyCarNLD/Datos/3.1.4.4 Tablas_Empresas]] |
| ➡️ Siguiente | [[Proyecto OnlyCarNLD/Datos/3.1.4.6 RLS_Policies]] |

---
