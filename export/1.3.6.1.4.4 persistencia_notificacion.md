---
id: 1.3.6.1.4.4
title: Persistencia de Notificación
parent: 1.3.6.1.4
breadcrumb: 0 → 1.0 → 1.3 → 1.3.6 → 1.3.6.1 → 1.3.6.1.4 → 1.3.6.1.4.4
type: hoja
status: activo
domain: comunicacion
summary: Sistema Android Foreground Service para notificaciones que NO desaparecen
  hasta ser atendidas con reminder cada 30s.
version: 1.0
last_updated: 2026-01-29 15:32
file_create: 2025-12-26 15:22
actors:
- operador
- sistema
dependencies:
- android_foreground_service
affects:
- 1.3.6.1.4.1 notificaciones_premium
content_hash: cdaa85a158a53c7e
---

# 1.3.6.1.4.4 Persistencia de Notificación

Sistema para que las notificaciones no desaparezcan hasta ser atendidas.

---

## Problema vs Solución

| Normal | Persistente |
|--------|-------------|
| Desaparece en 3s | NO desaparece |
| Se puede deslizar | NO se puede deslizar |
| Operador no la vio | Requiere acción explícita |
| ❌ OPORTUNIDAD PERDIDA | ✅ ATENDIDA |

---

## Implementación: Foreground Service

```kotlin
val notification = NotificationCompat.Builder(this, CHANNEL_ID)
    .setOngoing(true)           // No se puede deslizar
    .setAutoCancel(false)       // No desaparece al tocar
    .setTimeoutAfter(300000)    // Expira a los 5 min
    .build()

// Iniciar como foreground
startForeground(NOTIFICATION_ID, notification)
```

---

## Reminder cada 30 segundos

```kotlin
handler.postDelayed({
    val stillActive = ServiceApi.isRequestActive(requestId)
    if (stillActive) {
        SoundManager(context).playServiceRequestSound()
        VibrationManager(context).vibrateForRequest()
        scheduleNextReminder(requestId)
    }
}, 30000)
```

---

## Diagrama de Flujo

```mermaid
sequenceDiagram
    participant P as Push Firebase
    participant S as Service
    participant N as Notification
    participant O as Operador
    
    P->>S: Nueva solicitud
    S->>N: Mostrar (persistent=true)
    
    loop Cada 30s hasta 5min
        alt No responde
            S->>N: Re-mostrar heads-up
        else Responde
            O->>S: Aceptar/Pasar
            S->>N: Dismiss
        end
    end
```

---

## Navegación

| ⬆️ Padre             | [[Proyecto OnlyCarNLD/Datos/1.3.6.1.4 broadcast_solicitud]]    |
| -------------------- | ------------------------------------ |
| ⬅️ Hermano anterior  | [[Proyecto OnlyCarNLD/Datos/1.3.6.1.4.3 vibracion_patron]]     |

---
