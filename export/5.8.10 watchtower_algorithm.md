---
id: 5.8.10
title: Watchtower Algorithm
parent: '5.8'
breadcrumb: 0 ‚Üí 5.0 ‚Üí 5.8 ‚Üí 5.8.10
type: hoja
status: activo
children_count: 0
descendants_count: 0
domain:
- seguridad
- geofencing
- anomalias
- eta
summary: Algoritmo de monitoreo de anomal√≠as y geofencing predictivo (Safety).
last_updated: 2026-01-29 15:32
content_hash: 48b1b7629869e70b
---

# 5.8.10 Watchtower Algorithm

El "Ojo que todo lo ve". Cerebro anal√≠tico encargado de la seguridad proactiva y la predicci√≥n de eventos durante el servicio.

> [!IMPORTANT]
> **Diferenciaci√≥n de Responsabilidades:**
> *   **Watchtower (Este m√≥dulo):** Monitorea seguridad, detecta anomal√≠as y predice aproximaci√≥n ("A 5 mins").
> *   **[[Proyecto OnlyCarNLD/Datos/5.8.5 deteccion_llegada]]:** Determina y confirma exclusivamente el evento de llegada final ("Estoy aqu√≠").

---

## 1. L√≥gica de Detecci√≥n de Anomal√≠as

Algoritmos que corren en background (Edge Functions) para detectar comportamientos inusuales.

### 1.1 Detecci√≥n de Parada No Autorizada (Red Flag)
Se dispara si el veh√≠culo se detiene fuera del origen o destino por m√°s tiempo del permitido.

```mermaid
flowchart LR
    A[Stream GPS] --> B{Velocidad < 3km/h?}
    B -->|S√≠| C[Iniciar Timer]
    C --> D{Tiempo > 5 min?}
    D -->|S√≠| E{Ubicaci√≥n == Sem√°foro/Tr√°fico?}
    E -->|No| F[üî¥ ALERTA: PARADA IRREGULAR]
    E -->|S√≠| G[Ignorar]
```

> [!TIP]
> **Heur√≠stica de Tr√°fico (V1 vs V2):**
> *   **V1:** La excepci√≥n "Tr√°fico" se determina si el tiempo de detenci√≥n es **< 2 minutos**.
> *   **V2:** Se integrar√° API de Google Traffic para validar congesti√≥n real.

### 1.2 Detecci√≥n de Desv√≠o (Yellow Flag)
Verifica si el operador se aleja significativamente de la ruta √≥ptima calculada.

*   **Umbral:** > 500 metros de desviaci√≥n ortogonal de la polil√≠nea de ruta.
*   **Acci√≥n:** Notificaci√≥n push al operador ("¬øTodo bien con tu ruta?") + Alerta silenciosa al Admin.

### 1.3 P√©rdida de Se√±al (Black Flag)
*   **Trigger:** No se recibe `heartbeat` o `location_update` por > 10 minutos.
*   **Acci√≥n:** Marcado autom√°tico en Dashboard Admin como "OFFLINE - REQUIERE ATENCI√ìN".

---

## 2. Geofencing Predictivo (Approaching)

Sistema para generar la notificaci√≥n "Tu experto se acerca" y reducir la ansiedad del cliente.

### 2.1 L√≥gica de "Approaching"
El estado `approaching` es un estado transitorio virtual, no un estado de la base de datos del servicio.

**Condiciones de Disparo (OR):**
1.  **Distancia:** < 1.5 km del destino.
2.  **ETA:** < 4 minutos calculado via OSRM/Google Routes.

**Acciones:**
*   Enviar Push Notification al cliente: *"üöó ¬°[Nombre] est√° llegando! Prep√°rate para tu servicio."*
*   Activar UI de "Preparaci√≥n" en App Cliente (Ver [[Proyecto OnlyCarNLD/Datos/5.8.11 client_timeline_ui]]).

---

## 3. Algoritmo de ETA Din√°mico

C√°lculo continuo del Tiempo Estimado de Llegada para mostrar en la UI.

$$ETA_{final} = \frac{Distancia_{restante}}{Velocidad_{promedio\_segmento}} \times Factor_{trafico}$$

*   **Frecuencia de Rec√°lculo:** Cada 30-60 segundos (para no saturar APIs).
*   **Fuente de Tr√°fico:** Integraci√≥n opcional con Waze/Google o heur√≠stica basada en la velocidad actual del operador.

---

## Navegaci√≥n

| ‚¨ÜÔ∏è Padre             | [[Proyecto OnlyCarNLD/Datos/5.8. geolocalizacion]]            |
| -------------------- | ----------------------------------- |
| ‚¨ÖÔ∏è Hermano anterior  | [[Proyecto OnlyCarNLD/Datos/5.8.9 configuracion_remota]]      |
| ‚û°Ô∏è Hermano siguiente | [[Proyecto OnlyCarNLD/Datos/5.8.11 client_timeline_ui]]       |
