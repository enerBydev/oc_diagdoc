---
id: 5.8.7.3
title: App Killed
parent: 5.8.7
breadcrumb: 0 ‚Üí 5.0 ‚Üí 5.8 ‚Üí 5.8.7 ‚Üí 5.8.7.3
type: edge_case
status: activo
last_updated: 2026-01-29 15:32
file_create: 2026-01-02 18:49
domain:
- killed
- background
- recovery
summary: Manejo cuando app cerrada.
content_hash: 18d4122662dbed94
---

# 5.8.7.3 App Killed

Manejo cuando la app es terminada por el sistema operativo.

---

## Escenarios

| Escenario            | Causa               | Detectable?         |
| -------------------- | ------------------- | ------------------- |
| **Low memory**       | SO necesita RAM     | No directamente     |
| **Battery saver**    | Modo ahorro bater√≠a | Parcialmente        |
| **User force close** | Usuario cierra app  | No                  |
| **Crash**            | Error en c√≥digo     | S√≠ (crash reporter) |
| **Background limit** | iOS/Android limits  | Parcialmente        |

---

## Limitaciones por Plataforma

### iOS

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  iOS BACKGROUND EXECUTION                                       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                 ‚îÇ
‚îÇ  SIN Background Location Entitlement:                           ‚îÇ
‚îÇ  ‚Ä¢ App suspendida despu√©s de ~3 minutos en background           ‚îÇ
‚îÇ  ‚Ä¢ GPS se detiene completamente                                 ‚îÇ
‚îÇ  ‚Ä¢ No hay forma de continuar tracking                           ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  CON Background Location Entitlement (requiere Apple approval): ‚îÇ
‚îÇ  ‚Ä¢ Puede continuar tracking en background                       ‚îÇ
‚îÇ  ‚Ä¢ Requiere justificaci√≥n a Apple                               ‚îÇ
‚îÇ  ‚Ä¢ Badge azul en status bar                                     ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  RECOMENDACI√ìN PARA OnlyCar:                                 ‚îÇ
‚îÇ  ‚Üí NO usar background location (no es navigation app)           ‚îÇ
‚îÇ  ‚Üí Detectar cuando app reabre y ofrecer continuar               ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Android

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ANDROID BACKGROUND EXECUTION                                   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                 ‚îÇ
‚îÇ  Android 8+ (Oreo):                                             ‚îÇ
‚îÇ  ‚Ä¢ Location updates limitados en background                     ‚îÇ
‚îÇ  ‚Ä¢ Puede usar Foreground Service con notificaci√≥n               ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  Android 10+ (Q):                                               ‚îÇ
‚îÇ  ‚Ä¢ Requiere ACCESS_BACKGROUND_LOCATION expl√≠cito                ‚îÇ
‚îÇ  ‚Ä¢ Usuario debe aprobar manualmente                             ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  Android 12+ (S):                                               ‚îÇ
‚îÇ  ‚Ä¢ Restricciones a√∫n m√°s estrictas                              ‚îÇ
‚îÇ  ‚Ä¢ SO puede matar app en cualquier momento                      ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  RECOMENDACI√ìN PARA OnlyCar:                                 ‚îÇ
‚îÇ  ‚Üí Usar Foreground Service solo si es cr√≠tico                   ‚îÇ
‚îÇ  ‚Üí Preferir detecci√≥n al reabrir app                            ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## Estrategia: Recuperaci√≥n al Reabrir

```typescript
// composables/useAppRecovery.ts
import { App } from '@capacitor/app';

interface TrackingSession {
  servicioId: string;
  estado: 'en_camino' | 'llegado';
  startedAt: number;
  lastPosition: { lat: number; lng: number } | null;
  lastUpdateAt: number | null;
}

const SESSION_KEY = 'active_tracking_session';

export const useAppRecovery = () => {
  const pendingSession = ref<TrackingSession | null>(null);
  const showRecoveryDialog = ref(false);
  
  // Guardar sesi√≥n activa
  const saveSession = (session: TrackingSession) => {
    localStorage.setItem(SESSION_KEY, JSON.stringify(session));
  };
  
  // Limpiar sesi√≥n
  const clearSession = () => {
    localStorage.removeItem(SESSION_KEY);
    pendingSession.value = null;
  };
  
  // Verificar sesi√≥n pendiente al abrir app
  const checkPendingSession = async () => {
    const saved = localStorage.getItem(SESSION_KEY);
    if (!saved) return null;
    
    const session: TrackingSession = JSON.parse(saved);
    
    // Verificar si el servicio sigue activo en el backend
    const { data: servicio } = await useFetch(`/api/servicios/${session.servicioId}`);
    
    if (!servicio.value || servicio.value.estado !== 'en_camino') {
      // Servicio ya no est√° en camino, limpiar
      clearSession();
      return null;
    }
    
    // Hay sesi√≥n pendiente v√°lida
    pendingSession.value = session;
    showRecoveryDialog.value = true;
    return session;
  };
  
  // Continuar sesi√≥n
  const resumeSession = async () => {
    if (!pendingSession.value) return;
    
    showRecoveryDialog.value = false;
    
    // Re-iniciar tracking
    const { startTracking } = useGeolocation();
    await startTracking();
    
    // No limpiar sesi√≥n hasta que termine el servicio
  };
  
  // Descartar sesi√≥n
  const discardSession = async () => {
    showRecoveryDialog.value = false;
    clearSession();
  };
  
  // Escuchar cuando app vuelve a primer plano
  onMounted(() => {
    App.addListener('appStateChange', async ({ isActive }) => {
      if (isActive) {
        await checkPendingSession();
      }
    });
    
    // Tambi√©n verificar al montar
    checkPendingSession();
  });
  
  return {
    pendingSession: readonly(pendingSession),
    showRecoveryDialog,
    saveSession,
    clearSession,
    resumeSession,
    discardSession
  };
};
```

---

## Di√°logo de Recuperaci√≥n

```vue
<!-- components/TrackingRecoveryDialog.vue -->
<script setup lang="ts">
const { 
  pendingSession, 
  showRecoveryDialog, 
  resumeSession, 
  discardSession 
} = useAppRecovery();

const timeAgo = computed(() => {
  if (!pendingSession.value?.lastUpdateAt) return 'hace un momento';
  const diff = Date.now() - pendingSession.value.lastUpdateAt;
  const minutes = Math.floor(diff / 60000);
  if (minutes < 1) return 'hace menos de un minuto';
  if (minutes < 60) return `hace ${minutes} minutos`;
  const hours = Math.floor(minutes / 60);
  return `hace ${hours} hora${hours > 1 ? 's' : ''}`;
};
</script>

<template>
  <Modal 
    v-model="showRecoveryDialog"
    :closeable="false"
  >
    <template #header>
      üìç Servicio en progreso
    </template>
    
    <template #body>
      <div class="recovery-content">
        <p>
          Ten√≠as un servicio activo que se interrumpi√≥.
        </p>
        
        <div class="session-info">
          <div class="info-row">
            <span class="label">Estado:</span>
            <span class="value">En camino</span>
          </div>
          <div class="info-row">
            <span class="label">√öltima actualizaci√≥n:** 2026-01-01
            <span class="value">{{ timeAgo }}</span>
          </div>
        </div>
        
        <p class="question">
          ¬øDeseas continuar compartiendo tu ubicaci√≥n?
        </p>
      </div>
    </template>
    
    <template #footer>
      <button @click="resumeSession" class="btn-primary">
        ‚úÖ Continuar
      </button>
      <button @click="discardSession" class="btn-secondary">
        ‚ùå Ya llegu√© / Terminar
      </button>
    </template>
  </Modal>
</template>
```

---

## Notificaci√≥n Persistente (Android)

```typescript
// plugins/foreground-service.ts
// Solo para Android si se decide usar Foreground Service

import { LocalNotifications } from '@capacitor/local-notifications';

export const startForegroundService = async () => {
  // Crear notificaci√≥n persistente
  await LocalNotifications.schedule({
    notifications: [{
      id: 1,
      title: 'OnlyCar',
      body: 'Compartiendo ubicaci√≥n con el cliente',
      ongoing: true,
      autoCancel: false,
      smallIcon: 'ic_stat_location',
      channelId: 'tracking'
    }]
  });
};

export const stopForegroundService = async () => {
  await LocalNotifications.cancel({ notifications: [{ id: 1 }] });
};
```

---

## Flujo de Recuperaci√≥n

```mermaid
sequenceDiagram
    participant U as Usuario
    participant A as App
    participant S as Servidor
    
    Note over A: App cerrada por SO
    
    U->>A: Reabre app
    A->>A: Cargar sesi√≥n guardada
    A->>S: ¬øServicio sigue en_camino?
    
    alt Servicio activo
        S-->>A: S√≠, contin√∫a
        A->>U: Mostrar di√°logo recuperaci√≥n
        U->>A: "Continuar"
        A->>A: Reiniciar tracking
    else Servicio terminado
        S-->>A: No, ya termin√≥
        A->>A: Limpiar sesi√≥n
        A->>U: Mostrar dashboard normal
    end
```

---

‚Üí Ver m√∫ltiples dispositivos: [[Proyecto OnlyCarNLD/Datos/5.8.7.4 multiple_devices]]

---

## Navegaci√≥n

| ‚¨ÜÔ∏è Padre             | [[Proyecto OnlyCarNLD/Datos/5.8.7 edge_cases]]            |
| -------------------- | ---------------------- |
| ‚¨ÖÔ∏è Hermano anterior  | [[Proyecto OnlyCarNLD/Datos/5.8.7.2 network_offline]]              |
| ‚û°Ô∏è Hermano siguiente | [[Proyecto OnlyCarNLD/Datos/5.8.7.4 multiple_devices]]              |
