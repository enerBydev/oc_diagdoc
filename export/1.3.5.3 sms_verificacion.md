---
id: 1.3.5.3
title: SMS Verificación
parent: 1.3.5
breadcrumb: 0 → 1.0 → 1.3 → 1.3.5 → 1.3.5.3
type: feature
status: activo
last_updated: 2026-01-29 15:32
file_create: 2026-01-09 21:20
domain:
- comunicacion
- sms
- verificacion
- otp
summary: 'Canal SMS para verificación OTP de operadores y alertas críticas.

  Usa Twilio como proveedor con fallback a Vonage.

  '
content_hash: 1bc5524c216a4811
---

# 1.3.5.3 SMS Verificación

> **Propósito:** Proveer un canal de comunicación de última instancia para verificación de identidad (OTP) y alertas de emergencia.

---

## 1. Casos de Uso

| Caso | Criticidad | Ejemplo |
|------|------------|---------|
| **OTP Registro Operador** | Alta | "Tu código es 847291. Expira en 5 min." |
| **OTP Login sospechoso** | Alta | "Código de verificación: 573842" |
| **Alerta emergencia** | Crítica | "Tu servicio #1234 fue cancelado por el cliente" |
| **Recordatorio cita** | Media | "Mañana 10am tienes cita en Col. Centro" |

---

## 2. Proveedor: Twilio

### Justificación

| Criterio | Twilio | Vonage | Ventaja |
|----------|--------|--------|---------|
| **Cobertura México** | Excelente | Buena | Twilio |
| **Deliverability** | 95%+ | 90%+ | Twilio |
| **Precio** | $0.08/SMS | $0.05/SMS | Vonage |
| **API Quality** | Excelente | Buena | Twilio |
| **Sender ID** | Sí | Sí | Empate |

**Decisión:** Twilio como primario, Vonage como fallback.

---

## 3. Implementación

### 3.1 Configuración

```typescript
// server/utils/twilio.ts
import twilio from 'twilio';

const client = twilio(
  process.env.TWILIO_ACCOUNT_SID,
  process.env.TWILIO_AUTH_TOKEN
);

export { client as twilioClient };
```

### 3.2 Envío de OTP

```typescript
// server/api/sms/send-otp.post.ts
import { twilioClient } from '~/server/utils/twilio';

export default defineEventHandler(async (event) => {
  const { phone, purpose } = await readBody(event);
  
  // Generar código de 6 dígitos
  const code = Math.floor(100000 + Math.random() * 900000).toString();
  
  // Guardar en Redis con TTL de 5 minutos
  const redis = useRedis();
  await redis.setex(`otp:${phone}`, 300, code);
  
  // Enviar SMS
  const message = await twilioClient.messages.create({
    body: `Tu código OnlyCar es ${code}. Expira en 5 minutos.`,
    from: process.env.TWILIO_PHONE_NUMBER,
    to: phone
  });
  
  return { 
    success: true, 
    messageId: message.sid,
    expiresIn: 300 
  };
});
```

---

## 4. Rate Limiting y Costos

### Límites

| Límite | Valor | Justificación |
|--------|-------|---------------|
| Por teléfono/hora | 3 SMS | Evitar abuso |
| Por teléfono/día | 10 SMS | Evitar spam |
| Por IP/hora | 5 SMS | Prevenir bots |

### Costos Estimados

| Escenario | SMS/mes | Costo |
|-----------|---------|-------|
| **MVP (50 op)** | 200 | ~$16 USD |
| **Crecimiento (200 op)** | 800 | ~$64 USD |
| **Escala (1000 op)** | 4000 | ~$320 USD |

---

## 5. Formato de Mensajes

```text
# OTP Registro
[OnlyCar] Tu código de verificación es {CODE}. NO lo compartas con nadie.

# OTP Login
[OnlyCar] Código: {CODE}. Si no solicitaste esto, ignora este mensaje.

# Alerta Emergencia
[OnlyCar] URGENTE: El servicio #{ID} fue cancelado. Revisa la app.

# Recordatorio
[OnlyCar] Mañana {FECHA} a las {HORA} tienes cita en {DIRECCION}. ¡No faltes!
```

---

## 6. Fallback a Vonage

Si Twilio falla (timeout > 5s o error 5xx), intentar con Vonage:

```typescript
// server/utils/sms.ts
import { twilioClient } from './twilio';
import { vonageClient } from './vonage';

export async function sendSMS(to: string, message: string) {
  try {
    return await twilioClient.messages.create({
      body: message,
      from: process.env.TWILIO_PHONE_NUMBER,
      to
    });
  } catch (error) {
    console.warn('Twilio failed, trying Vonage:', error);
    
    return await vonageClient.sms.send({
      to,
      from: 'OnlyCar',
      text: message
    });
  }
}
```

---

## Navegación

| Elemento | Enlace |
|----------|--------|
| ⬆️ Padre | [[Proyecto OnlyCarNLD/Datos/1.3.5 notificaciones]] |
| ⬅️ Anterior | [[Proyecto OnlyCarNLD/Datos/1.3.5.2 email_transaccional]] |
