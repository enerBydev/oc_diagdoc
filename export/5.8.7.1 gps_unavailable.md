---
id: 5.8.7.1
title: GPS Unavailable
parent: 5.8.7
breadcrumb: 0 ‚Üí 5.0 ‚Üí 5.8 ‚Üí 5.8.7 ‚Üí 5.8.7.1
type: edge_case
status: activo
last_updated: 2026-01-29 15:32
file_create: 2026-01-01 18:10
domain:
- gps
- unavailable
- error
summary: Manejo cuando GPS no disponible.
content_hash: 713873dc1a747f14
---

# 5.8.7.1 GPS Unavailable

Manejo cuando el GPS no est√° disponible o tiene problemas.

---

## Escenarios

| Escenario | Causa | Frecuencia |
|-----------|-------|------------|
| **Sin se√±al** | Interior, t√∫nel, edificio | Alta |
| **Baja precisi√≥n** | Cielo nublado, interferencia | Media |
| **Timeout** | Hardware lento | Baja |
| **Sensor apagado** | Usuario desactiv√≥ GPS | Media |
| **Sin permiso** | Usuario deneg√≥ | Baja |

---

## Detecci√≥n

```typescript
// composables/useGpsAvailability.ts
import { Geolocation } from '@capacitor/geolocation';

interface GpsStatus {
  available: boolean;
  enabled: boolean;
  permissionGranted: boolean;
  lastError: string | null;
}

export const useGpsAvailability = () => {
  const status = reactive<GpsStatus>({
    available: true,
    enabled: true,
    permissionGranted: true,
    lastError: null
  });
  
  const checkAvailability = async (): Promise<GpsStatus> => {
    try {
      // Verificar permisos
      const permissions = await Geolocation.checkPermissions();
      status.permissionGranted = permissions.location === 'granted';
      
      if (!status.permissionGranted) {
        status.lastError = 'Permiso no otorgado';
        return status;
      }
      
      // Intentar obtener posici√≥n con timeout corto
      const pos = await Geolocation.getCurrentPosition({
        timeout: 5000,
        enableHighAccuracy: false
      });
      
      status.available = true;
      status.enabled = true;
      status.lastError = null;
      
    } catch (error: any) {
      status.available = false;
      
      if (error.code === 1) {
        status.permissionGranted = false;
        status.lastError = 'Permiso denegado';
      } else if (error.code === 2) {
        status.enabled = false;
        status.lastError = 'GPS deshabilitado';
      } else if (error.code === 3) {
        status.lastError = 'Timeout - Sin se√±al GPS';
      } else {
        status.lastError = error.message;
      }
    }
    
    return status;
  };
  
  return {
    status: readonly(status),
    checkAvailability
  };
};
```

---

## Estrategia de Fallback

```mermaid
flowchart TD
    A[Solicitar GPS] --> B{¬ø√âxito?}
    B -->|S√≠| C[Usar posici√≥n]
    B -->|No| D{¬øTipo error?}
    
    D -->|Permission| E[Mostrar di√°logo permiso]
    D -->|Disabled| F[Pedir activar GPS]
    D -->|Timeout| G[Reintentar con baja precisi√≥n]
    D -->|Unavailable| H[Usar √∫ltima conocida]
    
    G --> I{¬ø√âxito retry?}
    I -->|S√≠| C
    I -->|No| H
    
    H --> J[Mostrar advertencia]
    J --> K[Ofrecer confirmaci√≥n manual]
```

---

## Implementaci√≥n Fallback

```typescript
// composables/useGpsFallback.ts
export const useGpsFallback = () => {
  const { state, updatePosition, setError } = useGeoState();
  const { getCurrentPosition } = useGeolocation();
  
  const MAX_RETRIES = 3;
  const FALLBACK_OPTIONS = [
    { enableHighAccuracy: true, timeout: 10000 },   // Intento 1: Alta precisi√≥n
    { enableHighAccuracy: false, timeout: 15000 },  // Intento 2: Baja precisi√≥n
    { enableHighAccuracy: false, timeout: 20000, maximumAge: 60000 } // Intento 3: Permitir cache
  ];
  
  const getPositionWithFallback = async () => {
    for (let i = 0; i < MAX_RETRIES; i++) {
      try {
        const pos = await getCurrentPosition(FALLBACK_OPTIONS[i]);
        return pos;
      } catch (error) {
        console.warn(`GPS intento ${i + 1} fall√≥:`, error);
        
        if (i === MAX_RETRIES - 1) {
          // √öltimo intento: usar √∫ltima conocida
          if (state.value.lastKnownPosition) {
            setError('error_gps', 'Usando √∫ltima ubicaci√≥n conocida');
            return {
              ...state.value.lastKnownPosition,
              isStale: true,
              staleTime: state.value.lastUpdateTime
            };
          }
          throw error;
        }
      }
    }
  };
  
  return { getPositionWithFallback };
};
```

---

## UI de Error GPS

```vue
<!-- components/GpsErrorBanner.vue -->
<script setup lang="ts">
const props = defineProps<{
  errorType: 'permission' | 'disabled' | 'unavailable' | 'timeout';
}>();

const emit = defineEmits<{
  (e: 'retry'): void;
  (e: 'openSettings'): void;
  (e: 'manualConfirm'): void;
}>();

const config = computed(() => ({
  permission: {
    icon: 'üîí',
    title: 'Permiso de ubicaci√≥n requerido',
    description: 'Necesitamos acceso a tu GPS para compartir tu ubicaci√≥n con el cliente.',
    action: 'Dar permiso',
    actionType: 'openSettings' as const
  },
  disabled: {
    icon: 'üìç',
    title: 'GPS desactivado',
    description: 'Activa el GPS de tu dispositivo para continuar.',
    action: 'Abrir configuraci√≥n',
    actionType: 'openSettings' as const
  },
  unavailable: {
    icon: 'üì°',
    title: 'Sin se√±al GPS',
    description: 'No podemos obtener tu ubicaci√≥n. ¬øEst√°s en un √°rea cubierta?',
    action: 'Reintentar',
    actionType: 'retry' as const
  },
  timeout: {
    icon: '‚è±Ô∏è',
    title: 'GPS tardando demasiado',
    description: 'El GPS est√° tardando en responder. Intenta moverte a un √°rea abierta.',
    action: 'Reintentar',
    actionType: 'retry' as const
  }
}[props.errorType]));

const handleAction = () => {
  emit(config.value.actionType);
};
</script>

<template>
  <div class="gps-error-banner">
    <div class="icon">{{ config.icon }}</div>
    <div class="content">
      <h4>{{ config.title }}</h4>
      <p>{{ config.description }}</p>
    </div>
    <div class="actions">
      <button @click="handleAction" class="btn-primary">
        {{ config.action }}
      </button>
      <button @click="emit('manualConfirm')" class="btn-secondary">
        Confirmar llegada manualmente
      </button>
    </div>
  </div>
</template>
```

---

## Indicador de Precisi√≥n

```vue
<!-- Mostrar cuando precisi√≥n es baja -->
<template>
  <div v-if="accuracy > 50" class="low-accuracy-warning">
    ‚ö†Ô∏è Precisi√≥n baja (¬±{{ Math.round(accuracy) }}m)
  </div>
</template>
```

---

## Persistencia de √öltima Ubicaci√≥n

```typescript
// Guardar en localStorage para recuperaci√≥n
const saveLastKnownPosition = (pos: { lat: number; lng: number }) => {
  localStorage.setItem('lastKnownPosition', JSON.stringify({
    ...pos,
    savedAt: Date.now()
  }));
};

const getLastKnownPosition = () => {
  const saved = localStorage.getItem('lastKnownPosition');
  if (!saved) return null;
  
  const data = JSON.parse(saved);
  
  // Invalidar si es muy viejo (> 24 horas)
  if (Date.now() - data.savedAt > 24 * 60 * 60 * 1000) {
    localStorage.removeItem('lastKnownPosition');
    return null;
  }
  
  return data;
};
```

---

‚Üí Ver network offline: [[Proyecto OnlyCarNLD/Datos/5.8.7.2 network_offline]]

---

## Navegaci√≥n

| ‚¨ÜÔ∏è Padre             | [[Proyecto OnlyCarNLD/Datos/5.8.7 edge_cases]]            |
| -------------------- | ---------------------- |
| ‚û°Ô∏è Hermano siguiente | [[Proyecto OnlyCarNLD/Datos/5.8.7.2 network_offline]]              |
