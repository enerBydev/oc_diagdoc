---
id: 4.7.8
title: ADR-008 Storage
parent: '4.7'
breadcrumb: 0 ‚Üí 4.0 ‚Üí 4.7 ‚Üí 4.7.8
type: hoja
status: aceptado
adr_date: 2025-12-18
participants:
- enerBydev
- Backend Team
last_updated: 2026-01-29 16:05
file_create: 2026-01-05 19:57
domain:
- adr
- storage
- r2
- s3
actors:
- desarrollador
- devops
summary: ADR-008 Decisi√≥n de almacenamiento con Cloudflare R2.
content_hash: a38dde1be576e9a8
---

# 4.7.8 ADR-008 Storage

> Architecture Decision Record: Almacenamiento de Archivos

---

## Estado

**üü¢ ACEPTADO** ‚Äî 18 Diciembre 2025

---

## Contexto

El sistema necesita almacenar:
- Fotos antes/despu√©s de servicios (~50-200 KB c/u, WebP)
- Documentos de operadores (INE, licencia)
- CFDIs (PDFs de facturas)
- Avatars de usuarios
- Assets est√°ticos

Volumen estimado: 500 GB en primer a√±o, creciendo 100 GB/mes.

---

## Opciones Consideradas

| Opci√≥n | Costo/GB | Egress | Pros | Contras |
|--------|----------|--------|------|---------|
| **Cloudflare R2** | $0.015 | **$0** | Sin egress, S3 compatible | Nuevo, menos features |
| **AWS S3** | $0.023 | $0.09/GB | Maduro, muchas integraciones | Egress costoso |
| **Supabase Storage** | Incluido | L√≠mites tier | Integrado con auth | RLS complejo, l√≠mites |
| **Backblaze B2** | $0.005 | $0.01 | Barato | Menos integraciones |

---

## Decisi√≥n

**Cloudflare R2**

### Justificaci√≥n

1. **Egress GRATIS** ‚Äî Cr√≠tico para fotos p√∫blicas de servicios
2. **S3 compatible** ‚Äî Migraci√≥n f√°cil si necesario
3. **Integraci√≥n Workers** ‚Äî Procesamiento en edge
4. **Mismo vendor** que hosting ‚Üí simpleza operativa

---

## Consecuencias

### Positivas

- ‚úÖ $0 en transferencia de datos
- ‚úÖ API S3 compatible
- ‚úÖ Workers para resize/optimizaci√≥n
- ‚úÖ Un solo dashboard Cloudflare

### Negativas

- ‚ö†Ô∏è Menos herramientas que S3
- ‚ö†Ô∏è Sin lifecycle policies avanzadas
- ‚ö†Ô∏è L√≠mite 10 buckets en free tier

---

## Implementaci√≥n

```typescript
// server/utils/storage.ts
import { S3Client, PutObjectCommand } from '@aws-sdk/client-s3';

const r2 = new S3Client({
  region: 'auto',
  endpoint: `https://${process.env.CF_ACCOUNT_ID}.r2.cloudflarestorage.com`,
  credentials: {
    accessKeyId: process.env.R2_ACCESS_KEY!,
    secretAccessKey: process.env.R2_SECRET_KEY!,
  },
});

export async function uploadToR2(key: string, body: Buffer) {
  await r2.send(new PutObjectCommand({
    Bucket: 'onlycar-media',
    Key: key,
    Body: body,
  }));
  return `https://media.onlycar.mx/${key}`;
}
```

---

## Navegaci√≥n

| ‚¨ÜÔ∏è Padre | [[Proyecto OnlyCarNLD/Datos/4.7 Decisiones_Arquitectura]] |
|----------|---------------------------------|
| ‚¨ÖÔ∏è Anterior | [[Proyecto OnlyCarNLD/Datos/4.7.7 ADR_007_CICD]] |
| ‚û°Ô∏è Siguiente | [[Proyecto OnlyCarNLD/Datos/4.7.9 ADR_009_Caching]] |

---
