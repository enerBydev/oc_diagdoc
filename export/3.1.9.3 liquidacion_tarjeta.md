---
id: 3.1.9.3
title: Liquidaci√≥n por Tarjeta
parent: 3.1.9
breadcrumb: 0 ‚Üí 3.0 ‚Üí 3.1 ‚Üí 3.1.9 ‚Üí 3.1.9.3
type: modulo_padre
children_count: 0
descendants_count: 0
status: activo
last_updated: 2026-01-29 15:32
file_create: 2025-12-28 15:40
domain:
- liquidacion
- tarjeta
- point
actors:
- operador
summary: 'Sistema para liquidar cobros con tarjeta f√≠sica.

  Operador usa su terminal MercadoPago Point.'
content_hash: 0404c2ff39b6cef0
---

# 3.1.9.3 Liquidaci√≥n por Tarjeta

Sistema para que el operador liquide cobros recibidos con tarjeta f√≠sica.

---

## Contexto

> [!IMPORTANT]
> El operador usa **SU PROPIO** terminal MercadoPago Point.
> OnlyCar NO procesa esos cobros directamente.
> El operador debe **liquidar** lo cobrado a OnlyCar v√≠a MercadoPago.

---

## Problema a Resolver

```
Cliente paga con tarjeta ‚Üí Terminal MercadoPago del OPERADOR
                                    ‚îÇ
                                    ‚ñº
                        Dinero en cuenta MP del operador
                                    ‚îÇ
                                    ‚ñº
                        ¬øC√≥mo llega a OnlyCar?
```

---

## Soluci√≥n: MercadoPago Checkout

```
1. Operador cobra con su terminal Point
        ‚îÇ
        ‚ñº
2. Sistema OnlyCar registra el cobro
   (operador confirma monto en app)
        ‚îÇ
        ‚ñº
3. Antes del corte (21:30), operador tiene saldo pendiente
        ‚îÇ
        ‚ñº
4. Operador presiona "Liquidar con MercadoPago"
        ‚îÇ
        ‚ñº
5. Sistema genera link de pago (Checkout Pro)
        ‚îÇ
        ‚ñº
6. Operador paga desde su cuenta MP (saldo, tarjeta, SPEI)
        ‚îÇ
        ‚ñº
7. Webhook confirma ‚Üí Caja liquidada ‚úÖ
```

```mermaid
sequenceDiagram
    participant O as üë∑ Operador
    participant A as üì± App OnlyCar
    participant MP as üí≥ MercadoPago
    
    O->>A: 1. Cobra con terminal Point
    A->>A: 2. Registra cobro
    O->>A: 3. Presiona "Liquidar"
    A->>MP: 4. Genera link checkout
    MP-->>O: 5. Redirige a checkout
    O->>MP: 6. Paga (saldo/tarjeta/SPEI)
    MP-->>A: 7. Webhook confirma
    A-->>O: ‚úÖ Caja liquidada
```

---


## ‚è∞ Horario de Liquidaci√≥n

> [!CAUTION]
> **Corte de caja diario: 21:30**
> 
> Liquidar ANTES de las 21:30 para caja limpia del d√≠a.
> Saldo no liquidado se acumula para el viernes.

---

## UI: Liquidar Cobros Tarjeta

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  üí≥ LIQUIDAR COBROS CON TARJETA                                 ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                 ‚îÇ
‚îÇ  Tienes $850 pendientes de cobros con tarjeta Point             ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ DETALLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  #1 Lavado Premium     ‚îÇ $350  ‚îÇ Point MP                       ‚îÇ
‚îÇ  #2 Limpieza Interior  ‚îÇ $500  ‚îÇ Point MP                       ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  Total a liquidar: $850 MXN                                     ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ M√âTODO RECOMENDADO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  [ üì± Liquidar con MercadoPago ]                                ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  üí° Usa tu saldo de MercadoPago para liquidar                   ‚îÇ
‚îÇ     instant√°neamente sin comisiones extras.                     ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  ‚è∞ Tienes hasta las 21:30 para liquidar                        ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## Implementaci√≥n

```typescript
// server/api/caja/liquidar-tarjeta.post.ts
import { MercadoPagoConfig, Preference } from 'mercadopago';

const client = new MercadoPagoConfig({ 
  accessToken: process.env.MERCADOPAGO_ACCESS_TOKEN! 
});

export default defineEventHandler(async (event) => {
  const { operadorId, monto, cajaId } = await readBody(event);
  
  const preference = new Preference(client);
  
  const result = await preference.create({
    body: {
      items: [{
        id: `liquidacion-tarjeta-${cajaId}`,
        title: 'Liquidaci√≥n cobros tarjeta OnlyCar',
        quantity: 1,
        unit_price: monto,
        currency_id: 'MXN'
      }],
      external_reference: JSON.stringify({
        type: 'liquidacion_tarjeta',
        operador_id: operadorId,
        caja_id: cajaId,
        monto: monto
      }),
      notification_url: `${process.env.APP_URL}/api/webhooks/mercadopago`,
      auto_return: 'approved'
    }
  });
  
  return { checkout_url: result.init_point };
});
```

---

## Modelo de Datos

```sql
CREATE TABLE liquidaciones_tarjeta (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  operador_id UUID NOT NULL REFERENCES operadores(id),
  caja_id UUID NOT NULL REFERENCES cajas_diarias(id),
  
  monto DECIMAL(10,2) NOT NULL,
  metodo VARCHAR(20) DEFAULT 'mercadopago',
  
  -- MercadoPago
  preference_id VARCHAR(50),
  payment_id VARCHAR(50),
  
  -- Estado
  estado VARCHAR(20) DEFAULT 'pendiente',
  -- pendiente, procesando, completado, fallido
  
  completado_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT now()
);
```

---

## Integraci√≥n con MercadoPago

‚Üí Ver Point Terminal: [[Proyecto OnlyCarNLD/Datos/5.11.1 point_terminal]]
‚Üí Ver Checkout: [[Proyecto OnlyCarNLD/Datos/5.11.2 checkout_liquidacion]]
‚Üí Ver Webhooks: [[Proyecto OnlyCarNLD/Datos/5.11.3 webhooks_mercadopago]]

---

## Navegaci√≥n

| ‚¨ÜÔ∏è Padre             | [[Proyecto OnlyCarNLD/Datos/3.1.9 control_caja]]           |
| -------------------- | -------------------------------- |
| ‚¨ÖÔ∏è Hermano anterior  | [[Proyecto OnlyCarNLD/Datos/3.1.9.2 depositos_efectivo]]   |
| ‚û°Ô∏è Hermano siguiente | [[Proyecto OnlyCarNLD/Datos/3.1.9.4 penalizaciones_caja]]  |

---
