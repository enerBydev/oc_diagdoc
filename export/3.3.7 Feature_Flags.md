---
id: 3.3.7
title: Feature Flags
parent: '3.3'
breadcrumb: 0 → 3.0 → 3.3 → 3.3.7
type: hoja
status: activo
last_updated: 2026-01-29 15:32
file_create: 2026-01-05 12:40
domain:
- negocio
- features
- config
actors:
- admin
summary: Activación/desactivación dinámica de funcionalidades.
content_hash: c383b71aaf57005f
---

# 3.3.7 Feature Flags

> Control dinámico de funcionalidades sin deploy.

---

## 1. Flags Actuales

| Flag | Descripción | Estado | Rollout |
|------|-------------|--------|---------|
| `CHAT_ENABLED` | Chat cliente-operador | ✅ ON | 100% |
| `B2B_ENABLED` | Módulo B2B | ✅ ON | 100% |
| `PAGOS_MERCADOPAGO` | MercadoPago como opción | ⚠️ Beta | 30% |
| `FACTURACION_AUTO` | Facturación automática | ❌ OFF | 0% |

---

## 2. Modelo SQL

```sql
CREATE TABLE IF NOT EXISTS feature_flags (
  key VARCHAR(50) PRIMARY KEY,
  description TEXT,
  enabled BOOLEAN DEFAULT FALSE,
  rollout_percentage INTEGER DEFAULT 100 
    CHECK (rollout_percentage BETWEEN 0 AND 100),
  target_roles TEXT[], -- ['admin', 'operador', 'cliente']
  
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- RLS: Solo admin puede modificar
ALTER TABLE feature_flags ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Feature flags: lectura pública"
  ON feature_flags FOR SELECT
  USING (true);

CREATE POLICY "Feature flags: escritura admin"
  ON feature_flags FOR ALL
  USING (auth.user_role() = 'admin');

-- Datos iniciales
INSERT INTO feature_flags (key, description, enabled, rollout_percentage, target_roles) VALUES
  ('CHAT_ENABLED', 'Chat cliente-operador', true, 100, ARRAY['cliente', 'operador']),
  ('B2B_ENABLED', 'Módulo B2B completo', true, 100, ARRAY['admin', 'empresa']),
  ('PAGOS_MERCADOPAGO', 'MercadoPago como opción', true, 30, ARRAY['cliente']),
  ('FACTURACION_AUTO', 'Facturación automática', false, 0, ARRAY['admin']);
```

---

## 3. Composable de Consulta

```typescript
// composables/useFeatureFlags.ts
export const useFeatureFlags = () => {
  const supabase = useSupabaseClient();
  const user = useSupabaseUser();
  
  const isEnabled = async (flagKey: string): Promise<boolean> => {
    const { data } = await supabase
      .from('feature_flags')
      .select('enabled, rollout_percentage, target_roles')
      .eq('key', flagKey)
      .single();
    
    if (!data || !data.enabled) return false;
    
    // Check rollout percentage (gradual release)
    if (data.rollout_percentage < 100) {
      const userId = user.value?.id || 'anonymous';
      const hash = hashString(userId) % 100;
      if (hash >= data.rollout_percentage) return false;
    }
    
    // Check role permission
    const userRole = user.value?.user_metadata?.role || 'cliente';
    if (!data.target_roles.includes(userRole)) return false;
    
    return true;
  };
  
  return { isEnabled };
};

// Uso en componentes
const { isEnabled } = useFeatureFlags();
if (await isEnabled('PAGOS_MERCADOPAGO')) {
  // Mostrar opción MercadoPago
}
```

---

## Navegación

| ⬆️ Padre | [[Proyecto OnlyCarNLD/Datos/3.3. reglas_negocio]] |
|----------|-------------------------|
| ⬅️ Anterior | [[Proyecto OnlyCarNLD/Datos/3.3.6 Radio_Servicio]] |

---

