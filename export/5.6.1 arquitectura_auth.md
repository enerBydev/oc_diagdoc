---
id: 5.6.1
title: Arquitectura de Autenticación
parent: '5.6'
breadcrumb: 0 → 5.0 → 5.6 → 5.6.1
type: arquitectura
status: activo
last_updated: 2026-01-29 15:31
file_create: 2025-12-23 14:24
domain:
- auth
- api
- sql
summary: 'Diagrama técnico del sistema dual de autenticación.

  Componentes, flujos OAuth, flujos Email/Password, modelo de datos.'
content_hash: fae4140fea98c41f
---

# 5.6.1 Arquitectura de Autenticación

Diagrama técnico del sistema dual de autenticación.

---

## Componentes del Sistema

```
┌─────────────────────────────────────────────────────────────────┐
│                         CLIENTE                                 │
│              (PWA / App Móvil / Escritorio)                     │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            ▼
┌────────────────────────────────────────────────────────────────┐
│                      NUXT 4 / NITRO                            │
│                    (Frontend + API)                            │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  ┌───────────────────┐  ┌───────────────────────────────────┐  │
│  │  /api/auth/oauth  │  │  /api/auth/credentials            │  │
│  │                   │  │                                   │  │
│  │  • Azure callback │  │  • POST /login                    │  │
│  │  • Google callbck │  │  • POST /register                 │  │
│  │  • Token exchange │  │  • POST /reset-password           │  │
│  └─────────┬─────────┘  │  • POST /verify-email             │  │
│            │            │  • POST /verify-mfa               │  │
│            │            └─────────────┬─────────────────────┘  │
│            │                          │                        │
│            └──────────┬───────────────┘                        │
│                       │                                        │
│                       ▼                                        │
│           ┌───────────────────────┐                            │
│           │  /api/auth/session    │                            │
│           │                       │                            │
│           │  • Generar JWT        │                            │
│           │  • Refresh token      │                            │
│           │  • Logout             │                            │
│           │  • Detectar tipo      │                            │
│           └───────────┬───────────┘                            │
│                       │                                        │
└───────────────────────┼────────────────────────────────────────┘
                        │
           ┌────────────┴────────────┐
           ▼                         ▼
┌─────────────────────┐   ┌─────────────────────┐
│   SUPABASE / D1     │   │   PROVEEDORES       │
│   (Base de Datos)   │   │   EXTERNOS          │
├─────────────────────┤   ├─────────────────────┤
│ • users             │   │ • Azure AD          │
│ • auth_sessions     │   │ • Google OAuth      │
│ • empresas_b2b      │   │                     │
│ • password_hashes   │   │                     │
└─────────────────────┘   └─────────────────────┘
```

---

## Flujo OAuth (Azure / Google)

```
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│  USUARIO │     │   APP    │     │ PROVEEDOR│     │   API    │
└────┬─────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘
     │                │                │                │
     │ Clic "Azure"   │                │                │
     │───────────────>│                │                │
     │                │                │                │
     │                │ Redirect OAuth │                │
     │                │───────────────>│                │
     │                │                │                │
     │   Login Azure (externo)         │                │
     │<───────────────────────────────>│                │
     │                │                │                │
     │                │ Code + Token   │                │
     │                │<───────────────│                │
     │                │                │                │
     │                │ Validar + crear sesión          │
     │                │────────────────────────────────>│
     │                │                │                │
     │                │           JWT + Refresh         │
     │                │<────────────────────────────────│
     │                │                │                │
     │   Dashboard    │                │                │
     │<───────────────│                │                │
```

---

## Flujo Email/Password

```
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│  USUARIO │     │   APP    │     │   API    │     │    BD    │
└────┬─────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘
     │                │                │                │
     │ Ingresa email  │                │                │
     │ + password     │                │                │
     │───────────────>│                │                │
     │                │                │                │
     │                │ POST /login    │                │
     │                │───────────────>│                │
     │                │                │                │
     │                │                │ Verificar hash │
     │                │                │───────────────>│
     │                │                │                │
     │                │                │    Match?      │
     │                │                │<───────────────│
     │                │                │                │
     │                │      ¿MFA?     │                │
     │                │<───────────────│                │
     │                │                │                │
     │ (Si MFA) Código TOTP            │                │
     │───────────────>│                │                │
     │                │ Verificar MFA  │                │
     │                │───────────────>│                │
     │                │                │                │
     │                │  JWT + Refresh │                │
     │                │<───────────────│                │
     │                │                │                │
     │   Dashboard    │                │                │
     │<───────────────│                │                │
```

---

## Modelo de Datos

```sql
-- Tabla de usuarios (todos los métodos)
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email TEXT UNIQUE NOT NULL,
  email_verified BOOLEAN DEFAULT false,
  auth_method TEXT NOT NULL, -- 'oauth_azure', 'oauth_google', 'email_password'
  oauth_provider_id TEXT,    -- ID del proveedor OAuth si aplica
  password_hash TEXT,        -- Solo para email_password (Argon2id)
  mfa_enabled BOOLEAN DEFAULT false,
  mfa_secret TEXT,           -- TOTP secret encriptado
  tipo_usuario TEXT,         -- 'b2c_puro', 'corporate_plus', 'b2b_admin', etc
  dominio_email TEXT,        -- Extraído del email para detección
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

-- Sesiones activas
CREATE TABLE auth_sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  refresh_token TEXT UNIQUE NOT NULL,
  device_info JSONB,
  ip_address INET,
  expires_at TIMESTAMPTZ NOT NULL,
  created_at TIMESTAMPTZ DEFAULT now(),
  revoked_at TIMESTAMPTZ
);

-- Rate limiting
CREATE TABLE auth_attempts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email TEXT NOT NULL,
  ip_address INET NOT NULL,
  success BOOLEAN NOT NULL,
  attempted_at TIMESTAMPTZ DEFAULT now()
);

-- Índices para rate limiting
CREATE INDEX idx_auth_attempts_email ON auth_attempts(email, attempted_at);
CREATE INDEX idx_auth_attempts_ip ON auth_attempts(ip_address, attempted_at);
```

---

## Endpoints API

| Método | Endpoint | Descripción |
|--------|----------|-------------|
| GET | `/api/auth/oauth/azure` | Iniciar flujo Azure |
| GET | `/api/auth/oauth/google` | Iniciar flujo Google |
| GET | `/api/auth/oauth/callback` | Callback unificado |
| POST | `/api/auth/register` | Registro email/password |
| POST | `/api/auth/login` | Login email/password |
| POST | `/api/auth/verify-email` | Verificar email |
| POST | `/api/auth/reset-password` | Solicitar reset |
| POST | `/api/auth/reset-password/confirm` | Confirmar reset |
| POST | `/api/auth/mfa/setup` | Configurar MFA |
| POST | `/api/auth/mfa/verify` | Verificar código MFA |
| POST | `/api/auth/refresh` | Renovar JWT |
| POST | `/api/auth/logout` | Cerrar sesión |
| GET | `/api/auth/me` | Usuario actual |

---

## Navegación

| ⬆️ Padre            | [[Proyecto OnlyCarNLD/Datos/5.6. autenticacion]]              |
| ------------------- | ----------------------------------- |
| ➡️ Hermano siguiente | [[Proyecto OnlyCarNLD/Datos/5.6.2 oauth_proveedores]]         |

---
