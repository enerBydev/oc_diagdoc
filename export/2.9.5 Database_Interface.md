---
id: 2.9.5
title: Database Interface
parent: '2.9'
breadcrumb: 0 → 2.0 → 2.9 → 2.9.5
type: arquitectura
status: activo
domain:
- backend
- database
- supabase
- postgresql
summary: 'Patrones de comunicación con PostgreSQL (Supabase): Clientes (Admin vs Auth),
  Pooling con Supavisor y Tipado automático.'
last_updated: 2026-01-29 15:32
content_hash: a2a472424a176f58
---

# 2.9.5 Database Interface

> Estrategia de acceso a datos segura y escalable.

---

## Clientes de Supabase

En el backend (Nitro), manejamos dos tipos de instanciación del cliente:

### 1. Authenticated Client (Contexto Usuario)
Pasa el JWT del usuario al constructor. Respeta las políticas RLS (`auth.uid()`) de la base de datos.
*Uso: 90% de los endpoints públicos.*

```typescript
const client = useSupabaseClient(event);
// Este query solo retornará los datos que el usuario tiene permiso de ver
const { data } = await client.from('pedidos').select('*');
```

### 2. Service Role Client (Contexto Admin/System)
Usa el `SERVICE_ROLE_KEY`. **Ignora RLS**. Tiene poder absoluto de lectura/escritura.
*Uso: Webhooks, Jobs en segundo plano, creación de usuarios, tareas administrativas.*
**⚠️ PELIGRO: Nunca exponer este cliente al frontend.**

---

## Connection Pooling (Supavisor)
En entorno Serverless (Cloudflare Workers/Vercel), las conexiones directas a Postgres se agotan rápido porque cada lambda abre una nueva.
**Solución**: Usar siempre la URL del Pooler (puerto 6543) en modo transacción o sesión.

---

## Tipado End-to-End
Utilizamos `supabase gen types` para introspectar el esquema SQL y generar un archivo `database.types.ts`.
Esto garantiza que si la columna `precio` es numérica en DB, Typescript nos gritará si intentamos tratarla como string.

---

## Migraciones
El esquema no se edita en el Dashboard UI de Supabase en producción.
Flujo:
1.  Local: `supabase migration new create_table_x`
2.  Edit SQL file.
3.  Local: `supabase db reset` (test).
4.  Git push.
5.  CI/CD o `supabase db push` aplica cambios a remoto.

---

## Navegación

| ⬆️ Padre             | [[Proyecto OnlyCarNLD/Datos/2.9. Arquitectura_Backend]]       |
| -------------------- | ----------------------------------- |
| ⬅️ Hermano anterior  | [[Proyecto OnlyCarNLD/Datos/2.9.4 Edge_Functions]]            |
| ➡️ Hermano siguiente | [[Proyecto OnlyCarNLD/Datos/2.9.6 WebSocket_Architecture]]  |

---
