---
id: 5.8.6.5.10
title: Backup Recuperación
parent: 5.8.6.5
breadcrumb: 0 → 5.0 → 5.8 → 5.8.6 → 5.8.6.5 → 5.8.6.5.10
type: infraestructura
status: activo
last_updated: 2026-01-29 16:05
file_create: 2026-01-01 18:10
domain:
- backup
- recuperacion
- disaster
summary: Backup y recuperación de datos.
content_hash: cedb4662f9e62693
---

# 5.8.6.5.10 Backup y Recuperación

Estrategias de respaldo y recuperación de datos GPS.

---

## Estrategia de Backup

```
┌─────────────────────────────────────────────────────────────────┐
│  ESTRATEGIA DE BACKUP GPS                                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  NIVEL 1: Supabase Automático                                   │
│  ────────────────────────────────────────────────────────────   │
│  • Backup automático diario (Free tier)                         │
│  • Retención: 7 días                                            │
│  • Point-in-Time Recovery: Solo en Pro+                         │
│                                                                 │
│  NIVEL 2: Export Programático                                   │
│  ────────────────────────────────────────────────────────────   │
│  • Export semanal a Cloudflare R2                               │
│  • Formato: CSV comprimido                                      │
│  • Retención: 90 días                                           │
│                                                                 │
│  NIVEL 3: Tabla de Archivo                                      │
│  ────────────────────────────────────────────────────────────   │
│  • Datos de llegada archivados                                  │
│  • Retención: 3 años                                            │
│  • Propósito: Auditoría fiscal                                  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## Export Automático a R2

### Función de Export

```sql
-- Función para exportar ubicaciones de la semana
CREATE OR REPLACE FUNCTION exportar_ubicaciones_semana()
RETURNS TEXT AS $$
DECLARE
  v_filename TEXT;
  v_data JSON;
BEGIN
  v_filename := 'ubicaciones_' || TO_CHAR(NOW(), 'YYYY_WW') || '.json';
  
  SELECT json_agg(row_to_json(u))
  INTO v_data
  FROM ubicaciones_servicio u
  WHERE u.created_at >= NOW() - INTERVAL '7 days';
  
  -- El upload a R2 se hace desde Edge Function
  RETURN v_filename;
END;
$$ LANGUAGE plpgsql;
```

### Edge Function para Upload

```typescript
// supabase/functions/backup-ubicaciones/index.ts
import { S3Client, PutObjectCommand } from '@aws-sdk/client-s3';

const r2 = new S3Client({
  region: 'auto',
  endpoint: Deno.env.get('R2_ENDPOINT'),
  credentials: {
    accessKeyId: Deno.env.get('R2_ACCESS_KEY')!,
    secretAccessKey: Deno.env.get('R2_SECRET_KEY')!
  }
});

Deno.serve(async (req) => {
  const supabase = createClient(
    Deno.env.get('SUPABASE_URL')!,
    Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!
  );
  
  // Obtener datos de la última semana
  const { data, error } = await supabase
    .from('ubicaciones_servicio')
    .select('*')
    .gte('created_at', new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString());
  
  if (error) throw error;
  
  // Comprimir y subir
  const filename = `backups/ubicaciones_${new Date().toISOString().slice(0,10)}.json.gz`;
  const compressed = await compress(JSON.stringify(data));
  
  await r2.send(new PutObjectCommand({
    Bucket: 'onlycar-backups',
    Key: filename,
    Body: compressed,
    ContentType: 'application/gzip'
  }));
  
  // Log
  await supabase.from('backup_log').insert({
    tipo: 'ubicaciones_semanal',
    archivo: filename,
    registros: data.length,
    tamano_bytes: compressed.byteLength
  });
  
  return new Response(JSON.stringify({ 
    success: true, 
    filename,
    registros: data.length 
  }));
});
```

### Programación

```bash
# Cron de Cloudflare Workers (cada domingo 2 AM)
0 8 * * 0 # 8 UTC = 2 AM CST
```

---

## Tabla de Log de Backups

```sql
CREATE TABLE backup_log (
  id SERIAL PRIMARY KEY,
  tipo VARCHAR(50) NOT NULL,
  archivo TEXT NOT NULL,
  registros INTEGER,
  tamano_bytes BIGINT,
  created_at TIMESTAMPTZ DEFAULT now(),
  verificado BOOLEAN DEFAULT false,
  error TEXT
);

CREATE INDEX idx_backup_log_fecha ON backup_log(created_at DESC);
```

---

## Recuperación de Datos

### Escenario 1: Servicio Específico Necesita Datos Eliminados

```typescript
// Restaurar ubicaciones de un servicio desde backup
const restaurarServicio = async (servicioId: string, fechaBackup: string) => {
  // 1. Descargar backup de R2
  const backup = await r2.getObject({
    Bucket: 'onlycar-backups',
    Key: `backups/ubicaciones_${fechaBackup}.json.gz`
  });
  
  const data = JSON.parse(await decompress(backup.Body));
  
  // 2. Filtrar solo el servicio necesario
  const ubicacionesServicio = data.filter(
    (u: any) => u.servicio_id === servicioId
  );
  
  // 3. Restaurar (si no existen)
  for (const ubicacion of ubicacionesServicio) {
    await supabase
      .from('ubicaciones_servicio')
      .upsert(ubicacion, { onConflict: 'id' });
  }
  
  return ubicacionesServicio.length;
};
```

### Escenario 2: Restauración Masiva (Desastre)

```sql
-- 1. Crear tabla temporal desde backup
CREATE TEMP TABLE ubicaciones_restore (
  LIKE ubicaciones_servicio
);

-- 2. Importar desde CSV/JSON
COPY ubicaciones_restore FROM '/path/to/backup.csv' CSV HEADER;

-- 3. Insertar solo los que no existen
INSERT INTO ubicaciones_servicio
SELECT * FROM ubicaciones_restore r
WHERE NOT EXISTS (
  SELECT 1 FROM ubicaciones_servicio u WHERE u.id = r.id
);

-- 4. Limpiar
DROP TABLE ubicaciones_restore;
```

---

## Verificación de Backups

```typescript
// Verificar integridad de backup semanal
const verificarBackup = async () => {
  // 1. Obtener último backup
  const { data: backups } = await supabase
    .from('backup_log')
    .select('*')
    .order('created_at', { ascending: false })
    .limit(1);
  
  const ultimoBackup = backups?.[0];
  
  if (!ultimoBackup) {
    notifyAdmin({ type: 'error', message: 'No hay backups registrados' });
    return;
  }
  
  // 2. Verificar antigüedad
  const diasDesdeBackup = (Date.now() - new Date(ultimoBackup.created_at).getTime()) 
    / (24 * 60 * 60 * 1000);
  
  if (diasDesdeBackup > 8) {
    notifyAdmin({ 
      type: 'warning', 
      message: `Último backup hace ${diasDesdeBackup.toFixed(0)} días` 
    });
  }
  
  // 3. Verificar que archivo existe en R2
  try {
    await r2.headObject({ 
      Bucket: 'onlycar-backups', 
      Key: ultimoBackup.archivo 
    });
    
    // Marcar como verificado
    await supabase
      .from('backup_log')
      .update({ verificado: true })
      .eq('id', ultimoBackup.id);
      
  } catch (e) {
    notifyAdmin({ 
      type: 'error', 
      message: `Backup ${ultimoBackup.archivo} no encontrado en R2` 
    });
  }
};
```

---

## Política de Retención de Backups

| Tipo | Frecuencia | Retención | Storage |
|------|------------|-----------|---------|
| Supabase automático | Diario | 7 días | Incluido |
| Export a R2 | Semanal | 90 días | ~2 MB/semana |
| Archivos especiales | Manual | Indefinido | Variable |

---

## Disaster Recovery Plan

```
┌─────────────────────────────────────────────────────────────────┐
│  PLAN DE RECUPERACIÓN DE DESASTRES                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  RTO (Recovery Time Objective): 4 horas                         │
│  RPO (Recovery Point Objective): 7 días                         │
│                                                                 │
│  PASOS:                                                         │
│  1. Identificar último backup válido en R2                      │
│  2. Restaurar desde backup a nueva instancia Supabase           │
│  3. Verificar integridad de datos                               │
│  4. Actualizar conexiones de la app                             │
│  5. Notificar a usuarios afectados                              │
│                                                                 │
│  RESPONSABLE: Admin de sistema                                  │
│  DOCUMENTACIÓN: /docs/disaster-recovery.md                      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

→ Ver módulo principal: [[Proyecto OnlyCarNLD/Datos/5.8.6.5 historial_ubicaciones]]

---

## Navegación

| ⬆️ Padre             | [[Proyecto OnlyCarNLD/Datos/5.8.6.5 historial_ubicaciones]]            |
| -------------------- | ---------------------- |
| ⬅️ Hermano anterior  | [[Proyecto OnlyCarNLD/Datos/5.8.6.5.9 queries_optimizadas]]              |
