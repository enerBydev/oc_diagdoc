---
id: 5.6.2
title: Proveedores OAuth
parent: '5.6'
breadcrumb: 0 → 5.0 → 5.6 → 5.6.2
type: integracion
status: activo
last_updated: 2026-01-29 16:01
file_create: 2025-12-23 14:25
domain:
- oauth
- azure
- google
summary: 'Integración con Azure AD y Google para autenticación OAuth mixta.

  Cuentas personales y corporativas soportadas.'
content_hash: 8bb140da88a08b58
---

# 5.6.2 Proveedores OAuth

Integración con Azure AD y Google para autenticación OAuth mixta.

---

## Principio Mixto

> [!NOTE]
> Ambos proveedores aceptan cuentas **personales** Y **corporativas**.
> OnlyCar no distingue el proveedor para la detección de tipo de usuario.

---

## Microsoft Azure AD

### Configuración

| Parámetro | Valor |
|-----------|-------|
| **Tipo** | Multi-tenant + Personal Accounts |
| **Scopes** | `openid`, `profile`, `email` |
| **Redirect URI** | `https://app.onlycar.mx/api/auth/oauth/callback` |

### Tipos de Cuenta Soportados

| Tipo | Email Ejemplo | Resultado |
|------|---------------|-----------|
| Personal Microsoft | `@outlook.com`, `@hotmail.com`, `@live.com` | B2C Puro |
| Work/School | `@empresa.onmicrosoft.com` | Verificar en BD |
| Azure AD Custom | `@miempresa.com` | Verificar en BD |

### Variables de Entorno

```env
AZURE_AD_CLIENT_ID=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
AZURE_AD_CLIENT_SECRET=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
AZURE_AD_TENANT_ID=common  # 'common' para multi-tenant
```

### Flujo de Integración

```
1. Usuario clic "Continuar con Microsoft"
2. Redirect → login.microsoftonline.com/common/oauth2/v2.0/authorize
3. Usuario autentica (personal o trabajo)
4. Microsoft devuelve → code
5. API intercambia code → access_token + id_token
6. Extraemos: email, name, oid
7. Creamos/actualizamos usuario en BD
8. Generamos JWT propio
```

---

## Google OAuth

### Configuración

| Parámetro | Valor |
|-----------|-------|
| **Tipo** | Web Application |
| **Scopes** | `openid`, `profile`, `email` |
| **Redirect URI** | `https://app.onlycar.mx/api/auth/oauth/callback` |

### Tipos de Cuenta Soportados

| Tipo | Email Ejemplo | Resultado |
|------|---------------|-----------|
| Personal Gmail | `@gmail.com` | B2C Puro |
| Google Workspace | `@empresa.com` (Workspace) | Verificar en BD |

### Variables de Entorno

```env
GOOGLE_CLIENT_ID=xxxxxxxxxxxx.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=GOCSPX-xxxxxxxxxxxxxxxxxxxxxxxx
```

### Flujo de Integración

```
1. Usuario clic "Continuar con Google"
2. Redirect → accounts.google.com/o/oauth2/v2/auth
3. Usuario autentica (personal o Workspace)
4. Google devuelve → code
5. API intercambia code → access_token + id_token
6. Extraemos: email, name, sub
7. Creamos/actualizamos usuario en BD
8. Generamos JWT propio
```

---

## Callback Unificado

```typescript
// server/api/auth/oauth/callback.get.ts
export default defineEventHandler(async (event) => {
  const query = getQuery(event);
  const { code, state } = query;
  
  // Decodificar state para saber proveedor
  const { provider, redirect_to } = JSON.parse(
    Buffer.from(state as string, 'base64').toString()
  );
  
  let userInfo;
  
  if (provider === 'azure') {
    userInfo = await exchangeAzureCode(code as string);
  } else if (provider === 'google') {
    userInfo = await exchangeGoogleCode(code as string);
  }
  
  // Detectar tipo de usuario por dominio
  const domain = userInfo.email.split('@')[1];
  const tipoUsuario = await detectarTipoUsuario(domain);
  
  // Crear/actualizar usuario
  const user = await upsertUser({
    email: userInfo.email,
    name: userInfo.name,
    auth_method: `oauth_${provider}`,
    oauth_provider_id: userInfo.id,
    dominio_email: domain,
    tipo_usuario: tipoUsuario,
    email_verified: true // OAuth ya verifica el email
  });
  
  // Generar sesión
  const { accessToken, refreshToken } = await createSession(user.id);
  
  // Redirect con tokens
  return sendRedirect(event, `${redirect_to}?token=${accessToken}`);
});
```

---

## Comparativa de Proveedores

| Aspecto | Azure AD | Google |
|---------|----------|--------|
| **Multi-tenant** | ✅ Sí (common) | ✅ Sí |
| **Cuentas personales** | ✅ Outlook/Hotmail | ✅ Gmail |
| **Cuentas corporativas** | ✅ Azure AD | ✅ Workspace |
| **MFA del proveedor** | ✅ Condicional | ✅ Opcional |
| **Renovación token** | ✅ Refresh token | ✅ Refresh token |

---

## Manejo de Errores

| Error | Causa | Acción |
|-------|-------|--------|
| `access_denied` | Usuario canceló | Mostrar mensaje amigable |
| `invalid_grant` | Código expirado | Reiniciar flujo |
| `server_error` | Error del proveedor | Mostrar error + retry |
| `consent_required` | Falta consentimiento | Solicitar permisos |

---

## Navegación

| ⬆️ Padre            | [[Proyecto OnlyCarNLD/Datos/5.6. autenticacion]]              |
| ------------------- | ----------------------------------- |
| ⬅️ Hermano anterior | [[Proyecto OnlyCarNLD/Datos/5.6.1 arquitectura_auth]]         |
| ➡️ Hermano siguiente | [[Proyecto OnlyCarNLD/Datos/5.6.3 email_password_blindado]]   |

---
