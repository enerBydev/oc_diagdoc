---
id: 3.1.5.7
title: Disputas API
parent: 3.1.5
breadcrumb: 0 → 3.0 → 3.1 → 3.1.5 → 3.1.5.7
type: especificacion
status: activo
domain:
- api
- disputas
- soporte
actors:
- cliente
- operador
- admin
- sistema
summary: Endpoints REST para gestión del ciclo de vida de disputas. Implementa los
  flujos definidos en [[1.6.3.2 flujos_resolucion_disputas]].
file_create: 2026-01-16 11:10
last_updated: 2026-01-29 15:32
content_hash: cc3afdd110f155c6
---

# 3.1.5.7 Disputas API

> Endpoints para la gestión de incidencias y resolución de conflictos.

---

## 1. Endpoints

### `POST /api/disputes`
Crear una nueva disputa.

**Acceso:** Cliente, Operador, Admin, Sistema

**Body:**
```typescript
interface CreateDisputeRequest {
  cita_id: string;           // UUID de la cita afectada
  tipo: DisputeTipo;         // 'OP_NO_SHOW' | 'CL_INSATISFACCION' | ...
  descripcion: string;       // Descripción del problema
  evidencia?: string[];      // URLs de fotos/archivos
}
```

**Response:** `201 Created`
```typescript
interface DisputeResponse {
  id: string;
  estado: DisputeEstado;
  tipo: DisputeTipo;
  created_at: string;
}
```

**Lógica Interna:**
1. Validar que la cita exista y esté en estado `completada` o `cancelada`.
2. Verificar que no exista ya una disputa para esa cita.
3. Aplicar reglas de **Auto-Resolución** si aplican (ver [[Proyecto OnlyCarNLD/Datos/1.6.3.2 flujos_resolucion_disputas]]).

---

### `GET /api/disputes/:id`
Obtener detalle de una disputa.

**Acceso:** Participantes (Cliente/Operador involucrado), Admin

**Response:**
```typescript
interface DisputeDetail {
  id: string;
  cita: CitaResumen;
  tipo: DisputeTipo;
  severidad: number;
  estado: DisputeEstado;
  reportado_por: UserResumen;
  operador: OperadorResumen;
  asignado_a?: UserResumen;
  evidencia: string[];
  resolucion?: ResolucionData;
  mensajes: MensajeResumen[]; // Solo no-internos para no-admins
  created_at: string;
  updated_at: string;
}
```

---

### `PATCH /api/disputes/:id/state`
Cambiar estado de una disputa.

**Acceso:** Admin

**Body:**
```typescript
interface UpdateStateRequest {
  nuevo_estado: DisputeEstado;
  notas?: string;
}
```

**Validaciones:**
- Solo admins pueden mover estados.
- Algunas transiciones están prohibidas (ej: `CERRADO` → `ABIERTO`).

---

### `POST /api/disputes/:id/messages`
Añadir un mensaje al expediente de la disputa.

**Acceso:** Participantes, Admin

**Body:**
```typescript
interface AddMessageRequest {
  mensaje: string;
  adjuntos?: string[];
  es_interno?: boolean; // Solo Admin puede marcar como interno
}
```

---

### `POST /api/disputes/:id/resolve`
Dictar resolución y aplicar compensación.

**Acceso:** Admin, Sistema (Auto-Resolución)

**Body:**
```typescript
interface ResolveDisputeRequest {
  dictamen: 'FAVOR_CLIENTE' | 'FAVOR_OPERADOR' | 'SIN_ACCION';
  compensacion?: {
    tipo: 'REEMBOLSO' | 'CUPON' | 'RETOQUE' | 'PENALIZACION';
    monto?: number;        // Solo para REEMBOLSO
    cupon_codigo?: string;  // Solo para CUPON
    penalizacion_operador?: number; // Monto a descontar
  };
  notas_resolucion?: string;
}
```

**Lógica Interna:**
1. Actualizar estado a `EJECUCION_PAGO`.
2. Si hay reembolso: Llamar a Stripe Refund ([[Proyecto OnlyCarNLD/Datos/5.1. stripe_pagos]]).
3. Si hay cupón: Crear en `cupones` ([[Proyecto OnlyCarNLD/Datos/3.1.1.4 Sistema_Descuentos]]).
4. Si hay penalización: Registrar en `operador_penalizaciones`.
5. Mover a `CERRADO`.

---

### `GET /api/disputes/stats`
Dashboard de incidencias para Admin.

**Acceso:** Admin

**Response:**
```typescript
interface DisputeStats {
  total_abiertas: number;
  por_tipo: Record<DisputeTipo, number>;
  por_estado: Record<DisputeEstado, number>;
  tiempo_resolucion_promedio: number; // minutos
  top_operadores_incidencias: { operador: string; count: number }[];
}
```

---

## 2. Tipos Compartidos

```typescript
type DisputeTipo = 
  | 'OP_NO_SHOW'           // Operador no llegó
  | 'OP_RETRASO'           // Llegó > 30min tarde
  | 'CL_NO_SHOW'           // Cliente no apareció
  | 'CL_INSATISFACCION'    // Calidad deficiente
  | 'DANIO_MENOR'          // Daño al vehículo
  | 'PAGO_FALLIDO'         // Problema con cobro
  | 'OTRO';

type DisputeEstado = 
  | 'ABIERTO'
  | 'AUTO_RESOLUCION'
  | 'INVESTIGACION'
  | 'EVIDENCIA_REQ'
  | 'DICTAMEN'
  | 'EJECUCION_PAGO'
  | 'CERRADO'
  | 'APELACION';
```

---

## 3. Integración con Otros Módulos

| Módulo | Interacción |
|--------|-------------|
| [[Proyecto OnlyCarNLD/Datos/5.1. stripe_pagos]] | Procesamiento de reembolsos |
| [[Proyecto OnlyCarNLD/Datos/3.1.1.4 Sistema_Descuentos]] | Generación de cupones APOLOGY |
| [[Proyecto OnlyCarNLD/Datos/3.1.8 sistema_remuneracion]] | Aplicación de penalizaciones a operador |
| [[Proyecto OnlyCarNLD/Datos/2.11. Observabilidad]] | Logging de todas las resoluciones |
| [[Proyecto OnlyCarNLD/Datos/3.1.4.8 Tablas_Quantum]] | Registro en `decision_logs` |

---

## Navegación

| ⬆️ Padre | [[Proyecto OnlyCarNLD/Datos/3.1.5 api_logica_negocio]] |
|----------|------------------------------|
| ⬅️ Hermano anterior | [[Proyecto OnlyCarNLD/Datos/3.1.5.6 Types_TS]] |

---
